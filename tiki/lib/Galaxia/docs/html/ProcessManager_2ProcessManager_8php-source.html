<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ProcessManager.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>ProcessManager.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 
00005 
<a name="l00010"></a><a class="code" href="classProcessManager.html">00010</a> <span class="keyword">class </span><a class="code" href="classProcessManager.html">ProcessManager</a> <span class="keyword">extends</span> TikiLib {
00011 
<a name="l00016"></a><a class="code" href="classProcessManager.html#a0">00016</a>   function <a class="code" href="classProcessManager.html#a0">ProcessManager</a>($db) 
00017   {
00018     <span class="keywordflow">if</span>(!$db) {
00019       die(<span class="stringliteral">"Invalid db object passed to ProcessManager constructor"</span>);  
00020     }
00021     $this-&gt;db = $db;  
00022   }
00023   
00024  
<a name="l00028"></a><a class="code" href="classProcessManager.html#a1">00028</a>   function <a class="code" href="classProcessManager.html#a1">activate_process</a>($pId)
00029   {
00030     $query = <span class="stringliteral">"update galaxia_processes set isActive='y' where pId=$pId"</span>;
00031     $this-&gt;query($query);  
00032   }
00033   
<a name="l00037"></a><a class="code" href="classProcessManager.html#a2">00037</a>   function <a class="code" href="classProcessManager.html#a2">deactivate_process</a>($pId)
00038   {
00039     $query = <span class="stringliteral">"update galaxia_processes set isActive='n' where pId=$pId"</span>;
00040     $this-&gt;query($query);  
00041   }
00042     
00049 
<a name="l00050"></a><a class="code" href="classProcessManager.html#a3">00050</a>   function <a class="code" href="classProcessManager.html#a3">new_process_version</a>($pId, $minor=<span class="keyword">true</span>)
00051   {
00052     $oldpid = $pId;
00053     $proc_info = $this-&gt;<a class="code" href="classProcessManager.html#a5">get_process</a>($pId);
00054     $name = $proc_info['name'];
00055     <span class="keywordflow">if</span>(!$proc_info) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00056     <span class="comment">// Now update the version</span>
00057     $version = $this-&gt;_new_version($proc_info['version'],$minor);
00058     <span class="keywordflow">while</span>($this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_processes where name='$name' and version='$version'"</span>)) {
00059         $version = $this-&gt;_new_version($version,$minor);
00060     }
00061     <span class="comment">// Make new versions unactive</span>
00062     $proc_info['version'] = $version;
00063     $proc_info['isActive'] = <span class="charliteral">'n'</span>;
00064     $pid = $this-&gt;<a class="code" href="classProcessManager.html#a8">replace_process</a>(<span class="comment">/*new proc!*/</span> 0, $proc_info);
00065     <span class="comment">// And here copy all the activities &amp; so</span>
00066     $aM = <span class="keyword">new</span> <a class="code" href="classActivityManager.html">ActivityManager</a>($this-&gt;db);
00067     $query = <span class="stringliteral">"select * from galaxia_activities where pId=$oldpid"</span>;
00068         $result = $this-&gt;query($query);
00069     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {    
00070       $aM-&gt;replace_activity($pid,0,$res);
00071     }
00072     $query = <span class="stringliteral">"select * from galaxia_transitions where pId=$oldpid"</span>;
00073         $result = $this-&gt;query($query);
00074     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {    
00075       $aM-&gt;add_transition($pid,$res['actFromId'],$res['actToId']);
00076     }
00077     
00078     <span class="comment">//Now since we are copying a process we should copy</span>
00079     <span class="comment">//the old directory structure to the new directory</span>
00080     $oldname = $proc_info['normalized_name'];
00081     $newname = $this-&gt;_get_normalized_name($pid);
00082         $this-&gt;_rec_copy(<span class="stringliteral">"lib/Galaxia/processes/$oldname"</span>,<span class="stringliteral">"lib/Galaxia/processes/$newname"</span>);
00083     <span class="keywordflow">return</span> $pid;
00084   }
00085   
<a name="l00092"></a><a class="code" href="classProcessManager.html#a4">00092</a>   function <a class="code" href="classProcessManager.html#a4">process_name_exists</a>($name,$version)
00093   {
00094     $name = addslashes($this-&gt;_normalize_name($name,$version));
00095     <span class="keywordflow">return</span> $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_processes where normalized_name='$name'"</span>);
00096   }
00097   
00098   
<a name="l00102"></a><a class="code" href="classProcessManager.html#a5">00102</a>   function <a class="code" href="classProcessManager.html#a5">get_process</a>($pId)
00103   {
00104         $query = <span class="stringliteral">"select * from galaxia_processes where pId=$pId"</span>;
00105         $result = $this-&gt;query($query);
00106         <span class="keywordflow">if</span>(!$result-&gt;numRows()) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00107         $res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC);
00108         <span class="keywordflow">return</span> $res;
00109   }
00110   
<a name="l00114"></a><a class="code" href="classProcessManager.html#a6">00114</a>   function <a class="code" href="classProcessManager.html#a6">list_processes</a>($offset,$maxRecords,$sort_mode,$find,$where='')
00115   {
00116     $sort_mode = str_replace(<span class="stringliteral">"_"</span>,<span class="stringliteral">" "</span>,$sort_mode);
00117     <span class="keywordflow">if</span>($find) {
00118       $mid=<span class="stringliteral">" where ((name like '%"</span>.$find.<span class="stringliteral">"%') or (description like '%"</span>.$find.<span class="stringliteral">"%'))"</span>;
00119     } <span class="keywordflow">else</span> {
00120       $mid=<span class="stringliteral">""</span>;
00121     }
00122     <span class="keywordflow">if</span>($where) {
00123       <span class="keywordflow">if</span>($mid) {
00124         $mid.= <span class="stringliteral">" and ($where) "</span>;
00125       } <span class="keywordflow">else</span> {
00126         $mid.= <span class="stringliteral">" where ($where) "</span>;
00127       }
00128     }
00129     $query = <span class="stringliteral">"select * from galaxia_processes $mid order by $sort_mode limit $offset,$maxRecords"</span>;
00130     $query_cant = <span class="stringliteral">"select count(*) from galaxia_processes $mid"</span>;
00131     $result = $this-&gt;query($query);
00132     $cant = $this-&gt;getOne($query_cant);
00133     $ret = Array();
00134     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00135       $ret[] = $res;
00136     }
00137     $retval = Array();
00138     $retval[<span class="stringliteral">"data"</span>] = $ret;
00139     $retval[<span class="stringliteral">"cant"</span>] = $cant;
00140     <span class="keywordflow">return</span> $retval;
00141   }
00142   
<a name="l00146"></a><a class="code" href="classProcessManager.html#a7">00146</a>   function <a class="code" href="classProcessManager.html#a7">remove_process</a>($pId)
00147   {
00148     $name = $this-&gt;_get_normalized_name($pId);
00149 
00150     $query = <span class="stringliteral">"delete from galaxia_processes where pId=$pId"</span>;
00151     $this-&gt;query($query);
00152         $aM = <span class="keyword">new</span> <a class="code" href="classActivityManager.html">ActivityManager</a>($this-&gt;db);
00153 
00154     <span class="comment">// Remove process activities</span>
00155         $query = <span class="stringliteral">"select activityId from galaxia_activities where pId=$pId"</span>;
00156         $result = $this-&gt;query($query);
00157     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00158                 $aM-&gt;remove_activity($pId,$res['activityId']);
00159     }
00160 
00161     <span class="comment">// Remove process roles</span>
00162     $query = <span class="stringliteral">"delete from galaxia_roles where pId=$pId"</span>;
00163     $this-&gt;query($query);
00164     $query = <span class="stringliteral">"delete from galaxia_user_roles where pId=$pId"</span>;
00165     $this-&gt;query($query);
00166     
00167     <span class="comment">// Remove the directory structure</span>
00168     $this-&gt;_remove_directory(<span class="stringliteral">"lib/Galaxia/processes/$name"</span>,<span class="keyword">true</span>);
00169     
00170     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00171   }
00172   
<a name="l00178"></a><a class="code" href="classProcessManager.html#a8">00178</a>   function <a class="code" href="classProcessManager.html#a8">replace_process</a>($pId, $vars)
00179   {
00180     $TABLE_NAME = 'galaxia_processes';
00181     $now = date(<span class="stringliteral">"U"</span>);
00182     $vars['lastModif']=$now;
00183     $vars['normalized_name'] = $this-&gt;_normalize_name($vars['name'],$vars['version']);        
00184     foreach($vars as $key=&gt;$value)
00185     {
00186       $vars[$key]=addslashes($value);
00187     }
00188   
00189     <span class="keywordflow">if</span>($pId) {
00190       <span class="comment">// update mode</span>
00191       $old_proc = $this-&gt;<a class="code" href="classProcessManager.html#a5">get_process</a>($pId);
00192       $first = <span class="keyword">true</span>;
00193       $query =<span class="stringliteral">"update $TABLE_NAME set"</span>;
00194       foreach($vars as $key=&gt;$value) {
00195         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>;
00196         <span class="keywordflow">if</span>(!is_numeric($value)||strstr($value,<span class="charliteral">'.'</span>)) $value=<span class="stringliteral">"'"</span>.$value.<span class="stringliteral">"'"</span>;
00197         $query.= <span class="stringliteral">" $key=$value "</span>;
00198         $first = <span class="keyword">false</span>;
00199       }
00200       $query .= <span class="stringliteral">" where pId=$pId "</span>;
00201       $this-&gt;query($query);
00202       <span class="comment">// Note that if the name is being changed then</span>
00203       <span class="comment">// the directory has to be renamed!</span>
00204       $oldname = $old_proc['normalized_name'];
00205       $newname = $vars['normalized_name'];
00206       rename(<span class="stringliteral">"lib/Galaxia/processes/$oldname"</span>,<span class="stringliteral">"lib/Galaxia/processes/$newname"</span>);
00207     } <span class="keywordflow">else</span> {
00208       unset($vars['pId']);
00209       <span class="comment">// insert mode</span>
00210       $name = $this-&gt;_normalize_name($vars['name'],$vars['version']);
00211       die(<span class="stringliteral">"antes"</span>);
00212       $this-&gt;_create_directory_structure($name);
00213       $first = <span class="keyword">true</span>;
00214       $query = <span class="stringliteral">"insert into $TABLE_NAME("</span>;
00215       foreach(array_keys($vars) as $key) {
00216         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>; 
00217         $query.= <span class="stringliteral">"$key"</span>;
00218         $first = <span class="keyword">false</span>;
00219       } 
00220       $query .=<span class="stringliteral">") values("</span>;
00221       $first = <span class="keyword">true</span>;
00222       foreach(array_values($vars) as $value) {
00223         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>; 
00224         <span class="keywordflow">if</span>(!is_numeric($value)||strstr($value,<span class="charliteral">'.'</span>)) $value=<span class="stringliteral">"'"</span>.$value.<span class="stringliteral">"'"</span>;
00225         $query.= <span class="stringliteral">"$value"</span>;
00226         $first = <span class="keyword">false</span>;
00227       } 
00228       $query .=<span class="stringliteral">")"</span>;
00229       $this-&gt;query($query);
00230       $pId = $this-&gt;getOne(<span class="stringliteral">"select max(pId) from $TABLE_NAME where lastModif=$now"</span>); 
00231       <span class="comment">// Now automatically add a start and end activity </span>
00232       $aM= <span class="keyword">new</span> <a class="code" href="classActivityManager.html">ActivityManager</a>($this-&gt;db);
00233       $vars1 = Array(
00234         'name' =&gt; 'start',
00235         'description' =&gt; '<span class="keywordflow">default</span> start activity',
00236         'type' =&gt; 'start',
00237         'isInteractive' =&gt; <span class="charliteral">'y'</span>,
00238         'isAutoRouted' =&gt; <span class="charliteral">'y'</span>
00239       );
00240       $vars2 = Array(
00241         'name' =&gt; 'end',
00242         'description' =&gt; '<span class="keywordflow">default</span> end activity',
00243         'type' =&gt; 'end',
00244         'isInteractive' =&gt; <span class="charliteral">'n'</span>,
00245         'isAutoRouted' =&gt; <span class="charliteral">'y'</span>
00246       );
00247 
00248       $aM-&gt;replace_activity($pId,0,$vars1);
00249       $aM-&gt;replace_activity($pId,0,$vars2);
00250      
00251     }
00252     <span class="comment">// Get the id</span>
00253     <span class="keywordflow">return</span> $pId;
00254    }
00255    
00260    function _get_normalized_name($pId)
00261    {
00262      $info = $this-&gt;<a class="code" href="classProcessManager.html#a5">get_process</a>($pId);
00263      <span class="keywordflow">return</span> $info['normalized_name'];
00264    }
00265    
00270    function _normalize_name($name, $version)
00271    {
00272      $name = $name.<span class="charliteral">'_'</span>.$version;
00273      $name = str_replace(<span class="stringliteral">" "</span>,<span class="stringliteral">"_"</span>,$name);
00274      $name = preg_replace(<span class="stringliteral">"/[^0-9A-Za-z\_]/"</span>,'',$name);
00275      <span class="keywordflow">return</span> $name;
00276    }
00277    
00282    function _new_version($version,$minor=<span class="keyword">true</span>)
00283    {
00284      $parts = explode(<span class="charliteral">'.'</span>,$version);
00285      <span class="keywordflow">if</span>($minor) {
00286        $parts[count($parts)-1]++;
00287      } <span class="keywordflow">else</span> {
00288        $parts[0]++;
00289      }
00290      <span class="keywordflow">return</span> implode(<span class="charliteral">'.'</span>,$parts);
00291    }
00292    
00297    function _create_directory_structure($name)
00298    {
00299     
00300      <span class="comment">// Create in processes a directory with this name</span>
00301      mkdir(<span class="stringliteral">"lib/Galaxia/processes/$name"</span>,0777);
00302          mkdir(<span class="stringliteral">"lib/Galaxia/processes/$name/graph"</span>,0777);
00303          mkdir(<span class="stringliteral">"lib/Galaxia/processes/$name/code"</span>,0777);
00304          mkdir(<span class="stringliteral">"lib/Galaxia/processes/$name/compiled"</span>,0777);
00305          mkdir(<span class="stringliteral">"lib/Galaxia/processes/$name/code/activities"</span>,0777);
00306          mkdir(<span class="stringliteral">"lib/Galaxia/processes/$name/code/templates"</span>,0777);
00307          <span class="comment">// Create shared file</span>
00308          $fp = fopen(<span class="stringliteral">"lib/Galaxia/processes/$name/code/shared.php"</span>,<span class="stringliteral">"w"</span>);
00309          fwrite($fp,<span class="charliteral">'&lt;'</span>.<span class="charliteral">'?'</span>.'php'.<span class="stringliteral">"\n"</span>.<span class="charliteral">'?'</span>.<span class="charliteral">'&gt;'</span>);
00310          fclose($fp);
00311    }
00312    
00317    function _remove_directory($dir,$rec=<span class="keyword">false</span>)
00318    {
00319 
00320      $h = opendir($dir);
00321      <span class="keywordflow">while</span>(($file = readdir($h)) !== <span class="keyword">false</span>) {
00322        <span class="keywordflow">if</span>(is_file($dir.<span class="charliteral">'/'</span>.$file)) {
00323          unlink($dir.<span class="charliteral">'/'</span>.$file);
00324        } <span class="keywordflow">else</span> {
00325          <span class="keywordflow">if</span>($rec &amp;&amp; $file != <span class="charliteral">'.'</span> &amp;&amp; $file != '..') {
00326            $this-&gt;_remove_directory($dir.<span class="charliteral">'/'</span>.$file, <span class="keyword">true</span>);
00327          }
00328        }
00329      }
00330      rmdir($dir);
00331      closedir($h);   
00332    }
00333 
00334 
00335    function _rec_copy($dir1,$dir2)
00336    {
00337          @mkdir($dir2,0777);
00338      $h = opendir($dir1);
00339      <span class="keywordflow">while</span>(($file = readdir($h)) !== <span class="keyword">false</span>) {
00340        <span class="keywordflow">if</span>(is_file($dir1.<span class="charliteral">'/'</span>.$file)) {
00341          copy($dir1.<span class="charliteral">'/'</span>.$file,$dir2.<span class="charliteral">'/'</span>.$file);
00342        } <span class="keywordflow">else</span> {
00343          <span class="keywordflow">if</span>($file != <span class="charliteral">'.'</span> &amp;&amp; $file != '..') {
00344            $this-&gt;_rec_copy($dir1.<span class="charliteral">'/'</span>.$file, $dir2.<span class="charliteral">'/'</span>.$file);
00345          }
00346        }
00347      }
00348      closedir($h);   
00349    }
00350 
00351 
00352 
00353 }    
00354 
00355 
00357 $processManager = <span class="keyword">new</span> <a class="code" href="classProcessManager.html">ProcessManager</a>($dbTiki);
00358 
00359 ?&gt;
</pre></div><hr><address style="align: right;"><small>Generated on Mon Apr 14 11:51:59 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
