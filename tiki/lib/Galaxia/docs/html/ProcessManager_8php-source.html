<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Galaxia: ProcessManager.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>ProcessManager.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 include_once(GALAXIA_LIBRARY.'/src/<a class="code" href="classProcessManager.html">ProcessManager</a>/<a class="code" href="classBaseManager.html">BaseManager</a>.php');
00005 
<a name="l00009"></a><a class="code" href="classProcessManager.html">00009</a> <span class="keyword">class </span><a class="code" href="classProcessManager.html">ProcessManager</a> <span class="keyword">extends</span> <a class="code" href="classBaseManager.html">BaseManager</a> {
00010   var $parser;
00011   var $tree;
00012   var $current;
00013   var $buffer;
00014   
<a name="l00019"></a><a class="code" href="classProcessManager.html#a0">00019</a>   function <a class="code" href="classProcessManager.html#a0">ProcessManager</a>($db) 
00020   {
00021     <span class="keywordflow">if</span>(!$db) {
00022       die(<span class="stringliteral">"Invalid db object passed to ProcessManager constructor"</span>);  
00023     }
00024     $this-&gt;db = $db;  
00025   }
00026   
00027  
<a name="l00031"></a><a class="code" href="classProcessManager.html#a1">00031</a>   function <a class="code" href="classProcessManager.html#a1">activate_process</a>($pId)
00032   {
00033         $query = <span class="stringliteral">"update "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"processes set isActive='y' where pId=$pId"</span>;
00034     $this-&gt;query($query);  
00035     $msg = sprintf(tra('<a class="code" href="classProcess.html">Process</a> %d has been activated'),$pId);
00036     $this-&gt;notify_all(3,$msg);
00037   }
00038   
<a name="l00042"></a><a class="code" href="classProcessManager.html#a2">00042</a>   function <a class="code" href="classProcessManager.html#a2">deactivate_process</a>($pId)
00043   {
00044     $query = <span class="stringliteral">"update "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"processes set isActive='n' where pId=$pId"</span>;
00045     $this-&gt;query($query);  
00046     $msg = sprintf(tra('<a class="code" href="classProcess.html">Process</a> %d has been deactivated'),$pId);
00047     $this-&gt;notify_all(3,$msg);
00048   }
00049   
<a name="l00053"></a><a class="code" href="classProcessManager.html#a3">00053</a>   function <a class="code" href="classProcessManager.html#a3">serialize_process</a>($pId)
00054   {
00055     <span class="comment">// &lt;process&gt;</span>
00056     $out = '&lt;process&gt;'.<span class="stringliteral">"\n"</span>;
00057     $proc_info = $this-&gt;get_process($pId);
00058     $procname = $proc_info['normalized_name'];
00059     $out.= '  &lt;name&gt;'.htmlspecialchars($proc_info['name']).'&lt;/name&gt;'.<span class="stringliteral">"\n"</span>;
00060     $out.= '  &lt;isValid&gt;'.htmlspecialchars($proc_info['isValid']).'&lt;/isValid&gt;'.<span class="stringliteral">"\n"</span>;
00061     $out.= '  &lt;version&gt;'.htmlspecialchars($proc_info['version']).'&lt;/version&gt;'.<span class="stringliteral">"\n"</span>;
00062     $out.= '  &lt;isActive&gt;'.htmlspecialchars($proc_info['isActive']).'&lt;/isActive&gt;'.<span class="stringliteral">"\n"</span>;
00063         $out.='   &lt;description&gt;'.htmlspecialchars($proc_info['description']).'&lt;/description&gt;'.<span class="stringliteral">"\n"</span>;
00064     $out.= '  &lt;lastModif&gt;'.date(<span class="stringliteral">"d/m/Y [h:i:s]"</span>,$proc_info['lastModif']).'&lt;/lastModif&gt;'.<span class="stringliteral">"\n"</span>;
00065         $out.= '  &lt;sharedCode&gt;&lt;![CDATA[';
00066         $fp=fopen(GALAXIA_PROCESSES.<span class="stringliteral">"/$procname/code/shared.php"</span>,<span class="stringliteral">"r"</span>);
00067         <span class="keywordflow">while</span>(!feof($fp)) {
00068           $line=fread($fp,8192);
00069           $out.=$line;
00070         }
00071         fclose($fp);
00072         $out.= '  ]]&gt;&lt;/sharedCode&gt;'.<span class="stringliteral">"\n"</span>;
00073         <span class="comment">// Now loop over activities</span>
00074         $query = <span class="stringliteral">"select * from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities where pId=$pId"</span>;
00075         $result = $this-&gt;query($query);
00076         $out.='  &lt;activities&gt;'.<span class="stringliteral">"\n"</span>;
00077         $am = <span class="keyword">new</span> <a class="code" href="classActivityManager.html">ActivityManager</a>($this-&gt;db);
00078     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {       
00079         $name = $res['normalized_name'];
00080                 $out.='    &lt;activity&gt;'.<span class="stringliteral">"\n"</span>;
00081                 $out.='      &lt;name&gt;'.htmlspecialchars($res['name']).'&lt;/name&gt;'.<span class="stringliteral">"\n"</span>;
00082                 $out.='      &lt;type&gt;'.htmlspecialchars($res['type']).'&lt;/type&gt;'.<span class="stringliteral">"\n"</span>;
00083                 $out.='      &lt;description&gt;'.htmlspecialchars($res['description']).'&lt;/description&gt;'.<span class="stringliteral">"\n"</span>;
00084                 $out.='      &lt;lastModif&gt;'.date(<span class="stringliteral">"d/m/Y [h:i:s]"</span>,$res['lastModif']).'&lt;/lastModif&gt;'.<span class="stringliteral">"\n"</span>;
00085                 $out.='      &lt;isInteractive&gt;'.$res['isInteractive'].'&lt;/isInteractive&gt;'.<span class="stringliteral">"\n"</span>;
00086                 $out.='      &lt;isAutoRouted&gt;'.$res['isAutoRouted'].'&lt;/isAutoRouted&gt;'.<span class="stringliteral">"\n"</span>;
00087                 $out.='      &lt;roles&gt;'.<span class="stringliteral">"\n"</span>;
00088                 
00089                 $roles = $am-&gt;get_activity_roles($res['activityId']);
00090                 foreach($roles as $role) {
00091                   $out.='        &lt;role&gt;'.htmlspecialchars($role['name']).'&lt;/role&gt;'.<span class="stringliteral">"\n"</span>;
00092                 }       
00093                 $out.='      &lt;/roles&gt;'.<span class="stringliteral">"\n"</span>;
00094                 $out.='      &lt;code&gt;&lt;![CDATA[';
00095                 $fp=fopen(GALAXIA_PROCESSES.<span class="stringliteral">"/$procname/code/activities/$name.php"</span>,<span class="stringliteral">"r"</span>);
00096                 <span class="keywordflow">while</span>(!feof($fp)) {
00097                         $line=fread($fp,8192);
00098                         $out.=$line;
00099                 }
00100                 fclose($fp);
00101                 $out.='      ]]&gt;&lt;/code&gt;';
00102                 <span class="keywordflow">if</span>($res['isInteractive']==<span class="charliteral">'y'</span>) {
00103                         $out.='      &lt;<span class="keyword">template</span>&gt;&lt;![CDATA[';
00104                         $fp=fopen(GALAXIA_PROCESSES.<span class="stringliteral">"/$procname/code/templates/$name.tpl"</span>,<span class="stringliteral">"r"</span>);
00105                         <span class="keywordflow">while</span>(!feof($fp)) {
00106                                 $line=fread($fp,8192);
00107                                 $out.=$line;
00108                         }
00109                         fclose($fp);
00110                         $out.='      ]]&gt;&lt;/<span class="keyword">template</span>&gt;';
00111                 }
00112                 $out.='    &lt;/activity&gt;'.<span class="stringliteral">"\n"</span>;    
00113     }
00114         $out.='  &lt;/activities&gt;'.<span class="stringliteral">"\n"</span>;
00115         $out.='  &lt;transitions&gt;'.<span class="stringliteral">"\n"</span>;
00116         $transitions = $am-&gt;get_process_transitions($pId);
00117         foreach($transitions as $tran) {
00118           $out.='     &lt;transition&gt;'.<span class="stringliteral">"\n"</span>;
00119           $out.='       &lt;from&gt;'.htmlspecialchars($tran['actFromName']).'&lt;/from&gt;'.<span class="stringliteral">"\n"</span>;
00120           $out.='       &lt;to&gt;'.htmlspecialchars($tran['actToName']).'&lt;/to&gt;'.<span class="stringliteral">"\n"</span>;
00121           $out.='     &lt;/transition&gt;'.<span class="stringliteral">"\n"</span>;
00122         }       
00123         $out.='  &lt;/transitions&gt;'.<span class="stringliteral">"\n"</span>;
00124     $out.= '&lt;/process&gt;'.<span class="stringliteral">"\n"</span>;
00125     <span class="comment">//$fp = fopen(GALAXIA_PROCESSES."/$procname/$procname.xml","w");</span>
00126     <span class="comment">//fwrite($fp,$out);</span>
00127     <span class="comment">//fclose($fp);</span>
00128     <span class="keywordflow">return</span> $out;
00129   }
00130   
<a name="l00135"></a><a class="code" href="classProcessManager.html#a4">00135</a>   function <a class="code" href="classProcessManager.html#a4">unserialize_process</a>($xml) 
00136   {
00137         <span class="comment">// Create SAX parser assign this object as base for handlers</span>
00138         <span class="comment">// handlers are private methods defined below.</span>
00139         <span class="comment">// keep contexts and parse</span>
00140         $this-&gt;parser = xml_parser_create(); 
00141         xml_parser_set_option($this-&gt;parser,XML_OPTION_CASE_FOLDING,0);
00142         xml_set_object($this-&gt;parser, $<span class="keyword">this</span>);
00143         xml_set_element_handler($this-&gt;parser, <span class="stringliteral">"_start_element_handler"</span>, <span class="stringliteral">"_end_element_handler"</span>);
00144     xml_set_character_data_handler($this-&gt;parser, <span class="stringliteral">"_data_handler"</span>); 
00145     $aux=Array(
00146         'name'=&gt;'root',
00147         'children'=&gt;Array(),
00148         'parent' =&gt; 0,
00149         'data'=&gt;''
00150     );
00151     $this-&gt;tree[0]=$aux;
00152     $this-&gt;current=0;
00153     <span class="keywordflow">if</span> (!xml_parse($this-&gt;parser, $xml, <span class="keyword">true</span>)) {
00154         $error = sprintf(<span class="stringliteral">"XML error: %s at line %d"</span>,
00155                     xml_error_string(xml_get_error_code($this-&gt;parser)),
00156                     xml_get_current_line_number($this-&gt;parser));
00157         trigger_error($error,E_USER_WARNING);
00158         }
00159     xml_parser_free($this-&gt;parser);   
00160         <span class="comment">// Now that we have the tree we can do interesting things</span>
00161         <span class="comment">//print_r($this-&gt;tree);</span>
00162         $process=Array();
00163         $activities=Array();
00164         $transitions=Array();
00165         <span class="keywordflow">for</span>($i=0;$i&lt;count($this-&gt;tree[1]['children']);$i++) {
00166           <span class="comment">// Process attributes</span>
00167           $z=$this-&gt;tree[1]['children'][$i];
00168           $name = trim($this-&gt;tree[$z]['name']);
00169           <span class="keywordflow">if</span>($name=='activities') {
00170             <span class="keywordflow">for</span>($j=0;$j&lt;count($this-&gt;tree[$z]['children']);$j++) {
00171               $z2 = $this-&gt;tree[$z]['children'][$j];
00172               <span class="comment">// this is an activity $name = $this-&gt;tree[$z2]['name'];</span>
00173               <span class="keywordflow">if</span>($this-&gt;tree[$z2]['name']=='activity') {
00174               <span class="keywordflow">for</span>($k=0;$k&lt;count($this-&gt;tree[$z2]['children']);$k++) {
00175                 $z3 = $this-&gt;tree[$z2]['children'][$k];
00176                 $name = trim($this-&gt;tree[$z3]['name']);
00177                 $value= trim($this-&gt;tree[$z3]['data']);
00178                 <span class="keywordflow">if</span>($name=='roles') {
00179                   $roles=Array();
00180                           <span class="keywordflow">for</span>($l=0;$l&lt;count($this-&gt;tree[$z3]['children']);$l++) {
00181                             $z4 = $this-&gt;tree[$z3]['children'][$l];
00182                             $name = trim($this-&gt;tree[$z4]['name']);
00183                             $data = trim($this-&gt;tree[$z4]['data']);
00184                             $roles[]=$data;
00185                           }                                
00186                 } <span class="keywordflow">else</span> {
00187                         
00188                   $aux[$name]=$value;
00189                   <span class="comment">//print("$name:$value&lt;br/&gt;");</span>
00190                 }
00191               }
00192           $aux['roles']=$roles;
00193           $activities[]=$aux;
00194           }
00195             }
00196           } elseif($name=='transitions') {
00197             <span class="keywordflow">for</span>($j=0;$j&lt;count($this-&gt;tree[$z]['children']);$j++) {
00198               $z2 = $this-&gt;tree[$z]['children'][$j];
00199               <span class="comment">// this is an activity $name = $this-&gt;tree[$z2]['name'];</span>
00200               <span class="keywordflow">if</span>($this-&gt;tree[$z2]['name']=='transition') {
00201               <span class="keywordflow">for</span>($k=0;$k&lt;count($this-&gt;tree[$z2]['children']);$k++) {
00202                 $z3 = $this-&gt;tree[$z2]['children'][$k];
00203                 $name = trim($this-&gt;tree[$z3]['name']);
00204                 $value= trim($this-&gt;tree[$z3]['data']);
00205                 <span class="keywordflow">if</span>($name == 'from' || $name == 'to') {
00206                   $aux[$name]=$value;
00207                 }
00208               }
00209               }
00210               $transitions[] = $aux;
00211             }
00212 
00213           
00214           } <span class="keywordflow">else</span> {
00215             $value = trim($this-&gt;tree[$z]['data']);
00216             <span class="comment">//print("$name is $value&lt;br/&gt;");</span>
00217             $process[$name]=$value;
00218             
00219           }
00220         }
00221         $process['activities']=$activities;
00222         $process['transitions']=$transitions;
00223         <span class="keywordflow">return</span> $process;
00224   }
00225   
<a name="l00231"></a><a class="code" href="classProcessManager.html#a5">00231</a>   function <a class="code" href="classProcessManager.html#a5">import_process</a>($data)
00232   {
00233         <span class="comment">//Now the show begins</span>
00234         $am = <span class="keyword">new</span> <a class="code" href="classActivityManager.html">ActivityManager</a>($this-&gt;db);
00235         $rm = <span class="keyword">new</span> <a class="code" href="classRoleManager.html">RoleManager</a>($this-&gt;db);
00236         <span class="comment">// First create the process</span>
00237         $vars = Array(
00238                 'name' =&gt; $data['name'],
00239                 'version' =&gt; $data['version'],
00240                 'description' =&gt; $data['description'],
00241                 'lastModif' =&gt; $data['lastModif'],
00242                 'isActive' =&gt; $data['isActive'],
00243                 'isValid' =&gt; $data['isValid']
00244         );
00245         $pid = $this-&gt;replace_process(0,$vars,<span class="keyword">false</span>);
00246         <span class="comment">//Put the shared code </span>
00247         $proc_info = $this-&gt;get_process($pid);
00248         $procname = $proc_info['normalized_name'];
00249         $fp = fopen(GALAXIA_PROCESSES.<span class="stringliteral">"/$procname/code/shared.php"</span>,<span class="stringliteral">"w"</span>);
00250         fwrite($fp,$data['sharedCode']);
00251         fclose($fp);
00252         $actids = Array();
00253         <span class="comment">// Foreach activity create activities</span>
00254         foreach($data['activities'] as $activity) {
00255           $vars = Array(
00256                 'name' =&gt; $activity['name'],
00257                 'description' =&gt; $activity['description'],
00258                 'type' =&gt; $activity['type'],
00259                 'lastModif' =&gt; $activity['lastModif'],
00260                 'isInteractive' =&gt; $activity['isInteractive'],
00261                 'isAutoRouted' =&gt; $activity['isAutoRouted']
00262           );      
00263           $actname=$am-&gt;_normalize_name($activity['name']);
00264       
00265       $actid = $am-&gt;replace_activity($pid,0,$vars);
00266       $fp = fopen(GALAXIA_PROCESSES.<span class="stringliteral">"/$procname/code/activities/$actname"</span>.'.php',<span class="stringliteral">"w"</span>);
00267       fwrite($fp,$activity['code']);
00268       fclose($fp);
00269       <span class="keywordflow">if</span>($activity['isInteractive']==<span class="charliteral">'y'</span>) {
00270         $fp = fopen(GALAXIA_PROCESSES.<span class="stringliteral">"/$procname/code/templates/$actname"</span>.'.tpl',<span class="stringliteral">"w"</span>);
00271         fwrite($fp,$activity['<span class="keyword">template</span>']);
00272         fclose($fp);
00273       }
00274       $actids[$activity['name']] = $am-&gt;_get_activity_id_by_name($pid,$activity['name']);
00275           $actname = $am-&gt;_normalize_name($activity['name']);
00276           $now = date(<span class="stringliteral">"U"</span>);
00277 
00278           foreach($activity['roles'] as $role) {
00279 
00280             $vars = Array(
00281                 'name' =&gt; $role,
00282                 'description' =&gt; $role,
00283                 'lastModif' =&gt; $now,
00284                 );
00285                 <span class="keywordflow">if</span>(!$rm-&gt;role_name_exists($pid,$role)) {
00286                   $rid=$rm-&gt;replace_role($pid,0,$vars);
00287                 } <span class="keywordflow">else</span> {
00288                   $rid = $rm-&gt;get_role_id($pid,$role);
00289                 }
00290                 <span class="keywordflow">if</span>($actid &amp;&amp; $rid) {
00291                   $am-&gt;add_activity_role($actid,$rid);
00292                 }
00293           }
00294         }
00295         foreach($data['transitions'] as $tran) {
00296                 $am-&gt;add_transition($pid,$actids[$tran['from']],$actids[$tran['to']]);  
00297         }
00298         <span class="comment">// FIXME: recompile activities seems to be needed here</span>
00299         foreach ($actids as $name =&gt; $actid) {
00300                 $am-&gt;compile_activity($pid,$actid);
00301         }
00302         unset($am);
00303         unset($rm);
00304         $msg = sprintf(tra('<a class="code" href="classProcess.html">Process</a> %s %s imported'),$proc_info['name'],$proc_info['version']);
00305         $this-&gt;notify_all(2,$msg);
00306   }
00307   
00308   
00309    
00310     
00317 
<a name="l00318"></a><a class="code" href="classProcessManager.html#a6">00318</a>   function <a class="code" href="classProcessManager.html#a6">new_process_version</a>($pId, $minor=<span class="keyword">true</span>)
00319   {
00320     $oldpid = $pId;
00321     $proc_info = $this-&gt;get_process($pId);
00322     $name = $proc_info['name'];
00323     <span class="keywordflow">if</span>(!$proc_info) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00324     <span class="comment">// Now update the version</span>
00325     $version = $this-&gt;_new_version($proc_info['version'],$minor);
00326     <span class="keywordflow">while</span>($this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"processes where name='$name' and version='$version'"</span>)) {
00327         $version = $this-&gt;_new_version($version,$minor);
00328     }
00329     <span class="comment">// Make new versions unactive</span>
00330     $proc_info['version'] = $version;
00331     $proc_info['isActive'] = <span class="charliteral">'n'</span>;
00332     $pid = $this-&gt;replace_process(<span class="comment">/*new proc!*/</span> 0, $proc_info);
00333     <span class="comment">// And here copy all the activities &amp; so</span>
00334     $aM = <span class="keyword">new</span> <a class="code" href="classActivityManager.html">ActivityManager</a>($this-&gt;db);
00335     $query = <span class="stringliteral">"select * from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities where pId=$oldpid"</span>;
00336         $result = $this-&gt;query($query);
00337     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {    
00338       $aM-&gt;replace_activity($pid,0,$res);
00339     }
00340     $query = <span class="stringliteral">"select * from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"transitions where pId=$oldpid"</span>;
00341         $result = $this-&gt;query($query);
00342     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {    
00343       $aM-&gt;add_transition($pid,$res['actFromId'],$res['actToId']);
00344     }
00345     
00346     <span class="comment">//Now since we are copying a process we should copy</span>
00347     <span class="comment">//the old directory structure to the new directory</span>
00348     $oldname = $proc_info['normalized_name'];
00349     $newname = $this-&gt;_get_normalized_name($pid);
00350         $this-&gt;_rec_copy(GALAXIA_PROCESSES.<span class="stringliteral">"/$oldname"</span>,GALAXIA_PROCESSES.<span class="stringliteral">"/$newname"</span>);
00351     <span class="keywordflow">return</span> $pid;
00352   }
00353   
<a name="l00360"></a><a class="code" href="classProcessManager.html#a7">00360</a>   function <a class="code" href="classProcessManager.html#a7">process_name_exists</a>($name,$version)
00361   {
00362     $name = addslashes($this-&gt;_normalize_name($name,$version));
00363     <span class="keywordflow">return</span> $this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"processes where normalized_name='$name'"</span>);
00364   }
00365   
00366   
<a name="l00370"></a><a class="code" href="classProcessManager.html#a8">00370</a>   function <a class="code" href="classProcessManager.html#a8">get_process</a>($pId)
00371   {
00372         $query = <span class="stringliteral">"select * from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"processes where pId=$pId"</span>;
00373         $result = $this-&gt;query($query);
00374         <span class="keywordflow">if</span>(!$result-&gt;numRows()) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00375         $res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC);
00376         <span class="keywordflow">return</span> $res;
00377   }
00378   
<a name="l00382"></a><a class="code" href="classProcessManager.html#a9">00382</a>   function <a class="code" href="classProcessManager.html#a9">list_processes</a>($offset,$maxRecords,$sort_mode,$find,$where='')
00383   {
00384     $sort_mode = str_replace(<span class="stringliteral">"_"</span>,<span class="stringliteral">" "</span>,$sort_mode);
00385     <span class="keywordflow">if</span>($find) {
00386         $findesc = $this-&gt;qstr(<span class="charliteral">'%'</span>.$find.<span class="charliteral">'%'</span>);
00387       $mid=<span class="stringliteral">" where ((name like $findesc) or (description like $findesc))"</span>;
00388     } <span class="keywordflow">else</span> {
00389       $mid=<span class="stringliteral">""</span>;
00390     }
00391     <span class="keywordflow">if</span>($where) {
00392       <span class="keywordflow">if</span>($mid) {
00393         $mid.= <span class="stringliteral">" and ($where) "</span>;
00394       } <span class="keywordflow">else</span> {
00395         $mid.= <span class="stringliteral">" where ($where) "</span>;
00396       }
00397     }
00398     $query = <span class="stringliteral">"select * from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"processes $mid order by $sort_mode limit $offset,$maxRecords"</span>;
00399     $query_cant = <span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"processes $mid"</span>;
00400     $result = $this-&gt;query($query);
00401     $cant = $this-&gt;getOne($query_cant);
00402     $ret = Array();
00403     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00404       $ret[] = $res;
00405     }
00406     $retval = Array();
00407     $retval[<span class="stringliteral">"data"</span>] = $ret;
00408     $retval[<span class="stringliteral">"cant"</span>] = $cant;
00409     <span class="keywordflow">return</span> $retval;
00410   }
00411   
<a name="l00415"></a><a class="code" href="classProcessManager.html#a10">00415</a>   function <a class="code" href="classProcessManager.html#a10">invalidate_process</a>($pid)
00416   {
00417     $query = <span class="stringliteral">"update "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"processes set isValid='n' where pId=$pid"</span>;
00418     $this-&gt;query($query);
00419   }
00420   
<a name="l00424"></a><a class="code" href="classProcessManager.html#a11">00424</a>   function <a class="code" href="classProcessManager.html#a11">remove_process</a>($pId)
00425   {
00426     $this-&gt;deactivate_process($pId);
00427     $name = $this-&gt;_get_normalized_name($pId);
00428         $aM = <span class="keyword">new</span> <a class="code" href="classActivityManager.html">ActivityManager</a>($this-&gt;db);
00429     <span class="comment">// Remove process activities</span>
00430         $query = <span class="stringliteral">"select activityId from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities where pId=$pId"</span>;
00431         $result = $this-&gt;query($query);
00432     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00433                 $aM-&gt;remove_activity($pId,$res['activityId']);
00434     }
00435 
00436     <span class="comment">// Remove process roles</span>
00437     $query = <span class="stringliteral">"delete from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"roles where pId=$pId"</span>;
00438     $this-&gt;query($query);
00439     $query = <span class="stringliteral">"delete from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"user_roles where pId=$pId"</span>;
00440     $this-&gt;query($query);
00441     
00442     <span class="comment">// Remove the directory structure</span>
00443     <span class="keywordflow">if</span> (is_dir(GALAXIA_PROCESSES.<span class="stringliteral">"/$name"</span>)) {
00444       $this-&gt;_remove_directory(GALAXIA_PROCESSES.<span class="stringliteral">"/$name"</span>,<span class="keyword">true</span>);
00445     }
00446     <span class="keywordflow">if</span> (GALAXIA_TEMPLATES &amp;&amp; is_dir(GALAXIA_TEMPLATES.<span class="stringliteral">"/$name"</span>)) {
00447       $this-&gt;_remove_directory(GALAXIA_TEMPLATES.<span class="stringliteral">"/$name"</span>,<span class="keyword">true</span>);
00448     }
00449     <span class="comment">// And finally remove the proc</span>
00450     $query = <span class="stringliteral">"delete from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"processes where pId=$pId"</span>;
00451     $this-&gt;query($query);
00452     $msg = sprintf(tra('<a class="code" href="classProcess.html">Process</a> %s removed'),$name);
00453         $this-&gt;notify_all(5,$msg);
00454     
00455     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00456   }
00457   
<a name="l00463"></a><a class="code" href="classProcessManager.html#a12">00463</a>   function <a class="code" href="classProcessManager.html#a12">replace_process</a>($pId, $vars, $create = <span class="keyword">true</span>)
00464   {
00465     $TABLE_NAME = '<span class="stringliteral">".GALAXIA_TABLE_PREFIX."</span>processes';
00466     $now = date(<span class="stringliteral">"U"</span>);
00467     $vars['lastModif']=$now;
00468     $vars['normalized_name'] = $this-&gt;_normalize_name($vars['name'],$vars['version']);        
00469     foreach($vars as $key=&gt;$value)
00470     {
00471       $vars[$key]=addslashes($value);
00472     }
00473   
00474     <span class="keywordflow">if</span>($pId) {
00475       <span class="comment">// update mode</span>
00476       $old_proc = $this-&gt;get_process($pId);
00477       $first = <span class="keyword">true</span>;
00478       $query =<span class="stringliteral">"update $TABLE_NAME set"</span>;
00479       foreach($vars as $key=&gt;$value) {
00480         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>;
00481         <span class="keywordflow">if</span>(!is_numeric($value)||strstr($value,<span class="charliteral">'.'</span>)) $value=<span class="stringliteral">"'"</span>.$value.<span class="stringliteral">"'"</span>;
00482         $query.= <span class="stringliteral">" $key=$value "</span>;
00483         $first = <span class="keyword">false</span>;
00484       }
00485       $query .= <span class="stringliteral">" where pId=$pId "</span>;
00486       $this-&gt;query($query);
00487       <span class="comment">// Note that if the name is being changed then</span>
00488       <span class="comment">// the directory has to be renamed!</span>
00489       $oldname = $old_proc['normalized_name'];
00490       $newname = $vars['normalized_name'];
00491       <span class="keywordflow">if</span> ($newname != $oldname) {
00492           rename(GALAXIA_PROCESSES.<span class="stringliteral">"/$oldname"</span>,GALAXIA_PROCESSES.<span class="stringliteral">"/$newname"</span>);
00493       }
00494       $msg = sprintf(tra('<a class="code" href="classProcess.html">Process</a> %s has been updated'),$vars['name']);     
00495       $this-&gt;notify_all(3,$msg);
00496     } <span class="keywordflow">else</span> {
00497       unset($vars['pId']);
00498       <span class="comment">// insert mode</span>
00499       $name = $this-&gt;_normalize_name($vars['name'],$vars['version']);
00500       $this-&gt;_create_directory_structure($name);
00501       $first = <span class="keyword">true</span>;
00502       $query = <span class="stringliteral">"insert into $TABLE_NAME("</span>;
00503       foreach(array_keys($vars) as $key) {
00504         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>; 
00505         $query.= <span class="stringliteral">"$key"</span>;
00506         $first = <span class="keyword">false</span>;
00507       } 
00508       $query .=<span class="stringliteral">") values("</span>;
00509       $first = <span class="keyword">true</span>;
00510       foreach(array_values($vars) as $value) {
00511         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>; 
00512         <span class="keywordflow">if</span>(!is_numeric($value)||strstr($value,<span class="charliteral">'.'</span>)) $value=<span class="stringliteral">"'"</span>.$value.<span class="stringliteral">"'"</span>;
00513         $query.= <span class="stringliteral">"$value"</span>;
00514         $first = <span class="keyword">false</span>;
00515       } 
00516       $query .=<span class="stringliteral">")"</span>;
00517       $this-&gt;query($query);
00518       $pId = $this-&gt;getOne(<span class="stringliteral">"select max(pId) from $TABLE_NAME where lastModif=$now"</span>); 
00519       <span class="comment">// Now automatically add a start and end activity </span>
00520       <span class="comment">// unless importing ($create = false)</span>
00521       <span class="keywordflow">if</span>($create) {
00522               $aM= <span class="keyword">new</span> <a class="code" href="classActivityManager.html">ActivityManager</a>($this-&gt;db);
00523               $vars1 = Array(
00524                 'name' =&gt; 'start',
00525                 'description' =&gt; '<span class="keywordflow">default</span> start activity',
00526                 'type' =&gt; 'start',
00527                 'isInteractive' =&gt; <span class="charliteral">'y'</span>,
00528                 'isAutoRouted' =&gt; <span class="charliteral">'y'</span>
00529               );
00530               $vars2 = Array(
00531                 'name' =&gt; 'end',
00532                 'description' =&gt; '<span class="keywordflow">default</span> end activity',
00533                 'type' =&gt; 'end',
00534                 'isInteractive' =&gt; <span class="charliteral">'n'</span>,
00535                 'isAutoRouted' =&gt; <span class="charliteral">'y'</span>
00536               );
00537         
00538               $aM-&gt;replace_activity($pId,0,$vars1);
00539               $aM-&gt;replace_activity($pId,0,$vars2);
00540       }
00541           $msg = sprintf(tra('<a class="code" href="classProcess.html">Process</a> %s has been created'),$vars['name']);     
00542           $this-&gt;notify_all(4,$msg);
00543     }
00544     <span class="comment">// Get the id</span>
00545     <span class="keywordflow">return</span> $pId;
00546    }
00547    
00552    function _get_normalized_name($pId)
00553    {
00554      $info = $this-&gt;get_process($pId);
00555      <span class="keywordflow">return</span> $info['normalized_name'];
00556    }
00557    
00562    function _normalize_name($name, $version)
00563    {
00564      $name = $name.<span class="charliteral">'_'</span>.$version;
00565      $name = str_replace(<span class="stringliteral">" "</span>,<span class="stringliteral">"_"</span>,$name);
00566      $name = preg_replace(<span class="stringliteral">"/[^0-9A-Za-z\_]/"</span>,'',$name);
00567      <span class="keywordflow">return</span> $name;
00568    }
00569    
00574    function _new_version($version,$minor=<span class="keyword">true</span>)
00575    {
00576      $parts = explode(<span class="charliteral">'.'</span>,$version);
00577      <span class="keywordflow">if</span>($minor) {
00578        $parts[count($parts)-1]++;
00579      } <span class="keywordflow">else</span> {
00580        $parts[0]++;
00581      }
00582      <span class="keywordflow">return</span> implode(<span class="charliteral">'.'</span>,$parts);
00583    }
00584    
00589    function _create_directory_structure($name)
00590    {
00591      <span class="comment">// Create in processes a directory with this name</span>
00592      mkdir(GALAXIA_PROCESSES.<span class="stringliteral">"/$name"</span>,0770);
00593      mkdir(GALAXIA_PROCESSES.<span class="stringliteral">"/$name/graph"</span>,0770);
00594      mkdir(GALAXIA_PROCESSES.<span class="stringliteral">"/$name/code"</span>,0770);
00595      mkdir(GALAXIA_PROCESSES.<span class="stringliteral">"/$name/compiled"</span>,0770);
00596      mkdir(GALAXIA_PROCESSES.<span class="stringliteral">"/$name/code/activities"</span>,0770);
00597      mkdir(GALAXIA_PROCESSES.<span class="stringliteral">"/$name/code/templates"</span>,0770);
00598      <span class="keywordflow">if</span> (GALAXIA_TEMPLATES) {
00599        mkdir(GALAXIA_TEMPLATES.<span class="stringliteral">"/$name"</span>,0770);
00600      }
00601      <span class="comment">// Create shared file</span>
00602      $fp = fopen(GALAXIA_PROCESSES.<span class="stringliteral">"/$name/code/shared.php"</span>,<span class="stringliteral">"w"</span>);
00603      fwrite($fp,<span class="charliteral">'&lt;'</span>.<span class="charliteral">'?'</span>.'php'.<span class="stringliteral">"\n"</span>.<span class="charliteral">'?'</span>.<span class="charliteral">'&gt;'</span>);
00604      fclose($fp);
00605    }
00606    
00611    function _remove_directory($dir,$rec=<span class="keyword">false</span>)
00612    {
00613      <span class="comment">// Prevent a disaster</span>
00614          <span class="keywordflow">if</span>(trim($dir) == <span class="charliteral">'/'</span>|| trim($dir)==<span class="charliteral">'.'</span> || trim($dir)=='templates' || trim($dir)=='templates/') <span class="keywordflow">return</span> <span class="keyword">false</span>;
00615      $h = opendir($dir);
00616      <span class="keywordflow">while</span>(($file = readdir($h)) != <span class="keyword">false</span>) {
00617        <span class="keywordflow">if</span>(is_file($dir.<span class="charliteral">'/'</span>.$file)) {
00618          @unlink($dir.<span class="charliteral">'/'</span>.$file);
00619        } <span class="keywordflow">else</span> {
00620          <span class="keywordflow">if</span>($rec &amp;&amp; $file != <span class="charliteral">'.'</span> &amp;&amp; $file != '..') {
00621            $this-&gt;_remove_directory($dir.<span class="charliteral">'/'</span>.$file, <span class="keyword">true</span>);
00622          }
00623        }
00624      }
00625      closedir($h);   
00626      @rmdir($dir);
00627      @unlink($dir);
00628    }
00629 
00630 
00631    function _rec_copy($dir1,$dir2)
00632    {
00633          @mkdir($dir2,0777);
00634      $h = opendir($dir1);
00635      <span class="keywordflow">while</span>(($file = readdir($h)) !== <span class="keyword">false</span>) {
00636        <span class="keywordflow">if</span>(is_file($dir1.<span class="charliteral">'/'</span>.$file)) {
00637          copy($dir1.<span class="charliteral">'/'</span>.$file,$dir2.<span class="charliteral">'/'</span>.$file);
00638        } <span class="keywordflow">else</span> {
00639          <span class="keywordflow">if</span>($file != <span class="charliteral">'.'</span> &amp;&amp; $file != '..') {
00640            $this-&gt;_rec_copy($dir1.<span class="charliteral">'/'</span>.$file, $dir2.<span class="charliteral">'/'</span>.$file);
00641          }
00642        }
00643      }
00644      closedir($h);   
00645    }
00646 
00647 
00648    function _start_element_handler($parser,$element,$attribs)
00649    {
00650      
00651      $aux=Array('name'=&gt;$element,
00652                 'data'=&gt;'',
00653                 'parent' =&gt; $this-&gt;current,
00654                 'children'=&gt;Array());
00655      $i = count($this-&gt;tree);           
00656      $this-&gt;tree[$i] = $aux;
00657 
00658      $this-&gt;tree[$this-&gt;current]['children'][]=$i;
00659      $this-&gt;current=$i;
00660    }
00661 
00662 
00663    function _end_element_handler($parser,$element)
00664    {
00665         <span class="comment">//when a tag ends put text</span>
00666         $this-&gt;tree[$this-&gt;current]['data']=$this-&gt;buffer;           
00667         $this-&gt;buffer='';
00668         $this-&gt;current=$this-&gt;tree[$this-&gt;current]['parent'];
00669    }
00670 
00671 
00672    function _data_handler($parser,$data)
00673    {
00674         $this-&gt;buffer.=$data;
00675    }
00676 
00677 
00678 
00679 }    
00680 
00681 
00682 
00683 ?&gt;
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Sep 30 01:24:12 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
