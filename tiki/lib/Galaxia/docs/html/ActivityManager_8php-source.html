<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Galaxia: ActivityManager.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>ActivityManager.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 include_once(GALAXIA_LIBRARY.'/src/<a class="code" href="classProcessManager.html">ProcessManager</a>/<a class="code" href="classBaseManager.html">BaseManager</a>.php');
00005 
<a name="l00011"></a><a class="code" href="classActivityManager.html">00011</a> <span class="keyword">class </span><a class="code" href="classActivityManager.html">ActivityManager</a> <span class="keyword">extends</span> <a class="code" href="classBaseManager.html">BaseManager</a> {
00012   var $error='';
00013       
<a name="l00018"></a><a class="code" href="classActivityManager.html#a0">00018</a>   function <a class="code" href="classActivityManager.html#a0">ActivityManager</a>($db) {
00019     <span class="keywordflow">if</span>(!$db) {
00020       die(<span class="stringliteral">"Invalid db object passed to activityManager constructor"</span>);  
00021     }
00022     $this-&gt;db = $db;  
00023   }
00024   
00025   function get_error() {
00026     <span class="keywordflow">return</span> $this-&gt;error;
00027   }
00028   
<a name="l00032"></a><a class="code" href="classActivityManager.html#a2">00032</a>   function <a class="code" href="classActivityManager.html#a2">add_activity_role</a>($activityId, $roleId) {
00033     $query = <span class="stringliteral">"replace into `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activity_roles`(`activityId`,`roleId`) values(?,?)"</span>;
00034     $this-&gt;query($query,array($activityId, $roleId));
00035   }
00036   
<a name="l00040"></a><a class="code" href="classActivityManager.html#a3">00040</a>   function <a class="code" href="classActivityManager.html#a3">get_activity_roles</a>($activityId) {
00041     $query = <span class="stringliteral">"select activityId,roles.roleId,roles.name from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activity_roles gar, "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"roles roles where roles.roleId = gar.roleId and activityId=$activityId"</span>;
00042         $result = $this-&gt;query($query);
00043     $ret = Array();
00044     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00045       $ret[] = $res;
00046     }
00047     <span class="keywordflow">return</span> $ret;
00048   }
00049   
<a name="l00053"></a><a class="code" href="classActivityManager.html#a4">00053</a>   function <a class="code" href="classActivityManager.html#a4">remove_activity_role</a>($activityId, $roleId)
00054   {
00055     $query = <span class="stringliteral">"delete from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activity_roles where activityId=$activityId and roleId=$roleId"</span>;
00056     $this-&gt;query($query);
00057   }
00058   
<a name="l00062"></a><a class="code" href="classActivityManager.html#a5">00062</a>   function <a class="code" href="classActivityManager.html#a5">transition_exists</a>($pid,$actFromId,$actToId)
00063   {
00064     <span class="keywordflow">return</span>($this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"transitions where pId=$pid and actFromId=$actFromId and actToId=$actToId"</span>));
00065   }
00066   
<a name="l00070"></a><a class="code" href="classActivityManager.html#a6">00070</a>   function <a class="code" href="classActivityManager.html#a6">add_transition</a>($pId, $actFromId, $actToId)
00071   {
00072     <span class="comment">// No circular transitions allowed</span>
00073     <span class="keywordflow">if</span>($actFromId == $actToId) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00074     
00075     <span class="comment">// Rule: if act is not spl-x or spl-a it can't have more than</span>
00076     <span class="comment">// 1 outbound transition.</span>
00077     $a1 = $this-&gt;get_activity($pId, $actFromId);
00078     $a2 = $this-&gt;get_activity($pId, $actToId);
00079     <span class="keywordflow">if</span>(!$a1 || !$a2) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00080     <span class="keywordflow">if</span>($a1['type'] != '<span class="keywordflow">switch</span>' &amp;&amp; $a1['type'] != 'split') {
00081       <span class="keywordflow">if</span>($this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"transitions where actFromId=$actFromId"</span>)) {
00082         $this-&gt;error = tra('Cannot add transition only split activities can have more than one outbound transition');
00083         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00084       }
00085     }
00086     
00087     <span class="comment">// Rule: if act is standalone no transitions allowed</span>
00088     <span class="keywordflow">if</span>($a1['type'] == 'standalone' || $a2['type']=='standalone') <span class="keywordflow">return</span> <span class="keyword">false</span>;
00089     <span class="comment">// No inbound to start</span>
00090     <span class="keywordflow">if</span>($a2['type'] == 'start') <span class="keywordflow">return</span> <span class="keyword">false</span>;
00091     <span class="comment">// No outbound from end</span>
00092     <span class="keywordflow">if</span>($a1['type'] == 'end') <span class="keywordflow">return</span> <span class="keyword">false</span>;
00093      
00094     
00095     $query = <span class="stringliteral">"replace into "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"transitions(pId,actFromId,actToId)</span>
00096 <span class="stringliteral">              values($pId,$actFromId,$actToId)"</span>;
00097     $this-&gt;query($query);
00098     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00099   }
00100   
<a name="l00104"></a><a class="code" href="classActivityManager.html#a7">00104</a>   function <a class="code" href="classActivityManager.html#a7">remove_transition</a>($actFromId, $actToId)
00105   {
00106     $query = <span class="stringliteral">"delete from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"transitions where actFromId=$actFromId and actToId=$actToId"</span>;
00107     $this-&gt;query($query);
00108     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00109   }
00110   
<a name="l00114"></a><a class="code" href="classActivityManager.html#a8">00114</a>   function <a class="code" href="classActivityManager.html#a8">remove_activity_transitions</a>($pId, $aid)
00115   {
00116     $query = <span class="stringliteral">"delete from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"transitions where pId=$pId and (actFromId=$aid or actToId=$aid)"</span>;
00117     $this-&gt;query($query);
00118   }
00119   
00120   
<a name="l00124"></a><a class="code" href="classActivityManager.html#a9">00124</a>   function <a class="code" href="classActivityManager.html#a9">get_process_transitions</a>($pId,$actid=0)
00125   {
00126     <span class="keywordflow">if</span>(!$actid) {
00127         $query = <span class="stringliteral">"select a1.name as actFromName, a2.name as actToName, actFromId, actToId from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"transitions gt,"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities a1, "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities a2 where gt.actFromId = a1.activityId and gt.actToId = a2.activityId and gt.pId = $pId"</span>;
00128     } <span class="keywordflow">else</span> {
00129         $query = <span class="stringliteral">"select a1.name as actFromName, a2.name as actToName, actFromId, actToId from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"transitions gt,"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities a1, "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities a2 where gt.actFromId = a1.activityId and gt.actToId = a2.activityId and gt.pId = $pId and (actFromId = $actid)"</span>;
00130     }
00131     $result = $this-&gt;query($query);
00132     $ret = Array();
00133     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00134       $ret[] = $res;
00135     }
00136     <span class="keywordflow">return</span> $ret;
00137   }
00138   
<a name="l00142"></a><a class="code" href="classActivityManager.html#a10">00142</a>   function <a class="code" href="classActivityManager.html#a10">activity_is_auto_routed</a>($actid)
00143   {
00144     <span class="keywordflow">return</span>($this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities where activityId=$actid and isAutoRouted='y'"</span>));
00145   }
00146   
<a name="l00151"></a><a class="code" href="classActivityManager.html#a11">00151</a>   function <a class="code" href="classActivityManager.html#a11">get_process_activities</a>($pId)
00152   {
00153        $query = <span class="stringliteral">"select * from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities where pId=$pId"</span>;
00154     $result = $this-&gt;query($query);
00155     $ret = Array();
00156     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00157       $ret[] = $res;
00158     }
00159     <span class="keywordflow">return</span> $ret;
00160   }
00161 
00165   <span class="comment">//\todo build the real graph</span>
<a name="l00166"></a><a class="code" href="classActivityManager.html#a12">00166</a>   function <a class="code" href="classActivityManager.html#a12">build_process_graph</a>($pId)
00167   {
00168     $attributes = Array(
00169     
00170     );
00171     $graph = <span class="keyword">new</span> Process_GraphViz(<span class="keyword">true</span>,$attributes);
00172     $pm = <span class="keyword">new</span> <a class="code" href="classProcessManager.html">ProcessManager</a>($this-&gt;db);
00173     $name = $pm-&gt;_get_normalized_name($pId);
00174     $graph-&gt;set_pid($name);
00175     
00176     <span class="comment">// Nodes are process activities so get</span>
00177     <span class="comment">// the activities and add nodes as needed</span>
00178     $nodes = $this-&gt;get_process_activities($pId);
00179     
00180     foreach($nodes as $node)
00181     {
00182       <span class="keywordflow">if</span>($node['isInteractive']==<span class="charliteral">'y'</span>) {
00183         $color='blue';
00184       } <span class="keywordflow">else</span> {
00185         $color='black';
00186       }
00187       $auto[$node['name']] = $node['isAutoRouted'];
00188       $graph-&gt;addNode($node['name'],array('URL'=&gt;<span class="stringliteral">"foourl?activityId="</span>.$node['activityId'],
00189                                       'label'=&gt;$node['name'],
00190                                       'shape' =&gt; $this-&gt;_get_activity_shape($node['type']),
00191                                       'color' =&gt; $color
00192 
00193                                       )
00194                      );    
00195     }
00196     
00197     <span class="comment">// Now add edges, edges are transitions,</span>
00198     <span class="comment">// get the transitions and add the edges</span>
00199     $edges = $this-&gt;get_process_transitions($pId);
00200     foreach($edges as $edge)
00201     {
00202       <span class="keywordflow">if</span>($auto[$edge['actFromName']] == <span class="charliteral">'y'</span>) {
00203         $color = 'red';
00204       } <span class="keywordflow">else</span> {
00205         $color = 'black';
00206       }
00207         $graph-&gt;addEdge(array($edge['actFromName'] =&gt; $edge['actToName']), array('color'=&gt;$color));    
00208     }
00209     
00210     
00211     <span class="comment">// Save the map image and the image graph</span>
00212     $graph-&gt;image_and_map();
00213     unset($graph);
00214     <span class="keywordflow">return</span> <span class="keyword">true</span>;   
00215   }
00216   
00217   
<a name="l00230"></a><a class="code" href="classActivityManager.html#a13">00230</a>   function <a class="code" href="classActivityManager.html#a13">validate_process_activities</a>($pId)
00231   {
00232     $errors = Array();
00233     <span class="comment">// Pre rule no cricular activities</span>
00234     $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"transitions where pId=$pId and actFromId=actToId"</span>);
00235     <span class="keywordflow">if</span>($cant) {
00236       $errors[] = tra('Circular reference found some activty has a transition leading to itself');
00237     }
00238 
00239     <span class="comment">// Rule 1 must have exactly one start and end activity</span>
00240     $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities where pId=$pId and type='start'"</span>);
00241     <span class="keywordflow">if</span>($cant &lt; 1) {
00242       $errors[] = tra('<a class="code" href="classProcess.html">Process</a> does not have a start activity');
00243     }
00244     $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities where pId=$pId and type='end'"</span>);
00245     <span class="keywordflow">if</span>($cant != 1) {
00246       $errors[] = tra('<a class="code" href="classProcess.html">Process</a> does not have exactly one end activity');
00247     }
00248     
00249     <span class="comment">// Rule 2 end must be reachable from start</span>
00250     $nodes = Array();
00251     $endId = $this-&gt;getOne(<span class="stringliteral">"select activityId from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities where pId=$pId and type='end'"</span>);
00252     $aux['id']=$endId;
00253     $aux['visited']=<span class="keyword">false</span>;
00254     $nodes[] = $aux;
00255     
00256     $startId = $this-&gt;getOne(<span class="stringliteral">"select activityId from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities where pId=$pId and type='start'"</span>);
00257     $start_node['id']=$startId;
00258     $start_node['visited']=<span class="keyword">true</span>;    
00259     
00260     <span class="keywordflow">while</span>($this-&gt;_list_has_unvisited_nodes($nodes) &amp;&amp; !$this-&gt;_node_in_list($start_node,$nodes)) {
00261       <span class="keywordflow">for</span>($i=0;$i&lt;count($nodes);$i++) {
00262         $node=&amp;$nodes[$i];
00263         <span class="keywordflow">if</span>(!$node['visited']) {
00264           $node['visited']=<span class="keyword">true</span>;          
00265           $query = <span class="stringliteral">"select actFromId from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"transitions where actToId="</span>.$node['id'];
00266           $result = $this-&gt;query($query);
00267           $ret = Array();
00268           <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00269             $aux['id'] = $res['actFromId'];
00270             $aux['visited']=<span class="keyword">false</span>;
00271             <span class="keywordflow">if</span>(!$this-&gt;_node_in_list($aux,$nodes)) {
00272               $nodes[] = $aux;
00273             }
00274           }
00275         }
00276       }
00277     }
00278     
00279     <span class="keywordflow">if</span>(!$this-&gt;_node_in_list($start_node,$nodes)) {
00280       <span class="comment">// Start node is NOT reachable from the end node</span>
00281       $errors[] = tra('<a class="code" href="classEnd.html">End</a> activity is not reachable from start activty');
00282     }
00283     
00284     <span class="comment">//Rule 3: interactive activities must have a role</span>
00285     <span class="comment">//assigned.</span>
00286     <span class="comment">//Rule 5: standalone activities can't have transitions</span>
00287     $query = <span class="stringliteral">"select * from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities where pId = $pId"</span>;
00288     $result = $this-&gt;query($query);
00289     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00290       $aid = $res['activityId'];
00291       <span class="keywordflow">if</span>($res['isInteractive'] == <span class="charliteral">'y'</span>) {
00292           $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activity_roles where activityId="</span>.$res['activityId']);
00293           <span class="keywordflow">if</span>(!$cant) {
00294             $errors[] = tra('<a class="code" href="classActivity.html">Activity</a>').': '.$res['name'].tra(' is interactive but has no role assigned');
00295           }
00296       } <span class="keywordflow">else</span> {
00297         <span class="keywordflow">if</span>( $res['type'] != 'end' &amp;&amp; $res['isAutoRouted'] == <span class="charliteral">'n'</span>) {
00298           $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activity_roles where activityId="</span>.$res['activityId']);
00299             <span class="keywordflow">if</span>(!$cant) {
00300               $errors[] = tra('<a class="code" href="classActivity.html">Activity</a>').': '.$res['name'].tra(' is non-interactive and non-autorouted but has no role assigned');
00301             }
00302         }
00303       }
00304       <span class="keywordflow">if</span>($res['type']=='standalone') {
00305         <span class="keywordflow">if</span>($this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"transitions where actFromId=$aid or actToId=$aid"</span>)) {
00306            $errors[] = tra('<a class="code" href="classActivity.html">Activity</a>').': '.$res['name'].tra(' is standalone but has transitions');
00307         }
00308       }
00309 
00310     }
00311     
00312     
00313     <span class="comment">//Rule4: roles should be mapped</span>
00314     $query = <span class="stringliteral">"select * from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"roles where pId = $pId"</span>;
00315     $result = $this-&gt;query($query);
00316     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {      
00317         $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"user_roles where roleId="</span>.$res['roleId']);
00318         <span class="keywordflow">if</span>(!$cant) {
00319           $errors[] = tra('<a class="code" href="classRole.html">Role</a>').': '.$res['name'].tra(' is not mapped');
00320         }        
00321     }
00322     
00323     
00324     <span class="comment">// End of rules</span>
00325 
00326     <span class="comment">// Validate process sources</span>
00327     $serrors=$this-&gt;validate_process_sources($pId);
00328     $errors = array_merge($errors,$serrors);
00329     
00330     $this-&gt;error = $errors;
00331     
00332     
00333     
00334     $isValid = (count($errors)==0) ? <span class="charliteral">'y'</span> : <span class="charliteral">'n'</span>;
00335 
00336     $query = <span class="stringliteral">"update "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"processes set isValid='$isValid' where pId=$pId"</span>;
00337     $this-&gt;query($query);
00338     
00339     $this-&gt;_label_nodes($pId);    
00340     
00341     <span class="keywordflow">return</span> ($isValid==<span class="charliteral">'y'</span>);
00342     
00343     
00344   }
00345   
<a name="l00354"></a><a class="code" href="classActivityManager.html#a14">00354</a>   function <a class="code" href="classActivityManager.html#a14">validate_process_sources</a>($pid)
00355   {
00356     $errors=Array();
00357     $procname= $this-&gt;getOne(<span class="stringliteral">"select normalized_name from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"processes where pId=$pid"</span>);
00358     
00359     $query = <span class="stringliteral">"select * from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities where pId=$pid"</span>;
00360     $result = $this-&gt;query($query);
00361     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {          
00362       $actname = $res['normalized_name'];
00363       $source = GALAXIA_PROCESSES.<span class="stringliteral">"/$procname/code/activities/$actname"</span>.'.php';
00364       <span class="keywordflow">if</span> (!file_exists($source)) {
00365           <span class="keywordflow">continue</span>;
00366       }
00367       $fp = fopen($source,<span class="charliteral">'r'</span>);
00368       $data='';
00369       <span class="keywordflow">while</span>(!feof($fp)) {
00370         $data.=fread($fp,8192);
00371       }
00372       fclose($fp);
00373       <span class="keywordflow">if</span>($res['type']=='standalone') {
00374           <span class="keywordflow">if</span>(strstr($data,'$instance')) {
00375             $errors[] = tra('<a class="code" href="classActivity.html">Activity</a> '.$res['name'].' is standalone and is <span class="keyword">using</span> the $instance object');
00376           }    
00377       } <span class="keywordflow">else</span> {
00378         <span class="keywordflow">if</span>($res['isInteractive']==<span class="charliteral">'y'</span>) {
00379           <span class="keywordflow">if</span>(!strstr($data,'$instance-&gt;complete()')) {
00380             $errors[] = tra('<a class="code" href="classActivity.html">Activity</a> '.$res['name'].' is interactive so it must use the $instance-&gt;complete() method');
00381           }
00382         } <span class="keywordflow">else</span> {
00383           <span class="keywordflow">if</span>(strstr($data,'$instance-&gt;complete()')) {
00384             $errors[] = tra('<a class="code" href="classActivity.html">Activity</a> '.$res['name'].' is non-interactive so it must not use the $instance-&gt;complete() method');
00385           }
00386         }
00387         <span class="keywordflow">if</span>($res['type']=='<span class="keywordflow">switch</span>') {
00388           <span class="keywordflow">if</span>(!strstr($data,'$instance-&gt;setNextActivity(')) { 
00389             $errors[] = tra('<a class="code" href="classActivity.html">Activity</a> '.$res['name'].' is <span class="keywordflow">switch</span> so it must use $instance-&gt;setNextActivity($actname) method');          
00390           }
00391         }
00392       }    
00393     }
00394     <span class="keywordflow">return</span> $errors;
00395   }
00396   
<a name="l00400"></a><a class="code" href="classActivityManager.html#a15">00400</a>   function <a class="code" href="classActivityManager.html#a15">activity_name_exists</a>($pId,$name)
00401   {
00402     $name = addslashes($this-&gt;_normalize_name($name));
00403     <span class="keywordflow">return</span> $this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities where pId=$pId and normalized_name='$name'"</span>);
00404   }
00405   
00406   
<a name="l00410"></a><a class="code" href="classActivityManager.html#a16">00410</a>   function <a class="code" href="classActivityManager.html#a16">get_activity</a>($pId, $activityId)
00411   {
00412       $query = <span class="stringliteral">"select * from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities where pId=$pId and activityId=$activityId"</span>;
00413     $result = $this-&gt;query($query);
00414     $res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC);
00415     <span class="keywordflow">return</span> $res;
00416   }
00417   
<a name="l00421"></a><a class="code" href="classActivityManager.html#a17">00421</a>   function <a class="code" href="classActivityManager.html#a17">list_activities</a>($pId,$offset,$maxRecords,$sort_mode,$find,$where='')
00422   {
00423     $sort_mode = str_replace(<span class="stringliteral">"_"</span>,<span class="stringliteral">" "</span>,$sort_mode);
00424     <span class="keywordflow">if</span>($find) {
00425     $findesc = $this-&gt;qstr(<span class="charliteral">'%'</span>.$find.<span class="charliteral">'%'</span>);
00426       $mid=<span class="stringliteral">" where pId=$pId and ((name like $findesc) or (description like $findesc))"</span>;
00427     } <span class="keywordflow">else</span> {
00428       $mid=<span class="stringliteral">" where pId=$pId "</span>;
00429     }
00430     <span class="keywordflow">if</span>($where) {
00431       $mid.= <span class="stringliteral">" and ($where) "</span>;
00432     }
00433     $query = <span class="stringliteral">"select * from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities $mid order by $sort_mode limit $offset,$maxRecords"</span>;
00434     $query_cant = <span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities $mid"</span>;
00435     $result = $this-&gt;query($query);
00436     $cant = $this-&gt;getOne($query_cant);
00437     $ret = Array();
00438     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00439       $res['roles'] = $this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activity_roles where activityId="</span>.$res['activityId']);
00440       $ret[] = $res;
00441     }
00442     $retval = Array();
00443     $retval[<span class="stringliteral">"data"</span>] = $ret;
00444     $retval[<span class="stringliteral">"cant"</span>] = $cant;
00445     <span class="keywordflow">return</span> $retval;
00446   }
00447   
00448   
00449   
<a name="l00453"></a><a class="code" href="classActivityManager.html#a18">00453</a>   function <a class="code" href="classActivityManager.html#a18">remove_activity</a>($pId, $activityId)
00454   {
00455     $pm = <span class="keyword">new</span> <a class="code" href="classProcessManager.html">ProcessManager</a>($this-&gt;db);
00456     $proc_info = $pm-&gt;get_process($pId);
00457     $actname = $this-&gt;_get_normalized_name($activityId);
00458     $query = <span class="stringliteral">"delete from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities where pId=$pId and activityId=$activityId"</span>;
00459     $this-&gt;query($query);
00460     $query = <span class="stringliteral">"select actFromId,actToId from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"transitions where actFromId=$activityId or actToId=$activityId"</span>;
00461     $result = $this-&gt;query($query);
00462     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00463       $this-&gt;remove_transition($res['actFromId'], $res['actToId']);
00464     }
00465     $query = <span class="stringliteral">"delete from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activity_roles where activityId=$activityId"</span>;
00466     $this-&gt;query($query);
00467     <span class="comment">// And we have to remove the user and compiled files</span>
00468     <span class="comment">// for this activity</span>
00469     $procname = $proc_info['normalized_name'];
00470     unlink(GALAXIA_PROCESSES.<span class="stringliteral">"/$procname/code/activities/$actname"</span>.'.php'); 
00471     <span class="keywordflow">if</span> (file_exists(GALAXIA_PROCESSES.<span class="stringliteral">"/$procname/code/templates/$actname"</span>.'.tpl')) {
00472       @unlink(GALAXIA_PROCESSES.<span class="stringliteral">"/$procname/code/templates/$actname"</span>.'.tpl'); 
00473     }
00474     unlink(GALAXIA_PROCESSES.<span class="stringliteral">"/$procname/compiled/$actname"</span>.'.php'); 
00475     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00476   }
00477   
<a name="l00484"></a><a class="code" href="classActivityManager.html#a19">00484</a>   function <a class="code" href="classActivityManager.html#a19">replace_activity</a>($pId, $activityId, $vars)
00485   {
00486     $TABLE_NAME = '<span class="stringliteral">".GALAXIA_TABLE_PREFIX."</span>activities';
00487     $now = date(<span class="stringliteral">"U"</span>);
00488     $vars['lastModif']=$now;
00489     $vars['pId']=$pId;
00490     $vars['normalized_name'] = $this-&gt;_normalize_name($vars['name']);    
00491 
00492     $pm = <span class="keyword">new</span> <a class="code" href="classProcessManager.html">ProcessManager</a>($this-&gt;db);
00493     $proc_info = $pm-&gt;get_process($pId);
00494     
00495     
00496     foreach($vars as $key=&gt;$value)
00497     {
00498       $vars[$key]=addslashes($value);
00499     }
00500   
00501     <span class="keywordflow">if</span>($activityId) {
00502       $oldname = $this-&gt;_get_normalized_name($activityId);
00503       <span class="comment">// update mode</span>
00504       $first = <span class="keyword">true</span>;
00505       $query =<span class="stringliteral">"update $TABLE_NAME set"</span>;
00506       foreach($vars as $key=&gt;$value) {
00507         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>;
00508         <span class="keywordflow">if</span>(!is_numeric($value)) $value=<span class="stringliteral">"'"</span>.$value.<span class="stringliteral">"'"</span>;
00509         $query.= <span class="stringliteral">" $key=$value "</span>;
00510         $first = <span class="keyword">false</span>;
00511       }
00512       $query .= <span class="stringliteral">" where pId=$pId and activityId=$activityId "</span>;
00513       $this-&gt;query($query);
00514       
00515       $newname = $vars['normalized_name'];
00516       <span class="comment">// if the activity is changing name then we</span>
00517       <span class="comment">// should rename the user_file for the activity</span>
00518       <span class="comment">// remove the old compiled file and recompile</span>
00519       <span class="comment">// the activity</span>
00520       
00521       $user_file_old = GALAXIA_PROCESSES.<span class="charliteral">'/'</span>.$proc_info['normalized_name'].'/code/activities/'.$oldname.'.php';
00522       $user_file_new = GALAXIA_PROCESSES.<span class="charliteral">'/'</span>.$proc_info['normalized_name'].'/code/activities/'.$newname.'.php';
00523       rename($user_file_old, $user_file_new);
00524 
00525       $user_file_old = GALAXIA_PROCESSES.<span class="charliteral">'/'</span>.$proc_info['normalized_name'].'/code/templates/'.$oldname.'.tpl';
00526       $user_file_new = GALAXIA_PROCESSES.<span class="charliteral">'/'</span>.$proc_info['normalized_name'].'/code/templates/'.$newname.'.tpl';
00527       <span class="keywordflow">if</span> ($user_file_old != $user_file_new) {
00528         @rename($user_file_old, $user_file_new);
00529       }
00530 
00531       
00532       $compiled_file = GALAXIA_PROCESSES.<span class="charliteral">'/'</span>.$proc_info['normalized_name'].'/compiled/'.$oldname.'.php';    
00533       unlink($compiled_file);
00534       $this-&gt;compile_activity($pId,$activityId);
00535       
00536       
00537     } <span class="keywordflow">else</span> {
00538       
00539       <span class="comment">// When inserting activity names can't be duplicated</span>
00540       <span class="keywordflow">if</span>($this-&gt;activity_name_exists($pId, $vars['name'])) {
00541           <span class="keywordflow">return</span> <span class="keyword">false</span>;
00542       }
00543       unset($vars['activityId']);
00544       <span class="comment">// insert mode</span>
00545       $first = <span class="keyword">true</span>;
00546       $query = <span class="stringliteral">"insert into $TABLE_NAME("</span>;
00547       foreach(array_keys($vars) as $key) {
00548         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>; 
00549         $query.= <span class="stringliteral">"$key"</span>;
00550         $first = <span class="keyword">false</span>;
00551       } 
00552       $query .=<span class="stringliteral">") values("</span>;
00553       $first = <span class="keyword">true</span>;
00554       foreach(array_values($vars) as $value) {
00555         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>; 
00556         <span class="keywordflow">if</span>(!is_numeric($value)) $value=<span class="stringliteral">"'"</span>.$value.<span class="stringliteral">"'"</span>;
00557         $query.= <span class="stringliteral">"$value"</span>;
00558         $first = <span class="keyword">false</span>;
00559       } 
00560       $query .=<span class="stringliteral">")"</span>;
00561       $this-&gt;query($query);
00562       $activityId = $this-&gt;getOne(<span class="stringliteral">"select max(activityId) from $TABLE_NAME where pId=$pId and lastModif=$now"</span>); 
00563       $ret = $activityId;
00564       <span class="keywordflow">if</span>(!$activityId) {
00565          print(<span class="stringliteral">"select max(activityId) from $TABLE_NAME where pId=$pId and lastModif=$now"</span>);
00566          die;      
00567       }
00568       <span class="comment">// Should create the code file</span>
00569       $procname = $proc_info[<span class="stringliteral">"normalized_name"</span>];
00570         $fw = fopen(GALAXIA_PROCESSES.<span class="stringliteral">"/$procname/code/activities/"</span>.$vars['normalized_name'].'.php<span class="charliteral">','</span>w');
00571         fwrite($fw,<span class="charliteral">'&lt;'</span>.<span class="charliteral">'?'</span>.'php'.<span class="stringliteral">"\n"</span>.<span class="charliteral">'?'</span>.<span class="charliteral">'&gt;'</span>);
00572         fclose($fw);
00573         
00574          <span class="keywordflow">if</span>($vars['isInteractive']==<span class="charliteral">'y'</span>) {
00575             $fw = fopen(GALAXIA_PROCESSES.<span class="stringliteral">"/$procname/code/templates/"</span>.$vars['normalized_name'].'.tpl<span class="charliteral">','</span>w');
00576             <span class="keywordflow">if</span> (defined('GALAXIA_TEMPLATE_HEADER') &amp;&amp; GALAXIA_TEMPLATE_HEADER) {
00577               fwrite($fw,GALAXIA_TEMPLATE_HEADER . <span class="stringliteral">"\n"</span>);
00578             }
00579             fclose($fw);
00580         }
00581 
00582          $this-&gt;compile_activity($pId,$activityId);
00583       
00584     }
00585     <span class="comment">// Get the id</span>
00586     <span class="keywordflow">return</span> $activityId;
00587   }
00588   
<a name="l00592"></a><a class="code" href="classActivityManager.html#a20">00592</a>   function <a class="code" href="classActivityManager.html#a20">set_interactivity</a>($pId, $actid, $value)
00593   {
00594     $query = <span class="stringliteral">"update "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities set isInteractive='$value' where pId=$pId and activityId=$actid"</span>;
00595     $this-&gt;query($query);
00596     <span class="comment">// If template does not exist then create template</span>
00597     $this-&gt;compile_activity($pId,$actid);
00598   }
00599 
<a name="l00603"></a><a class="code" href="classActivityManager.html#a21">00603</a>   function <a class="code" href="classActivityManager.html#a21">set_autorouting</a>($pId, $actid, $value)
00604   {
00605     $query = <span class="stringliteral">"update "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities set isAutoRouted='$value' where pId=$pId and activityId=$actid"</span>;
00606     $this-&gt;query($query);
00607   }
00608 
00609   
<a name="l00613"></a><a class="code" href="classActivityManager.html#a22">00613</a>   function <a class="code" href="classActivityManager.html#a22">compile_activity</a>($pId, $activityId)
00614   {
00615     $act_info = $this-&gt;get_activity($pId,$activityId);
00616        $actname = $act_info['normalized_name'];
00617     $pm = <span class="keyword">new</span> <a class="code" href="classProcessManager.html">ProcessManager</a>($this-&gt;db);
00618     $proc_info = $pm-&gt;get_process($pId);
00619     $compiled_file = GALAXIA_PROCESSES.<span class="charliteral">'/'</span>.$proc_info['normalized_name'].'/compiled/'.$act_info['normalized_name'].'.php';    
00620     $template_file = GALAXIA_PROCESSES.<span class="charliteral">'/'</span>.$proc_info['normalized_name'].'/code/templates/'.$actname.'.tpl';    
00621     $user_file = GALAXIA_PROCESSES.<span class="charliteral">'/'</span>.$proc_info['normalized_name'].'/code/activities/'.$actname.'.php';
00622     $pre_file = GALAXIA_LIBRARY.'/compiler/'.$act_info['type'].'_pre.php';
00623     $pos_file = GALAXIA_LIBRARY.'/compiler/'.$act_info['type'].'_pos.php';
00624     $fw = fopen($compiled_file,<span class="stringliteral">"wb"</span>);
00625     
00626     <span class="comment">// First of all add an include to to the shared code</span>
00627     $shared_file = GALAXIA_PROCESSES.<span class="charliteral">'/'</span>.$proc_info['normalized_name'].'/code/shared.php';    
00628     
00629     fwrite($fw, <span class="charliteral">'&lt;'</span>.<span class="stringliteral">"?php include_once('$shared_file'); ?"</span>.<span class="charliteral">'&gt;'</span>.<span class="stringliteral">"\n"</span>);
00630     
00631     <span class="comment">// Before pre shared</span>
00632     $fp = fopen(GALAXIA_LIBRARY.'/compiler/_shared_pre.php',<span class="stringliteral">"rb"</span>);
00633     <span class="keywordflow">while</span> (!feof($fp)) {
00634         $data = fread($fp, 4096);
00635         fwrite($fw,$data);
00636     }
00637     fclose($fp);
00638 
00639     <span class="comment">// Now get pre and pos files for the activity</span>
00640     $fp = fopen($pre_file,<span class="stringliteral">"rb"</span>);
00641     <span class="keywordflow">while</span> (!feof($fp)) {
00642         $data = fread($fp, 4096);
00643         fwrite($fw,$data);
00644     }
00645     fclose($fp);
00646     
00647     <span class="comment">// Get the user data for the activity </span>
00648     $fp = fopen($user_file,<span class="stringliteral">"rb"</span>);    
00649     <span class="keywordflow">while</span> (!feof($fp)) {
00650         $data = fread($fp, 4096);
00651         fwrite($fw,$data);
00652     }
00653     fclose($fp);
00654 
00655     <span class="comment">// Get pos and write</span>
00656     $fp = fopen($pos_file,<span class="stringliteral">"rb"</span>);
00657     <span class="keywordflow">while</span> (!feof($fp)) {
00658         $data = fread($fp, 4096);
00659         fwrite($fw,$data);
00660     }
00661     fclose($fp);
00662 
00663     <span class="comment">// Shared pos</span>
00664     $fp = fopen(GALAXIA_LIBRARY.'/compiler/_shared_pos.php',<span class="stringliteral">"rb"</span>);
00665     <span class="keywordflow">while</span> (!feof($fp)) {
00666         $data = fread($fp, 4096);
00667         fwrite($fw,$data);
00668     }
00669     fclose($fp);
00670 
00671     fclose($fw);
00672 
00673     <span class="comment">//Copy the templates</span>
00674     
00675     <span class="keywordflow">if</span>($act_info['isInteractive']==<span class="charliteral">'y'</span> &amp;&amp; !file_exists($template_file)) {
00676       $fw = fopen($template_file,<span class="charliteral">'w'</span>);
00677       <span class="keywordflow">if</span> (defined('GALAXIA_TEMPLATE_HEADER') &amp;&amp; GALAXIA_TEMPLATE_HEADER) {
00678         fwrite($fw,GALAXIA_TEMPLATE_HEADER . <span class="stringliteral">"\n"</span>);
00679       }
00680       fclose($fw);
00681     }
00682     <span class="keywordflow">if</span>($act_info['isInteractive']!=<span class="charliteral">'y'</span> &amp;&amp; file_exists($template_file)) {
00683       @unlink($template_file);
00684       <span class="keywordflow">if</span> (GALAXIA_TEMPLATES &amp;&amp; file_exists(GALAXIA_TEMPLATES.<span class="charliteral">'/'</span>.$proc_info['normalized_name'].<span class="stringliteral">"/$actname.tpl"</span>)) {
00685         @unlink(GALAXIA_TEMPLATES.<span class="charliteral">'/'</span>.$proc_info['normalized_name'].<span class="stringliteral">"/$actname.tpl"</span>);
00686       }
00687     }
00688     <span class="keywordflow">if</span> (GALAXIA_TEMPLATES &amp;&amp; file_exists($template_file)) {
00689       @copy($template_file,GALAXIA_TEMPLATES.<span class="charliteral">'/'</span>.$proc_info['normalized_name'].<span class="stringliteral">"/$actname.tpl"</span>);
00690     }
00691   }
00692   
00697   function _get_activity_id_by_name($pid,$name)
00698   {
00699     $name = addslashes($name);
00700     <span class="keywordflow">if</span>($this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities where pId=$pid and name='$name'"</span>)) {
00701       <span class="keywordflow">return</span>($this-&gt;getOne(<span class="stringliteral">"select activityId from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities where pId=$pid and name='$name'"</span>));    
00702     } <span class="keywordflow">else</span> {
00703       <span class="keywordflow">return</span> '';
00704     }
00705   }
00706   
00710   function _get_activity_shape($type)
00711   {
00712     <span class="keywordflow">switch</span>($type) {
00713       <span class="keywordflow">case</span> <span class="stringliteral">"start"</span>: 
00714           <span class="keywordflow">return</span> <span class="stringliteral">"circle"</span>;
00715       <span class="keywordflow">case</span> <span class="stringliteral">"end"</span>:
00716           <span class="keywordflow">return</span> <span class="stringliteral">"doublecircle"</span>;
00717       <span class="keywordflow">case</span> <span class="stringliteral">"activity"</span>:
00718           <span class="keywordflow">return</span> <span class="stringliteral">"box"</span>;
00719       <span class="keywordflow">case</span> <span class="stringliteral">"split"</span>:
00720           <span class="keywordflow">return</span> <span class="stringliteral">"triangle"</span>;
00721       <span class="keywordflow">case</span> <span class="stringliteral">"switch"</span>:
00722         <span class="keywordflow">return</span> <span class="stringliteral">"diamond"</span>;
00723       <span class="keywordflow">case</span> <span class="stringliteral">"join"</span>:
00724           <span class="keywordflow">return</span> <span class="stringliteral">"invtriangle"</span>;
00725       <span class="keywordflow">case</span> <span class="stringliteral">"standalone"</span>:
00726           <span class="keywordflow">return</span> <span class="stringliteral">"hexagon"</span>;
00727       <span class="keywordflow">default</span>:
00728           <span class="keywordflow">return</span> <span class="stringliteral">"egg"</span>;            
00729       
00730     }
00731 
00732   }
00733 
00734   
00739   function _list_has_unvisited_nodes($list) 
00740   {
00741     foreach($list as $node) {
00742       <span class="keywordflow">if</span>(!$node['visited']) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00743     }
00744     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00745   }
00746   
00751   function _node_in_list($node,$list)
00752   {
00753     foreach($list as $a_node) {
00754       <span class="keywordflow">if</span>($node['id'] == $a_node['id']) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00755     }
00756     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00757   }
00758   
00763   function _normalize_name($name)
00764   {
00765     $name = str_replace(<span class="stringliteral">" "</span>,<span class="stringliteral">"_"</span>,$name);
00766     $name = preg_replace(<span class="stringliteral">"/[^A-Za-z_]/"</span>,'',$name);
00767     <span class="keywordflow">return</span> $name;
00768   }
00769   
00774   function _get_normalized_name($activityId)
00775   {
00776     <span class="keywordflow">return</span> $this-&gt;getOne(<span class="stringliteral">"select normalized_name from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities where activityId=$activityId"</span>);
00777   }
00778   
00783   function _label_nodes($pId)
00784   {
00785     
00786     
00788     $nodes = Array();
00789     <span class="comment">// the end activity id</span>
00790     $endId = $this-&gt;getOne(<span class="stringliteral">"select activityId from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities where pId=$pId and type='end'"</span>);
00791     <span class="comment">// and the number of total nodes (=activities)</span>
00792     $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities where pId=$pId"</span>);
00793     $nodes[] = $endId;
00794     $label = $cant;
00795     $num = $cant;
00796     
00797     $query = <span class="stringliteral">"update "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities set flowNum=$cant+1 where pId=$pId"</span>;
00798     $this-&gt;query($query);
00799     
00800     <span class="keywordflow">while</span>(count($nodes)) {
00801       $newnodes = Array();
00802       foreach($nodes as $node) {
00803         $query = <span class="stringliteral">"update "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities set flowNum=$num where activityId=$node"</span>;
00804         $this-&gt;query($query);
00805         $query = <span class="stringliteral">"select actFromId from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"transitions where actToId="</span>.$node;
00806         $result = $this-&gt;query($query);
00807         $ret = Array();
00808         <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00809           $newnodes[] = $res['actFromId'];
00810         }
00811       }
00812       $num--;
00813       $nodes=Array();
00814       $nodes=$newnodes;
00815       
00816     }
00817     
00818     $min = $this-&gt;getOne(<span class="stringliteral">"select min(flowNum) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities where pId=$pId"</span>);
00819     $query = <span class="stringliteral">"update "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities set flowNum=flowNum-$min where pId=$pId"</span>;
00820     $this-&gt;query($query);
00821     
00822     <span class="comment">//$query = "update ".GALAXIA_TABLE_PREFIX."activities set flowNum=0 where flowNum=$cant+1";</span>
00823     <span class="comment">//$this-&gt;query($query);</span>
00824   }
00825     
00826 }
00827 
00828 
00829 ?&gt;
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Sep 30 01:24:12 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
