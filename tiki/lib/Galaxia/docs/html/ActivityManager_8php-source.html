<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ActivityManager.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>ActivityManager.php</h1><div class="fragment"><pre>00001 &lt;?php
00004 
<a name="l00012"></a><a class="code" href="classActivityManager.html">00012</a> <span class="keyword">class </span><a class="code" href="classActivityManager.html">ActivityManager</a> <span class="keyword">extends</span> BaseManager {
00013   var $error='';
00014       
<a name="l00019"></a><a class="code" href="classActivityManager.html#a0">00019</a>   function <a class="code" href="classActivityManager.html#a0">ActivityManager</a>($db) 
00020   {
00021     <span class="keywordflow">if</span>(!$db) {
00022       die(<span class="stringliteral">"Invalid db object passed to activityManager constructor"</span>);  
00023     }
00024     $this-&gt;db = $db;  
00025   }
00026   
00027   function get_error()
00028   {
00029     <span class="keywordflow">return</span> $this-&gt;error;
00030   }
00031   
<a name="l00035"></a><a class="code" href="classActivityManager.html#a2">00035</a>   function <a class="code" href="classActivityManager.html#a2">add_activity_role</a>($activityId, $roleId)
00036   {
00037     $query = <span class="stringliteral">"replace into galaxia_activity_roles(activityId, roleId)</span>
00038 <span class="stringliteral">    values($activityId, $roleId)"</span>;
00039     $this-&gt;query($query);
00040   }
00041   
<a name="l00045"></a><a class="code" href="classActivityManager.html#a3">00045</a>   function <a class="code" href="classActivityManager.html#a3">get_activity_roles</a>($activityId)
00046   {
00047     $query = <span class="stringliteral">"select activityId,roles.roleId,roles.name from galaxia_activity_roles gar, galaxia_roles roles where roles.roleId = gar.roleId and activityId=$activityId"</span>;
00048         $result = $this-&gt;query($query);
00049     $ret = Array();
00050     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00051       $ret[] = $res;
00052     }
00053     <span class="keywordflow">return</span> $ret;
00054   }
00055   
<a name="l00059"></a><a class="code" href="classActivityManager.html#a4">00059</a>   function <a class="code" href="classActivityManager.html#a4">remove_activity_role</a>($activityId, $roleId)
00060   {
00061     $query = <span class="stringliteral">"delete from galaxia_activity_roles where activityId=$activityId and roleId=$roleId"</span>;
00062     $this-&gt;query($query);
00063   }
00064   
<a name="l00068"></a><a class="code" href="classActivityManager.html#a5">00068</a>   function <a class="code" href="classActivityManager.html#a5">transition_exists</a>($pid,$actFromId,$actToId)
00069   {
00070     <span class="keywordflow">return</span>($this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_transitions where pId=$pid and actFromId=$actFromId and actToId=$actToId"</span>));
00071   }
00072   
<a name="l00076"></a><a class="code" href="classActivityManager.html#a6">00076</a>   function <a class="code" href="classActivityManager.html#a6">add_transition</a>($pId, $actFromId, $actToId)
00077   {
00078     <span class="comment">// No circular transitions allowed</span>
00079     <span class="keywordflow">if</span>($actFromId == $actToId) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00080     
00081     <span class="comment">// Rule: if act is not spl-x or spl-a it can't have more than</span>
00082     <span class="comment">// 1 outbound transition.</span>
00083     $a1 = $this-&gt;<a class="code" href="classActivityManager.html#a16">get_activity</a>($pId, $actFromId);
00084     $a2 = $this-&gt;<a class="code" href="classActivityManager.html#a16">get_activity</a>($pId, $actToId);
00085     <span class="keywordflow">if</span>(!$a1 || !$a2) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00086     <span class="keywordflow">if</span>($a1['type'] != '<span class="keywordflow">switch</span>' &amp;&amp; $a1['type'] != 'split') {
00087       <span class="keywordflow">if</span>($this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_transitions where actFromId=$actFromId"</span>)) {
00088         $this-&gt;error = tra('Cannot add transition only split activities can have more than one outbound transition');
00089         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00090       }
00091     }
00092     
00093     <span class="comment">// Rule: if act is standalone no transitions allowed</span>
00094     <span class="keywordflow">if</span>($a1['type'] == 'standalone' || $a2['type']=='standalone') <span class="keywordflow">return</span> <span class="keyword">false</span>;
00095     <span class="comment">// No inbound to start</span>
00096     <span class="keywordflow">if</span>($a2['type'] == 'start') <span class="keywordflow">return</span> <span class="keyword">false</span>;
00097     <span class="comment">// No outbound from end</span>
00098     <span class="keywordflow">if</span>($a1['type'] == 'end') <span class="keywordflow">return</span> <span class="keyword">false</span>;
00099      
00100         
00101         $query = <span class="stringliteral">"replace into galaxia_transitions(pId,actFromId,actToId)</span>
00102 <span class="stringliteral">                  values($pId,$actFromId,$actToId)"</span>;
00103         $this-&gt;query($query);
00104         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00105   }
00106   
<a name="l00110"></a><a class="code" href="classActivityManager.html#a7">00110</a>   function <a class="code" href="classActivityManager.html#a7">remove_transition</a>($actFromId, $actToId)
00111   {
00112         $query = <span class="stringliteral">"delete from galaxia_transitions where actFromId=$actFromId and actToId=$actToId"</span>;
00113         $this-&gt;query($query);
00114         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00115   }
00116   
<a name="l00120"></a><a class="code" href="classActivityManager.html#a8">00120</a>   function <a class="code" href="classActivityManager.html#a8">remove_activity_transitions</a>($pId, $aid)
00121   {
00122     $query = <span class="stringliteral">"delete from galaxia_transitions where pId=$pId and (actFromId=$aid or actToId=$aid)"</span>;
00123     $this-&gt;query($query);
00124   }
00125   
00126   
<a name="l00130"></a><a class="code" href="classActivityManager.html#a9">00130</a>   function <a class="code" href="classActivityManager.html#a9">get_process_transitions</a>($pId,$actid=0)
00131   {
00132     <span class="keywordflow">if</span>(!$actid) {
00133                 $query = <span class="stringliteral">"select a1.name as actFromName, a2.name as actToName, actFromId, actToId from galaxia_transitions gt,galaxia_activities a1, galaxia_activities a2 where gt.actFromId = a1.activityId and gt.actToId = a2.activityId and gt.pId = $pId"</span>;
00134         } <span class="keywordflow">else</span> {
00135                 $query = <span class="stringliteral">"select a1.name as actFromName, a2.name as actToName, actFromId, actToId from galaxia_transitions gt,galaxia_activities a1, galaxia_activities a2 where gt.actFromId = a1.activityId and gt.actToId = a2.activityId and gt.pId = $pId and (actFromId = $actid)"</span>;
00136         }
00137         $result = $this-&gt;query($query);
00138     $ret = Array();
00139     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00140       $ret[] = $res;
00141     }
00142     <span class="keywordflow">return</span> $ret;
00143   }
00144   
<a name="l00148"></a><a class="code" href="classActivityManager.html#a10">00148</a>   function <a class="code" href="classActivityManager.html#a10">activity_is_auto_routed</a>($actid)
00149   {
00150     <span class="keywordflow">return</span>($this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_activities where activityId=$actid and isAutoRouted='y'"</span>));
00151   }
00152   
<a name="l00157"></a><a class="code" href="classActivityManager.html#a11">00157</a>   function <a class="code" href="classActivityManager.html#a11">get_process_activities</a>($pId)
00158   {
00159         $query = <span class="stringliteral">"select * from galaxia_activities where pId=$pId"</span>;
00160         $result = $this-&gt;query($query);
00161     $ret = Array();
00162     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00163       $ret[] = $res;
00164     }
00165     <span class="keywordflow">return</span> $ret;
00166   }
00167 
00171   <span class="comment">//\todo build the real graph</span>
<a name="l00172"></a><a class="code" href="classActivityManager.html#a12">00172</a>   function <a class="code" href="classActivityManager.html#a12">build_process_graph</a>($pId)
00173   {
00174     $attributes = Array(
00175     
00176     );
00177         $graph = <span class="keyword">new</span> Process_GraphViz(<span class="keyword">true</span>,$attributes);
00178         $pm = <span class="keyword">new</span> <a class="code" href="classProcessManager.html">ProcessManager</a>($this-&gt;db);
00179         $name = $pm-&gt;_get_normalized_name($pId);
00180         $graph-&gt;set_pid($name);
00181         
00182         <span class="comment">// Nodes are process activities so get</span>
00183         <span class="comment">// the activities and add nodes as needed</span>
00184         $nodes = $this-&gt;<a class="code" href="classActivityManager.html#a11">get_process_activities</a>($pId);
00185         
00186         foreach($nodes as $node)
00187         {
00188           <span class="keywordflow">if</span>($node['isInteractive']==<span class="charliteral">'y'</span>) {
00189             $color='blue';
00190           } <span class="keywordflow">else</span> {
00191             $color='black';
00192           }
00193           $<span class="keyword">auto</span>[$node['name']] = $node['isAutoRouted'];
00194           $graph-&gt;addNode($node['name'],array('URL'=&gt;<span class="stringliteral">"foourl"</span>,
00195                                                                     'label'=&gt;$node['name'],
00196                                                                     'shape' =&gt; $this-&gt;_get_activity_shape($node['type']),
00197                                                                     'color' =&gt; $color
00198 
00199                                                                     )
00200                          );     
00201         }
00202         
00203         <span class="comment">// Now add edges, edges are transitions,</span>
00204         <span class="comment">// get the transitions and add the edges</span>
00205         $edges = $this-&gt;<a class="code" href="classActivityManager.html#a9">get_process_transitions</a>($pId);
00206         foreach($edges as $edge)
00207         {
00208           <span class="keywordflow">if</span>($<span class="keyword">auto</span>[$edge['actFromName']] == <span class="charliteral">'y'</span>) {
00209             $color = 'red';
00210           } <span class="keywordflow">else</span> {
00211             $color = 'black';
00212           }
00213           $graph-&gt;addEdge(array($edge['actFromName'] =&gt; $edge['actToName']), array('color'=&gt;$color));   
00214         }
00215         
00216         
00217         <span class="comment">// Save the map image and the image graph</span>
00218         $graph-&gt;image_and_map();
00219         unset($graph);
00220         <span class="keywordflow">return</span> <span class="keyword">true</span>;   
00221   }
00222   
00223   
<a name="l00236"></a><a class="code" href="classActivityManager.html#a13">00236</a>   function <a class="code" href="classActivityManager.html#a13">validate_process_activities</a>($pId)
00237   {
00238         $errors = Array();
00239     <span class="comment">// Pre rule no cricular activities</span>
00240     $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_transitions where pId=$pId and actFromId=actToId"</span>);
00241     <span class="keywordflow">if</span>($cant) {
00242       $errors[] = tra('Circular reference found some activty has a transition leading to itself');
00243     }
00244     
00245     <span class="comment">// Rule 1 must have exactly one start and end activity</span>
00246     $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_activities where pId=$pId and type='start'"</span>);
00247     <span class="keywordflow">if</span>($cant &lt; 1) {
00248       $errors[] = tra('<a class="code" href="classProcess.html">Process</a> does not have a start activity');
00249     }
00250     $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_activities where pId=$pId and type='end'"</span>);
00251     <span class="keywordflow">if</span>($cant != 1) {
00252       $errors[] = tra('<a class="code" href="classProcess.html">Process</a> does not have exactly one end activity');
00253     }
00254     
00255     <span class="comment">// Rule 2 end must be reachable from start</span>
00256         $nodes = Array();
00257     $endId = $this-&gt;getOne(<span class="stringliteral">"select activityId from galaxia_activities where pId=$pId and type='end'"</span>);
00258     $aux['id']=$endId;
00259     $aux['visited']=<span class="keyword">false</span>;
00260     $nodes[] = $aux;
00261     
00262     $startId = $this-&gt;getOne(<span class="stringliteral">"select activityId from galaxia_activities where pId=$pId and type='start'"</span>);
00263     $start_node['id']=$startId;
00264     $start_node['visited']=<span class="keyword">true</span>;    
00265     
00266     <span class="keywordflow">while</span>($this-&gt;_list_has_unvisited_nodes($nodes) &amp;&amp; !$this-&gt;_node_in_list($start_node,$nodes)) {
00267       <span class="keywordflow">for</span>($i=0;$i&lt;count($nodes);$i++) {
00268         $node=&amp;$nodes[$i];
00269         <span class="keywordflow">if</span>(!$node['visited']) {
00270                   $node['visited']=<span class="keyword">true</span>;          
00271           $query = <span class="stringliteral">"select actFromId from galaxia_transitions where actToId="</span>.$node['id'];
00272           $result = $this-&gt;query($query);
00273           $ret = Array();
00274           <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00275             $aux['id'] = $res['actFromId'];
00276             $aux['visited']=<span class="keyword">false</span>;
00277             <span class="keywordflow">if</span>(!$this-&gt;_node_in_list($aux,$nodes)) {
00278                           $nodes[] = $aux;
00279             }
00280           }
00281         }
00282       }
00283     }
00284     
00285     <span class="keywordflow">if</span>(!$this-&gt;_node_in_list($start_node,$nodes)) {
00286       <span class="comment">// Start node is NOT reachable from the end node</span>
00287       $errors[] = tra('End activity is not reachable from start activty');
00288     }
00289     
00290     <span class="comment">//Rule 3: interactive activities must have a role</span>
00291     <span class="comment">//assigned.</span>
00292     <span class="comment">//Rule 5: standalone activities can't have transitions</span>
00293     $query = <span class="stringliteral">"select * from galaxia_activities where pId = $pId"</span>;
00294         $result = $this-&gt;query($query);
00295     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00296       $aid = $res['activityId'];
00297       <span class="keywordflow">if</span>($res['isInteractive'] == <span class="charliteral">'y'</span>) {
00298         $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_activity_roles where activityId="</span>.$res['activityId']);
00299         <span class="keywordflow">if</span>(!$cant) {
00300           $errors[] = tra('Activity').': '.$res['name'].tra(' is interactive but has no role assigned');
00301         }
00302       } <span class="keywordflow">else</span> {
00303         <span class="keywordflow">if</span>( $res['type'] != 'end' &amp;&amp; $res['isAutoRouted'] == <span class="charliteral">'n'</span>) {
00304           $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_activity_roles where activityId="</span>.$res['activityId']);
00305           <span class="keywordflow">if</span>(!$cant) {
00306             $errors[] = tra('Activity').': '.$res['name'].tra(' is non-interactive and non-autorouted but has no role assigned');
00307           }
00308         }
00309           }
00310       <span class="keywordflow">if</span>($res['type']=='standalone') {
00311         <span class="keywordflow">if</span>($this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_transitions where actFromId=$aid or actToId=$aid"</span>)) {
00312            $errors[] = tra('Activity').': '.$res['name'].tra(' is standalone but has transitions');
00313         }
00314       }
00315 
00316     }
00317     
00318     
00319     
00320     <span class="comment">//Rule4: roles should be mapped</span>
00321         $query = <span class="stringliteral">"select * from galaxia_roles where pId = $pId"</span>;
00322         $result = $this-&gt;query($query);
00323     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {      
00324         $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_user_roles where roleId="</span>.$res['roleId']);
00325                 <span class="keywordflow">if</span>(!$cant) {
00326                   $errors[] = tra('<a class="code" href="classRole.html">Role</a>').': '.$res['name'].tra(' is not mapped');
00327                 }       
00328         }
00329         
00330     
00331     <span class="comment">// End of rules</span>
00332 
00333         <span class="comment">// Validate process sources</span>
00334         $serrors=$this-&gt;<a class="code" href="classActivityManager.html#a14">validate_process_sources</a>($pId);
00335         $errors = array_merge($errors,$serrors);
00336         
00337     $this-&gt;error = $errors;
00338     
00339     
00340     
00341     $isValid = (count($errors)==0) ? <span class="charliteral">'y'</span> : <span class="charliteral">'n'</span>;
00342 
00343     $query = <span class="stringliteral">"update galaxia_processes set isValid='$isValid' where pId=$pId"</span>;
00344     $this-&gt;query($query);
00345     
00346         $this-&gt;_label_nodes($pId);    
00347     
00348     <span class="keywordflow">return</span> ($isValid==<span class="charliteral">'y'</span>);
00349     
00350         
00351   }
00352   
<a name="l00361"></a><a class="code" href="classActivityManager.html#a14">00361</a>   function <a class="code" href="classActivityManager.html#a14">validate_process_sources</a>($pid)
00362   {
00363     $errors=Array();
00364     $procname= $this-&gt;getOne(<span class="stringliteral">"select normalized_name from galaxia_processes where pId=$pid"</span>);
00365     $query = <span class="stringliteral">"select * from galaxia_activities where pId=$pid"</span>;
00366     $result = $this-&gt;query($query);
00367     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {          
00368       $actname = $res['normalized_name'];
00369       $source = <span class="stringliteral">"lib/Galaxia/processes/$procname/code/activities/$actname"</span>.'.php';
00370       $fp = fopen($source,<span class="charliteral">'r'</span>);
00371       $data='';
00372       <span class="keywordflow">while</span>(!feof($fp)) {
00373         $data.=fread($fp,8192);
00374       }
00375       fclose($fp);
00376       <span class="keywordflow">if</span>($res['type']=='standalone') {
00377                 <span class="keywordflow">if</span>(strstr($data,'$instance')) {
00378                   $errors[] = tra('Activity '.$res['name'].' is standalone and is <span class="keyword">using</span> the $instance object');
00379                 }    
00380       } <span class="keywordflow">else</span> {
00381         <span class="keywordflow">if</span>($res['isInteractive']==<span class="charliteral">'y'</span>) {
00382           <span class="keywordflow">if</span>(!strstr($data,'$instance-&gt;complete()')) {
00383             $errors[] = tra('Activity '.$res['name'].' is interactive so it must use the $instance-&gt;complete() method');
00384           }
00385         } <span class="keywordflow">else</span> {
00386           <span class="keywordflow">if</span>(strstr($data,'$instance-&gt;complete()')) {
00387             $errors[] = tra('Activity '.$res['name'].' is non-interactive so it must not use the $instance-&gt;complete() method');
00388           }
00389         }
00390         <span class="keywordflow">if</span>($res['type']=='<span class="keywordflow">switch</span>') {
00391           <span class="keywordflow">if</span>(!strstr($data,'$instance-&gt;setNextActivity(')) { 
00392                         $errors[] = tra('Activity '.$res['name'].' is <span class="keywordflow">switch</span> so it must use $instance-&gt;setNextActivity($actname) method');          
00393           }
00394         }
00395       }    
00396     }
00397     <span class="keywordflow">return</span> $errors;
00398   }
00399   
<a name="l00403"></a><a class="code" href="classActivityManager.html#a15">00403</a>   function <a class="code" href="classActivityManager.html#a15">activity_name_exists</a>($pId,$name)
00404   {
00405     $name = addslashes($this-&gt;_normalize_name($name));
00406     <span class="keywordflow">return</span> $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_activities where pId=$pId and normalized_name='$name'"</span>);
00407   }
00408   
00409   
<a name="l00413"></a><a class="code" href="classActivityManager.html#a16">00413</a>   function <a class="code" href="classActivityManager.html#a16">get_activity</a>($pId, $activityId)
00414   {
00415         $query = <span class="stringliteral">"select * from galaxia_activities where pId=$pId and activityId=$activityId"</span>;
00416         $result = $this-&gt;query($query);
00417         $res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC);
00418         <span class="keywordflow">return</span> $res;
00419   }
00420   
<a name="l00424"></a><a class="code" href="classActivityManager.html#a17">00424</a>   function <a class="code" href="classActivityManager.html#a17">list_activities</a>($pId,$offset,$maxRecords,$sort_mode,$find,$where='')
00425   {
00426     $sort_mode = str_replace(<span class="stringliteral">"_"</span>,<span class="stringliteral">" "</span>,$sort_mode);
00427     <span class="keywordflow">if</span>($find) {
00428       $mid=<span class="stringliteral">" where pId=$pId and ((name like '%"</span>.$find.<span class="stringliteral">"%') or (description like '%"</span>.$find.<span class="stringliteral">"%'))"</span>;
00429     } <span class="keywordflow">else</span> {
00430       $mid=<span class="stringliteral">" where pId=$pId "</span>;
00431     }
00432     <span class="keywordflow">if</span>($where) {
00433       $mid.= <span class="stringliteral">" and ($where) "</span>;
00434     }
00435     $query = <span class="stringliteral">"select * from galaxia_activities $mid order by $sort_mode limit $offset,$maxRecords"</span>;
00436     $query_cant = <span class="stringliteral">"select count(*) from galaxia_activities $mid"</span>;
00437     $result = $this-&gt;query($query);
00438     $cant = $this-&gt;getOne($query_cant);
00439     $ret = Array();
00440     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00441       $res['roles'] = $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_activity_roles where activityId="</span>.$res['activityId']);
00442       $ret[] = $res;
00443     }
00444     $retval = Array();
00445     $retval[<span class="stringliteral">"data"</span>] = $ret;
00446     $retval[<span class="stringliteral">"cant"</span>] = $cant;
00447     <span class="keywordflow">return</span> $retval;
00448   }
00449   
00450   
00451   
<a name="l00455"></a><a class="code" href="classActivityManager.html#a18">00455</a>   function <a class="code" href="classActivityManager.html#a18">remove_activity</a>($pId, $activityId)
00456   {
00457         $pm = <span class="keyword">new</span> <a class="code" href="classProcessManager.html">ProcessManager</a>($this-&gt;db);
00458     $proc_info = $pm-&gt;get_process($pId);
00459     $actname = $this-&gt;_get_normalized_name($activityId);
00460     $query = <span class="stringliteral">"delete from galaxia_activities where pId=$pId and activityId=$activityId"</span>;
00461     $this-&gt;query($query);
00462     $query = <span class="stringliteral">"select actFromId,actToId from galaxia_transitions where actFromId=$activityId or actToId=$activityId"</span>;
00463     $result = $this-&gt;query($query);
00464     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00465       $this-&gt;<a class="code" href="classActivityManager.html#a7">remove_transition</a>($res['actFromId'], $res['actToId']);
00466     }
00467     $query = <span class="stringliteral">"delete from galaxia_activity_roles where activityId=$activityId"</span>;
00468     $this-&gt;query($query);
00469     <span class="comment">// And we have to remove the user and compiled files</span>
00470     <span class="comment">// for this activity</span>
00471     $procname = $proc_info['normalized_name'];
00472     unlink(<span class="stringliteral">"lib/Galaxia/processes/$procname/code/activities/$actname"</span>.'.php'); 
00473     @unlink(<span class="stringliteral">"lib/Galaxia/processes/$procname/code/templates/$actname"</span>.'.tpl'); 
00474     unlink(<span class="stringliteral">"lib/Galaxia/processes/$procname/compiled/$actname"</span>.'.php'); 
00475     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00476   }
00477   
<a name="l00484"></a><a class="code" href="classActivityManager.html#a19">00484</a>   function <a class="code" href="classActivityManager.html#a19">replace_activity</a>($pId, $activityId, $vars)
00485   {
00486     $TABLE_NAME = 'galaxia_activities';
00487     $now = date(<span class="stringliteral">"U"</span>);
00488     $vars['lastModif']=$now;
00489     $vars['pId']=$pId;
00490     $vars['normalized_name'] = $this-&gt;_normalize_name($vars['name']);    
00491 
00492         $pm = <span class="keyword">new</span> <a class="code" href="classProcessManager.html">ProcessManager</a>($this-&gt;db);
00493         $proc_info = $pm-&gt;get_process($pId);
00494         
00495     
00496     foreach($vars as $key=&gt;$value)
00497     {
00498       $vars[$key]=addslashes($value);
00499     }
00500   
00501     <span class="keywordflow">if</span>($activityId) {
00502       $oldname = $this-&gt;_get_normalized_name($activityId);
00503       <span class="comment">// update mode</span>
00504       $first = <span class="keyword">true</span>;
00505       $query =<span class="stringliteral">"update $TABLE_NAME set"</span>;
00506       foreach($vars as $key=&gt;$value) {
00507         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>;
00508         <span class="keywordflow">if</span>(!is_numeric($value)) $value=<span class="stringliteral">"'"</span>.$value.<span class="stringliteral">"'"</span>;
00509         $query.= <span class="stringliteral">" $key=$value "</span>;
00510         $first = <span class="keyword">false</span>;
00511       }
00512       $query .= <span class="stringliteral">" where pId=$pId and activityId=$activityId "</span>;
00513       $this-&gt;query($query);
00514       
00515       $newname = $vars['normalized_name'];
00516       <span class="comment">// if the activity is changing name then we</span>
00517       <span class="comment">// should rename the user_file for the activity</span>
00518       <span class="comment">// remove the old compiled file and recompile</span>
00519       <span class="comment">// the activity</span>
00520       
00521       $user_file_old = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/code/activities/'.$oldname.'.php';
00522       $user_file_new = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/code/activities/'.$newname.'.php';
00523       rename($user_file_old, $user_file_new);
00524 
00525       $user_file_old = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/code/templates/'.$oldname.'.tpl';
00526       $user_file_new = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/code/templates/'.$newname.'.tpl';
00527       @rename($user_file_old, $user_file_new);
00528 
00529       
00530           $compiled_file = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/compiled/'.$oldname.'.php';    
00531           unlink($compiled_file);
00532           $this-&gt;compile_activity($pId,$activityId);
00533       
00534       
00535     } <span class="keywordflow">else</span> {
00536       
00537       <span class="comment">// When inserting activity names can't be duplicated</span>
00538       <span class="keywordflow">if</span>($this-&gt;<a class="code" href="classActivityManager.html#a15">activity_name_exists</a>($pId, $vars['name'])) {
00539               <span class="keywordflow">return</span> <span class="keyword">false</span>;
00540       }
00541       unset($vars['activityId']);
00542       <span class="comment">// insert mode</span>
00543       $first = <span class="keyword">true</span>;
00544       $query = <span class="stringliteral">"insert into $TABLE_NAME("</span>;
00545       foreach(array_keys($vars) as $key) {
00546         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>; 
00547         $query.= <span class="stringliteral">"$key"</span>;
00548         $first = <span class="keyword">false</span>;
00549       } 
00550       $query .=<span class="stringliteral">") values("</span>;
00551       $first = <span class="keyword">true</span>;
00552       foreach(array_values($vars) as $value) {
00553         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>; 
00554         <span class="keywordflow">if</span>(!is_numeric($value)) $value=<span class="stringliteral">"'"</span>.$value.<span class="stringliteral">"'"</span>;
00555         $query.= <span class="stringliteral">"$value"</span>;
00556         $first = <span class="keyword">false</span>;
00557       } 
00558       $query .=<span class="stringliteral">")"</span>;
00559       $this-&gt;query($query);
00560       $activityId = $this-&gt;getOne(<span class="stringliteral">"select max(activityId) from $TABLE_NAME where pId=$pId and lastModif=$now"</span>); 
00561       $ret = $activityId;
00562       <span class="keywordflow">if</span>(!$activityId) {
00563                 print(<span class="stringliteral">"select max(activityId) from $TABLE_NAME where pId=$pId and lastModif=$now"</span>);
00564                 die;      
00565       }
00566       <span class="comment">// Should create the code file</span>
00567       $procname = $proc_info[<span class="stringliteral">"normalized_name"</span>];
00568           $fw = fopen(<span class="stringliteral">"lib/Galaxia/processes/$procname/code/activities/"</span>.$vars['normalized_name'].'.php<span class="charliteral">','</span>w');
00569           fwrite($fw,<span class="charliteral">'&lt;'</span>.<span class="charliteral">'?'</span>.'php'.<span class="stringliteral">"\n"</span>.<span class="charliteral">'?'</span>.<span class="charliteral">'&gt;'</span>);
00570           fclose($fw);
00571           
00572           <span class="keywordflow">if</span>($vars['isInteractive']==<span class="charliteral">'y'</span>) {
00573                   $fw = fopen(<span class="stringliteral">"lib/Galaxia/processes/$procname/code/templates/"</span>.$vars['normalized_name'].'.tpl<span class="charliteral">','</span>w');
00574                   fwrite($fw,<span class="charliteral">'{'</span>.<span class="charliteral">'*'</span>.'Smarty <span class="keyword">template</span><span class="charliteral">'.'</span>*<span class="charliteral">'.'</span>}'.<span class="stringliteral">"\n"</span>);
00575                   fclose($fw);
00576           }
00577 
00578           $this-&gt;compile_activity($pId,$activityId);
00579       
00580     }
00581     <span class="comment">// Get the id</span>
00582     <span class="keywordflow">return</span> $activityId;
00583   }
00584   
00588   function set_interactivity($pId, $actid, $value)
00589   {
00590     $query = <span class="stringliteral">"update galaxia_activities set isInteractive='$value' where pId=$pId and activityId=$actid"</span>;
00591     $this-&gt;query($query);
00592   }
00593 
00597   function set_autorouting($pId, $actid, $value)
00598   {
00599     $query = <span class="stringliteral">"update galaxia_activities set isAutoRouted='$value' where pId=$pId and activityId=$actid"</span>;
00600     $this-&gt;query($query);
00601   }
00602 
00603   
00607   function compile_activity($pId, $activityId)
00608   {
00609     $act_info = $this-&gt;<a class="code" href="classActivityManager.html#a16">get_activity</a>($pId,$activityId);
00610         $actname = $act_info['normalized_name'];
00611     $pm = <span class="keyword">new</span> <a class="code" href="classProcessManager.html">ProcessManager</a>($this-&gt;db);
00612     $proc_info = $pm-&gt;get_process($pId);
00613     $compiled_file = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/compiled/'.$act_info['normalized_name'].'.php';    
00614     $template_file = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/code/templates/'.$actname.'.tpl';    
00615     $user_file = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/code/activities/'.$actname.'.php';
00616     $pre_file = 'lib/Galaxia/compiler/'.$act_info['type'].'_pre.php';
00617     $pos_file = 'lib/Galaxia/compiler/'.$act_info['type'].'_pos.php';
00618     $fw = fopen($compiled_file,<span class="stringliteral">"w"</span>);
00619     
00620     <span class="comment">// First of all add an include to to the shared code</span>
00621     $shared_file = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/code/shared.php';    
00622     
00623     fwrite($fw, <span class="charliteral">'&lt;'</span>.<span class="charliteral">'?'</span>.<span class="stringliteral">"include_once('$shared_file');"</span>.<span class="charliteral">'?'</span>.<span class="charliteral">'&gt;'</span>.<span class="stringliteral">"\n"</span>);
00624     
00625     <span class="comment">// Before pre shared</span>
00626     $fp = fopen('lib/Galaxia/compiler/_shared_pre.php',<span class="stringliteral">"r"</span>);
00627     $data = fread($fp, filesize('lib/Galaxia/compiler/_shared_pre.php'));
00628         fwrite($fw,$data);
00629     
00630     <span class="comment">// Now get pre and pos files for the activity</span>
00631         $fp = fopen($pre_file,<span class="stringliteral">"r"</span>);
00632         $data = fread($fp, filesize($pre_file));
00633         fwrite($fw,$data);
00634         fclose($fp);
00635         
00636         <span class="comment">// Get the user data for the activity </span>
00637         $fp = fopen($user_file,<span class="stringliteral">"r"</span>);    
00638         $data = fread($fp,filesize($user_file));
00639         fwrite($fw,$data);
00640         fclose($fp);
00641         
00642         <span class="comment">// Get pos and write</span>
00643         $fp = fopen($pos_file,<span class="stringliteral">"r"</span>);
00644         $data = fread($fp, filesize($pos_file));
00645         fwrite($fw,$data);
00646         fclose($fp);
00647         
00648         <span class="comment">// Shared pos</span>
00649     $fp = fopen('lib/Galaxia/compiler/_shared_pos.php',<span class="stringliteral">"r"</span>);
00650     $data = fread($fp, filesize('lib/Galaxia/compiler/_shared_pos.php'));
00651         fwrite($fw,$data);
00652 
00653         <span class="comment">//Copy the templates</span>
00654         @copy($template_file,<span class="stringliteral">"templates/"</span>.$proc_info['normalized_name'].<span class="stringliteral">"/$actname.tpl"</span>);
00655     
00656   }
00657   
00662   function _get_activity_id_by_name($pid,$name)
00663   {
00664     $name = addslashes($name);
00665     <span class="keywordflow">if</span>($this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_activities where pId=$pid and name='$name'"</span>)) {
00666           <span class="keywordflow">return</span>($this-&gt;getOne(<span class="stringliteral">"select activityId from galaxia_activities where pId=$pid and name='$name'"</span>));    
00667     } <span class="keywordflow">else</span> {
00668       <span class="keywordflow">return</span> '';
00669     }
00670   }
00671   
00675   function _get_activity_shape($type)
00676   {
00677     <span class="keywordflow">switch</span>($type) {
00678       <span class="keywordflow">case</span> <span class="stringliteral">"start"</span>: 
00679         <span class="keywordflow">return</span> <span class="stringliteral">"circle"</span>;
00680       <span class="keywordflow">case</span> <span class="stringliteral">"end"</span>:
00681         <span class="keywordflow">return</span> <span class="stringliteral">"doublecircle"</span>;
00682       <span class="keywordflow">case</span> <span class="stringliteral">"activity"</span>:
00683         <span class="keywordflow">return</span> <span class="stringliteral">"box"</span>;
00684       <span class="keywordflow">case</span> <span class="stringliteral">"split"</span>:
00685         <span class="keywordflow">return</span> <span class="stringliteral">"triangle"</span>;
00686       <span class="keywordflow">case</span> <span class="stringliteral">"switch"</span>:
00687         <span class="keywordflow">return</span> <span class="stringliteral">"diamond"</span>;
00688       <span class="keywordflow">case</span> <span class="stringliteral">"join"</span>:
00689         <span class="keywordflow">return</span> <span class="stringliteral">"invtriangle"</span>;
00690       <span class="keywordflow">case</span> <span class="stringliteral">"standalone"</span>:
00691         <span class="keywordflow">return</span> <span class="stringliteral">"hexagon"</span>;
00692       <span class="keywordflow">default</span>:
00693         <span class="keywordflow">return</span> <span class="stringliteral">"egg"</span>;                   
00694       
00695     }
00696 
00697   }
00698 
00699   
00704   function _list_has_unvisited_nodes($list) 
00705   {
00706     foreach($list as $node) {
00707       <span class="keywordflow">if</span>(!$node['visited']) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00708     }
00709     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00710   }
00711   
00716   function _node_in_list($node,$list)
00717   {
00718     foreach($list as $a_node) {
00719       <span class="keywordflow">if</span>($node['id'] == $a_node['id']) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00720     }
00721     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00722   }
00723   
00728   function _normalize_name($name)
00729   {
00730     $name = str_replace(<span class="stringliteral">" "</span>,<span class="stringliteral">"_"</span>,$name);
00731     $name = preg_replace(<span class="stringliteral">"/[^A-Za-z_]/"</span>,'',$name);
00732     <span class="keywordflow">return</span> $name;
00733   }
00734   
00739   function _get_normalized_name($activityId)
00740   {
00741     <span class="keywordflow">return</span> $this-&gt;getOne(<span class="stringliteral">"select normalized_name from galaxia_activities where activityId=$activityId"</span>);
00742   }
00743   
00748   function _label_nodes($pId)
00749   {
00750         
00751     
00753         $nodes = Array();
00754         <span class="comment">// the end activity id</span>
00755     $endId = $this-&gt;getOne(<span class="stringliteral">"select activityId from galaxia_activities where pId=$pId and type='end'"</span>);
00756     <span class="comment">// and the number of total nodes (=activities)</span>
00757     $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_activities where pId=$pId"</span>);
00758     $nodes[] = $endId;
00759     $label = $cant;
00760     $num = $cant;
00761     
00762     $query = <span class="stringliteral">"update galaxia_activities set flowNum=$cant+1 where pId=$pId"</span>;
00763     $this-&gt;query($query);
00764     
00765     <span class="keywordflow">while</span>(count($nodes)) {
00766       $newnodes = Array();
00767       foreach($nodes as $node) {
00768         $query = <span class="stringliteral">"update galaxia_activities set flowNum=$num where activityId=$node"</span>;
00769         $this-&gt;query($query);
00770         $query = <span class="stringliteral">"select actFromId from galaxia_transitions where actToId="</span>.$node;
00771         $result = $this-&gt;query($query);
00772         $ret = Array();
00773         <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00774           $newnodes[] = $res['actFromId'];
00775         }
00776       }
00777       $num--;
00778       $nodes=Array();
00779       $nodes=$newnodes;
00780       
00781     }
00782     
00783     $min = $this-&gt;getOne(<span class="stringliteral">"select min(flowNum) from galaxia_activities where pId=$pId"</span>);
00784     $query = <span class="stringliteral">"update galaxia_activities set flowNum=flowNum-$min where pId=$pId"</span>;
00785     $this-&gt;query($query);
00786     
00787     <span class="comment">//$query = "update galaxia_activities set flowNum=0 where flowNum=$cant+1";</span>
00788     <span class="comment">//$this-&gt;query($query);</span>
00789   }
00790     
00791 }
00792 
00793 
00794 ?&gt;
</pre></div><hr><address style="align: right;"><small>Generated on Fri Apr 25 16:07:08 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
