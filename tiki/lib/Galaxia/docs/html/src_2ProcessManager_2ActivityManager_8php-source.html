<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ActivityManager.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>ActivityManager.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 
00005 
00012 <span class="comment">/*\todo</span>
00013 <span class="comment">  Add a method to check activity an activity name exists in a process (to be used</span>
00014 <span class="comment">  to prevent duplicate names)</span>
00015 <span class="comment">*/</span>
00016 
00017 <span class="keyword">class </span><a class="code" href="classActivityManager.html">ActivityManager</a> <span class="keyword">extends</span> BaseManager {
00018   var $error='';
00019       
<a name="l00024"></a><a class="code" href="classActivityManager.html#a16">00024</a>   function <a class="code" href="classActivityManager.html#a0">ActivityManager</a>($db) 
00025   {
00026     <span class="keywordflow">if</span>(!$db) {
00027       die(<span class="stringliteral">"Invalid db object passed to activityManager constructor"</span>);  
00028     }
00029     $this-&gt;db = $db;  
00030   }
00031   
00032   function get_error()
00033   {
00034     <span class="keywordflow">return</span> $this-&gt;error;
00035   }
00036   
<a name="l00040"></a><a class="code" href="classActivityManager.html#a18">00040</a>   function <a class="code" href="classActivityManager.html#a2">add_activity_role</a>($activityId, $roleId)
00041   {
00042     $query = <span class="stringliteral">"replace into galaxia_activity_roles(activityId, roleId)</span>
00043 <span class="stringliteral">    values($activityId, $roleId)"</span>;
00044     $this-&gt;query($query);
00045   }
00046   
<a name="l00050"></a><a class="code" href="classActivityManager.html#a19">00050</a>   function <a class="code" href="classActivityManager.html#a3">get_activity_roles</a>($activityId)
00051   {
00052     $query = <span class="stringliteral">"select activityId,roles.roleId,roles.name from galaxia_activity_roles gar, galaxia_roles roles where roles.roleId = gar.roleId and activityId=$activityId"</span>;
00053         $result = $this-&gt;query($query);
00054     $ret = Array();
00055     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00056       $ret[] = $res;
00057     }
00058     <span class="keywordflow">return</span> $ret;
00059   }
00060   
<a name="l00064"></a><a class="code" href="classActivityManager.html#a20">00064</a>   function <a class="code" href="classActivityManager.html#a4">remove_activity_role</a>($activityId, $roleId)
00065   {
00066     $query = <span class="stringliteral">"delete from galaxia_activity_roles where activityId=$activityId and roleId=$roleId"</span>;
00067     $this-&gt;query($query);
00068   }
00069   
<a name="l00073"></a><a class="code" href="classActivityManager.html#a21">00073</a>   function <a class="code" href="classActivityManager.html#a21">transition_exists</a>($pid,$actFromId,$actToId)
00074   {
00075     <span class="keywordflow">return</span>($this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_transitions where pId=$pid and actFromId=$actFromId and actToId=$actToId"</span>));
00076   }
00077   
<a name="l00081"></a><a class="code" href="classActivityManager.html#a22">00081</a>   function <a class="code" href="classActivityManager.html#a5">add_transition</a>($pId, $actFromId, $actToId)
00082   {
00083     <span class="comment">// No circular transitions allowed</span>
00084     <span class="keywordflow">if</span>($actFromId == $actToId) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00085     
00086     <span class="comment">// Rule: if act is not spl-x or spl-a it can't have more than</span>
00087     <span class="comment">// 1 outbound transition.</span>
00088     $a1 = $this-&gt;<a class="code" href="classActivityManager.html#a12">get_activity</a>($pId, $actFromId);
00089     $a2 = $this-&gt;<a class="code" href="classActivityManager.html#a12">get_activity</a>($pId, $actToId);
00090     <span class="keywordflow">if</span>(!$a1 || !$a2) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00091     <span class="keywordflow">if</span>($a1['type'] != '<span class="keywordflow">switch</span>' &amp;&amp; $a1['type'] != 'split') {
00092       <span class="keywordflow">if</span>($this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_transitions where actFromId=$actFromId"</span>)) {
00093         $this-&gt;error = tra('Cannot add transition only split activities can have more than one outbound transition');
00094         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00095       }
00096     }
00097     
00098     <span class="comment">// Rule: if act is standalone no transitions allowed</span>
00099     <span class="keywordflow">if</span>($a1['type'] == 'standalone' || $a2['type']=='standalone') <span class="keywordflow">return</span> <span class="keyword">false</span>;
00100     <span class="comment">// No inbound to start</span>
00101     <span class="keywordflow">if</span>($a2['type'] == 'start') <span class="keywordflow">return</span> <span class="keyword">false</span>;
00102     <span class="comment">// No outbound from end</span>
00103     <span class="keywordflow">if</span>($a1['type'] == 'end') <span class="keywordflow">return</span> <span class="keyword">false</span>;
00104      
00105         
00106         $query = <span class="stringliteral">"replace into galaxia_transitions(pId,actFromId,actToId)</span>
00107 <span class="stringliteral">                  values($pId,$actFromId,$actToId)"</span>;
00108         $this-&gt;query($query);
00109         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00110   }
00111   
<a name="l00115"></a><a class="code" href="classActivityManager.html#a23">00115</a>   function <a class="code" href="classActivityManager.html#a6">remove_transition</a>($actFromId, $actToId)
00116   {
00117         $query = <span class="stringliteral">"delete from galaxia_transitions where actFromId=$actFromId and actToId=$actToId"</span>;
00118         $this-&gt;query($query);
00119         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00120   }
00121   
<a name="l00125"></a><a class="code" href="classActivityManager.html#a24">00125</a>   function <a class="code" href="classActivityManager.html#a24">remove_activity_transitions</a>($pId, $aid)
00126   {
00127     $query = <span class="stringliteral">"delete from galaxia_transitions where pId=$pId and (actFromId=$aid or actToId=$aid)"</span>;
00128     $this-&gt;query($query);
00129   }
00130   
00131   
<a name="l00135"></a><a class="code" href="classActivityManager.html#a25">00135</a>   function <a class="code" href="classActivityManager.html#a7">get_process_transitions</a>($pId,$actid=0)
00136   {
00137     <span class="keywordflow">if</span>(!$actid) {
00138                 $query = <span class="stringliteral">"select a1.name as actFromName, a2.name as actToName, actFromId, actToId from galaxia_transitions gt,galaxia_activities a1, galaxia_activities a2 where gt.actFromId = a1.activityId and gt.actToId = a2.activityId and gt.pId = $pId"</span>;
00139         } <span class="keywordflow">else</span> {
00140                 $query = <span class="stringliteral">"select a1.name as actFromName, a2.name as actToName, actFromId, actToId from galaxia_transitions gt,galaxia_activities a1, galaxia_activities a2 where gt.actFromId = a1.activityId and gt.actToId = a2.activityId and gt.pId = $pId and (actFromId = $actid)"</span>;
00141         }
00142         $result = $this-&gt;query($query);
00143     $ret = Array();
00144     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00145       $ret[] = $res;
00146     }
00147     <span class="keywordflow">return</span> $ret;
00148   }
00149   
<a name="l00153"></a><a class="code" href="classActivityManager.html#a26">00153</a>   function <a class="code" href="classActivityManager.html#a26">activity_is_auto_routed</a>($actid)
00154   {
00155     <span class="keywordflow">return</span>($this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_activities where activityId=$actid and isAutoRouted='y'"</span>));
00156   }
00157   
<a name="l00162"></a><a class="code" href="classActivityManager.html#a27">00162</a>   function <a class="code" href="classActivityManager.html#a8">get_process_activities</a>($pId)
00163   {
00164         $query = <span class="stringliteral">"select * from galaxia_activities where pId=$pId"</span>;
00165         $result = $this-&gt;query($query);
00166     $ret = Array();
00167     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00168       $ret[] = $res;
00169     }
00170     <span class="keywordflow">return</span> $ret;
00171   }
00172 
00176   <span class="comment">//\todo build the real graph</span>
<a name="l00177"></a><a class="code" href="classActivityManager.html#a28">00177</a>   function <a class="code" href="classActivityManager.html#a9">build_process_graph</a>($pId)
00178   {
00179     $attributes = Array(
00180     
00181     );
00182         $graph = <span class="keyword">new</span> Process_GraphViz(<span class="keyword">true</span>,$attributes);
00183         $pm = <span class="keyword">new</span> <a class="code" href="classProcessManager.html">ProcessManager</a>($this-&gt;db);
00184         $name = $pm-&gt;_get_normalized_name($pId);
00185         $graph-&gt;set_pid($name);
00186         
00187         <span class="comment">// Nodes are process activities so get</span>
00188         <span class="comment">// the activities and add nodes as needed</span>
00189         $nodes = $this-&gt;<a class="code" href="classActivityManager.html#a8">get_process_activities</a>($pId);
00190         
00191         foreach($nodes as $node)
00192         {
00193           <span class="keywordflow">if</span>($node['isInteractive']==<span class="charliteral">'y'</span>) {
00194             $color='blue';
00195           } <span class="keywordflow">else</span> {
00196             $color='black';
00197           }
00198           $<span class="keyword">auto</span>[$node['name']] = $node['isAutoRouted'];
00199           $graph-&gt;addNode($node['name'],array('URL'=&gt;<span class="stringliteral">"foourl"</span>,
00200                                                                     'label'=&gt;$node['name'],
00201                                                                     'shape' =&gt; $this-&gt;_get_activity_shape($node['type']),
00202                                                                     'color' =&gt; $color
00203 
00204                                                                     )
00205                          );     
00206         }
00207         
00208         <span class="comment">// Now add edges, edges are transitions,</span>
00209         <span class="comment">// get the transitions and add the edges</span>
00210         $edges = $this-&gt;<a class="code" href="classActivityManager.html#a7">get_process_transitions</a>($pId);
00211         foreach($edges as $edge)
00212         {
00213           <span class="keywordflow">if</span>($<span class="keyword">auto</span>[$edge['actFromName']] == <span class="charliteral">'y'</span>) {
00214             $color = 'red';
00215           } <span class="keywordflow">else</span> {
00216             $color = 'black';
00217           }
00218           $graph-&gt;addEdge(array($edge['actFromName'] =&gt; $edge['actToName']), array('color'=&gt;$color));   
00219         }
00220         
00221         
00222         <span class="comment">// Save the map image and the image graph</span>
00223         $graph-&gt;image_and_map();
00224         unset($graph);
00225         <span class="keywordflow">return</span> <span class="keyword">true</span>;   
00226   }
00227   
00228   
<a name="l00239"></a><a class="code" href="classActivityManager.html#a29">00239</a>   function <a class="code" href="classActivityManager.html#a10">validate_process_activities</a>($pId)
00240   {
00241         $errors = Array();
00242     <span class="comment">// Pre rule no cricular activities</span>
00243     $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_transitions where pId=$pId and actFromId=actToId"</span>);
00244     <span class="keywordflow">if</span>($cant) {
00245       $errors[] = tra('Circular reference found some activty has a transition leading to itself');
00246     }
00247     
00248     <span class="comment">// Rule 1 must have exactly one start and end activity</span>
00249     $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_activities where pId=$pId and type='start'"</span>);
00250     <span class="keywordflow">if</span>($cant &lt; 1) {
00251       $errors[] = tra('Process does not have a start activity');
00252     }
00253     $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_activities where pId=$pId and type='end'"</span>);
00254     <span class="keywordflow">if</span>($cant != 1) {
00255       $errors[] = tra('Process does not have exactly one end activity');
00256     }
00257     
00258     <span class="comment">// Rule 2 end must be reachable from start</span>
00259         $nodes = Array();
00260     $endId = $this-&gt;getOne(<span class="stringliteral">"select activityId from galaxia_activities where pId=$pId and type='end'"</span>);
00261     $aux['id']=$endId;
00262     $aux['visited']=<span class="keyword">false</span>;
00263     $nodes[] = $aux;
00264     
00265     $startId = $this-&gt;getOne(<span class="stringliteral">"select activityId from galaxia_activities where pId=$pId and type='start'"</span>);
00266     $start_node['id']=$startId;
00267     $start_node['visited']=<span class="keyword">true</span>;    
00268     
00269     <span class="keywordflow">while</span>($this-&gt;_list_has_unvisited_nodes($nodes) &amp;&amp; !$this-&gt;_node_in_list($start_node,$nodes)) {
00270       <span class="keywordflow">for</span>($i=0;$i&lt;count($nodes);$i++) {
00271         $node=&amp;$nodes[$i];
00272         <span class="keywordflow">if</span>(!$node['visited']) {
00273                   $node['visited']=<span class="keyword">true</span>;          
00274           $query = <span class="stringliteral">"select actFromId from galaxia_transitions where actToId="</span>.$node['id'];
00275           $result = $this-&gt;query($query);
00276           $ret = Array();
00277           <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00278             $aux['id'] = $res['actFromId'];
00279             $aux['visited']=<span class="keyword">false</span>;
00280             <span class="keywordflow">if</span>(!$this-&gt;_node_in_list($aux,$nodes)) {
00281                           $nodes[] = $aux;
00282             }
00283           }
00284         }
00285       }
00286     }
00287     
00288     <span class="keywordflow">if</span>(!$this-&gt;_node_in_list($start_node,$nodes)) {
00289       <span class="comment">// Start node is NOT reachable from the end node</span>
00290       $errors[] = tra('End activity is not reachable from start activty');
00291     }
00292     
00293     <span class="comment">//Rule 3: interactive activities must have a role</span>
00294     <span class="comment">//assigned.</span>
00295     <span class="comment">//Rule 5: standalone activities can't have transitions</span>
00296     $query = <span class="stringliteral">"select * from galaxia_activities where pId = $pId"</span>;
00297         $result = $this-&gt;query($query);
00298     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00299       $aid = $res['activityId'];
00300       <span class="keywordflow">if</span>($res['isInteractive'] == <span class="charliteral">'y'</span>) {
00301         $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_activity_roles where activityId="</span>.$res['activityId']);
00302         <span class="keywordflow">if</span>(!$cant) {
00303           $errors[] = tra('Activity').': '.$res['name'].tra(' is interactive but has no role assigned');
00304         }
00305       }
00306       <span class="keywordflow">if</span>($res['type']=='standalone') {
00307         <span class="keywordflow">if</span>($this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_transitions where actFromId=$aid or actToId=$aid"</span>)) {
00308            $errors[] = tra('Activity').': '.$res['name'].tra(' is standalone but has transitions');
00309         }
00310       }
00311     }
00312     
00313     <span class="comment">//Rule4: roles should be mapped</span>
00314         $query = <span class="stringliteral">"select * from galaxia_roles where pId = $pId"</span>;
00315         $result = $this-&gt;query($query);
00316     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {      
00317         $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_user_roles where roleId="</span>.$res['roleId']);
00318                 <span class="keywordflow">if</span>(!$cant) {
00319                   $errors[] = tra('Role').': '.$res['name'].tra(' is not mapped');
00320                 }       
00321         }
00322         
00323     
00324     <span class="comment">// End of rules</span>
00325         
00326     $this-&gt;error = $errors;
00327     
00328     $isValid = (count($errors)==0) ? <span class="charliteral">'y'</span> : <span class="charliteral">'n'</span>;
00329 
00330     $query = <span class="stringliteral">"update galaxia_processes set isValid='$isValid' where pId=$pId"</span>;
00331     $this-&gt;query($query);
00332     
00333     
00334     
00335     <span class="keywordflow">return</span> ($isValid==<span class="charliteral">'y'</span>);
00336     
00337         
00338   }
00339   
<a name="l00343"></a><a class="code" href="classActivityManager.html#a30">00343</a>   function <a class="code" href="classActivityManager.html#a11">activity_name_exists</a>($pId,$name)
00344   {
00345     $name = addslashes($this-&gt;_normalize_name($name));
00346     <span class="keywordflow">return</span> $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_activities where pId=$pId and normalized_name='$name'"</span>);
00347   }
00348   
00349   
<a name="l00353"></a><a class="code" href="classActivityManager.html#a31">00353</a>   function <a class="code" href="classActivityManager.html#a12">get_activity</a>($pId, $activityId)
00354   {
00355         $query = <span class="stringliteral">"select * from galaxia_activities where pId=$pId and activityId=$activityId"</span>;
00356         $result = $this-&gt;query($query);
00357         $res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC);
00358         <span class="keywordflow">return</span> $res;
00359   }
00360   
<a name="l00364"></a><a class="code" href="classActivityManager.html#a32">00364</a>   function <a class="code" href="classActivityManager.html#a13">list_activities</a>($pId,$offset,$maxRecords,$sort_mode,$find,$where='')
00365   {
00366     $sort_mode = str_replace(<span class="stringliteral">"_"</span>,<span class="stringliteral">" "</span>,$sort_mode);
00367     <span class="keywordflow">if</span>($find) {
00368       $mid=<span class="stringliteral">" where pId=$pId and ((name like '%"</span>.$find.<span class="stringliteral">"%') or (description like '%"</span>.$find.<span class="stringliteral">"%'))"</span>;
00369     } <span class="keywordflow">else</span> {
00370       $mid=<span class="stringliteral">" where pId=$pId "</span>;
00371     }
00372     <span class="keywordflow">if</span>($where) {
00373       $mid.= <span class="stringliteral">" and ($where) "</span>;
00374     }
00375     $query = <span class="stringliteral">"select * from galaxia_activities $mid order by $sort_mode limit $offset,$maxRecords"</span>;
00376     $query_cant = <span class="stringliteral">"select count(*) from galaxia_activities $mid"</span>;
00377     $result = $this-&gt;query($query);
00378     $cant = $this-&gt;getOne($query_cant);
00379     $ret = Array();
00380     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00381       $res['roles'] = $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_activity_roles where activityId="</span>.$res['activityId']);
00382       $ret[] = $res;
00383     }
00384     $retval = Array();
00385     $retval[<span class="stringliteral">"data"</span>] = $ret;
00386     $retval[<span class="stringliteral">"cant"</span>] = $cant;
00387     <span class="keywordflow">return</span> $retval;
00388   }
00389   
00390   
00391   
<a name="l00395"></a><a class="code" href="classActivityManager.html#a33">00395</a>   function <a class="code" href="classActivityManager.html#a14">remove_activity</a>($pId, $activityId)
00396   {
00397         $pm = <span class="keyword">new</span> <a class="code" href="classProcessManager.html">ProcessManager</a>($this-&gt;db);
00398     $proc_info = $pm-&gt;get_process($pId);
00399     $actname = $this-&gt;_get_normalized_name($activityId);
00400     $query = <span class="stringliteral">"delete from galaxia_activities where pId=$pId and activityId=$activityId"</span>;
00401     $this-&gt;query($query);
00402     $query = <span class="stringliteral">"select actFromId,actToId from galaxia_transitions where actFromId=$activityId or actToId=$activityId"</span>;
00403     $result = $this-&gt;query($query);
00404     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00405       $this-&gt;<a class="code" href="classActivityManager.html#a6">remove_transition</a>($res['actFromId'], $res['actToId']);
00406     }
00407     $query = <span class="stringliteral">"delete from galaxia_activity_roles where activityId=$activityId"</span>;
00408     $this-&gt;query($query);
00409     <span class="comment">// And we have to remove the user and compiled files</span>
00410     <span class="comment">// for this activity</span>
00411     $procname = $proc_info['normalized_name'];
00412     unlink(<span class="stringliteral">"lib/Galaxia/processes/$procname/code/activities/$actname"</span>.'.php'); 
00413     unlink(<span class="stringliteral">"lib/Galaxia/processes/$procname/compiled/$actname"</span>.'.php'); 
00414     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00415   }
00416   
<a name="l00423"></a><a class="code" href="classActivityManager.html#a34">00423</a>   function <a class="code" href="classActivityManager.html#a15">replace_activity</a>($pId, $activityId, $vars)
00424   {
00425     $TABLE_NAME = 'galaxia_activities';
00426     $now = date(<span class="stringliteral">"U"</span>);
00427     $vars['lastModif']=$now;
00428     $vars['pId']=$pId;
00429     $vars['normalized_name'] = $this-&gt;_normalize_name($vars['name']);    
00430 
00431         $pm = <span class="keyword">new</span> <a class="code" href="classProcessManager.html">ProcessManager</a>($this-&gt;db);
00432         $proc_info = $pm-&gt;get_process($pId);
00433         
00434     
00435     foreach($vars as $key=&gt;$value)
00436     {
00437       $vars[$key]=addslashes($value);
00438     }
00439   
00440     <span class="keywordflow">if</span>($activityId) {
00441       $oldname = $this-&gt;_get_normalized_name($activityId);
00442       <span class="comment">// update mode</span>
00443       $first = <span class="keyword">true</span>;
00444       $query =<span class="stringliteral">"update $TABLE_NAME set"</span>;
00445       foreach($vars as $key=&gt;$value) {
00446         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>;
00447         <span class="keywordflow">if</span>(!is_numeric($value)) $value=<span class="stringliteral">"'"</span>.$value.<span class="stringliteral">"'"</span>;
00448         $query.= <span class="stringliteral">" $key=$value "</span>;
00449         $first = <span class="keyword">false</span>;
00450       }
00451       $query .= <span class="stringliteral">" where pId=$pId and activityId=$activityId "</span>;
00452       $this-&gt;query($query);
00453       
00454       $newname = $vars['normalized_name'];
00455       <span class="comment">// if the activity is changing name then we</span>
00456       <span class="comment">// should rename the user_file for the activity</span>
00457       <span class="comment">// remove the old compiled file and recompile</span>
00458       <span class="comment">// the activity</span>
00459       
00460       $user_file_old = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/code/activities/'.$oldname.'.php';
00461       $user_file_new = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/code/activities/'.$newname.'.php';
00462       rename($user_file_old, $user_file_new);
00463       
00464           $compiled_file = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/compiled/'.$oldname.'.php';    
00465           unlink($compiled_file);
00466           $this-&gt;compile_activity($pId,$activityId);
00467       
00468       
00469     } <span class="keywordflow">else</span> {
00470       
00471       <span class="comment">// When inserting activity names can't be duplicated</span>
00472       <span class="keywordflow">if</span>($this-&gt;<a class="code" href="classActivityManager.html#a11">activity_name_exists</a>($pId, $vars['name'])) {
00473               <span class="keywordflow">return</span> <span class="keyword">false</span>;
00474       }
00475       unset($vars['activityId']);
00476       <span class="comment">// insert mode</span>
00477       $first = <span class="keyword">true</span>;
00478       $query = <span class="stringliteral">"insert into $TABLE_NAME("</span>;
00479       foreach(array_keys($vars) as $key) {
00480         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>; 
00481         $query.= <span class="stringliteral">"$key"</span>;
00482         $first = <span class="keyword">false</span>;
00483       } 
00484       $query .=<span class="stringliteral">") values("</span>;
00485       $first = <span class="keyword">true</span>;
00486       foreach(array_values($vars) as $value) {
00487         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>; 
00488         <span class="keywordflow">if</span>(!is_numeric($value)) $value=<span class="stringliteral">"'"</span>.$value.<span class="stringliteral">"'"</span>;
00489         $query.= <span class="stringliteral">"$value"</span>;
00490         $first = <span class="keyword">false</span>;
00491       } 
00492       $query .=<span class="stringliteral">")"</span>;
00493       $this-&gt;query($query);
00494       $activityId = $this-&gt;getOne(<span class="stringliteral">"select max(activityId) from $TABLE_NAME where pId=$pId and lastModif=$now"</span>); 
00495       $ret = $activityId;
00496       <span class="keywordflow">if</span>(!$activityId) {
00497                 print(<span class="stringliteral">"select max(activityId) from $TABLE_NAME where pId=$pId and lastModif=$now"</span>);
00498                 die;      
00499       }
00500       <span class="comment">// Should create the code file</span>
00501       $procname = $proc_info[<span class="stringliteral">"normalized_name"</span>];
00502           $fw = fopen(<span class="stringliteral">"lib/Galaxia/processes/$procname/code/activities/"</span>.$vars['normalized_name'].'.php<span class="charliteral">','</span>w');
00503           fwrite($fw,<span class="charliteral">'&lt;'</span>.<span class="charliteral">'?'</span>.'php'.<span class="stringliteral">"\n"</span>.<span class="charliteral">'?'</span>.<span class="charliteral">'&gt;'</span>);
00504           fclose($fw);
00505           
00506           <span class="keywordflow">if</span>($vars['isInteractive']==<span class="charliteral">'y'</span>) {
00507                   $fw = fopen(<span class="stringliteral">"lib/Galaxia/processes/$procname/code/templates/"</span>.$vars['normalized_name'].'.php<span class="charliteral">','</span>w');
00508                   fwrite($fw,<span class="charliteral">'{'</span>.<span class="charliteral">'*'</span>.'Smarty <span class="keyword">template</span><span class="charliteral">'.'</span>*<span class="charliteral">'.'</span>}'.<span class="stringliteral">"\n"</span>);
00509                   fclose($fw);
00510           }
00511 
00512           $this-&gt;compile_activity($pId,$activityId);
00513       
00514     }
00515     <span class="comment">// Get the id</span>
00516     <span class="keywordflow">return</span> $activityId;
00517   }
00518   
00522   function set_interactivity($pId, $actid, $value)
00523   {
00524     $query = <span class="stringliteral">"update galaxia_activities set isInteractive='$value' where pId=$pId and activityId=$actid"</span>;
00525     $this-&gt;query($query);
00526   }
00527 
00531   function set_autorouting($pId, $actid, $value)
00532   {
00533     $query = <span class="stringliteral">"update galaxia_activities set isAutoRouted='$value' where pId=$pId and activityId=$actid"</span>;
00534     $this-&gt;query($query);
00535   }
00536 
00537   
00541   function compile_activity($pId, $activityId)
00542   {
00543     $act_info = $this-&gt;<a class="code" href="classActivityManager.html#a12">get_activity</a>($pId,$activityId);
00544         $actname = $act_info['normalized_name'];
00545     $pm = <span class="keyword">new</span> <a class="code" href="classProcessManager.html">ProcessManager</a>($this-&gt;db);
00546     $proc_info = $pm-&gt;get_process($pId);
00547     $compiled_file = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/compiled/'.$act_info['normalized_name'].'.php';    
00548     $user_file = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/code/activities/'.$actname.'.php';
00549     $pre_file = 'lib/Galaxia/compiler/'.$act_info['type'].'_pre.php';
00550     $pos_file = 'lib/Galaxia/compiler/'.$act_info['type'].'_pos.php';
00551     $fw = fopen($compiled_file,<span class="stringliteral">"w"</span>);
00552     
00553     <span class="comment">// First of all add an include to to the shared code</span>
00554     $shared_file = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/code/shared.php';    
00555     
00556     fwrite($fw, <span class="charliteral">'&lt;'</span>.<span class="charliteral">'?'</span>.<span class="stringliteral">"include_once('$shared_file');"</span>.<span class="charliteral">'?'</span>.<span class="charliteral">'&gt;'</span>.<span class="stringliteral">"\n"</span>);
00557     
00558     <span class="comment">// Before pre shared</span>
00559     $fp = fopen('lib/Galaxia/compiler/_shared_pre.php',<span class="stringliteral">"r"</span>);
00560     $data = fread($fp, filesize('lib/Galaxia/compiler/_shared_pre.php'));
00561         fwrite($fw,$data);
00562     
00563     <span class="comment">// Now get pre and pos files for the activity</span>
00564         $fp = fopen($pre_file,<span class="stringliteral">"r"</span>);
00565         $data = fread($fp, filesize($pre_file));
00566         fwrite($fw,$data);
00567         fclose($fp);
00568         
00569         <span class="comment">// Get the user data for the activity </span>
00570         $fp = fopen($user_file,<span class="stringliteral">"r"</span>);    
00571         $data = fread($fp,filesize($user_file));
00572         fwrite($fw,$data);
00573         fclose($fp);
00574         
00575         <span class="comment">// Get pos and write</span>
00576         $fp = fopen($pos_file,<span class="stringliteral">"r"</span>);
00577         $data = fread($fp, filesize($pos_file));
00578         fwrite($fw,$data);
00579         fclose($fp);
00580         
00581         <span class="comment">// Shared pos</span>
00582     $fp = fopen('lib/Galaxia/compiler/_shared_pos.php',<span class="stringliteral">"r"</span>);
00583     $data = fread($fp, filesize('lib/Galaxia/compiler/_shared_pos.php'));
00584         fwrite($fw,$data);
00585 
00586         
00587     
00588   }
00589   
00594   function _get_activity_id_by_name($pid,$name)
00595   {
00596     $name = addslashes($name);
00597     <span class="keywordflow">if</span>($this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_activities where pId=$pid and name='$name'"</span>)) {
00598           <span class="keywordflow">return</span>($this-&gt;getOne(<span class="stringliteral">"select activityId from galaxia_activities where pId=$pid and name='$name'"</span>));    
00599     } <span class="keywordflow">else</span> {
00600       <span class="keywordflow">return</span> '';
00601     }
00602   }
00603   
00607   function _get_activity_shape($type)
00608   {
00609     <span class="keywordflow">switch</span>($type) {
00610       <span class="keywordflow">case</span> <span class="stringliteral">"start"</span>: 
00611         <span class="keywordflow">return</span> <span class="stringliteral">"circle"</span>;
00612       <span class="keywordflow">case</span> <span class="stringliteral">"end"</span>:
00613         <span class="keywordflow">return</span> <span class="stringliteral">"doublecircle"</span>;
00614       <span class="keywordflow">case</span> <span class="stringliteral">"activity"</span>:
00615         <span class="keywordflow">return</span> <span class="stringliteral">"box"</span>;
00616       <span class="keywordflow">case</span> <span class="stringliteral">"split"</span>:
00617         <span class="keywordflow">return</span> <span class="stringliteral">"triangle"</span>;
00618       <span class="keywordflow">case</span> <span class="stringliteral">"switch"</span>:
00619         <span class="keywordflow">return</span> <span class="stringliteral">"diamond"</span>;
00620       <span class="keywordflow">case</span> <span class="stringliteral">"join"</span>:
00621         <span class="keywordflow">return</span> <span class="stringliteral">"invtriangle"</span>;
00622       <span class="keywordflow">case</span> <span class="stringliteral">"standalone"</span>:
00623         <span class="keywordflow">return</span> <span class="stringliteral">"hexagon"</span>;
00624       <span class="keywordflow">default</span>:
00625         <span class="keywordflow">return</span> <span class="stringliteral">"egg"</span>;                   
00626       
00627     }
00628 
00629   }
00630 
00631   
00636   function _list_has_unvisited_nodes($list) 
00637   {
00638     foreach($list as $node) {
00639       <span class="keywordflow">if</span>(!$node['visited']) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00640     }
00641     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00642   }
00643   
00648   function _node_in_list($node,$list)
00649   {
00650     foreach($list as $a_node) {
00651       <span class="keywordflow">if</span>($node['id'] == $a_node['id']) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00652     }
00653     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00654   }
00655   
00660   function _normalize_name($name)
00661   {
00662     $name = str_replace(<span class="stringliteral">" "</span>,<span class="stringliteral">"_"</span>,$name);
00663     $name = preg_replace(<span class="stringliteral">"/[^A-Za-z_]/"</span>,'',$name);
00664     <span class="keywordflow">return</span> $name;
00665   }
00666   
00671   function _get_normalized_name($activityId)
00672   {
00673     <span class="keywordflow">return</span> $this-&gt;getOne(<span class="stringliteral">"select normalized_name from galaxia_activities where activityId=$activityId"</span>);
00674   }
00675   
00676   
00677     
00678 }
00679 
00680 
00681 ?&gt;
</pre></div><hr><address style="align: right;"><small>Generated on Mon Apr 14 11:51:57 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
