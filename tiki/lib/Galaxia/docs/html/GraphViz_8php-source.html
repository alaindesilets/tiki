<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Galaxia: GraphViz.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>GraphViz.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 <span class="comment">//</span>
00003 <span class="comment">// +----------------------------------------------------------------------+</span>
00004 <span class="comment">// | PEAR :: Image :: GraphViz                                            |</span>
00005 <span class="comment">// +----------------------------------------------------------------------+</span>
00006 <span class="comment">// | Copyright (c) 2002 Sebastian Bergmann &lt;sb@sebastian-bergmann.de&gt; and |</span>
00007 <span class="comment">// |                    Dr. Volker GÃ¶bbels &lt;vmg@arachnion.de&gt;.            |</span>
00008 <span class="comment">// +----------------------------------------------------------------------+</span>
00009 <span class="comment">// | This source file is subject to version 3.00 of the PHP License,      |</span>
00010 <span class="comment">// | that is available at http://www.php.net/license/3_0.txt.             |</span>
00011 <span class="comment">// | If you did not receive a copy of the PHP license and are unable to   |</span>
00012 <span class="comment">// | obtain it through the world-wide-web, please send a note to          |</span>
00013 <span class="comment">// | license@php.net so we can mail you a copy immediately.               |</span>
00014 <span class="comment">// +----------------------------------------------------------------------+</span>
00015 <span class="comment">//</span>
00016 <span class="comment">// $Id: GraphViz_8php-source.html,v 1.5 2003-09-29 23:43:40 mikespub Exp $</span>
00017 <span class="comment">//</span>
00018 
00057 <span class="keyword">class </span>Process_GraphViz {
00063     var $dotCommand = 'dot';
00064     
00065     var $pid;
00066 
00072     var $neatoCommand = 'neato';
00073 
00079     var $graph;
00080 
00088     function Process_GraphViz($directed = <span class="keyword">true</span>, $attributes = array()) {
00089         $this-&gt;setDirected($directed);
00090         $this-&gt;setAttributes($attributes);
00091         <span class="keywordflow">if</span> (defined('GRAPHVIZ_BIN_DIR') &amp;&amp; GRAPHVIZ_BIN_DIR) {
00092             $this-&gt;dotCommand = GRAPHVIZ_BIN_DIR.<span class="charliteral">'/'</span>.$this-&gt;dotCommand;
00093             $this-&gt;neatoCommand = GRAPHVIZ_BIN_DIR.<span class="charliteral">'/'</span>.$this-&gt;neatoCommand;
00094         }
00095     }
00096     
00097     function set_pid($pid) 
00098     {
00099       $this-&gt;pid = $pid;
00100     }
00101 
00109     function image($format = 'png') {
00110         <span class="keywordflow">if</span> ($file = $this-&gt;saveParsedGraph()) {
00111             $outputfile = $file . <span class="charliteral">'.'</span> . $format;
00112             $outputfile2 = $file . <span class="charliteral">'.'</span> . 'map';
00113             $command  = $this-&gt;graph['directed'] ? $this-&gt;dotCommand : $this-&gt;neatoCommand;
00114             $command .= <span class="stringliteral">" -T$format -o$outputfile $file"</span>;
00115 
00116             @`$command`;
00117             $command = $this-&gt;dotCommand;
00118             $command.= <span class="stringliteral">" -Tcmap -o$outputfile2 $file"</span>;
00119             @`$command`;
00120             $fr = fopen($outputfile2,<span class="stringliteral">"r"</span>);
00121             $map = fread($fr,filesize($outputfile2));
00122             fclose($fr);
00123             @unlink($file);
00124 
00125             <span class="keywordflow">switch</span> ($format) {
00126                 <span class="keywordflow">case</span> 'gif':
00127                 <span class="keywordflow">case</span> 'jpg':
00128                 <span class="keywordflow">case</span> 'png':
00129                 <span class="keywordflow">case</span> 'svg':
00130                 <span class="keywordflow">case</span> 'wbmp': {
00131                     header('Content-Type: image/' . $format);
00132                 }
00133                 <span class="keywordflow">break</span>;
00134 
00135                 <span class="keywordflow">case</span> 'pdf': {
00136                     header('Content-Type: application/pdf');
00137                 }
00138                 <span class="keywordflow">break</span>;
00139             }
00140 
00141             header('Content-Length: ' . filesize($outputfile));
00142 
00143             $fp = fopen($outputfile, 'rb');
00144 
00145             <span class="keywordflow">if</span> ($fp) {
00146                 echo fread($fp, filesize($outputfile));
00147                 fclose($fp);
00148                 @unlink($outputfile);
00149             }
00150             @unlink($outputfile2);
00151             <span class="keywordflow">return</span> $map;
00152         }
00153     }
00154     
00155     function image_and_map($format = 'png') {
00156         <span class="keywordflow">if</span> ($file = $this-&gt;saveParsedGraph()) {
00157             $outputfile = $file . <span class="charliteral">'.'</span> . $format;
00158             $outputfile2 = $file . <span class="charliteral">'.'</span> . 'map';
00159             <span class="keywordflow">if</span>(!isset($this-&gt;graph['directed'])) $this-&gt;graph['directed']=<span class="keyword">true</span>;
00160             $command  = $this-&gt;graph['directed'] ? $this-&gt;dotCommand : $this-&gt;neatoCommand;
00161             $command .= <span class="stringliteral">" -T$format -o $outputfile $file"</span>;
00162             @`$command`;
00163 
00164             $command = $this-&gt;dotCommand;
00165             $command.= <span class="stringliteral">" -Tcmap -o $outputfile2 $file"</span>;
00166             @`$command`;
00167             @unlink($file);
00168             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00169         }
00170     }
00171 
00172     
00173     function map() {
00174         <span class="keywordflow">if</span> ($file = $this-&gt;saveParsedGraph()) {
00175             
00176             $outputfile2 = $file . <span class="charliteral">'.'</span> . 'map';
00177             
00178             $command = $this-&gt;dotCommand;
00179             $command.= <span class="stringliteral">" -Tcmap -o$outputfile2 $file"</span>;
00180             @`$command`;
00181             $fr = fopen($outputfile2,<span class="stringliteral">"r"</span>);
00182             $map = fread($fr,filesize($outputfile2));
00183             fclose($fr);
00184             
00185             @unlink($outputfile2);
00186             @unlink($file);
00187             <span class="keywordflow">return</span> $map;
00188         }
00189     }
00190 
00198     function addCluster($id, $title) {
00199         $this-&gt;graph['clusters'][$id] = $title;
00200     }
00201 
00210     function addNode($name, $attributes = array(), $group = '<span class="keywordflow">default</span>') {
00211         $this-&gt;graph['nodes'][$group][$name] = $attributes;
00212     }
00213 
00220     function removeNode($name, $group = '<span class="keywordflow">default</span>') {
00221         <span class="keywordflow">if</span> (isset($this-&gt;graph['nodes'][$group][$name])) {
00222             unset($this-&gt;graph['nodes'][$group][$name]);
00223         }
00224     }
00225 
00233     function addEdge($edge, $attributes = array()) {
00234         <span class="keywordflow">if</span> (is_array($edge)) {
00235             $from = key($edge);
00236             $to   = $edge[$from];
00237             $id   = $from . <span class="charliteral">'_'</span> . $to;
00238 
00239             <span class="keywordflow">if</span> (!isset($this-&gt;graph['edges'][$id])) {
00240                 $this-&gt;graph['edges'][$id] = $edge;
00241             } <span class="keywordflow">else</span> {
00242                 $this-&gt;graph['edges'][$id] = array_merge(
00243                   $this-&gt;graph['edges'][$id],
00244                   $edge
00245                 );
00246             }
00247 
00248             <span class="keywordflow">if</span> (is_array($attributes)) {
00249                 <span class="keywordflow">if</span> (!isset($this-&gt;graph['edgeAttributes'][$id])) {
00250                     $this-&gt;graph['edgeAttributes'][$id] = $attributes;
00251                 } <span class="keywordflow">else</span> {
00252                     $this-&gt;graph['edgeAttributes'][$id] = array_merge(
00253                       $this-&gt;graph['edgeAttributes'][$id],
00254                       $attributes
00255                     );
00256                 }
00257             }
00258         }
00259     }
00260 
00267     function removeEdge($edge) {
00268         <span class="keywordflow">if</span> (is_array($edge)) {
00269               $from = key($edge);
00270               $to   = $edge[$from];
00271               $id   = $from . <span class="charliteral">'_'</span> . $to;
00272 
00273             <span class="keywordflow">if</span> (isset($this-&gt;graph['edges'][$id])) {
00274                 unset($this-&gt;graph['edges'][$id]);
00275             }
00276 
00277             <span class="keywordflow">if</span> (isset($this-&gt;graph['edgeAttributes'][$id])) {
00278                 unset($this-&gt;graph['edgeAttributes'][$id]);
00279             }
00280         }
00281     }
00282 
00289     function addAttributes($attributes) {
00290         <span class="keywordflow">if</span> (is_array($attributes)) {
00291             $this-&gt;graph['attributes'] = array_merge(
00292               $this-&gt;graph['attributes'],
00293               $attributes
00294             );
00295         }
00296     }
00297 
00304     function setAttributes($attributes) {
00305         <span class="keywordflow">if</span> (is_array($attributes)) {
00306             $this-&gt;graph['attributes'] = $attributes;
00307         }
00308     }
00309 
00316     function setDirected($directed) {
00317         <span class="keywordflow">if</span> (is_bool($directed)) {
00318             $this-&gt;graph['directed'] = $directed;
00319         }
00320     }
00321 
00328     function load($file) {
00329         <span class="keywordflow">if</span> ($serialized_graph = implode('', @file($file))) {
00330             $this-&gt;graph = unserialize($serialized_graph);
00331         }
00332     }
00333 
00341     function save($file = '') {
00342         $serialized_graph = serialize($this-&gt;graph);
00343 
00344         <span class="keywordflow">if</span> (empty($file)) {
00345             $file = tempnam('temp', 'graph_');
00346         }
00347 
00348         <span class="keywordflow">if</span> ($fp = @fopen($file, <span class="charliteral">'w'</span>)) {
00349             @fputs($fp, $serialized_graph);
00350             @fclose($fp);
00351 
00352             <span class="keywordflow">return</span> $file;
00353         }
00354 
00355         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00356     }
00357 
00364     function parse() {
00365         $parsedGraph = <span class="stringliteral">"digraph G {\n"</span>;
00366 
00367         <span class="keywordflow">if</span> (isset($this-&gt;graph['attributes'])) {
00368             foreach ($this-&gt;graph['attributes'] as $key =&gt; $value) {
00369                 $attributeList[] = $key . '=<span class="stringliteral">"' . $value . '"</span>';
00370             }
00371 
00372             <span class="keywordflow">if</span> (!empty($attributeList)) {
00373               $parsedGraph .= implode(<span class="charliteral">','</span>, $attributeList) . <span class="stringliteral">";\n"</span>;
00374             }
00375         }
00376 
00377         <span class="keywordflow">if</span> (isset($this-&gt;graph['nodes'])) {
00378             foreach($this-&gt;graph['nodes'] as $group =&gt; $nodes) {
00379                 <span class="keywordflow">if</span> ($group != '<span class="keywordflow">default</span>') {
00380                   $parsedGraph .= sprintf(
00381                     <span class="stringliteral">"subgraph \"cluster_%s\" {\nlabel=\"%s\";\n"</span>,
00382 
00383                     $group,
00384                     isset($this-&gt;graph['clusters'][$group]) ? $this-&gt;graph['clusters'][$group] : ''
00385                   );
00386                 }
00387 
00388                 foreach($nodes as $node =&gt; $attributes) {
00389                     unset($attributeList);
00390 
00391                     foreach($attributes as $key =&gt; $value) {
00392                         $attributeList[] = $key . '=<span class="stringliteral">"' . $value . '"</span>';
00393                     }
00394 
00395                     <span class="keywordflow">if</span> (!empty($attributeList)) {
00396                         $parsedGraph .= sprintf(
00397                           <span class="stringliteral">"\"%s\" [ %s ];\n"</span>,
00398                           addslashes(stripslashes($node)),
00399                           implode(<span class="charliteral">','</span>, $attributeList)
00400                         );
00401                     }
00402                 }
00403 
00404                 <span class="keywordflow">if</span> ($group != '<span class="keywordflow">default</span>') {
00405                   $parsedGraph .= <span class="stringliteral">"}\n"</span>;
00406                 }
00407             }
00408         }
00409 
00410         <span class="keywordflow">if</span> (isset($this-&gt;graph['edges'])) {
00411             foreach($this-&gt;graph['edges'] as $label =&gt; $node) {
00412                 unset($attributeList);
00413 
00414                 $from = key($node);
00415                 $to   = $node[$from];
00416 
00417                 foreach($this-&gt;graph['edgeAttributes'][$label] as $key =&gt; $value) {
00418                     $attributeList[] = $key . '=<span class="stringliteral">"' . $value . '"</span>';
00419                 }
00420 
00421                 $parsedGraph .= sprintf(
00422                   '<span class="stringliteral">"%s"</span> -&gt; <span class="stringliteral">"%s"</span>',
00423                   addslashes(stripslashes($from)),
00424                   addslashes(stripslashes($to))
00425                 );
00426                 
00427                 <span class="keywordflow">if</span> (!empty($attributeList)) {
00428                     $parsedGraph .= sprintf(
00429                       ' [ %s ]',
00430                       implode(<span class="charliteral">','</span>, $attributeList)
00431                     );
00432                 }
00433 
00434                 $parsedGraph .= <span class="stringliteral">";\n"</span>;
00435             }
00436         }
00437 
00438         <span class="keywordflow">return</span> $parsedGraph . <span class="stringliteral">"}\n"</span>;
00439     }
00440 
00449     function saveParsedGraph($file = '') {
00450         $parsedGraph = $this-&gt;parse();
00451         <span class="keywordflow">if</span> (!empty($parsedGraph)) {
00452 
00453                 $file = GALAXIA_PROCESSES.<span class="charliteral">'/'</span>.$this-&gt;pid.'/graph/'.$this-&gt;pid;
00454             <span class="keywordflow">if</span> ($fp = @fopen($file, <span class="charliteral">'w'</span>)) {
00455                 @fputs($fp, $parsedGraph);
00456                 @fclose($fp);
00457 
00458                 <span class="keywordflow">return</span> $file;
00459             }
00460         }
00461 
00462         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00463     }
00464 }
00465 ?&gt;
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Sep 30 01:24:12 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
