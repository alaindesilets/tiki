<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ActivityManager.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>ActivityManager.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 
00005 
00012 <span class="comment">/*\todo</span>
00013 <span class="comment">  Add a method to check activity an activity name exists in a process (to be used</span>
00014 <span class="comment">  to prevent duplicate names)</span>
00015 <span class="comment">*/</span>
00016 
<a name="l00017"></a><a class="code" href="classActivityManager.html">00017</a> <span class="keyword">class </span><a class="code" href="classActivityManager.html">ActivityManager</a> <span class="keyword">extends</span> TikiLib {
00018   var $error='';
00019       
<a name="l00024"></a><a class="code" href="classActivityManager.html#a0">00024</a>   function <a class="code" href="classActivityManager.html#a0">ActivityManager</a>($db) 
00025   {
00026     <span class="keywordflow">if</span>(!$db) {
00027       die(<span class="stringliteral">"Invalid db object passed to activityManager constructor"</span>);  
00028     }
00029     $this-&gt;db = $db;  
00030   }
00031   
00032   function get_error()
00033   {
00034     <span class="keywordflow">return</span> $this-&gt;error;
00035   }
00036   
<a name="l00040"></a><a class="code" href="classActivityManager.html#a2">00040</a>   function <a class="code" href="classActivityManager.html#a2">add_activity_role</a>($activityId, $roleId)
00041   {
00042     $query = <span class="stringliteral">"replace into galaxia_activity_roles(activityId, roleId)</span>
00043 <span class="stringliteral">    values($activityId, $roleId)"</span>;
00044     $this-&gt;query($query);
00045   }
00046   
<a name="l00050"></a><a class="code" href="classActivityManager.html#a3">00050</a>   function <a class="code" href="classActivityManager.html#a3">get_activity_roles</a>($activityId)
00051   {
00052     $query = <span class="stringliteral">"select activityId,roles.roleId,roles.name from galaxia_activity_roles gar, galaxia_roles roles where roles.roleId = gar.roleId and activityId=$activityId"</span>;
00053         $result = $this-&gt;query($query);
00054     $ret = Array();
00055     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00056       $ret[] = $res;
00057     }
00058     <span class="keywordflow">return</span> $ret;
00059   }
00060   
<a name="l00064"></a><a class="code" href="classActivityManager.html#a4">00064</a>   function <a class="code" href="classActivityManager.html#a4">remove_activity_role</a>($activityId, $roleId)
00065   {
00066     $query = <span class="stringliteral">"delete from galaxia_activity_roles where activityId=$activityId and roleId=$roleId"</span>;
00067     $this-&gt;query($query);
00068   }
00069   
<a name="l00073"></a><a class="code" href="classActivityManager.html#a5">00073</a>   function <a class="code" href="classActivityManager.html#a5">add_transition</a>($pId, $actFromId, $actToId)
00074   {
00075     <span class="comment">// No circular transitions allowed</span>
00076     <span class="keywordflow">if</span>($actFromId == $actToId) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00077     <span class="comment">// Rule: if act is not spl-x or spl-a it can't have more than</span>
00078     <span class="comment">// 1 outbound transition.</span>
00079     $a1 = $this-&gt;<a class="code" href="classActivityManager.html#a12">get_activity</a>($pId, $actFromId);
00080     <span class="keywordflow">if</span>($a1['type'] != 'spl-a' &amp;&amp; $a1['type'] != 'spl-x') {
00081       <span class="keywordflow">if</span>($this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_transitions where actFromId=$actFromId"</span>)) {
00082         $this-&gt;error = tra('Cannot add transition only split activities can have more than one outbound transition');
00083         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00084       }
00085     }
00086         
00087         $query = <span class="stringliteral">"replace into galaxia_transitions(pId,actFromId,actToId)</span>
00088 <span class="stringliteral">                  values($pId,$actFromId,$actToId)"</span>;
00089         $this-&gt;query($query);
00090         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00091   }
00092   
<a name="l00096"></a><a class="code" href="classActivityManager.html#a6">00096</a>   function <a class="code" href="classActivityManager.html#a6">remove_transition</a>($actFromId, $actToId)
00097   {
00098         $query = <span class="stringliteral">"delete from galaxia_transitions where actFromId=$actFromId and actToId=$actToId"</span>;
00099         $this-&gt;query($query);
00100         <span class="keywordflow">return</span> <span class="keyword">true</span>;
00101   }
00102   
00103   
<a name="l00107"></a><a class="code" href="classActivityManager.html#a7">00107</a>   function <a class="code" href="classActivityManager.html#a7">get_process_transitions</a>($pId,$actid=0)
00108   {
00109     <span class="keywordflow">if</span>(!$actid) {
00110                 $query = <span class="stringliteral">"select a1.name as actFromName, a2.name as actToName, actFromId, actToId from galaxia_transitions gt,galaxia_activities a1, galaxia_activities a2 where gt.actFromId = a1.activityId and gt.actToId = a2.activityId and gt.pId = $pId"</span>;
00111         } <span class="keywordflow">else</span> {
00112                 $query = <span class="stringliteral">"select a1.name as actFromName, a2.name as actToName, actFromId, actToId from galaxia_transitions gt,galaxia_activities a1, galaxia_activities a2 where gt.actFromId = a1.activityId and gt.actToId = a2.activityId and gt.pId = $pId and (actFromId = $actid)"</span>;
00113         }
00114         $result = $this-&gt;query($query);
00115     $ret = Array();
00116     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00117       $ret[] = $res;
00118     }
00119     <span class="keywordflow">return</span> $ret;
00120   }
00121   
<a name="l00126"></a><a class="code" href="classActivityManager.html#a8">00126</a>   function <a class="code" href="classActivityManager.html#a8">get_process_activities</a>($pId)
00127   {
00128         $query = <span class="stringliteral">"select * from galaxia_activities where pId=$pId"</span>;
00129         $result = $this-&gt;query($query);
00130     $ret = Array();
00131     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00132       $ret[] = $res;
00133     }
00134     <span class="keywordflow">return</span> $ret;
00135   }
00136 
00140   <span class="comment">//\todo build the real graph</span>
<a name="l00141"></a><a class="code" href="classActivityManager.html#a9">00141</a>   function <a class="code" href="classActivityManager.html#a9">build_process_graph</a>($pId)
00142   {
00143         $graph = <span class="keyword">new</span> Process_GraphViz();
00144         $graph-&gt;set_pid($pId);
00145         
00146         <span class="comment">// Nodes are process activities so get</span>
00147         <span class="comment">// the activities and add nodes as needed</span>
00148         
00149         <span class="comment">// Now add edges, edges are transitions,</span>
00150         <span class="comment">// get the transitions and add the edges</span>
00151         
00152         $graph-&gt;addNode(<span class="stringliteral">"foo"</span>,array('URL'=&gt;<span class="stringliteral">"foourl"</span>,
00153                                                                     'label'=&gt;<span class="stringliteral">"foo label"</span>,
00154                                                                     'shape' =&gt; 'box'
00155                                                                     )
00156                          );     
00157         $graph-&gt;addEdge(array('foo' =&gt; 'foo'), array('color'=&gt;'black'));        
00158         <span class="comment">// Save the map image and the image graph</span>
00159         $graph-&gt;image_and_map();
00160         unset($graph);
00161         <span class="keywordflow">return</span> <span class="keyword">true</span>;   
00162   }
00163   
00164   
<a name="l00173"></a><a class="code" href="classActivityManager.html#a10">00173</a>   function <a class="code" href="classActivityManager.html#a10">validate_process_activities</a>($pId)
00174   {
00175         $errors = Array();
00176     <span class="comment">// Pre rule no cricular activities</span>
00177     $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_transitions where pId=$pId and actFromId=actToId"</span>);
00178     <span class="keywordflow">if</span>($cant) {
00179       $errors[] = tra('Circular reference found some activty has a transition leading to itself');
00180     }
00181     
00182     <span class="comment">// Rule 1 must have exactly one start and end activity</span>
00183     $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_activities where pId=$pId and type='start'"</span>);
00184     <span class="keywordflow">if</span>($cant != 1) {
00185       $errors[] = tra('Process does not have exactly one start activity');
00186     }
00187     $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_activities where pId=$pId and type='end'"</span>);
00188     <span class="keywordflow">if</span>($cant != 1) {
00189       $errors[] = tra('Process does not have exactly one end activity');
00190     }
00191     
00192     <span class="comment">// Rule 2 end must be reachable from start</span>
00193         $nodes = Array();
00194     $endId = $this-&gt;getOne(<span class="stringliteral">"select activityId from galaxia_activities where pId=$pId and type='end'"</span>);
00195     $aux['id']=$endId;
00196     $aux['visited']=<span class="keyword">false</span>;
00197     $nodes[] = $aux;
00198     
00199     $startId = $this-&gt;getOne(<span class="stringliteral">"select activityId from galaxia_activities where pId=$pId and type='start'"</span>);
00200     $start_node['id']=$startId;
00201     $start_node['visited']=<span class="keyword">true</span>;    
00202     
00203     <span class="keywordflow">while</span>($this-&gt;_list_has_unvisited_nodes($nodes) &amp;&amp; !$this-&gt;_node_in_list($start_node,$nodes)) {
00204       <span class="keywordflow">for</span>($i=0;$i&lt;count($nodes);$i++) {
00205         $node=&amp;$nodes[$i];
00206         <span class="keywordflow">if</span>(!$node['visited']) {
00207                   $node['visited']=<span class="keyword">true</span>;          
00208           $query = <span class="stringliteral">"select actFromId from galaxia_transitions where actToId="</span>.$node['id'];
00209           $result = $this-&gt;query($query);
00210           $ret = Array();
00211           <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00212             $aux['id'] = $res['actFromId'];
00213             $aux['visited']=<span class="keyword">false</span>;
00214             <span class="keywordflow">if</span>(!$this-&gt;_node_in_list($aux,$nodes)) {
00215                           $nodes[] = $aux;
00216             }
00217           }
00218         }
00219       }
00220     }
00221     
00222     <span class="keywordflow">if</span>(!$this-&gt;_node_in_list($start_node,$nodes)) {
00223       <span class="comment">// Start node is NOT reachable from the end node</span>
00224       $errors[] = tra('End activity is not reachable from start activty');
00225     }
00226     
00227     <span class="comment">//Rule 3: interactive activities must have a role</span>
00228     <span class="comment">//assigned.</span>
00229     $query = <span class="stringliteral">"select * from galaxia_activities where pId = $pId"</span>;
00230         $result = $this-&gt;query($query);
00231     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00232       <span class="keywordflow">if</span>($res['isInteractive'] == <span class="charliteral">'y'</span>) {
00233         $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_activity_roles where activityId="</span>.$res['activityId']);
00234         <span class="keywordflow">if</span>(!$cant) {
00235           $errors[] = tra('Activity').': '.$res['name'].tra(' is interactive but has no role assigned');
00236         }
00237       }
00238     }
00239     
00240     <span class="comment">//Rule4: roles should be mapped</span>
00241         $query = <span class="stringliteral">"select * from galaxia_roles where pId = $pId"</span>;
00242         $result = $this-&gt;query($query);
00243     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {      
00244         $cant = $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_user_roles where roleId="</span>.$res['roleId']);
00245                 <span class="keywordflow">if</span>(!$cant) {
00246                   $errors[] = tra('Role').': '.$res['name'].tra(' is not mapped');
00247                 }       
00248         }
00249     $this-&gt;error = $errors;
00250     
00251     <span class="keywordflow">return</span> (count($errors)==0);
00252     
00253         
00254   }
00255   
<a name="l00259"></a><a class="code" href="classActivityManager.html#a11">00259</a>   function <a class="code" href="classActivityManager.html#a11">activity_name_exists</a>($pId,$name)
00260   {
00261     $name = addslashes($this-&gt;_normalize_name($name));
00262     <span class="keywordflow">return</span> $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_activities where pId=$pId and normalized_name='$name'"</span>);
00263   }
00264   
00265   
<a name="l00269"></a><a class="code" href="classActivityManager.html#a12">00269</a>   function <a class="code" href="classActivityManager.html#a12">get_activity</a>($pId, $activityId)
00270   {
00271         $query = <span class="stringliteral">"select * from galaxia_activities where pId=$pId and activityId=$activityId"</span>;
00272         $result = $this-&gt;query($query);
00273         $res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC);
00274         <span class="keywordflow">return</span> $res;
00275   }
00276   
<a name="l00280"></a><a class="code" href="classActivityManager.html#a13">00280</a>   function <a class="code" href="classActivityManager.html#a13">list_activities</a>($pId,$offset,$maxRecords,$sort_mode,$find,$where='')
00281   {
00282     $sort_mode = str_replace(<span class="stringliteral">"_"</span>,<span class="stringliteral">" "</span>,$sort_mode);
00283     <span class="keywordflow">if</span>($find) {
00284       $mid=<span class="stringliteral">" where pId=$pId and ((name like '%"</span>.$find.<span class="stringliteral">"%') or (description like '%"</span>.$find.<span class="stringliteral">"%'))"</span>;
00285     } <span class="keywordflow">else</span> {
00286       $mid=<span class="stringliteral">" where pId=$pId "</span>;
00287     }
00288     <span class="keywordflow">if</span>($where) {
00289       $mid.= <span class="stringliteral">" and ($where) "</span>;
00290     }
00291     $query = <span class="stringliteral">"select * from galaxia_activities $mid order by $sort_mode limit $offset,$maxRecords"</span>;
00292     $query_cant = <span class="stringliteral">"select count(*) from galaxia_activities $mid"</span>;
00293     $result = $this-&gt;query($query);
00294     $cant = $this-&gt;getOne($query_cant);
00295     $ret = Array();
00296     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00297       $res['roles'] = $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_activity_roles where activityId="</span>.$res['activityId']);
00298       $ret[] = $res;
00299     }
00300     $retval = Array();
00301     $retval[<span class="stringliteral">"data"</span>] = $ret;
00302     $retval[<span class="stringliteral">"cant"</span>] = $cant;
00303     <span class="keywordflow">return</span> $retval;
00304   }
00305   
00306   
00307   
<a name="l00311"></a><a class="code" href="classActivityManager.html#a14">00311</a>   function <a class="code" href="classActivityManager.html#a14">remove_activity</a>($pId, $activityId)
00312   {
00313         $pm = <span class="keyword">new</span> <a class="code" href="classProcessManager.html">ProcessManager</a>($this-&gt;db);
00314     $proc_info = $pm-&gt;get_process($pId);
00315     $actname = $this-&gt;_get_normalized_name($activityId);
00316     $query = <span class="stringliteral">"delete from galaxia_activities where pId=$pId and activityId=$activityId"</span>;
00317     $this-&gt;query($query);
00318     $query = <span class="stringliteral">"select actFromId,actToId from galaxia_transitions where actFromId=$activityId or actToId=$activityId"</span>;
00319     $result = $this-&gt;query($query);
00320     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {  
00321       $this-&gt;<a class="code" href="classActivityManager.html#a6">remove_transition</a>($res['actFromId'], $res['actToId']);
00322     }
00323     $query = <span class="stringliteral">"delete from galaxia_activity_roles where activityId=$activityId"</span>;
00324     $this-&gt;query($query);
00325     <span class="comment">// And we have to remove the user and compiled files</span>
00326     <span class="comment">// for this activity</span>
00327     $procname = $proc_info['normalized_name'];
00328     unlink(<span class="stringliteral">"lib/Galaxia/processes/$procname/code/activities/$actname"</span>.'.php'); 
00329     unlink(<span class="stringliteral">"lib/Galaxia/processes/$procname/compiled/$actname"</span>.'.php'); 
00330     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00331   }
00332   
<a name="l00339"></a><a class="code" href="classActivityManager.html#a15">00339</a>   function <a class="code" href="classActivityManager.html#a15">replace_activity</a>($pId, $activityId, $vars)
00340   {
00341     $TABLE_NAME = 'galaxia_activities';
00342     $now = date(<span class="stringliteral">"U"</span>);
00343     $vars['lastModif']=$now;
00344     $vars['pId']=$pId;
00345     $vars['normalized_name'] = $this-&gt;_normalize_name($vars['name']);    
00346 
00347         $pm = <span class="keyword">new</span> <a class="code" href="classProcessManager.html">ProcessManager</a>($this-&gt;db);
00348         $proc_info = $pm-&gt;get_process($pId);
00349         
00350     
00351     foreach($vars as $key=&gt;$value)
00352     {
00353       $vars[$key]=addslashes($value);
00354     }
00355   
00356     <span class="keywordflow">if</span>($activityId) {
00357       $oldname = $this-&gt;_get_normalized_name($activityId);
00358       <span class="comment">// update mode</span>
00359       $first = <span class="keyword">true</span>;
00360       $query =<span class="stringliteral">"update $TABLE_NAME set"</span>;
00361       foreach($vars as $key=&gt;$value) {
00362         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>;
00363         <span class="keywordflow">if</span>(!is_numeric($value)) $value=<span class="stringliteral">"'"</span>.$value.<span class="stringliteral">"'"</span>;
00364         $query.= <span class="stringliteral">" $key=$value "</span>;
00365         $first = <span class="keyword">false</span>;
00366       }
00367       $query .= <span class="stringliteral">" where pId=$pId and activityId=$activityId "</span>;
00368       $this-&gt;query($query);
00369       
00370       $newname = $vars['normalized_name'];
00371       <span class="comment">// if the activity is changing name then we</span>
00372       <span class="comment">// should rename the user_file for the activity</span>
00373       <span class="comment">// remove the old compiled file and recompile</span>
00374       <span class="comment">// the activity</span>
00375       
00376       $user_file_old = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/code/activities/'.$oldname.'.php';
00377       $user_file_new = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/code/activities/'.$newname.'.php';
00378       rename($user_file_old, $user_file_new);
00379       
00380       $user_file_old = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/code/templates/'.$oldname.'.php';
00381       $user_file_new = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/code/templates/'.$newname.'.php';
00382       <span class="keywordflow">if</span>(file_exists($user_file_old)) rename($user_file_old, $user_file_new);
00383 
00384 
00385           $compiled_file = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/compiled/'.$oldname.'.php';    
00386           unlink($compiled_file);
00387           $this-&gt;compile_activity($pId,$activityId);
00388       
00389       
00390     } <span class="keywordflow">else</span> {
00391       
00392       <span class="comment">// When inserting activity names can't be duplicated</span>
00393       <span class="keywordflow">if</span>($this-&gt;<a class="code" href="classActivityManager.html#a11">activity_name_exists</a>($pId, $vars['name'])) {
00394               <span class="keywordflow">return</span> <span class="keyword">false</span>;
00395       }
00396 
00397       unset($vars['activityId']);
00398       <span class="comment">// insert mode</span>
00399       $first = <span class="keyword">true</span>;
00400       $query = <span class="stringliteral">"insert into $TABLE_NAME("</span>;
00401       foreach(array_keys($vars) as $key) {
00402         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>; 
00403         $query.= <span class="stringliteral">"$key"</span>;
00404         $first = <span class="keyword">false</span>;
00405       } 
00406       $query .=<span class="stringliteral">") values("</span>;
00407       $first = <span class="keyword">true</span>;
00408       foreach(array_values($vars) as $value) {
00409         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>; 
00410         <span class="keywordflow">if</span>(!is_numeric($value)) $value=<span class="stringliteral">"'"</span>.$value.<span class="stringliteral">"'"</span>;
00411         $query.= <span class="stringliteral">"$value"</span>;
00412         $first = <span class="keyword">false</span>;
00413       } 
00414       $query .=<span class="stringliteral">")"</span>;
00415       $this-&gt;query($query);
00416       $activityId = $this-&gt;getOne(<span class="stringliteral">"select max(activityId) from $TABLE_NAME where pId=$pId and lastModif=$now"</span>); 
00417       <span class="comment">// Should create the code file</span>
00418       $procname = $proc_info[<span class="stringliteral">"normalized_name"</span>];
00419           $fw = fopen(<span class="stringliteral">"lib/Galaxia/processes/$procname/code/activities/"</span>.$vars['normalized_name'].'.php<span class="charliteral">','</span>w');
00420           fwrite($fw,<span class="charliteral">'&lt;'</span>.<span class="charliteral">'?'</span>.'php'.<span class="stringliteral">"\n"</span>.<span class="charliteral">'?'</span>.<span class="charliteral">'&gt;'</span>);
00421           fclose($fw);
00422           <span class="keywordflow">if</span>($vars['isInteractive']==<span class="charliteral">'y'</span>) {
00423                   $fw = fopen(<span class="stringliteral">"lib/Galaxia/processes/$procname/code/templates/"</span>.$vars['normalized_name'].'.php<span class="charliteral">','</span>w');
00424                   fwrite($fw,<span class="charliteral">'{'</span>.<span class="charliteral">'*'</span>.'Smarty <span class="keyword">template</span><span class="charliteral">'.'</span>*<span class="charliteral">'.'</span>}'.<span class="stringliteral">"\n"</span>);
00425                   fclose($fw);
00426           }
00427           
00428           $this-&gt;compile_activity($pId,$activityId);
00429       
00430     }
00431     <span class="comment">// Get the id</span>
00432     <span class="keywordflow">return</span> $activityId;
00433   }
00434   
00438   function set_interactivity($pId, $actid, $value)
00439   {
00440     $query = <span class="stringliteral">"update galaxia_activities set isInteractive='$value' where pId=$pId and activityId=$actid"</span>;
00441     $this-&gt;query($query);
00442   }
00443 
00447   function set_autorouting($pId, $actid, $value)
00448   {
00449     $query = <span class="stringliteral">"update galaxia_activities set isAutoRouted='$value' where pId=$pId and activityId=$actid"</span>;
00450     $this-&gt;query($query);
00451   }
00452 
00453   
00457   function compile_activity($pId, $activityId)
00458   {
00459     $act_info = $this-&gt;<a class="code" href="classActivityManager.html#a12">get_activity</a>($pId,$activityId);
00460         $actname = $act_info['normalized_name'];
00461     $pm = <span class="keyword">new</span> <a class="code" href="classProcessManager.html">ProcessManager</a>($this-&gt;db);
00462     $proc_info = $pm-&gt;get_process($pId);
00463     $compiled_file = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/compiled/'.$act_info['normalized_name'].'.php';    
00464     $user_file = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/code/activities/'.$actname.'.php';
00465     $pre_file = 'lib/Galaxia/compiler/'.$act_info['type'].'_pre.php';
00466     $pos_file = 'lib/Galaxia/compiler/'.$act_info['type'].'_pos.php';
00467     
00468     $fw = fopen($compiled_file,<span class="stringliteral">"w"</span>);
00469     
00470     <span class="comment">// First of all add an include to to the shared code</span>
00471     $shared_file = 'lib/Galaxia/processes/'.$proc_info['normalized_name'].'/code/shared.php';    
00472     
00473     fwrite($fw, <span class="charliteral">'&lt;'</span>.<span class="charliteral">'?'</span>.<span class="stringliteral">"include_once('$shared_file');"</span>.<span class="charliteral">'?'</span>.<span class="charliteral">'&gt;'</span>.<span class="stringliteral">"\n"</span>);
00474     
00475     <span class="comment">// Now get pre and pos files for the activity</span>
00476         $fp = fopen($pre_file,<span class="stringliteral">"r"</span>);
00477         $data = fread($fp, filesize($pre_file));
00478         fwrite($fw,$data);
00479         fclose($fp);
00480         
00481         
00482         
00483         <span class="comment">// Get the user data for the activity </span>
00484 
00485         $fp = fopen($user_file,<span class="stringliteral">"r"</span>);    
00486         $data = fread($fp,filesize($user_file));
00487         fwrite($fw,$data);
00488         fclose($fp);
00489         
00490         <span class="comment">// Get pos and write</span>
00491         $fp = fopen($pos_file,<span class="stringliteral">"r"</span>);
00492         $data = fread($fp, filesize($pos_file));
00493         fwrite($fw,$data);
00494         fclose($fp);
00495         
00496     
00497   }
00498 
00499   
00504   function _list_has_unvisited_nodes($list) 
00505   {
00506     foreach($list as $node) {
00507       <span class="keywordflow">if</span>(!$node['visited']) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00508     }
00509     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00510   }
00511   
00516   function _node_in_list($node,$list)
00517   {
00518     foreach($list as $a_node) {
00519       <span class="keywordflow">if</span>($node['id'] == $a_node['id']) <span class="keywordflow">return</span> <span class="keyword">true</span>;
00520     }
00521     <span class="keywordflow">return</span> <span class="keyword">false</span>;
00522   }
00523   
00528   function _normalize_name($name)
00529   {
00530     $name = str_replace(<span class="stringliteral">" "</span>,<span class="stringliteral">"_"</span>,$name);
00531     $name = preg_replace(<span class="stringliteral">"/[^A-Za-z_]/"</span>,'',$name);
00532     <span class="keywordflow">return</span> $name;
00533   }
00534   
00539   function _get_normalized_name($activityId)
00540   {
00541     <span class="keywordflow">return</span> $this-&gt;getOne(<span class="stringliteral">"select normalized_name from galaxia_activities where activityId=$activityId"</span>);
00542   }
00543   
00544   
00545     
00546 }
00547 
00549 $activityManager = <span class="keyword">new</span> ActivityManager($dbTiki);
00550 
00551 ?&gt;
</pre></div><hr><address style="align: right;"><small>Generated on Mon Apr 14 11:51:56 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
