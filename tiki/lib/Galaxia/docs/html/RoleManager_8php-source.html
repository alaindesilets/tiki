<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Galaxia: RoleManager.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>RoleManager.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 include_once(GALAXIA_LIBRARY.'/src/<a class="code" href="classProcessManager.html">ProcessManager</a>/<a class="code" href="classBaseManager.html">BaseManager</a>.php');
00005 
<a name="l00017"></a><a class="code" href="classRoleManager.html">00017</a> <span class="keyword">class </span><a class="code" href="classRoleManager.html">RoleManager</a> <span class="keyword">extends</span> <a class="code" href="classBaseManager.html">BaseManager</a> {
00018     
<a name="l00023"></a><a class="code" href="classRoleManager.html#a0">00023</a>   function <a class="code" href="classRoleManager.html#a0">RoleManager</a>($db) 
00024   {
00025     <span class="keywordflow">if</span>(!$db) {
00026       die(<span class="stringliteral">"Invalid db object passed to RoleManager constructor"</span>);  
00027     }
00028     $this-&gt;db = $db;  
00029   }
00030   
00031   function get_role_id($pid,$name)
00032   {
00033     $name = addslashes($name);
00034     <span class="keywordflow">return</span> ($this-&gt;getOne(<span class="stringliteral">"select roleId from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"roles where name='$name' and pId=$pid"</span>));
00035   }
00036   
<a name="l00040"></a><a class="code" href="classRoleManager.html#a2">00040</a>   function <a class="code" href="classRoleManager.html#a2">get_role</a>($pId, $roleId)
00041   {
00042         $query = <span class="stringliteral">"select * from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"roles where pId=$pId and roleId=$roleId"</span>;
00043         $result = $this-&gt;query($query);
00044         $res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC);
00045         <span class="keywordflow">return</span> $res;
00046   }
00047   
<a name="l00051"></a><a class="code" href="classRoleManager.html#a3">00051</a>   function <a class="code" href="classRoleManager.html#a3">role_name_exists</a>($pid,$name)
00052   {
00053         $name = addslashes($name);
00054     <span class="keywordflow">return</span> ($this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"roles where pId=$pid and name='$name'"</span>));
00055   }
00056   
<a name="l00060"></a><a class="code" href="classRoleManager.html#a4">00060</a>   function <a class="code" href="classRoleManager.html#a4">map_user_to_role</a>($pId,$user,$roleId)
00061   {
00062     $query = <span class="stringliteral">"replace into "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"user_roles(pId,user,roleId) values($pId,'$user',$roleId)"</span>;
00063     $this-&gt;query($query);
00064   }
00065   
<a name="l00069"></a><a class="code" href="classRoleManager.html#a5">00069</a>   function <a class="code" href="classRoleManager.html#a5">remove_mapping</a>($user,$roleId)
00070   { 
00071     $query = <span class="stringliteral">"delete from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"user_roles where user='$user' and roleId=$roleId"</span>;
00072     $this-&gt;query($query);
00073   }
00074   
<a name="l00078"></a><a class="code" href="classRoleManager.html#a6">00078</a>   function <a class="code" href="classRoleManager.html#a6">list_mappings</a>($pId,$offset,$maxRecords,$sort_mode,$find)  {
00079     $sort_mode = str_replace(<span class="stringliteral">"_"</span>,<span class="stringliteral">" "</span>,$sort_mode);
00080     <span class="keywordflow">if</span>($find) {
00081         $findesc = $this-&gt;qstr(<span class="charliteral">'%'</span>.$find.<span class="charliteral">'%'</span>);
00082       $mid=<span class="stringliteral">" where gr.roleId=gur.roleId and gur.pId=$pId and ((name like $findesc) or (user like $findesc) or (description like $findesc))"</span>;
00083     } <span class="keywordflow">else</span> {
00084       $mid=<span class="stringliteral">" where gr.roleId=gur.roleId and gur.pId=$pId "</span>;
00085     }
00086     $query = <span class="stringliteral">"select name,gr.roleId,user from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"roles gr, "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"user_roles gur $mid order by $sort_mode limit $offset,$maxRecords"</span>;
00087     $query_cant = <span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"roles gr, "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"user_roles gur $mid"</span>;
00088     $result = $this-&gt;query($query);
00089     $cant = $this-&gt;getOne($query_cant);
00090     $ret = Array();
00091     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00092       $ret[] = $res;
00093     }
00094     $retval = Array();
00095     $retval[<span class="stringliteral">"data"</span>] = $ret;
00096     $retval[<span class="stringliteral">"cant"</span>] = $cant;
00097     <span class="keywordflow">return</span> $retval;
00098   }
00099   
<a name="l00103"></a><a class="code" href="classRoleManager.html#a7">00103</a>   function <a class="code" href="classRoleManager.html#a7">list_roles</a>($pId,$offset,$maxRecords,$sort_mode,$find,$where='')
00104   {
00105     $sort_mode = str_replace(<span class="stringliteral">"_"</span>,<span class="stringliteral">" "</span>,$sort_mode);
00106     <span class="keywordflow">if</span>($find) {
00107         $findesc = $this-&gt;qstr(<span class="charliteral">'%'</span>.$find.<span class="charliteral">'%'</span>);
00108       $mid=<span class="stringliteral">" where pId=$pId and ((name like $findesc) or (description like $findesc))"</span>;
00109     } <span class="keywordflow">else</span> {
00110       $mid=<span class="stringliteral">" where pId=$pId "</span>;
00111     }
00112     <span class="keywordflow">if</span>($where) {
00113       $mid.= <span class="stringliteral">" and ($where) "</span>;
00114     }
00115     $query = <span class="stringliteral">"select * from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"roles $mid order by $sort_mode limit $offset,$maxRecords"</span>;
00116     $query_cant = <span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"roles $mid"</span>;
00117     $result = $this-&gt;query($query);
00118     $cant = $this-&gt;getOne($query_cant);
00119     $ret = Array();
00120     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00121       $ret[] = $res;
00122     }
00123     $retval = Array();
00124     $retval[<span class="stringliteral">"data"</span>] = $ret;
00125     $retval[<span class="stringliteral">"cant"</span>] = $cant;
00126     <span class="keywordflow">return</span> $retval;
00127   }
00128   
00129   
00130   
<a name="l00134"></a><a class="code" href="classRoleManager.html#a8">00134</a>   function <a class="code" href="classRoleManager.html#a8">remove_role</a>($pId, $roleId)
00135   {
00136     $query = <span class="stringliteral">"delete from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"roles where pId=$pId and roleId=$roleId"</span>;
00137     $this-&gt;query($query);
00138     $query = <span class="stringliteral">"delete from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activity_roles where roleId=$roleId"</span>;
00139     $this-&gt;query($query);
00140     $query = <span class="stringliteral">"delete from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"user_roles where roleId=$roleId"</span>;
00141     $this-&gt;query($query);
00142   }
00143   
<a name="l00150"></a><a class="code" href="classRoleManager.html#a9">00150</a>   function <a class="code" href="classRoleManager.html#a9">replace_role</a>($pId, $roleId, $vars)
00151   {
00152     $TABLE_NAME = '<span class="stringliteral">".GALAXIA_TABLE_PREFIX."</span>roles';
00153     $now = date(<span class="stringliteral">"U"</span>);
00154     $vars['lastModif']=$now;
00155     $vars['pId']=$pId;
00156     
00157     foreach($vars as $key=&gt;$value)
00158     {
00159       $vars[$key]=addslashes($value);
00160     }
00161   
00162     <span class="keywordflow">if</span>($roleId) {
00163       <span class="comment">// update mode</span>
00164       $first = <span class="keyword">true</span>;
00165       $query =<span class="stringliteral">"update $TABLE_NAME set"</span>;
00166       foreach($vars as $key=&gt;$value) {
00167         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>;
00168         <span class="keywordflow">if</span>(!is_numeric($value)) $value=<span class="stringliteral">"'"</span>.$value.<span class="stringliteral">"'"</span>;
00169         $query.= <span class="stringliteral">" $key=$value "</span>;
00170         $first = <span class="keyword">false</span>;
00171       }
00172       $query .= <span class="stringliteral">" where pId=$pId and roleId=$roleId "</span>;
00173       $this-&gt;query($query);
00174     } <span class="keywordflow">else</span> {
00175       $name = $vars['name'];
00176       <span class="keywordflow">if</span> ($this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"roles where pId=$pId and name='$name'"</span>)) {
00177         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00178       }
00179       unset($vars['roleId']);
00180       <span class="comment">// insert mode</span>
00181       $first = <span class="keyword">true</span>;
00182       $query = <span class="stringliteral">"insert into $TABLE_NAME("</span>;
00183       foreach(array_keys($vars) as $key) {
00184         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>; 
00185         $query.= <span class="stringliteral">"$key"</span>;
00186         $first = <span class="keyword">false</span>;
00187       } 
00188       $query .=<span class="stringliteral">") values("</span>;
00189       $first = <span class="keyword">true</span>;
00190       foreach(array_values($vars) as $value) {
00191         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>; 
00192         <span class="keywordflow">if</span>(!is_numeric($value)) $value=<span class="stringliteral">"'"</span>.$value.<span class="stringliteral">"'"</span>;
00193         $query.= <span class="stringliteral">"$value"</span>;
00194         $first = <span class="keyword">false</span>;
00195       } 
00196       $query .=<span class="stringliteral">")"</span>;
00197       $this-&gt;query($query);
00198       $roleId = $this-&gt;getOne(<span class="stringliteral">"select max(roleId) from $TABLE_NAME where pId=$pId and lastModif=$now"</span>); 
00199     }
00200     <span class="comment">// Get the id</span>
00201     <span class="keywordflow">return</span> $roleId;
00202   }
00203     
00204 }
00205 
00206 
00207 ?&gt;
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Sep 30 01:24:13 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
