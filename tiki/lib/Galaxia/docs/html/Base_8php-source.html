<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Galaxia: Base.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>Base.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 include_once(GALAXIA_LIBRARY.'/src/common/<a class="code" href="classObservable.html">Observable</a>.php');
00005 
<a name="l00009"></a><a class="code" href="classBase.html">00009</a> <span class="keyword">class </span><a class="code" href="classBase.html">Base</a> <span class="keyword">extends</span> <a class="code" href="classObservable.html">Observable</a> {
00010   var $db;  <span class="comment">// The ADODB object used to access the database</span>
00011         var $num_queries = 0;
00012 
00013   <span class="comment">// Constructor receiving a ADODB database object.</span>
00014   function <a class="code" href="classBase.html">Base</a>($db)
00015   {
00016     <span class="keywordflow">if</span>(!$db) {
00017       die(<span class="stringliteral">"Invalid db object passed to Base constructor"</span>);
00018     }
00019     $this-&gt;db = $db;
00020   }
00021 
00022         <span class="comment">// copied from tikilib.php</span>
00023         function query($query, $values = null, $numrows = -1, $offset = -1, $reporterrors = <span class="keyword">true</span>) {
00024                 $this-&gt;convert_query($query);
00025                 <span class="keywordflow">if</span> ($numrows == -1 &amp;&amp; $offset == -1)
00026                         $result = $this-&gt;db-&gt;Execute($query, $values);
00027                 <span class="keywordflow">else</span>
00028                         $result = $this-&gt;db-&gt;SelectLimit($query, $numrows, $offset, $values);
00029                 <span class="keywordflow">if</span> (!$result &amp;&amp; $reporterrors)
00030                         $this-&gt;sql_error($query, $values, $result);
00031                 $this-&gt;num_queries++;
00032                 <span class="keywordflow">return</span> $result;
00033         }
00034 
00035         function getOne($query, $values = null, $reporterrors = <span class="keyword">true</span>) {
00036                 $this-&gt;convert_query($query);
00037                 $result = $this-&gt;db-&gt;SelectLimit($query, 1, 0, $values);
00038                 <span class="keywordflow">if</span> (!$result &amp;&amp; $reporterrors)
00039                         $this-&gt;sql_error($query, $values, $result);
00040 
00041                 $res = $result-&gt;fetchRow();
00042                 $this-&gt;num_queries++;
00043                 <span class="keywordflow">if</span> ($res === <span class="keyword">false</span>)
00044                         <span class="keywordflow">return</span> (NULL); <span class="comment">//simulate pears behaviour</span>
00045                 list($key, $value) = each($res);
00046                 <span class="keywordflow">return</span> $value;
00047         }
00048 
00049         function sql_error($query, $values, $result) {
00050                 global $ADODB_Database;
00051 
00052                 trigger_error($ADODB_Database . <span class="stringliteral">" error:  "</span> . $this-&gt;db-&gt;ErrorMsg(). <span class="stringliteral">" in query:&lt;br/&gt;"</span> . $query . <span class="stringliteral">"&lt;br/&gt;"</span>, E_USER_WARNING);
00053                 <span class="comment">// only for debugging.</span>
00054                 print_r($values);
00055                 <span class="comment">//echo "&lt;br/&gt;";</span>
00056                 die;
00057         }
00058 
00059         <span class="comment">// functions to support DB abstraction</span>
00060         function convert_query(&amp;$query) {
00061                 global $ADODB_Database;
00062 
00063                 <span class="keywordflow">switch</span> ($ADODB_Database) {
00064                 <span class="keywordflow">case</span> <span class="stringliteral">"oci8"</span>:
00065                         $query = preg_replace(<span class="stringliteral">"/`/"</span>, <span class="stringliteral">"\""</span>, $query);
00066                         <span class="comment">// convert bind variables - adodb does not do that </span>
00067                         $qe = explode(<span class="stringliteral">"?"</span>, $query);
00068                         $query = '';
00069                         <span class="keywordflow">for</span> ($i = 0; $i &lt; <span class="keyword">sizeof</span>($qe) - 1; $i++) {
00070                                 $query .= $qe[$i] . <span class="stringliteral">":"</span> . $i;
00071                         }
00072                         $query .= $qe[$i];
00073                         <span class="keywordflow">break</span>;
00074                 <span class="keywordflow">case</span> <span class="stringliteral">"postgres7"</span>:
00075                 <span class="keywordflow">case</span> <span class="stringliteral">"sybase"</span>:
00076                         $query = preg_replace(<span class="stringliteral">"/`/"</span>, <span class="stringliteral">"\""</span>, $query);
00077                         <span class="keywordflow">break</span>;
00078                 }
00079         }
00080 
00081         function convert_sortmode($sort_mode) {
00082                 global $ADODB_Database;
00083 
00084                 <span class="keywordflow">switch</span> ($ADODB_Database) {
00085                 <span class="keywordflow">case</span> <span class="stringliteral">"pgsql72"</span>:
00086                 <span class="keywordflow">case</span> <span class="stringliteral">"postgres7"</span>:
00087                 <span class="keywordflow">case</span> <span class="stringliteral">"oci8"</span>:
00088                 <span class="keywordflow">case</span> <span class="stringliteral">"sybase"</span>:
00089                         <span class="comment">// Postgres needs " " around column names</span>
00090                         <span class="comment">//preg_replace("#([A-Za-z]+)#","\"\$1\"",$sort_mode);</span>
00091                         $sort_mode = str_replace(<span class="stringliteral">"_"</span>, <span class="stringliteral">"\" "</span>, $sort_mode);
00092                         $sort_mode = <span class="stringliteral">"\""</span> . $sort_mode;
00093                         <span class="keywordflow">break</span>;
00094                 <span class="keywordflow">case</span> <span class="stringliteral">"mysql3"</span>:
00095                 <span class="keywordflow">case</span> <span class="stringliteral">"mysql"</span>:
00096                 <span class="keywordflow">default</span>:
00097                         $sort_mode = str_replace(<span class="stringliteral">"_"</span>, <span class="stringliteral">"` "</span>, $sort_mode);
00098                         $sort_mode = <span class="stringliteral">"`"</span> . $sort_mode;
00099                         <span class="keywordflow">break</span>;
00100                 }
00101                 <span class="keywordflow">return</span> $sort_mode;
00102         }
00103 
00104         function convert_binary() {
00105                 global $ADODB_Database;
00106 
00107                 <span class="keywordflow">switch</span> ($ADODB_Database) {
00108                 <span class="keywordflow">case</span> <span class="stringliteral">"pgsql72"</span>:
00109                 <span class="keywordflow">case</span> <span class="stringliteral">"oci8"</span>:
00110                 <span class="keywordflow">case</span> <span class="stringliteral">"postgres7"</span>:
00111                         <span class="keywordflow">return</span>;
00112                         <span class="keywordflow">break</span>;
00113                 <span class="keywordflow">case</span> <span class="stringliteral">"mysql3"</span>:
00114                 <span class="keywordflow">case</span> <span class="stringliteral">"mysql"</span>:
00115                         <span class="keywordflow">return</span> <span class="stringliteral">"binary"</span>;
00116                         <span class="keywordflow">break</span>;
00117                 }
00118         }
00119 
00120 
00121 } <span class="comment">//end of class</span>
00122 
00123 ?&gt;
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Sep 30 01:24:12 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
