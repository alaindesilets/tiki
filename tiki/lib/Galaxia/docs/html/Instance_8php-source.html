<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Galaxia: Instance.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>Instance.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 include_once (GALAXIA_LIBRARY.'/src/common/<a class="code" href="classBase.html">Base</a>.php');
00005 
<a name="l00011"></a><a class="code" href="classInstance.html">00011</a> <span class="keyword">class </span><a class="code" href="classInstance.html">Instance</a> <span class="keyword">extends</span> <a class="code" href="classBase.html">Base</a> {
00012   var $properties = Array();
00013   var $owner = '';
00014   var $status = '';
00015   var $started;
00016   var $nextActivity;
00017   var $nextUser;
00018   var $ended;
<a name="l00020"></a><a class="code" href="classInstance.html#o7">00020</a>   var <a class="code" href="classInstance.html#o7">$activities</a> = Array();
00021   var $pId;
00022   var $instanceId = 0;
<a name="l00024"></a><a class="code" href="classInstance.html#o10">00024</a>   var <a class="code" href="classInstance.html#o10">$workitems</a> = Array(); 
00025   
00026   function <a class="code" href="classInstance.html">Instance</a>($db) {
00027     $this-&gt;db = $db;
00028   }
00029   
<a name="l00033"></a><a class="code" href="classInstance.html#a1">00033</a>   function <a class="code" href="classInstance.html#a1">getInstance</a>($instanceId) {
00034     <span class="comment">// Get the instance data</span>
00035     $query = <span class="stringliteral">"select * from `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instances` where `instanceId`=?"</span>;
00036     $result = $this-&gt;query($query,array($instanceId));
00037     <span class="keywordflow">if</span>(!$result-&gt;numRows()) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00038     $res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC);
00039 
00040                 <span class="comment">//Populate </span>
00041                 $this-&gt;properties = unserialize($res['properties']);
00042                 $this-&gt;status = $res['status'];
00043                 $this-&gt;pId = $res['pId'];
00044                 $this-&gt;instanceId = $res['instanceId'];
00045                 $this-&gt;owner = $res['owner'];
00046                 $this-&gt;started = $res['started'];
00047                 $this-&gt;ended = $res['ended'];
00048                 $this-&gt;nextActivity = $res['nextActivity'];
00049                 $this-&gt;nextUser = $res['nextUser'];
00050     <span class="comment">// Get the activities where the instance is (ids only is ok)</span>
00051     $query = <span class="stringliteral">"select * from `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_activities` where  `instanceId`=?"</span>;
00052                 $result = $this-&gt;query($query,array($instanceId));    
00053                 <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00054                         $this-&gt;activities[]=$res;
00055                 }    
00056   }
00057   
<a name="l00064"></a><a class="code" href="classInstance.html#a2">00064</a>   function <a class="code" href="classInstance.html#a2">setNextActivity</a>($actname) {
00065     $pId = $this-&gt;pId;
00066     $actname=trim($actname);
00067     $aid = $this-&gt;getOne(<span class="stringliteral">"select `activityId` from `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities` where `pId`=? and `name`=?"</span>,array($pId,$actname));
00068     <span class="keywordflow">if</span>(!$this-&gt;getOne(<span class="stringliteral">"select count(*) from `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities` where `activityId`=? and `pId`=?"</span>,array($aid,$pId))) {
00069         trigger_error(tra('Fatal error: setting next activity to an unexisting activity'),E_USER_WARNING);
00070     }
00071     $this-&gt;nextActivity=$aid;
00072     $query = <span class="stringliteral">"update `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instances` set `nextActivity`=? where `instanceId`=?"</span>;
00073     $this-&gt;query($query,array($aid,$this-&gt;instanceId));
00074   }
00075 
<a name="l00081"></a><a class="code" href="classInstance.html#a3">00081</a>   function <a class="code" href="classInstance.html#a3">setNextUser</a>($user) {
00082     $pId = $this-&gt;pId;
00083     $this-&gt;nextUser = $user;
00084     $query = <span class="stringliteral">"update `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instances` set `nextUser`=? where `instanceId`=?"</span>;
00085     $this-&gt;query($query,array($user,$this-&gt;instanceId));
00086   }
00087  
00094   function _createNewInstance($activityId,$user) {
00095         <span class="comment">// Creates a new instance setting up started,ended,user</span>
00096         <span class="comment">// and status</span>
00097         $pid = $this-&gt;getOne(<span class="stringliteral">"select `pId` from `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities` where `activityId`=?"</span>,array($activityId));
00098         $this-&gt;status = 'active';
00099         $this-&gt;nextActivity = 0;
00100         $this-&gt;setNextUser('');
00101         $this-&gt;pId = $pid;
00102         $now = date(<span class="stringliteral">"U"</span>);
00103         $this-&gt;started=$now;
00104         $this-&gt;owner = $user;
00105         $props=serialize($this-&gt;properties);
00106                 $query = <span class="stringliteral">"insert into `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instances`(`started`,`ended`,`status`,`pId`,`owner`,`properties`) values(?,?,?,?,?,?)"</span>;
00107         $this-&gt;query($query,array($now,0,'active',$pid,$user,$props));
00108         $this-&gt;instanceId = $this-&gt;getOne(<span class="stringliteral">"select max(`instanceId`) from `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instances` where `started`=? and `owner`=?"</span>,array($now,$user));
00109         $iid=$this-&gt;instanceId;
00110         
00111         <span class="comment">// Now update the properties!</span>
00112     $props = serialize($this-&gt;properties);
00113     $query = <span class="stringliteral">"update `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instances` set `properties`=? where `instanceId`=?"</span>;
00114     $this-&gt;query($query,array($props,$iid));
00115 
00116         <span class="comment">// Then add in ".GALAXIA_TABLE_PREFIX."instance_activities an entry for the</span>
00117         <span class="comment">// activity the user and status running and started now</span>
00118         $query = <span class="stringliteral">"insert into `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_activities`(`instanceId`,`activityId`,`user`,`started`,`status`) values(?,?,?,?,?)"</span>;
00119         $this-&gt;query($query,array($iid,$activityId,$user,$now,'running'));
00120   }
00121   
<a name="l00126"></a><a class="code" href="classInstance.html#a4">00126</a>   function <a class="code" href="classInstance.html#a4">set</a>($name,$value) {
00127     $this-&gt;properties[$name] = $value;
00128     $props = serialize($this-&gt;properties);
00129     $query = <span class="stringliteral">"update `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instances` set `properties`=? where `instanceId`=?"</span>;
00130     $this-&gt;query($query,array($props,$this-&gt;instanceId));
00131   }
00132   
<a name="l00136"></a><a class="code" href="classInstance.html#a5">00136</a>   function <a class="code" href="classInstance.html#a5">get</a>($name) {
00137     <span class="keywordflow">if</span>(isset($this-&gt;properties[$name])) {
00138       <span class="keywordflow">return</span> $this-&gt;properties[$name];
00139     } <span class="keywordflow">else</span> {
00140       <span class="keywordflow">return</span> <span class="keyword">false</span>;
00141     }
00142   }
00143   
<a name="l00148"></a><a class="code" href="classInstance.html#a6">00148</a>   function <a class="code" href="classInstance.html#a6">getActivities</a>() {
00149     <span class="keywordflow">return</span> $this-&gt;activities;
00150   }
00151   
<a name="l00156"></a><a class="code" href="classInstance.html#a7">00156</a>   function <a class="code" href="classInstance.html#a7">getStatus</a>() {
00157     <span class="keywordflow">return</span> $this-&gt;status;
00158   }
00159   
<a name="l00164"></a><a class="code" href="classInstance.html#a8">00164</a>   function <a class="code" href="classInstance.html#a8">setStatus</a>($status) {
00165     $this-&gt;status = $status; 
00166     <span class="comment">// and update the database</span>
00167     $query = <span class="stringliteral">"update `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instances` set `status`=? where `instanceId`=?"</span>;
00168     $this-&gt;query($query,array($status,$this-&gt;instanceId));  
00169   }
00170   
<a name="l00174"></a><a class="code" href="classInstance.html#a9">00174</a>   function <a class="code" href="classInstance.html#a9">getInstanceId</a>() {
00175     <span class="keywordflow">return</span> $this-&gt;instanceId;
00176   }
00177   
<a name="l00181"></a><a class="code" href="classInstance.html#a10">00181</a>   function <a class="code" href="classInstance.html#a10">getProcessId</a>() {
00182         <span class="keywordflow">return</span> $this-&gt;pId;
00183   }
00184   
<a name="l00188"></a><a class="code" href="classInstance.html#a11">00188</a>   function <a class="code" href="classInstance.html#a11">getOwner</a>() {
00189     <span class="keywordflow">return</span> $this-&gt;owner;
00190   }
00191   
<a name="l00195"></a><a class="code" href="classInstance.html#a12">00195</a>   function <a class="code" href="classInstance.html#a12">setOwner</a>($user) {
00196     $this-&gt;owner = $user;
00197     <span class="comment">// save database</span>
00198     $query = <span class="stringliteral">"update `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instances` set `owner`=? where `instanceId`=?"</span>;
00199     $this-&gt;query($query,array($owner,$this-&gt;instanceId));  
00200   }
00201   
<a name="l00207"></a><a class="code" href="classInstance.html#a13">00207</a>   function <a class="code" href="classInstance.html#a13">setActivityUser</a>($activityId,$theuser) {
00208     <span class="keywordflow">if</span>(empty($theuser)) $theuser=<span class="charliteral">'*'</span>;
00209                 <span class="keywordflow">for</span>($i=0;$i&lt;count($this-&gt;activities);$i++) {
00210                         <span class="keywordflow">if</span>($this-&gt;activities[$i]['activityId']==$activityId) {
00211                                 $this-&gt;activities[$i]['user']=$theuser;
00212                                 $query = <span class="stringliteral">"update `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_activities` set `user`=? where `activityId`=? and `instanceId`=?"</span>;
00213 
00214                                 $this-&gt;query($query,array($theuser,$activityId,$this-&gt;instanceId));
00215                         }
00216                 }  
00217   }
00218   
<a name="l00223"></a><a class="code" href="classInstance.html#a14">00223</a>   function <a class="code" href="classInstance.html#a14">getActivityUser</a>($activityId) {
00224                 <span class="keywordflow">for</span>($i=0;$i&lt;count($this-&gt;activities);$i++) {
00225                         <span class="keywordflow">if</span>($this-&gt;activities[$i]['activityId']==$activityId) {
00226                                 <span class="keywordflow">return</span> $this-&gt;activities[$i]['user'];
00227                         }
00228                 }  
00229                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00230   }
00231 
<a name="l00236"></a><a class="code" href="classInstance.html#a15">00236</a>   function <a class="code" href="classInstance.html#a15">setActivityStatus</a>($activityId,$status) {
00237                 <span class="keywordflow">for</span>($i=0;$i&lt;count($this-&gt;activities);$i++) {
00238                         <span class="keywordflow">if</span>($this-&gt;activities[$i]['activityId']==$activityId) {
00239                                 $this-&gt;activities[$i]['status']=$status;
00240                                 $query = <span class="stringliteral">"update `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_activities` set `status`=? where `activityId`=? and `instanceId`=?"</span>;
00241                                 $this-&gt;query($query,array($status,$activityId,$this-&gt;instanceId));
00242                         }
00243                 }  
00244   }
00245   
00246   
<a name="l00251"></a><a class="code" href="classInstance.html#a16">00251</a>   function <a class="code" href="classInstance.html#a16">getActivityStatus</a>($activityId) {
00252                 <span class="keywordflow">for</span>($i=0;$i&lt;count($this-&gt;activities);$i++) {
00253                         <span class="keywordflow">if</span>($this-&gt;activities[$i]['activityId']==$activityId) {
00254                                 <span class="keywordflow">return</span> $this-&gt;activities[$i]['status'];
00255                         }
00256                 }  
00257                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00258   }
00259   
<a name="l00263"></a><a class="code" href="classInstance.html#a17">00263</a>   function <a class="code" href="classInstance.html#a17">setActivityStarted</a>($activityId) {
00264         $now = date(<span class="stringliteral">"U"</span>);
00265                 <span class="keywordflow">for</span>($i=0;$i&lt;count($this-&gt;activities);$i++) {
00266                         <span class="keywordflow">if</span>($this-&gt;activities[$i]['activityId']==$activityId) {
00267                                 $this-&gt;activities[$i]['started']=$now;
00268                                 $query = <span class="stringliteral">"update `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_activities` set `started`=? where `activityId`=? and `instanceId`=?"</span>;
00269                                 $this-&gt;query($query,array($now,$activityId,$this-&gt;instanceId));
00270                         }
00271                 }  
00272   }
00273   
<a name="l00277"></a><a class="code" href="classInstance.html#a18">00277</a>   function <a class="code" href="classInstance.html#a18">getActivityStarted</a>($activityId) {
00278                 <span class="keywordflow">for</span>($i=0;$i&lt;count($this-&gt;activities);$i++) {
00279                         <span class="keywordflow">if</span>($this-&gt;activities[$i]['activityId']==$activityId) {
00280                                 <span class="keywordflow">return</span> $this-&gt;activities[$i]['started'];
00281                         }
00282                 }  
00283                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00284   }
00285   
00290   function _get_instance_activity($activityId) {
00291                 <span class="keywordflow">for</span>($i=0;$i&lt;count($this-&gt;activities);$i++) {
00292                         <span class="keywordflow">if</span>($this-&gt;activities[$i]['activityId']==$activityId) {
00293                                 <span class="keywordflow">return</span> $this-&gt;activities[$i];
00294                         }
00295                 }  
00296                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00297   }
00298 
<a name="l00302"></a><a class="code" href="classInstance.html#a19">00302</a>   function <a class="code" href="classInstance.html#a19">setStarted</a>($time) {
00303     $this-&gt;started=$time;
00304     $query = <span class="stringliteral">"update `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instances` set `started`=? where `instanceId`=?"</span>;
00305     $this-&gt;query($query,array($time,$this-&gt;instanceId));    
00306   }
00307   
<a name="l00311"></a><a class="code" href="classInstance.html#a20">00311</a>   function <a class="code" href="classInstance.html#a20">getStarted</a>() {
00312     <span class="keywordflow">return</span> $this-&gt;started;
00313   }
00314   
<a name="l00318"></a><a class="code" href="classInstance.html#a21">00318</a>   function <a class="code" href="classInstance.html#a21">setEnded</a>($time) {
00319         $this-&gt;ended=$time;
00320     $query = <span class="stringliteral">"update `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instances` set `ended`=? where `instanceId`=?"</span>;
00321     $this-&gt;query($query,array($time,$this-&gt;instanceId));    
00322   }
00323   
<a name="l00327"></a><a class="code" href="classInstance.html#a22">00327</a>   function <a class="code" href="classInstance.html#a22">getEnded</a>() {
00328     <span class="keywordflow">return</span> $this-&gt;ended;
00329   }
00330   
<a name="l00347"></a><a class="code" href="classInstance.html#a23">00347</a>   function <a class="code" href="classInstance.html#a23">complete</a>($activityId=0,$force=<span class="keyword">false</span>,$addworkitem=<span class="keyword">true</span>) {
00348         global $user;
00349         global $__activity_completed;
00350         
00351                 $__activity_completed = <span class="keyword">true</span>;
00352         
00353         <span class="keywordflow">if</span>(empty($user)) {$theuser=<span class="charliteral">'*'</span>;} <span class="keywordflow">else</span> {$theuser=$user;}
00354         
00355         <span class="keywordflow">if</span>($activityId==0) {
00356           $activityId=$_REQUEST['activityId'];
00357         }       
00358         
00359         <span class="comment">// If we are completing a start activity then the instance must </span>
00360         <span class="comment">// be created first!</span>
00361                 $type = $this-&gt;getOne(<span class="stringliteral">"select `type` from `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities` where `activityId`=?"</span>,array($activityId));       
00362         <span class="keywordflow">if</span>($type=='start') {
00363           $this-&gt;_createNewInstance($activityId,$theuser);
00364         }
00365                 
00366                 <span class="comment">// Now set ended</span>
00367                 $now = date(<span class="stringliteral">"U"</span>);
00368                 $query = <span class="stringliteral">"update `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_activities` set `ended`=? where `activityId`=? and `instanceId`=?"</span>;
00369                 $this-&gt;query($query,array($now,$activityId,$this-&gt;instanceId));
00370         
00371         <span class="comment">//Add a workitem to the instance </span>
00372         $iid = $this-&gt;instanceId;
00373         <span class="keywordflow">if</span>($addworkitem) {
00374                         $max = $this-&gt;getOne(<span class="stringliteral">"select max(`orderId`) from `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"workitems` where `instanceId`=?"</span>,array($iid));
00375                         <span class="keywordflow">if</span>(!$max) {
00376                                 $max=1;
00377                         } <span class="keywordflow">else</span> {
00378                                 $max++;
00379                         }
00380                         $act = $this-&gt;_get_instance_activity($activityId);
00381                         <span class="keywordflow">if</span>(!$act) {
00382                                 <span class="comment">//Then this is a start activity ending</span>
00383                                 $started = $this-&gt;getStarted();
00384                                 $putuser = $this-&gt;getOwner();
00385                         } <span class="keywordflow">else</span> {
00386                                 $started=$act['started'];
00387                                 $putuser = $act['user'];
00388                         }
00389                         $ended = date(<span class="stringliteral">"U"</span>);
00390                         $properties = serialize($this-&gt;properties);
00391                         $query=<span class="stringliteral">"insert into `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"workitems`(`instanceId`,`orderId`,`activityId`,`started`,`ended`,`properties`,`user`) values(?,?,?,?,?,?,?)"</span>;              
00392                         $this-&gt;query($query,array($iid,$max,$activityId,$started,$ended,$properties,$putuser));
00393         }
00394         
00395         <span class="comment">//Set the status for the instance-activity to completed</span>
00396         $this-&gt;setActivityStatus($activityId,'completed');
00397         
00398         <span class="comment">//If this and end actt then terminate the instance</span>
00399         <span class="keywordflow">if</span>($type=='end') {
00400           $this-&gt;terminate();
00401           <span class="keywordflow">return</span>;
00402         }
00403         
00404         <span class="comment">//If the activity ending is autorouted then send to the</span>
00405         <span class="comment">//activity</span>
00406         <span class="keywordflow">if</span> ($type != 'end') {
00407                 <span class="keywordflow">if</span> (($force) || ($this-&gt;getOne(<span class="stringliteral">"select `isAutoRouted` from `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities` where `activityId`=?"</span>,array($activityId)) == <span class="charliteral">'y'</span>))      {
00408                         <span class="comment">// Now determine where to send the instance</span>
00409                         $query = <span class="stringliteral">"select `actToId` from `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"transitions` where `actFromId`=?"</span>;
00410                                 $result = $this-&gt;query($query,array($activityId));
00411                                 $candidates = Array();
00412                                 <span class="keywordflow">while</span> ($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00413                                         $candidates[] = $res['actToId'];
00414                                 }  
00415                                 <span class="keywordflow">if</span>($type == 'split') {
00416                                         $first = <span class="keyword">true</span>;
00417                                         foreach ($candidates as $cand) {
00418                                                 $this-&gt;sendTo($activityId,$cand,$first);
00419                                                 $first = <span class="keyword">false</span>;
00420                                         }
00421                                 } elseif($type == '<span class="keywordflow">switch</span>') {
00422                                         <span class="keywordflow">if</span> (in_array($this-&gt;nextActivity,$candidates)) {
00423                                                 $this-&gt;sendTo($activityId,$this-&gt;nextActivity);
00424                                         } <span class="keywordflow">else</span> {
00425                                                 trigger_error(tra('Fatal error: nextActivity doesn match any candidate in autoruting <span class="keywordflow">switch</span> activity'),E_USER_WARNING);
00426                                         }
00427                                 } <span class="keywordflow">else</span> {
00428                                         <span class="keywordflow">if</span> (count($candidates)&gt;1) {
00429                                                 trigger_error(tra('Fatal error: non-deterministic decision <span class="keywordflow">for</span> autorouting activity'),E_USER_WARNING);
00430                                         } <span class="keywordflow">else</span> {
00431                                                 $this-&gt;sendTo($activityId,$candidates[0]);
00432                                         }
00433                                 }
00434                 }
00435         }
00436   }
00437   
<a name="l00444"></a><a class="code" href="classInstance.html#a24">00444</a>   function <a class="code" href="classInstance.html#a24">terminate</a>() {
00445         <span class="comment">//Set the status of the instance to completed</span>
00446         $now = date(<span class="stringliteral">"U"</span>);
00447         $query = <span class="stringliteral">"update `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instances` set `status`=?, `ended`=? where `instanceId`=?"</span>;
00448         $this-&gt;query($query,array('completed',$now,$this-&gt;instanceId));
00449         $query = <span class="stringliteral">"delete from `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_activities` where `instanceId`=?"</span>;
00450         $this-&gt;query($query,array($this-&gt;instanceId));
00451         $this-&gt;status = 'completed';
00452         $this-&gt;activities = Array();
00453   }
00454   
00455   
<a name="l00461"></a><a class="code" href="classInstance.html#a25">00461</a>   function <a class="code" href="classInstance.html#a25">sendTo</a>($from,$activityId,$split=<span class="keyword">false</span>) {
00462     <span class="comment">//1: if we are in a join check</span>
00463     <span class="comment">//if this instance is also in</span>
00464     <span class="comment">//other activity if so do</span>
00465     <span class="comment">//nothing</span>
00466                 $type = $this-&gt;getOne(<span class="stringliteral">"select `type` from `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities` where `activityId`=?"</span>,array($activityId));
00467                 
00468                 <span class="comment">// Verify the existance of a transition</span>
00469                 <span class="keywordflow">if</span>(!$this-&gt;getOne(<span class="stringliteral">"select count(*) from `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"transitions` where `actFromId`=? and `actToId`=?"</span>,array($from,$activityId))) {
00470                         trigger_error(tra('Fatal error: trying to send an instance to an activity but no transition found'),E_USER_WARNING);
00471                 }
00472     
00473     <span class="comment">//try to determine the user or *</span>
00474     <span class="comment">//Use the nextUser</span>
00475     <span class="keywordflow">if</span>($this-&gt;nextUser) {
00476         $putuser = $this-&gt;nextUser;
00477     } <span class="keywordflow">else</span> {
00478             $candidates = Array();
00479             $query = <span class="stringliteral">"select `roleId` from `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activity_roles` where `activityId`=?"</span>;
00480                         $result = $this-&gt;query($query,array($activityId)); 
00481                         <span class="keywordflow">while</span> ($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00482                                 $roleId = $res['roleId'];
00483                                 $query2 = <span class="stringliteral">"select `user` from `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"user_roles` where `roleId`=?"</span>;
00484                                 $result2 = $this-&gt;query($query2,array($roleId)); 
00485                                 <span class="keywordflow">while</span> ($res2 = $result2-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00486                                         $candidates[] = $res2['user'];
00487                                 }
00488                         }
00489                         <span class="keywordflow">if</span>(count($candidates) == 1) {
00490                                 $putuser = $candidates[0];
00491                         } <span class="keywordflow">else</span> {
00492                                 $putuser = <span class="charliteral">'*'</span>;
00493                         }
00494                 }        
00495     <span class="comment">//update the instance_activities table</span>
00496     <span class="comment">//if not splitting delete first</span>
00497     <span class="comment">//please update started,status,user</span>
00498     <span class="keywordflow">if</span>(!$split) {
00499       $query = <span class="stringliteral">"delete from `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_activities` where `instanceId`=? and `activityId`=?"</span>;
00500       $this-&gt;query($query,array($this-&gt;instanceId,$from));
00501                 }
00502     $now = date(<span class="stringliteral">"U"</span>);
00503     $iid = $this-&gt;instanceId;
00504     $query=<span class="stringliteral">"replace into `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_activities`(`instanceId`,`activityId`,`user`,`status`,`started`) values(?,?,?,?,?)"</span>;
00505     $this-&gt;query($query,array($iid,$activityId,$putuser,'running',$now));
00506     
00507     <span class="comment">//we are now in a new activity</span>
00508     $this-&gt;activities=Array();
00509     $query = <span class="stringliteral">"select * from `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_activities` where `instanceId`=?"</span>;
00510                 $result = $this-&gt;query($query,array($iid));
00511                 <span class="keywordflow">while</span> ($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00512                         $this-&gt;activities[]=$res;
00513                 }    
00514         
00515                 <span class="keywordflow">if</span> ($type == 'join') {
00516                         <span class="keywordflow">if</span> (count($this-&gt;activities)&gt;1) {
00517                                 <span class="comment">// This instance will have to wait!</span>
00518                                 <span class="keywordflow">return</span>;
00519                         }
00520                 }    
00521 
00522      
00523     <span class="comment">//if the activity is not interactive then</span>
00524                 <span class="comment">//execute the code for the activity and</span>
00525                 <span class="comment">//complete the activity</span>
00526     $isInteractive = $this-&gt;getOne(<span class="stringliteral">"select `isInteractive` from `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities` where `activityId`=?"</span>,array($activityId));
00527     <span class="keywordflow">if</span> ($isInteractive==<span class="charliteral">'n'</span>) {
00528 
00529       <span class="comment">// Now execute the code for the activity (function defined in lib/Galaxia/config.php)</span>
00530       galaxia_execute_activity($activityId, $iid , 1);
00531 
00532       <span class="comment">// Reload in case the activity did some change</span>
00533       $this-&gt;getInstance($this-&gt;instanceId);
00534       $this-&gt;complete($activityId);
00535     }
00536   }
00537   
<a name="l00541"></a><a class="code" href="classInstance.html#a26">00541</a>   function <a class="code" href="classInstance.html#a26">get_instance_comment</a>($cId) {
00542     $iid = $this-&gt;instanceId;
00543     $query = <span class="stringliteral">"select * from `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_comments` where `instanceId`=? and `cId`=?"</span>;
00544     $result = $this-&gt;query($query,array($iid,$cId));
00545                 $res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC);
00546                 <span class="keywordflow">return</span> $res;
00547   }
00548   
<a name="l00552"></a><a class="code" href="classInstance.html#a27">00552</a>   function <a class="code" href="classInstance.html#a27">replace_instance_comment</a>($cId, $activityId, $activity, $user, $title, $comment) {
00553     <span class="keywordflow">if</span> (!$user) {
00554                         $user = 'Anonymous';
00555                 }
00556         $iid = $this-&gt;instanceId;
00557         <span class="keywordflow">if</span> ($cId) {
00558                 $query = <span class="stringliteral">"update `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_comments` set `title`=?,`comment`=? where `instanceId`=? and `cId`=?"</span>;
00559                         $this-&gt;query($query,array($title,$comment,$iid,$cId));
00560         } <span class="keywordflow">else</span> {
00561                 $hash = md5($title.$comment);
00562                 <span class="keywordflow">if</span> ($this-&gt;getOne(<span class="stringliteral">"select count(*) from `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_comments` where `instanceId`=? and `hash`=?"</span>,array($iid,$hash))) {
00563                                 <span class="keywordflow">return</span> <span class="keyword">false</span>;
00564                         }
00565                         $now = date(<span class="stringliteral">"U"</span>);
00566                         $query =<span class="stringliteral">"insert into `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_comments`(`instanceId`,`user`,`activityId`,`activity`,`title`,`comment`,`timestamp`,`hash`) values(?,?,?,?,?,?,?,?)"</span>;
00567                         $this-&gt;query($query,array($iid,$user,$activityId,$activity,$title,$comment,$now,$hash));
00568         }  
00569   }
00570   
<a name="l00574"></a><a class="code" href="classInstance.html#a28">00574</a>   function <a class="code" href="classInstance.html#a28">remove_instance_comment</a>($cId) {
00575     $iid = $this-&gt;instanceId;
00576     $query = <span class="stringliteral">"delete from `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_comments` where `cId`=? and `instanceId`=?"</span>;
00577     $this-&gt;query($query,array($cId,$iid));
00578   }
00579  
<a name="l00583"></a><a class="code" href="classInstance.html#a29">00583</a>   function <a class="code" href="classInstance.html#a29">get_instance_comments</a>() {
00584     $iid = $this-&gt;instanceId;
00585     $query = <span class="stringliteral">"select * from `"</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_comments` where `instanceId`=? order by "</span>.$this-&gt;convert_sortmode(<span class="stringliteral">"timestamp_desc"</span>);
00586                 $result = $this-&gt;query($query,array($iid));    
00587                 $ret = Array();
00588                 <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {    
00589                         $ret[] = $res;
00590                 }
00591                 <span class="keywordflow">return</span> $ret;
00592   }
00593 
00594 }
00595 ?&gt;
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Sep 30 01:24:12 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
