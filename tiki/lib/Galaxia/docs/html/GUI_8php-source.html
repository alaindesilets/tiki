<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>Galaxia: GUI.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex"><a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="namespaces.html">Namespace List</a> | <a class="qindex" href="hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="classes.html">Alphabetical&nbsp;List</a> | <a class="qindex" href="annotated.html">Class&nbsp;List</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Class&nbsp;Members</a> | <a class="qindex" href="pages.html">Related&nbsp;Pages</a></div>
<h1>GUI.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 include_once(GALAXIA_LIBRARY.'/src/common/<a class="code" href="classBase.html">Base</a>.php');
00005 
<a name="l00008"></a><a class="code" href="classGUI.html">00008</a> <span class="keyword">class </span><a class="code" href="classGUI.html">GUI</a> <span class="keyword">extends</span> <a class="code" href="classBase.html">Base</a> {
00009 
<a name="l00022"></a><a class="code" href="classGUI.html#a0">00022</a>   function <a class="code" href="classGUI.html#a0">gui_list_user_processes</a>($user,$offset,$maxRecords,$sort_mode,$find,$where='')
00023   {
00024     $sort_mode = str_replace(<span class="stringliteral">"_"</span>,<span class="stringliteral">" "</span>,$sort_mode);
00025     <span class="keywordflow">if</span>($find) {
00026       $mid=<span class="stringliteral">" and ((gp.name like '%"</span>.$find.<span class="stringliteral">"%') or (gp.description like '%"</span>.$find.<span class="stringliteral">"%'))"</span>;
00027     } <span class="keywordflow">else</span> {
00028       $mid=<span class="stringliteral">""</span>;
00029     }
00030     <span class="keywordflow">if</span>($where) {
00031       <span class="keywordflow">if</span>($mid) {
00032         $mid.= <span class="stringliteral">" and ($where) "</span>;
00033       } <span class="keywordflow">else</span> {
00034         $mid.= <span class="stringliteral">" and ($where) "</span>;
00035       }
00036     }
00037     
00038     $query = <span class="stringliteral">"select distinct(gp.pId), </span>
00039 <span class="stringliteral">                                 gp.isActive,                    </span>
00040 <span class="stringliteral">                     gp.name as procname, </span>
00041 <span class="stringliteral">                     gp.normalized_name as normalized_name, </span>
00042 <span class="stringliteral">                     gp.version as version</span>
00043 <span class="stringliteral">              from</span>
00044 <span class="stringliteral">                "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"processes gp INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities ga ON gp.pId=ga.pId</span>
00045 <span class="stringliteral">                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activity_roles gar ON gar.activityId=ga.activityId</span>
00046 <span class="stringliteral">                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"roles gr ON gr.roleId=gar.roleId</span>
00047 <span class="stringliteral">                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"user_roles gur ON gur.roleId=gr.roleId</span>
00048 <span class="stringliteral">              where gp.isActive='y' and user='$user'</span>
00049 <span class="stringliteral">                            $mid order by $sort_mode limit $offset,$maxRecords"</span>;
00050     $query_cant = <span class="stringliteral">"select count(distinct(gp.pId)) from</span>
00051 <span class="stringliteral">                "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"processes gp INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities ga ON gp.pId=ga.pId</span>
00052 <span class="stringliteral">                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activity_roles gar ON gar.activityId=ga.activityId</span>
00053 <span class="stringliteral">                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"roles gr ON gr.roleId=gar.roleId</span>
00054 <span class="stringliteral">                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"user_roles gur ON gur.roleId=gr.roleId</span>
00055 <span class="stringliteral">              where gp.isActive='y' and gur.user='$user' $mid"</span>;
00056     $result = $this-&gt;query($query);
00057     $cant = $this-&gt;getOne($query_cant);
00058     $ret = Array();
00059     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00060       <span class="comment">// Get instances per activity</span>
00061       $pId=$res['pId'];
00062       $res['activities']=$this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"processes gp INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities ga ON gp.pId=ga.pId INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activity_roles gar ON gar.activityId=ga.activityId</span>
00063 <span class="stringliteral">                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"roles gr ON gr.roleId=gar.roleId</span>
00064 <span class="stringliteral">                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"user_roles gur ON gur.roleId=gr.roleId</span>
00065 <span class="stringliteral">                where gp.pId=$pId and gur.user='$user'"</span>);
00066           $res['instances']=$this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instances gi INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_activities gia ON gi.instanceId=gia.instanceId INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activity_roles gar ON gia.activityId=gar.activityId INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"user_roles gur ON gar.roleId=gur.roleId where gi.pId=$pId and ((gia.user='$user') or (gia.user='*' and gur.user='$user'))"</span>);                  
00067       $ret[] = $res;
00068     }
00069     $retval = Array();
00070     $retval[<span class="stringliteral">"data"</span>] = $ret;
00071     $retval[<span class="stringliteral">"cant"</span>] = $cant;
00072     <span class="keywordflow">return</span> $retval;
00073   }
00074 
00075 
00076   function gui_list_user_activities($user,$offset,$maxRecords,$sort_mode,$find,$where='')
00077   {
00078     $sort_mode = str_replace(<span class="stringliteral">"_"</span>,<span class="stringliteral">" "</span>,$sort_mode);
00079     <span class="keywordflow">if</span>($find) {
00080       $mid=<span class="stringliteral">" and ((name like '%"</span>.$find.<span class="stringliteral">"%') or (description like '%"</span>.$find.<span class="stringliteral">"%'))"</span>;
00081     } <span class="keywordflow">else</span> {
00082       $mid=<span class="stringliteral">""</span>;
00083     }
00084     <span class="keywordflow">if</span>($where) {
00085       <span class="keywordflow">if</span>($mid) {
00086         $mid.= <span class="stringliteral">" and ($where) "</span>;
00087       } <span class="keywordflow">else</span> {
00088         $mid.= <span class="stringliteral">" and ($where) "</span>;
00089       }
00090     }
00091     
00092     $query = <span class="stringliteral">"select distinct(ga.activityId),                     </span>
00093 <span class="stringliteral">                                 ga.name,</span>
00094 <span class="stringliteral">                                 ga.type,</span>
00095 <span class="stringliteral">                     gp.name as procname, </span>
00096 <span class="stringliteral">                     ga.isInteractive,</span>
00097 <span class="stringliteral">                     ga.isAutoRouted,</span>
00098 <span class="stringliteral">                     ga.activityId,</span>
00099 <span class="stringliteral">                     gp.version as version,</span>
00100 <span class="stringliteral">                     gp.pId,</span>
00101 <span class="stringliteral">                     gp.isActive</span>
00102 <span class="stringliteral">              from</span>
00103 <span class="stringliteral">                "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"processes gp INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities ga ON gp.pId=ga.pId</span>
00104 <span class="stringliteral">                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activity_roles gar ON gar.activityId=ga.activityId</span>
00105 <span class="stringliteral">                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"roles gr ON gr.roleId=gar.roleId</span>
00106 <span class="stringliteral">                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"user_roles gur ON gur.roleId=gr.roleId</span>
00107 <span class="stringliteral">              where gp.isActive='y' and user='$user'</span>
00108 <span class="stringliteral">                            $mid order by $sort_mode limit $offset,$maxRecords"</span>;
00109     $query_cant = <span class="stringliteral">"select count(distinct(ga.activityId)) from</span>
00110 <span class="stringliteral">                "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"processes gp INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities ga ON gp.pId=ga.pId</span>
00111 <span class="stringliteral">                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activity_roles gar ON gar.activityId=ga.activityId</span>
00112 <span class="stringliteral">                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"roles gr ON gr.roleId=gar.roleId</span>
00113 <span class="stringliteral">                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"user_roles gur ON gur.roleId=gr.roleId</span>
00114 <span class="stringliteral">              where gp.isActive='y' and gur.user='$user' $mid"</span>;
00115     $result = $this-&gt;query($query);
00116     $cant = $this-&gt;getOne($query_cant);
00117     $ret = Array();
00118     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00119       <span class="comment">// Get instances per activity</span>
00120           $res['instances']=$this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instances gi INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_activities gia ON gi.instanceId=gia.instanceId INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activity_roles gar ON gia.activityId=gar.activityId INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"user_roles gur ON gar.roleId=gur.roleId where gia.activityId="</span>.$res['activityId'].<span class="stringliteral">" and ((gia.user='$user') or (gia.user='*' and gur.user='$user'))"</span>);                
00121       $ret[] = $res;
00122     }
00123     $retval = Array();
00124     $retval[<span class="stringliteral">"data"</span>] = $ret;
00125     $retval[<span class="stringliteral">"cant"</span>] = $cant;
00126     <span class="keywordflow">return</span> $retval;
00127   }
00128 
00129 
00130   function gui_list_user_instances($user,$offset,$maxRecords,$sort_mode,$find,$where='')
00131   {
00132     $sort_mode = str_replace(<span class="stringliteral">"_"</span>,<span class="stringliteral">" "</span>,$sort_mode);
00133     <span class="keywordflow">if</span>($find) {
00134       $mid=<span class="stringliteral">" and ((name like '%"</span>.$find.<span class="stringliteral">"%') or (description like '%"</span>.$find.<span class="stringliteral">"%'))"</span>;
00135     } <span class="keywordflow">else</span> {
00136       $mid=<span class="stringliteral">""</span>;
00137     }
00138     <span class="keywordflow">if</span>($where) {
00139       <span class="keywordflow">if</span>($mid) {
00140         $mid.= <span class="stringliteral">" and ($where) "</span>;
00141       } <span class="keywordflow">else</span> {
00142         $mid.= <span class="stringliteral">" and ($where) "</span>;
00143       }
00144     }
00145     
00146     $query = <span class="stringliteral">"select distinct(gi.instanceId),                     </span>
00147 <span class="stringliteral">                                 gi.started,</span>
00148 <span class="stringliteral">                                 gi.owner,</span>
00149 <span class="stringliteral">                                 gia.user,</span>
00150 <span class="stringliteral">                                 gi.status,</span>
00151 <span class="stringliteral">                                 gia.status as actstatus,</span>
00152 <span class="stringliteral">                                 ga.name,</span>
00153 <span class="stringliteral">                                 ga.type,</span>
00154 <span class="stringliteral">                     gp.name as procname, </span>
00155 <span class="stringliteral">                     ga.isInteractive,</span>
00156 <span class="stringliteral">                     ga.isAutoRouted,</span>
00157 <span class="stringliteral">                     ga.activityId,</span>
00158 <span class="stringliteral">                     gp.version as version,</span>
00159 <span class="stringliteral">                     gp.pId</span>
00160 <span class="stringliteral">              from</span>
00161 <span class="stringliteral">                                "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instances gi </span>
00162 <span class="stringliteral">                                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_activities gia ON gi.instanceId=gia.instanceId</span>
00163 <span class="stringliteral">                                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities ga ON gia.activityId = ga.activityId</span>
00164 <span class="stringliteral">                                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activity_roles gar ON gia.activityId=gar.activityId</span>
00165 <span class="stringliteral">                                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"user_roles gur ON gur.roleId=gar.roleId</span>
00166 <span class="stringliteral">                                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"processes gp ON gp.pId=ga.pId</span>
00167 <span class="stringliteral">                                where (gia.user='$user' or (gia.user='*' and gur.user='$user')) $mid order by $sort_mode limit $offset,$maxRecords"</span>;
00168     $query_cant = <span class="stringliteral">"select count(distinct(gi.instanceId)) from</span>
00169 <span class="stringliteral">                                                                "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instances gi </span>
00170 <span class="stringliteral">                                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_activities gia ON gi.instanceId=gia.instanceId</span>
00171 <span class="stringliteral">                                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activities ga ON gia.activityId = ga.activityId</span>
00172 <span class="stringliteral">                                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activity_roles gar ON gia.activityId=gar.activityId</span>
00173 <span class="stringliteral">                                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"user_roles gur ON gur.roleId=gar.roleId</span>
00174 <span class="stringliteral">                                INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"processes gp ON gp.pId=ga.pId</span>
00175 <span class="stringliteral">                                where (gia.user='$user' or (gia.user='*' and gur.user='$user')) $mid "</span>;
00176     $result = $this-&gt;query($query);
00177     $cant = $this-&gt;getOne($query_cant);
00178     $ret = Array();
00179     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00180       <span class="comment">// Get instances per activity</span>
00181       $ret[] = $res;
00182     }
00183     $retval = Array();
00184     $retval[<span class="stringliteral">"data"</span>] = $ret;
00185     $retval[<span class="stringliteral">"cant"</span>] = $cant;
00186     <span class="keywordflow">return</span> $retval;
00187   }
00188 
00189   function gui_abort_instance($user,$activityId,$instanceId)
00190   {
00191     <span class="comment">// Users can only abort instances belonging to them</span>
00192         <span class="keywordflow">if</span>(!$this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_activities where activityId=$activityId and instanceId=$instanceId and user='$user'"</span>)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00193         $query = <span class="stringliteral">"update "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instances set status='aborted' where instanceId=$instanceId"</span>;
00194         $this-&gt;query($query);
00195                 
00196   }
00197   
00198   function gui_exception_instance($user,$activityId,$instanceId)
00199   {
00200     <span class="comment">// Users can only abort instances belonging to them</span>
00201         <span class="keywordflow">if</span>(!$this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_activities where activityId=$activityId and instanceId=$instanceId and user='$user'"</span>)) <span class="keywordflow">return</span> <span class="keyword">false</span>;   
00202     $query = <span class="stringliteral">"update "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instances set status='exception' where instanceId=$instanceId"</span>;
00203         $this-&gt;query($query);
00204   }
00205 
00206   
00207   function gui_send_instance($user,$activityId,$instanceId)
00208   {
00209         <span class="keywordflow">if</span>(!
00210           ($this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_activities where activityId=$activityId and instanceId=$instanceId and user='$user'"</span>))
00211           ||
00212           ($this-&gt;getOne(<span class="stringliteral">"select count(*) </span>
00213 <span class="stringliteral">                          from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_activities gia</span>
00214 <span class="stringliteral">                          INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activity_roles gar ON gar.activityId=gia.activityId</span>
00215 <span class="stringliteral">                          INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"user_roles gur ON gar.roleId=gur.roleId</span>
00216 <span class="stringliteral">                          where gia.instanceId=$instanceId and gia.activityId=$activityId and gia.user='*' and gur.user='$user'</span>
00217 <span class="stringliteral">                                         "</span>))
00218           )
00219           <span class="keywordflow">return</span> <span class="keyword">false</span>; 
00220     include_once(GALAXIA_LIBRARY.'/src/API/<a class="code" href="classInstance.html">Instance</a>.php');
00221     $instance = <span class="keyword">new</span> <a class="code" href="classInstance.html">Instance</a>($this-&gt;db);
00222     $instance-&gt;getInstance($instanceId);
00223     $instance-&gt;complete($activityId,<span class="keyword">true</span>,<span class="keyword">false</span>);
00224     unset($instance);  
00225   }
00226   
00227   function gui_release_instance($user,$activityId,$instanceId)
00228   {
00229         <span class="keywordflow">if</span>(!$this-&gt;getOne(<span class="stringliteral">"select count(*) from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_activities where activityId=$activityId and instanceId=$instanceId and user='$user'"</span>)) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00230         $query = <span class="stringliteral">"update "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_activities set user='*' where instanceId=$instanceId and activityId=$activityId"</span>;
00231         $this-&gt;query($query);    
00232   }
00233   
00234   function gui_grab_instance($user,$activityId,$instanceId)
00235   {
00236         <span class="comment">// Grab only if roles are ok  </span>
00237         <span class="keywordflow">if</span>(!$this-&gt;getOne(<span class="stringliteral">"select count(*) </span>
00238 <span class="stringliteral">                          from "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_activities gia</span>
00239 <span class="stringliteral">                          INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"activity_roles gar ON gar.activityId=gia.activityId</span>
00240 <span class="stringliteral">                          INNER JOIN "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"user_roles gur ON gar.roleId=gur.roleId</span>
00241 <span class="stringliteral">                          where gia.instanceId=$instanceId and gia.activityId=$activityId and gia.user='*' and gur.user='$user'</span>
00242 <span class="stringliteral">                                         "</span>))    <span class="keywordflow">return</span> <span class="keyword">false</span>;
00243         $query = <span class="stringliteral">"update "</span>.GALAXIA_TABLE_PREFIX.<span class="stringliteral">"instance_activities set user='$user' where instanceId=$instanceId and activityId=$activityId"</span>;
00244         $this-&gt;query($query);    
00245   }
00246 }
00247 ?&gt;
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Sep 30 01:24:12 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
