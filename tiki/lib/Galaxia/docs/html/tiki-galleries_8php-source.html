<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>tiki-galleries.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>tiki-galleries.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 <span class="comment">// Initialization</span>
00003 require_once('tiki-setup.php');
00004 include_once(<span class="stringliteral">"lib/imagegals/imagegallib.php"</span>);
00005 
00006 <span class="comment">// Now check permissions to access this page</span>
00007 <span class="comment">/*</span>
00008 <span class="comment">if($tiki_p_view != 'y') {</span>
00009 <span class="comment">  $smarty-&gt;assign('msg',tra("Permission denied you cannot view pages like this page"));</span>
00010 <span class="comment">  $smarty-&gt;display("styles/$style_base/error.tpl");</span>
00011 <span class="comment">  die;  </span>
00012 <span class="comment">}</span>
00013 <span class="comment">*/</span>
00014 
00015 <span class="keywordflow">if</span>($feature_galleries != <span class="charliteral">'y'</span>) {
00016   $smarty-&gt;assign('msg',tra(<span class="stringliteral">"This feature is disabled"</span>));
00017   $smarty-&gt;display(<span class="stringliteral">"styles/$style_base/error.tpl"</span>);
00018   die;  
00019 }
00020 
00021 
00022 <span class="keywordflow">if</span>(isset($_REQUEST[<span class="stringliteral">"find"</span>])) {
00023   $find = $_REQUEST[<span class="stringliteral">"find"</span>];  
00024 } <span class="keywordflow">else</span> {
00025   $find = ''; 
00026 }
00027 $smarty-&gt;assign('find',$find);
00028 
00029 <span class="keywordflow">if</span>(!isset($_REQUEST[<span class="stringliteral">"galleryId"</span>])) {
00030   $_REQUEST[<span class="stringliteral">"galleryId"</span>] = 0;
00031 }
00032 $smarty-&gt;assign('galleryId',$_REQUEST[<span class="stringliteral">"galleryId"</span>]);
00033 
00034 <span class="comment">// This check should be done before checking individual permissions</span>
00035 <span class="keywordflow">if</span>($tiki_p_view_image_gallery != <span class="charliteral">'y'</span>) {
00036   $smarty-&gt;assign('msg',tra(<span class="stringliteral">"Permission denied you can not view this section"</span>));
00037   $smarty-&gt;display(<span class="stringliteral">"styles/$style_base/error.tpl"</span>);
00038   die;  
00039 }
00040 
00041 <span class="comment">// Individual permissions are checked because we may be trying to edit the gallery</span>
00042 
00043 <span class="comment">// Check here for indivdual permissions the objectType is 'image galleries' and the id is galleryId</span>
00044 $smarty-&gt;assign('individual<span class="charliteral">','</span>n');
00045 <span class="keywordflow">if</span>($userlib-&gt;object_has_one_permission($_REQUEST[<span class="stringliteral">"galleryId"</span>],'image gallery')) {
00046   $smarty-&gt;assign('individual<span class="charliteral">','</span>y');
00047   <span class="keywordflow">if</span>($tiki_p_admin != <span class="charliteral">'y'</span>) {
00048     <span class="comment">// Now get all the permissions that are set for this type of permissions 'image gallery'</span>
00049     $perms = $userlib-&gt;get_permissions(0,-1,'permName_desc<span class="charliteral">','</span><span class="charliteral">','</span>image galleries');
00050     foreach($perms[<span class="stringliteral">"data"</span>] as $perm) {
00051       $permName=$perm[<span class="stringliteral">"permName"</span>];
00052       <span class="keywordflow">if</span>($userlib-&gt;object_has_permission($user,$_REQUEST[<span class="stringliteral">"galleryId"</span>],'image gallery',$permName)) {
00053         $$permName = <span class="charliteral">'y'</span>;
00054         $smarty-&gt;assign(<span class="stringliteral">"$permName"</span>,<span class="charliteral">'y'</span>);
00055       } <span class="keywordflow">else</span> {
00056         $$permName = <span class="charliteral">'n'</span>;
00057         $smarty-&gt;assign(<span class="stringliteral">"$permName"</span>,<span class="charliteral">'n'</span>);
00058       }
00059     }
00060   }
00061 }
00062 
00063 
00064 
00065 $foo = parse_url($_SERVER[<span class="stringliteral">"REQUEST_URI"</span>]);
00066 $foo[<span class="stringliteral">"path"</span>]=str_replace(<span class="stringliteral">"tiki-galleries"</span>,<span class="stringliteral">"tiki-browse_gallery"</span>,$foo[<span class="stringliteral">"path"</span>]);
00067 $smarty-&gt;assign('url',httpPrefix().$foo[<span class="stringliteral">"path"</span>]);
00068 
00069 <span class="comment">// Init smarty variables to blank values</span>
00070 <span class="comment">//$smarty-&gt;assign('theme','');</span>
00071 $smarty-&gt;assign('name<span class="charliteral">','</span>');
00072 $smarty-&gt;assign('description<span class="charliteral">','</span>');
00073 $smarty-&gt;assign('maxRows',10);
00074 $smarty-&gt;assign('rowImages',6);
00075 $smarty-&gt;assign('thumbSizeX',80);
00076 $smarty-&gt;assign('thumbSizeY',80);
00077 $smarty-&gt;assign('<span class="keyword">public</span><span class="charliteral">','</span>n');
00078 $smarty-&gt;assign('edited<span class="charliteral">','</span>n');
00079 $smarty-&gt;assign('visible<span class="charliteral">','</span>y');
00080 $smarty-&gt;assign('edit_mode<span class="charliteral">','</span>n');
00081 
00082 <span class="comment">// If we are editing an existing gallery prepare smarty variables</span>
00083 <span class="keywordflow">if</span>(isset($_REQUEST[<span class="stringliteral">"edit_mode"</span>])&amp;&amp;$_REQUEST[<span class="stringliteral">"edit_mode"</span>]) {
00084   <span class="comment">// Get information about this galleryID and fill smarty variables</span>
00085   $smarty-&gt;assign('edit_mode<span class="charliteral">','</span>y');
00086   $smarty-&gt;assign('edited<span class="charliteral">','</span>y');
00087   <span class="keywordflow">if</span>($_REQUEST[<span class="stringliteral">"galleryId"</span>]&gt;0) {
00088     $info = $imagegallib-&gt;get_gallery_info($_REQUEST[<span class="stringliteral">"galleryId"</span>]);
00089     $scaleinfo = $imagegallib-&gt;get_gallery_scale_info($_REQUEST[<span class="stringliteral">"galleryId"</span>]);
00090     <span class="comment">//$smarty-&gt;assign_by_ref('theme',$info["theme"]);</span>
00091     $smarty-&gt;assign_by_ref('name',$info[<span class="stringliteral">"name"</span>]);
00092     $smarty-&gt;assign_by_ref('description',$info[<span class="stringliteral">"description"</span>]);
00093     $smarty-&gt;assign_by_ref('maxRows',$info[<span class="stringliteral">"maxRows"</span>]);
00094     $smarty-&gt;assign_by_ref('rowImages',$info[<span class="stringliteral">"rowImages"</span>]);
00095     $smarty-&gt;assign_by_ref('thumbSizeX',$info[<span class="stringliteral">"thumbSizeX"</span>]);
00096     $smarty-&gt;assign_by_ref('thumbSizeY',$info[<span class="stringliteral">"thumbSizeY"</span>]);
00097     $smarty-&gt;assign_by_ref('<span class="keyword">public</span>',$info[<span class="stringliteral">"public"</span>]);
00098     $smarty-&gt;assign_by_ref('visible',$info[<span class="stringliteral">"visible"</span>]);
00099     $smarty-&gt;assign_by_ref('scaleinfo',$scaleinfo);
00100   }
00101 }
00102 
00103 
00104 <span class="comment">// Process the insertion or modification of a gallery here</span>
00105 <span class="keywordflow">if</span>(isset($_REQUEST[<span class="stringliteral">"edit"</span>])) {
00106   <span class="comment">// Saving information</span>
00107   <span class="comment">// If the user is not gallery admin</span>
00108   <span class="keywordflow">if</span>($tiki_p_admin_galleries != <span class="charliteral">'y'</span>) {
00109     <span class="keywordflow">if</span>($tiki_p_create_galleries != <span class="charliteral">'y'</span>) {
00110       <span class="comment">// If you can't create a gallery then you can't edit a gallery because you can't have a gallery</span>
00111       $smarty-&gt;assign('msg',tra(<span class="stringliteral">"Permission denied you cannot create galleries and so you cant edit them"</span>));
00112       $smarty-&gt;display(<span class="stringliteral">"styles/$style_base/error.tpl"</span>);
00113       die;  
00114     }
00115     <span class="comment">// If the user can create a gallery then check if he can edit THIS gallery</span>
00116     <span class="keywordflow">if</span>($_REQUEST[<span class="stringliteral">"galleryId"</span>]&gt;0) {
00117       $info = $tikilib-&gt;get_gallery_info($_REQUEST[<span class="stringliteral">"galleryId"</span>]);
00118       <span class="keywordflow">if</span>(!$user || $info[<span class="stringliteral">"user"</span>]!=$user) {
00119         $smarty-&gt;assign('msg',tra(<span class="stringliteral">"Permission denied you cannot edit this gallery"</span>));
00120         $smarty-&gt;display(<span class="stringliteral">"styles/$style_base/error.tpl"</span>);
00121         die;  
00122       }
00123     }
00124   }
00125   <span class="comment">// Everything is ok so we proceed to edit the gallery</span>
00126   $smarty-&gt;assign('edit_mode<span class="charliteral">','</span>y');
00127   <span class="comment">//$smarty-&gt;assign_by_ref('theme',$_REQUEST["theme"]);</span>
00128   $smarty-&gt;assign_by_ref('name',$_REQUEST[<span class="stringliteral">"name"</span>]);
00129   $smarty-&gt;assign_by_ref('description',$_REQUEST[<span class="stringliteral">"description"</span>]);
00130   $smarty-&gt;assign_by_ref('maxRows',$_REQUEST[<span class="stringliteral">"maxRows"</span>]);
00131   $smarty-&gt;assign_by_ref('rowImages',$_REQUEST[<span class="stringliteral">"rowImages"</span>]);
00132   $smarty-&gt;assign_by_ref('thumbSizeX',$_REQUEST[<span class="stringliteral">"thumbSizeX"</span>]);
00133   $smarty-&gt;assign_by_ref('thumbSizeY',$_REQUEST[<span class="stringliteral">"thumbSizeY"</span>]);
00134   <span class="keywordflow">if</span>(isset($_REQUEST[<span class="stringliteral">"visible"</span>]) &amp;&amp; $_REQUEST[<span class="stringliteral">"visible"</span>]==<span class="stringliteral">"on"</span>) {
00135     $smarty-&gt;assign('visible<span class="charliteral">','</span>y');
00136     $visible =<span class="charliteral">'y'</span>;
00137   } <span class="keywordflow">else</span> {
00138     $visible =<span class="charliteral">'n'</span>;
00139   }
00140   <span class="keywordflow">if</span>(!isset($_REQUEST[<span class="stringliteral">"visible"</span>])) {
00141     $visible = <span class="charliteral">'y'</span>;
00142   }
00143   $smarty-&gt;assign_by_ref('visible',$visible);
00144   <span class="keywordflow">if</span>(isset($_REQUEST[<span class="stringliteral">"public"</span>]) &amp;&amp; $_REQUEST[<span class="stringliteral">"public"</span>]==<span class="stringliteral">"on"</span>) {
00145     $smarty-&gt;assign('<span class="keyword">public</span><span class="charliteral">','</span>y');
00146     $<span class="keyword">public</span> =<span class="charliteral">'y'</span>;
00147   } <span class="keywordflow">else</span> {
00148     $<span class="keyword">public</span> =<span class="charliteral">'n'</span>;
00149   }
00150   $smarty-&gt;assign_by_ref('<span class="keyword">public</span>',$<span class="keyword">public</span>);
00151   $gid = $imagegallib-&gt;replace_gallery($_REQUEST[<span class="stringliteral">"galleryId"</span>],$_REQUEST[<span class="stringliteral">"name"</span>],$_REQUEST[<span class="stringliteral">"description"</span>],'',$user,$_REQUEST[<span class="stringliteral">"maxRows"</span>],$_REQUEST[<span class="stringliteral">"rowImages"</span>],$_REQUEST[<span class="stringliteral">"thumbSizeX"</span>],$_REQUEST[<span class="stringliteral">"thumbSizeY"</span>],$<span class="keyword">public</span>,$visible);
00152   
00153 <span class="preprocessor">  #add scales</span>
00154 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (isset($_REQUEST[<span class="stringliteral">"scaleSizeX"</span>]) &amp;&amp; is_numeric($_REQUEST[<span class="stringliteral">"scaleSizeX"</span>])
00155       &amp;&amp; isset($_REQUEST[<span class="stringliteral">"scaleSizeY"</span>]) &amp;&amp; is_numeric($_REQUEST[<span class="stringliteral">"scaleSizeY"</span>]))
00156    {
00157      $imagegallib-&gt;add_gallery_scale($_REQUEST[<span class="stringliteral">"galleryId"</span>],$_REQUEST[<span class="stringliteral">"scaleSizeX"</span>],
00158                        $_REQUEST[<span class="stringliteral">"scaleSizeY"</span>]);
00159    }
00160 <span class="preprocessor">  #remove scales</span>
00161 <span class="preprocessor"></span>  $scaleinfo = $imagegallib-&gt;get_gallery_scale_info($_REQUEST[<span class="stringliteral">"galleryId"</span>]);
00162 <span class="preprocessor">  # loop though scales to determine if a scale has to be removed</span>
00163 <span class="preprocessor"></span>  <span class="keywordflow">while</span> (list ($num, $sci) = each ($scaleinfo)) {
00164     $sizestr=$sci[<span class="stringliteral">"xsize"</span>].<span class="stringliteral">"x"</span>.$sci[<span class="stringliteral">"ysize"</span>];
00165     <span class="keywordflow">if</span> (isset($_REQUEST[$sizestr]) &amp;&amp; $_REQUEST[$sizestr]=='on'){
00166       $imagegallib-&gt;remove_gallery_scale($_REQUEST[<span class="stringliteral">"galleryId"</span>],$sci[<span class="stringliteral">"xsize"</span>],$sci[<span class="stringliteral">"ysize"</span>]);
00167     }
00168   }
00169 
00170   $cat_type='image gallery';
00171   $cat_objid = $gid;
00172   $cat_desc = substr($_REQUEST[<span class="stringliteral">"description"</span>],0,200);
00173   $cat_name = $_REQUEST[<span class="stringliteral">"name"</span>];
00174   $cat_href=<span class="stringliteral">"tiki-browse_gallery.php?galleryId="</span>.$cat_objid;
00175   include_once(<span class="stringliteral">"categorize.php"</span>);
00176   
00177   $smarty-&gt;assign('edit_mode<span class="charliteral">','</span>n');
00178 }
00179 
00180 
00181 <span class="keywordflow">if</span>(isset($_REQUEST[<span class="stringliteral">"removegal"</span>])) {
00182   <span class="keywordflow">if</span>($tiki_p_admin_galleries != <span class="charliteral">'y'</span>) {
00183      $info = $tikilib-&gt;get_gallery_info($_REQUEST[<span class="stringliteral">"removegal"</span>]);
00184      <span class="keywordflow">if</span>(!$user || $info[<span class="stringliteral">"user"</span>]!=$user) {
00185        $smarty-&gt;assign('msg',tra(<span class="stringliteral">"Permission denied you cannot remove this gallery"</span>));
00186        $smarty-&gt;display(<span class="stringliteral">"styles/$style_base/error.tpl"</span>);
00187        die;  
00188      }
00189   }
00190   $imagegallib-&gt;remove_gallery($_REQUEST[<span class="stringliteral">"removegal"</span>]);
00191 }
00192 
00193 <span class="keywordflow">if</span>(!isset($_REQUEST[<span class="stringliteral">"sort_mode"</span>])) {
00194   $sort_mode = 'name_desc'; 
00195 } <span class="keywordflow">else</span> {
00196   $sort_mode = $_REQUEST[<span class="stringliteral">"sort_mode"</span>];
00197 } 
00198 $smarty-&gt;assign_by_ref('sort_mode',$sort_mode);
00199 
00200 <span class="comment">// If offset is set use it if not then use offset =0</span>
00201 <span class="comment">// use the maxRecords php variable to set the limit</span>
00202 <span class="comment">// if sortMode is not set then use lastModif_desc</span>
00203 <span class="keywordflow">if</span>(!isset($_REQUEST[<span class="stringliteral">"offset"</span>])) {
00204   $offset = 0;
00205 } <span class="keywordflow">else</span> {
00206   $offset = $_REQUEST[<span class="stringliteral">"offset"</span>]; 
00207 }
00208 $smarty-&gt;assign_by_ref('offset',$offset);
00209 
00210 <span class="comment">// Get the list of libraries available for this user (or public galleries)</span>
00211 <span class="comment">// GET ALL GALLERIES SINCE ALL GALLERIES ARE BROWSEABLE</span>
00212 $galleries = $tikilib-&gt;list_galleries($offset,$maxRecords,$sort_mode, 'admin',$find);
00213 <span class="keywordflow">for</span>($i=0;$i&lt;count($galleries[<span class="stringliteral">"data"</span>]);$i++) {
00214   <span class="keywordflow">if</span>($userlib-&gt;object_has_one_permission($galleries[<span class="stringliteral">"data"</span>][$i][<span class="stringliteral">"galleryId"</span>],'image gallery')) {
00215     $galleries[<span class="stringliteral">"data"</span>][$i][<span class="stringliteral">"individual"</span>]=<span class="charliteral">'y'</span>;
00216     
00217     <span class="keywordflow">if</span>($userlib-&gt;object_has_permission($user,$galleries[<span class="stringliteral">"data"</span>][$i][<span class="stringliteral">"galleryId"</span>],'image gallery<span class="charliteral">','</span>tiki_p_view_image_gallery')) {
00218       $galleries[<span class="stringliteral">"data"</span>][$i][<span class="stringliteral">"individual_tiki_p_view_image_gallery"</span>]=<span class="charliteral">'y'</span>;
00219     } <span class="keywordflow">else</span> {
00220       $galleries[<span class="stringliteral">"data"</span>][$i][<span class="stringliteral">"individual_tiki_p_view_image_gallery"</span>]=<span class="charliteral">'n'</span>;
00221     }
00222     <span class="keywordflow">if</span>($userlib-&gt;object_has_permission($user,$galleries[<span class="stringliteral">"data"</span>][$i][<span class="stringliteral">"galleryId"</span>],'image gallery<span class="charliteral">','</span>tiki_p_upload_images')) {
00223       $galleries[<span class="stringliteral">"data"</span>][$i][<span class="stringliteral">"individual_tiki_p_upload_images"</span>]=<span class="charliteral">'y'</span>;
00224     } <span class="keywordflow">else</span> {
00225       $galleries[<span class="stringliteral">"data"</span>][$i][<span class="stringliteral">"individual_tiki_p_upload_images"</span>]=<span class="charliteral">'n'</span>;
00226     }
00227     <span class="keywordflow">if</span>($userlib-&gt;object_has_permission($user,$galleries[<span class="stringliteral">"data"</span>][$i][<span class="stringliteral">"galleryId"</span>],'image gallery<span class="charliteral">','</span>tiki_p_create_galleries')) {
00228       $galleries[<span class="stringliteral">"data"</span>][$i][<span class="stringliteral">"individual_tiki_p_create_galleries"</span>]=<span class="charliteral">'y'</span>;
00229     } <span class="keywordflow">else</span> {
00230       $galleries[<span class="stringliteral">"data"</span>][$i][<span class="stringliteral">"individual_tiki_p_create_galleries"</span>]=<span class="charliteral">'n'</span>;
00231     }
00232     <span class="keywordflow">if</span>($tiki_p_admin==<span class="charliteral">'y'</span> || $userlib-&gt;object_has_permission($user,$galleries[<span class="stringliteral">"data"</span>][$i][<span class="stringliteral">"galleryId"</span>],'image gallery<span class="charliteral">','</span>tiki_p_admin_galleries')) {
00233       $galleries[<span class="stringliteral">"data"</span>][$i][<span class="stringliteral">"individual_tiki_p_create_galleries"</span>]=<span class="charliteral">'y'</span>;
00234       $galleries[<span class="stringliteral">"data"</span>][$i][<span class="stringliteral">"individual_tiki_p_upload_images"</span>]=<span class="charliteral">'y'</span>;
00235       $galleries[<span class="stringliteral">"data"</span>][$i][<span class="stringliteral">"individual_tiki_p_view_image_gallery"</span>]=<span class="charliteral">'y'</span>;
00236     } 
00237     
00238   } <span class="keywordflow">else</span> {
00239     $galleries[<span class="stringliteral">"data"</span>][$i][<span class="stringliteral">"individual"</span>]=<span class="charliteral">'n'</span>;
00240   }
00241 }
00242 
00243 <span class="comment">// If there're more records then assign next_offset</span>
00244 $cant_pages = ceil($galleries[<span class="stringliteral">"cant"</span>] / $maxRecords);
00245 $smarty-&gt;assign_by_ref('cant_pages',$cant_pages);
00246 $smarty-&gt;assign('actual_page',1+($offset/$maxRecords));
00247 
00248 <span class="keywordflow">if</span>($galleries[<span class="stringliteral">"cant"</span>] &gt; ($offset + $maxRecords)) {
00249   $smarty-&gt;assign('next_offset',$offset + $maxRecords);
00250 } <span class="keywordflow">else</span> {
00251   $smarty-&gt;assign('next_offset',-1); 
00252 }
00253 <span class="comment">// If offset is &gt; 0 then prev_offset</span>
00254 <span class="keywordflow">if</span>($offset&gt;0) {
00255   $smarty-&gt;assign('prev_offset',$offset - $maxRecords);  
00256 } <span class="keywordflow">else</span> {
00257   $smarty-&gt;assign('prev_offset',-1); 
00258 }
00259 
00260 $smarty-&gt;assign_by_ref('galleries',$galleries[<span class="stringliteral">"data"</span>]);
00261 <span class="comment">//print_r($galleries["data"]);</span>
00262 
00263 $cat_type='image gallery';
00264 $cat_objid = $_REQUEST[<span class="stringliteral">"galleryId"</span>];
00265 include_once(<span class="stringliteral">"categorize_list.php"</span>);
00266 
00267 $section='galleries';
00268 include_once('tiki-section_options.php');
00269 
00270 
00271 <span class="comment">// Display the template</span>
00272 $smarty-&gt;assign('mid<span class="charliteral">','</span>tiki-galleries.tpl');
00273 $smarty-&gt;display(<span class="stringliteral">"styles/$style_base/tiki.tpl"</span>);
00274 ?&gt;
</pre></div><hr><address style="align: right;"><small>Generated on Mon Apr 14 11:52:00 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
