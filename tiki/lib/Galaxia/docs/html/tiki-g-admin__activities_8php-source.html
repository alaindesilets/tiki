<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>tiki-g-admin_activities.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>tiki-g-admin_activities.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 require_once('tiki-setup.php');
00003 include_once('lib/Galaxia/<a class="code" href="classProcessManager.html">ProcessManager</a>.php');
00004 
00005 <span class="comment">// The galaxia activities manager PHP script.</span>
00006 
00007 <span class="comment">//\remove this!</span>
00008 <span class="comment">//:todo: remove</span>
00009 <span class="comment">//$foo = $processManager-&gt;serialize_process($_REQUEST['pid']);</span>
00010 <span class="comment">//$x = $processManager-&gt;unserialize_process($foo);</span>
00011 <span class="comment">//print_r($x);</span>
00012 
00013 
00014 <span class="comment">/*</span>
00015 <span class="comment">// Check if feature is enabled and permissions</span>
00016 <span class="comment">if($feature_galaxia != 'y') {</span>
00017 <span class="comment">  $smarty-&gt;assign('msg',tra("This feature is disabled"));</span>
00018 <span class="comment">  $smarty-&gt;display("styles/$style_base/error.tpl");</span>
00019 <span class="comment">  die;  </span>
00020 <span class="comment">}</span>
00021 <span class="comment">*/</span>
00022 
00023 <span class="keywordflow">if</span>(!isset($_REQUEST['pid'])) {
00024   $smarty-&gt;assign('msg',tra(<span class="stringliteral">"No process indicated"</span>));
00025   $smarty-&gt;display(<span class="stringliteral">"styles/$style_base/error.tpl"</span>);
00026   die;  
00027 }
00028 $smarty-&gt;assign('pid',$_REQUEST['pid']);
00029 
00030 $proc_info = $processManager-&gt;get_process($_REQUEST['pid']);
00031 $proc_info['graph']=<span class="stringliteral">"lib/Galaxia/Processes/"</span>.$proc_info['normalized_name'].<span class="stringliteral">"/graph/"</span>.$proc_info['normalized_name'].<span class="stringliteral">".png"</span>;
00032 
00033 
00034 
00035 <span class="comment">// Retrieve activity info if we are editing, assign to </span>
00036 <span class="comment">// default values when creating a new activity</span>
00037 <span class="keywordflow">if</span>(!isset($_REQUEST['activityId'])) $_REQUEST['activityId'] = 0;
00038 <span class="keywordflow">if</span>($_REQUEST[<span class="stringliteral">"activityId"</span>]) {
00039   $info = $activityManager-&gt;get_activity($_REQUEST['pid'],$_REQUEST[<span class="stringliteral">"activityId"</span>]);
00040 } <span class="keywordflow">else</span> {
00041   $info = Array(
00042     'name' =&gt; '',
00043     'description' =&gt; '',
00044     'activityId' =&gt; 0,
00045     'isInteractive' =&gt; <span class="charliteral">'y'</span>,
00046     'isAutoRouted' =&gt; <span class="charliteral">'n'</span>,
00047     'type' =&gt; 'activity'
00048   );
00049 }
00050 $smarty-&gt;assign('activityId',$_REQUEST['activityId']);
00051 $smarty-&gt;assign('info',$info);
00052 
00053 <span class="comment">// Remove a role from the activity</span>
00054 <span class="keywordflow">if</span>(isset($_REQUEST['remove_role']) &amp;&amp; $_REQUEST['activityId']) {
00055   $activityManager-&gt;remove_activity_role($_REQUEST['activityId'],$_REQUEST['remove_role']);
00056 }
00057 
00058 $role_to_add=0;
00059 <span class="comment">// Add a role to the process</span>
00060 <span class="keywordflow">if</span>(isset($_REQUEST['addrole'])) {
00061   $isInteractive = (isset($_REQUEST['isInteractive'])&amp;&amp;$_REQUEST['isInteractive']=='on') ? <span class="charliteral">'y'</span> : <span class="charliteral">'n'</span>;
00062   $isAutoRouted = (isset($_REQUEST['isAutoRouted'])&amp;&amp;$_REQUEST['isAutoRouted']=='on') ? <span class="charliteral">'y'</span> : <span class="charliteral">'n'</span>;
00063   $info = Array(
00064     'name' =&gt; $_REQUEST['name'],
00065     'description' =&gt; $_REQUEST['description'],
00066     'activityId' =&gt; $_REQUEST['activityId'],
00067     'isInteractive' =&gt; $isInteractive,
00068     'isAutoRouted' =&gt; $isAutoRouted,
00069     'type' =&gt; $_REQUEST['type'],
00070   );  
00071   $vars=Array(
00072         'name' =&gt; $_REQUEST['rolename'],
00073         'description' =&gt; ''
00074   );
00075 
00076   <span class="keywordflow">if</span>(isset($_REQUEST[<span class="stringliteral">"userole"</span>]) &amp;&amp; $_REQUEST[<span class="stringliteral">"userole"</span>]) {
00077     <span class="keywordflow">if</span>($_REQUEST['activityId']) {
00078       $activityManager-&gt;add_activity_role($_REQUEST['activityId'],$_REQUEST[<span class="stringliteral">"userole"</span>]);
00079     }
00080   } <span class="keywordflow">else</span> {
00081     $rid = $roleManager-&gt;replace_role($_REQUEST['pid'],0,$vars);
00082     <span class="keywordflow">if</span>($_REQUEST['activityId']) {
00083       $activityManager-&gt;add_activity_role($_REQUEST['activityId'],$rid);
00084         } 
00085 
00086   }
00087   
00088 }
00089 
00090 
00091 <span class="comment">// Delete activities</span>
00092 <span class="keywordflow">if</span>(isset($_REQUEST[<span class="stringliteral">"delete_act"</span>])) {
00093   foreach(array_keys($_REQUEST[<span class="stringliteral">"activity"</span>]) as $item) {         
00094     $activityManager-&gt;remove_activity($_REQUEST['pid'], $item);
00095   }
00096 }
00097 
00098 
00099 
00100 <span class="comment">// If we are adding an activity then add it!</span>
00101 <span class="keywordflow">if</span>(isset($_REQUEST['save_act'])) {
00102         $isInteractive = (isset($_REQUEST['isInteractive'])&amp;&amp;$_REQUEST['isInteractive']=='on') ? <span class="charliteral">'y'</span> : <span class="charliteral">'n'</span>;
00103         $isAutoRouted = (isset($_REQUEST['isAutoRouted'])&amp;&amp;$_REQUEST['isAutoRouted']=='on') ? <span class="charliteral">'y'</span> : <span class="charliteral">'n'</span>;
00104         $vars = Array(
00105     'name' =&gt; $_REQUEST['name'],
00106     'description' =&gt; $_REQUEST['description'],
00107     'activityId' =&gt; $_REQUEST['activityId'],
00108     'isInteractive' =&gt; $isInteractive,
00109     'isAutoRouted' =&gt; $isAutoRouted,
00110     'type' =&gt; $_REQUEST['type'],
00111         );  
00112 
00113         <span class="keywordflow">if</span>($activityManager-&gt;activity_name_exists($_REQUEST['pid'],$_REQUEST['name']) &amp;&amp; $_REQUEST['activityId']==0) {
00114           $smarty-&gt;assign('msg',tra(<span class="stringliteral">"Activity name already exists"</span>));
00115           $smarty-&gt;display(<span class="stringliteral">"styles/$style_base/error.tpl"</span>);
00116           die;  
00117         }
00118         
00119         $newaid = $activityManager-&gt;replace_activity($_REQUEST['pid'],$_REQUEST['activityId'],$vars);
00120         $rid = 0;
00121         <span class="keywordflow">if</span>(isset($_REQUEST['userole']) &amp;&amp; $_REQUEST['userole']) $rid = $_REQUEST['userole'];
00122         <span class="keywordflow">if</span>(!empty($_REQUEST['rolename'])) {
00123             $vars=Array(
00124                         'name' =&gt; $_REQUEST['rolename'],
00125                         'description' =&gt; ''
00126                 );
00127             $rid = $roleManager-&gt;replace_role($_REQUEST['pid'],0,$vars);
00128 
00129         }
00130         
00131         <span class="keywordflow">if</span>($rid) {
00132           $activityManager-&gt;add_activity_role($newaid,$rid);
00133         }
00134 
00135         $info = Array(
00136     'name' =&gt; '',
00137     'description' =&gt; '',
00138     'activityId' =&gt; 0,
00139     'isInteractive' =&gt; <span class="charliteral">'y'</span>,
00140     'isAutoRouted' =&gt; <span class="charliteral">'n'</span>,
00141     'type' =&gt; 'activity'
00142     );  
00143     $_REQUEST['activityId']=0;
00144     $smarty-&gt;assign('info',$info);
00145     <span class="comment">// remove transitions</span>
00146     $activityManager-&gt;remove_activity_transitions($_REQUEST['pid'],$newaid);
00147         <span class="keywordflow">if</span>(isset($_REQUEST[<span class="stringliteral">"add_tran_from"</span>])) {
00148                 foreach($_REQUEST[<span class="stringliteral">"add_tran_from"</span>] as $actfrom) {
00149                         $activityManager-&gt;add_transition($_REQUEST['pid'],$actfrom,$newaid);            
00150                 }
00151         }       
00152         <span class="keywordflow">if</span>(isset($_REQUEST[<span class="stringliteral">"add_tran_to"</span>])) {
00153                 foreach($_REQUEST[<span class="stringliteral">"add_tran_to"</span>] as $actto) {
00154                         $activityManager-&gt;add_transition($_REQUEST['pid'],$newaid,$actto);              
00155                 }
00156         }       
00157 
00158 }
00159 
00160 <span class="comment">// Get all the process roles</span>
00161 $all_roles = $roleManager-&gt;list_roles($_REQUEST['pid'],0,-1,'name_asc<span class="charliteral">','</span>');
00162 $smarty-&gt;assign_by_ref('all_roles',$all_roles['data']);
00163 
00164 <span class="comment">// Get activity roles</span>
00165 <span class="keywordflow">if</span>($_REQUEST['activityId']) {
00166  $roles = $activityManager-&gt;get_activity_roles($_REQUEST['activityId']);
00167 } <span class="keywordflow">else</span> {
00168  $roles=Array();
00169 }
00170 $smarty-&gt;assign('roles',$roles);
00171 
00172 
00173 $where='';
00174 <span class="keywordflow">if</span>(isset($_REQUEST['filter'])) {
00175   $wheres = Array();
00176   <span class="keywordflow">if</span>($_REQUEST['filter_type']) {
00177    $wheres[]=<span class="stringliteral">" type='"</span>.$_REQUEST['filter_type'].<span class="stringliteral">"'"</span>;
00178   }
00179   <span class="keywordflow">if</span>($_REQUEST['filter_interactive']) {
00180    $wheres[]=<span class="stringliteral">" isInteractive='"</span>.$_REQUEST['filter_interactive'].<span class="stringliteral">"'"</span>;
00181   }
00182   <span class="keywordflow">if</span>($_REQUEST['filter_autoroute']) {
00183    $wheres[]=<span class="stringliteral">" isAutoRouted='"</span>.$_REQUEST['filter_autoroute'].<span class="stringliteral">"'"</span>;
00184   }
00185   $where = implode('and',$wheres);
00186 }
00187 
00188 
00189 <span class="keywordflow">if</span>(!isset($_REQUEST['sort_mode'])) $_REQUEST['sort_mode']='name_asc';
00190 <span class="keywordflow">if</span>(!isset($_REQUEST['find'])) $_REQUEST['find']='';
00191 <span class="keywordflow">if</span>(!isset($_REQUEST['were'])) $_REQUEST['where']=$where;
00192 $smarty-&gt;assign('sort_mode',$_REQUEST['sort_mode']);
00193 $smarty-&gt;assign('find',$_REQUEST['find']);
00194 $smarty-&gt;assign('where',$_REQUEST['where']);
00195 <span class="comment">//Now information for activities in this process</span>
00196 $activities = $activityManager-&gt;list_activities($_REQUEST['pid'],0,-1,$_REQUEST['sort_mode'],$_REQUEST['find'],$where);
00197 
00198 <span class="comment">//Now check if the activity is or not part of a transition</span>
00199 <span class="keywordflow">if</span>(isset($_REQUEST['activityId'])) {
00200   <span class="keywordflow">for</span>($i=0;$i&lt;count($activities[<span class="stringliteral">"data"</span>]);$i++) {
00201     $id = $activities[<span class="stringliteral">"data"</span>][$i]['activityId'];
00202     $activities[<span class="stringliteral">"data"</span>][$i]['to'] = $activityManager-&gt;transition_exists($_REQUEST['pid'],$_REQUEST['activityId'],$id) ? <span class="charliteral">'y'</span> :<span class="charliteral">'n'</span>;
00203     $activities[<span class="stringliteral">"data"</span>][$i]['from'] = $activityManager-&gt;transition_exists($_REQUEST['pid'],$id,$_REQUEST['activityId']) ? <span class="charliteral">'y'</span> :<span class="charliteral">'n'</span>;
00204   }
00205 }
00206 
00207 <span class="comment">// Set activities</span>
00208 <span class="keywordflow">if</span>(isset($_REQUEST[<span class="stringliteral">"update_act"</span>])) {
00209   <span class="keywordflow">for</span>($i=0;$i&lt;count($activities[<span class="stringliteral">"data"</span>]);$i++) {
00210     $id = $activities[<span class="stringliteral">"data"</span>][$i]['activityId'];
00211     <span class="keywordflow">if</span>(isset($_REQUEST['activity_inter'][<span class="stringliteral">"$id"</span>])) {
00212           $activities[<span class="stringliteral">"data"</span>][$i]['isInteractive'] = <span class="charliteral">'y'</span>;
00213           $activityManager-&gt;set_interactivity($_REQUEST['pid'],$id,<span class="charliteral">'y'</span>);
00214     } <span class="keywordflow">else</span> {
00215       $activities[<span class="stringliteral">"data"</span>][$i]['isInteractive'] = <span class="charliteral">'n'</span>;
00216       $activityManager-&gt;set_interactivity($_REQUEST['pid'],$id,<span class="charliteral">'n'</span>);
00217     }
00218     <span class="keywordflow">if</span>(isset($_REQUEST['activity_route'][<span class="stringliteral">"$id"</span>])) {
00219           $activities[<span class="stringliteral">"data"</span>][$i]['isAutoRouted'] = <span class="charliteral">'y'</span>;
00220           $activityManager-&gt;set_autorouting($_REQUEST['pid'],$id,<span class="charliteral">'y'</span>);
00221     } <span class="keywordflow">else</span> {
00222       $activities[<span class="stringliteral">"data"</span>][$i]['isAutoRouted'] = <span class="charliteral">'n'</span>;
00223       $activityManager-&gt;set_autorouting($_REQUEST['pid'],$id,<span class="charliteral">'n'</span>);
00224     }
00225   }
00226 }
00227 $smarty-&gt;assign_by_ref('items',$activities['data']);
00228 
00229 
00230 <span class="comment">// Transitions</span>
00231 <span class="keywordflow">if</span>(isset($_REQUEST[<span class="stringliteral">"delete_tran"</span>])) {
00232   foreach(array_keys($_REQUEST[<span class="stringliteral">"transition"</span>]) as $item) {       
00233     $parts = explode(<span class="stringliteral">"_"</span>,$item);
00234     $activityManager-&gt;remove_transition($parts[0],$parts[1]);
00235   }
00236 }
00237 
00238 
00239 <span class="keywordflow">if</span>(isset($_REQUEST['add_trans'])) {
00240   $activityManager-&gt;add_transition($_REQUEST['pid'],$_REQUEST['actFromId'],$_REQUEST['actToId']);
00241 }
00242 
00243 
00244 <span class="keywordflow">if</span>(isset($_REQUEST['filter_tran_name']) &amp;&amp; $_REQUEST['filter_tran_name']) {
00245         $transitions = $activityManager-&gt;get_process_transitions($_REQUEST['pid'],$_REQUEST['filter_tran_name']);  
00246 } <span class="keywordflow">else</span> {
00247         $transitions = $activityManager-&gt;get_process_transitions($_REQUEST['pid'],'');  
00248 }
00249 <span class="keywordflow">if</span>(!isset($_REQUEST['filter_tran_name'])) $_REQUEST['filter_tran_name']='';
00250 $smarty-&gt;assign('filter_tran_name',$_REQUEST['filter_tran_name']);
00251 $smarty-&gt;assign_by_ref('transitions',$transitions);
00252 
00253 $valid = $activityManager-&gt;validate_process_activities($_REQUEST['pid']);
00254 $proc_info['isValid']=$valid?<span class="charliteral">'y'</span>:<span class="charliteral">'n'</span>;
00255 <span class="keywordflow">if</span>($valid &amp;&amp; isset($_REQUEST['activate_proc'])) {
00256   $processManager-&gt;activate_process($_REQUEST['pid']);
00257   $proc_info['isActive']=<span class="charliteral">'y'</span>;
00258 }
00259 <span class="keywordflow">if</span>(isset($_REQUEST['deactivate_proc'])) {
00260   $processManager-&gt;deactivate_process($_REQUEST['pid']);
00261   $proc_info['isActive']=<span class="charliteral">'n'</span>;
00262 }
00263 
00264 $smarty-&gt;assign_by_ref('proc_info',$proc_info);
00265 
00266 $errors = Array();
00267 <span class="keywordflow">if</span>(!$valid) {
00268   $errors = $activityManager-&gt;get_error();
00269 }
00270 $smarty-&gt;assign('errors',$errors);
00271 
00272 $activityManager-&gt;build_process_graph($_REQUEST['pid']);
00273 
00274 $smarty-&gt;assign('mid<span class="charliteral">','</span>tiki-g-admin_activities.tpl');
00275 $smarty-&gt;display(<span class="stringliteral">"styles/$style_base/tiki.tpl"</span>);
00276 ?&gt;
</pre></div><hr><address style="align: right;"><small>Generated on Mon Apr 14 11:52:00 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
