<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>tiki-g-admin_processes.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>tiki-g-admin_processes.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 require_once('tiki-setup.php');
00003 include_once('lib/Galaxia/<a class="code" href="classProcessManager.html">ProcessManager</a>.php');
00004 
00005 <span class="comment">//mkdir('lib/Galaxia/aaa');</span>
00006 <span class="comment">//rmdir('lib/Galaxia/processes/foo_212/code/activities');</span>
00007 
00008 <span class="comment">// The galaxia process manager PHP script.</span>
00009 
00010 <span class="comment">/*</span>
00011 <span class="comment">// Check if feature is enabled and permissions</span>
00012 <span class="comment">if($feature_galaxia != 'y') {</span>
00013 <span class="comment">  $smarty-&gt;assign('msg',tra("This feature is disabled"));</span>
00014 <span class="comment">  $smarty-&gt;display("styles/$style_base/error.tpl");</span>
00015 <span class="comment">  die;  </span>
00016 <span class="comment">}</span>
00017 <span class="comment">*/</span>
00018 
00019 <span class="comment">// Check if we are editing an existing process</span>
00020 <span class="comment">// if so retrieve the process info and assign it.</span>
00021 <span class="keywordflow">if</span>(!isset($_REQUEST['pid'])) $_REQUEST['pid'] = 0;
00022 <span class="keywordflow">if</span>($_REQUEST[<span class="stringliteral">"pid"</span>]) {
00023   $info = $processManager-&gt;get_process($_REQUEST[<span class="stringliteral">"pid"</span>]);
00024   $info['graph']=<span class="stringliteral">"lib/Galaxia/Processes/"</span>.$info['normalized_name'].<span class="stringliteral">"/graph/"</span>.$info['normalized_name'].<span class="stringliteral">".png"</span>; 
00025 } <span class="keywordflow">else</span> {
00026   $info = Array(
00027     'name' =&gt; '',
00028     'description' =&gt; '',
00029     'version' =&gt; '1.0',
00030     'isActive' =&gt; <span class="charliteral">'n'</span>,
00031     'pId' =&gt; 0
00032   );
00033 }
00034 
00035 $smarty-&gt;assign_by_ref('proc_info',$info);
00036 $smarty-&gt;assign('pid',$_REQUEST['pid']);
00037 $smarty-&gt;assign('info',$info);
00038 
00039 <span class="comment">//Check here for an uploaded process</span>
00040 <span class="keywordflow">if</span>(isset($_FILES['userfile1'])&amp;&amp;is_uploaded_file($_FILES['userfile1']['tmp_name'])) {
00041   $fp = fopen($_FILES['userfile1']['tmp_name'],<span class="stringliteral">"rb"</span>);
00042   $data = '';
00043   $fhash='';
00044   <span class="keywordflow">while</span>(!feof($fp)) {
00045     $data .= fread($fp,8192*16);
00046   }
00047   fclose($fp);
00048   $size = $_FILES['userfile1']['size'];
00049   $name = $_FILES['userfile1']['name'];
00050   $type = $_FILES['userfile1']['type'];
00051           
00052   $process_data = $processManager-&gt;unserialize_process($data);
00053   <span class="keywordflow">if</span>($processManager-&gt;process_name_exists($process_data['name'],$process_data['version'])) {
00054     $smarty-&gt;assign('msg',tra(<span class="stringliteral">"The process name already exists"</span>));
00055         $smarty-&gt;display(<span class="stringliteral">"styles/$style_base/error.tpl"</span>);
00056         die;  
00057   } <span class="keywordflow">else</span> {
00058         $processManager-&gt;import_process($process_data);
00059   }
00060 
00061 }
00062 
00063 
00064 <span class="keywordflow">if</span>(isset($_REQUEST[<span class="stringliteral">"delete"</span>])) {
00065   foreach(array_keys($_REQUEST[<span class="stringliteral">"process"</span>]) as $item) {          
00066     $processManager-&gt;remove_process($item);
00067   }
00068 }
00069 
00070 <span class="keywordflow">if</span>(isset($_REQUEST['newminor'])) {
00071   $processManager-&gt;new_process_version($_REQUEST['newminor']);
00072 }
00073 <span class="keywordflow">if</span>(isset($_REQUEST['newmajor'])) {
00074   $processManager-&gt;new_process_version($_REQUEST['newmajor'],<span class="keyword">false</span>);
00075 }
00076 
00077 
00078 <span class="keywordflow">if</span>(isset($_REQUEST['save'])) {
00079         $vars = Array(
00080           'name' =&gt; $_REQUEST['name'],
00081           'description' =&gt; $_REQUEST['description'],
00082           'version' =&gt; $_REQUEST['version'],
00083           'isActive' =&gt; <span class="charliteral">'n'</span>
00084         );
00085         <span class="keywordflow">if</span>($processManager-&gt;process_name_exists($_REQUEST['name'],$_REQUEST['version']) &amp;&amp; $_REQUEST['pid']==0) {
00086           $smarty-&gt;assign('msg',tra(<span class="stringliteral">"Process already exists"</span>));
00087           $smarty-&gt;display(<span class="stringliteral">"styles/$style_base/error.tpl"</span>);
00088           die;  
00089         }
00090         <span class="keywordflow">if</span>(isset($_REQUEST['isActive'])&amp;&amp;$_REQUEST['isActive']=='on') {
00091                 $vars['isActive'] = <span class="charliteral">'y'</span>;
00092         }
00093         $pid = $processManager-&gt;replace_process($_REQUEST['pid'],$vars);
00094         
00095     $valid = $activityManager-&gt;validate_process_activities($pid);
00096     <span class="keywordflow">if</span>(!$valid) {
00097       $processManager-&gt;deactivate_process($pid);
00098     }  
00099         
00100         $info = Array(
00101     'name' =&gt; '',
00102     'description' =&gt; '',
00103     'version' =&gt; '1.0',
00104     'isActive' =&gt; <span class="charliteral">'n'</span>,
00105     'pId' =&gt; 0
00106     );  
00107     $smarty-&gt;assign('info',$info);
00108 }
00109 
00110 $where = ''; 
00111 $wheres=Array();
00112 <span class="keywordflow">if</span>(isset($_REQUEST['filter'])) {
00113   <span class="keywordflow">if</span>($_REQUEST['filter_name']) {
00114    $wheres[]=<span class="stringliteral">" name='"</span>.$_REQUEST['filter_name'].<span class="stringliteral">"'"</span>;
00115   }
00116   <span class="keywordflow">if</span>($_REQUEST['filter_active']) {
00117    $wheres[]=<span class="stringliteral">" isActive='"</span>.$_REQUEST['filter_active'].<span class="stringliteral">"'"</span>;
00118   }
00119   $where = implode('and',$wheres);
00120 }
00121 <span class="keywordflow">if</span>(isset($_REQUEST['where'])) {
00122   $where = $_REQUEST['where'];
00123 }
00124 
00125 <span class="keywordflow">if</span>(!isset($_REQUEST[<span class="stringliteral">"sort_mode"</span>])) {  $sort_mode = 'lastModif_desc'; } <span class="keywordflow">else</span> {  $sort_mode = $_REQUEST[<span class="stringliteral">"sort_mode"</span>];} 
00126 <span class="keywordflow">if</span>(!isset($_REQUEST[<span class="stringliteral">"offset"</span>])) {  $offset = 0;} <span class="keywordflow">else</span> {  $offset = $_REQUEST[<span class="stringliteral">"offset"</span>]; }$smarty-&gt;assign_by_ref('offset',$offset);
00127 <span class="keywordflow">if</span>(isset($_REQUEST[<span class="stringliteral">"find"</span>])) { $find = $_REQUEST[<span class="stringliteral">"find"</span>];  } <span class="keywordflow">else</span> {  $find = ''; } $smarty-&gt;assign('find',$find);
00128 $smarty-&gt;assign('where',$where); $smarty-&gt;assign_by_ref('sort_mode',$sort_mode);
00129 
00130 $items = $processManager-&gt;list_processes($offset,$maxRecords,$sort_mode,$find,$where);
00131 $smarty-&gt;assign('cant',$items['cant']);
00132 
00133 $cant_pages = ceil($items[<span class="stringliteral">"cant"</span>] / $maxRecords);$smarty-&gt;assign_by_ref('cant_pages',$cant_pages);$smarty-&gt;assign('actual_page',1+($offset/$maxRecords));
00134 <span class="keywordflow">if</span>($items[<span class="stringliteral">"cant"</span>] &gt; ($offset+$maxRecords)) {  $smarty-&gt;assign('next_offset',$offset + $maxRecords);} <span class="keywordflow">else</span> {  $smarty-&gt;assign('next_offset',-1); }
00135 <span class="keywordflow">if</span>($offset&gt;0) {  $smarty-&gt;assign('prev_offset',$offset - $maxRecords);  } <span class="keywordflow">else</span> {  $smarty-&gt;assign('prev_offset',-1); }
00136 $smarty-&gt;assign_by_ref('items',$items[<span class="stringliteral">"data"</span>]);
00137 
00138 <span class="keywordflow">if</span>($_REQUEST['pid']) {
00139   $valid = $activityManager-&gt;validate_process_activities($_REQUEST['pid']);
00140   $errors = Array();
00141   <span class="keywordflow">if</span>(!$valid) {
00142     $processManager-&gt;deactivate_process($_REQUEST['pid']);
00143     $errors = $activityManager-&gt;get_error();
00144   }
00145   $smarty-&gt;assign('errors',$errors);
00146 }
00147 
00148 
00149 $all_procs = $items = $processManager-&gt;list_processes(0,-1,'name_desc<span class="charliteral">','</span><span class="charliteral">','</span>');
00150 $smarty-&gt;assign_by_ref('all_procs',$all_procs['data']);
00151 
00152 $smarty-&gt;assign('mid<span class="charliteral">','</span>tiki-g-admin_processes.tpl');
00153 $smarty-&gt;display(<span class="stringliteral">"styles/$style_base/tiki.tpl"</span>);
00154 ?&gt;
</pre></div><hr><address style="align: right;"><small>Generated on Mon Apr 14 11:52:00 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
