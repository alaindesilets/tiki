<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>GraphViz.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>GraphViz.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 <span class="comment">//</span>
00003 <span class="comment">// +----------------------------------------------------------------------+</span>
00004 <span class="comment">// | PEAR :: Image :: GraphViz                                            |</span>
00005 <span class="comment">// +----------------------------------------------------------------------+</span>
00006 <span class="comment">// | Copyright (c) 2002 Sebastian Bergmann &lt;sb@sebastian-bergmann.de&gt; and |</span>
00007 <span class="comment">// |                    Dr. Volker GÃ¶bbels &lt;vmg@arachnion.de&gt;.            |</span>
00008 <span class="comment">// +----------------------------------------------------------------------+</span>
00009 <span class="comment">// | This source file is subject to version 3.00 of the PHP License,      |</span>
00010 <span class="comment">// | that is available at http://www.php.net/license/3_0.txt.             |</span>
00011 <span class="comment">// | If you did not receive a copy of the PHP license and are unable to   |</span>
00012 <span class="comment">// | obtain it through the world-wide-web, please send a note to          |</span>
00013 <span class="comment">// | license@php.net so we can mail you a copy immediately.               |</span>
00014 <span class="comment">// +----------------------------------------------------------------------+</span>
00015 <span class="comment">//</span>
00016 <span class="comment">// $Id: GraphViz_8php-source.html,v 1.3 2003-04-25 20:53:16 lrargerich Exp $</span>
00017 <span class="comment">//</span>
00018 
00057 <span class="keyword">class </span>Process_GraphViz {
00063     var $dotCommand = 'dot';
00064     
00065     var $pid;
00066 
00072     var $neatoCommand = 'neato';
00073 
00079     var $graph;
00080 
00088     function Process_GraphViz($directed = <span class="keyword">true</span>, $attributes = array()) {
00089         $this-&gt;setDirected($directed);
00090         $this-&gt;setAttributes($attributes);
00091     }
00092     
00093     function set_pid($pid) 
00094     {
00095       $this-&gt;pid = $pid;
00096     }
00097 
00105     function image($format = 'png') {
00106         <span class="keywordflow">if</span> ($file = $this-&gt;saveParsedGraph()) {
00107             $outputfile = $file . <span class="charliteral">'.'</span> . $format;
00108             $outputfile2 = $file . <span class="charliteral">'.'</span> . 'map';
00109             $command  = $this-&gt;graph['directed'] ? $this-&gt;dotCommand : $this-&gt;neatoCommand;
00110             $command .= <span class="stringliteral">" -T$format -o$outputfile $file"</span>;
00111  
00112             @`$command`;
00113             $command = $this-&gt;dotCommand;
00114             $command.= <span class="stringliteral">" -Tcmap -o$outputfile2 $file"</span>;
00115             @`$command`;
00116             $fr = fopen($outputfile2,<span class="stringliteral">"r"</span>);
00117             $map = fread($fr,filesize($outputfile2));
00118             fclose($fr);
00119             @unlink($file);
00120 
00121             <span class="keywordflow">switch</span> ($format) {
00122                 <span class="keywordflow">case</span> 'gif':
00123                 <span class="keywordflow">case</span> 'jpg':
00124                 <span class="keywordflow">case</span> 'png':
00125                 <span class="keywordflow">case</span> 'svg':
00126                 <span class="keywordflow">case</span> 'wbmp': {
00127                     header('Content-Type: image/' . $format);
00128                 }
00129                 <span class="keywordflow">break</span>;
00130 
00131                 <span class="keywordflow">case</span> 'pdf': {
00132                     header('Content-Type: application/pdf');
00133                 }
00134                 <span class="keywordflow">break</span>;
00135             }
00136 
00137             header('Content-Length: ' . filesize($outputfile));
00138 
00139             $fp = fopen($outputfile, 'rb');
00140 
00141             <span class="keywordflow">if</span> ($fp) {
00142                 echo fread($fp, filesize($outputfile));
00143                 fclose($fp);
00144                 @unlink($outputfile);
00145             }
00146             @unlink($outputfile2);
00147             <span class="keywordflow">return</span> $map;
00148         }
00149     }
00150     
00151     function image_and_map($format = 'png') {
00152         <span class="keywordflow">if</span> ($file = $this-&gt;saveParsedGraph()) {
00153             $outputfile = $file . <span class="charliteral">'.'</span> . $format;
00154             $outputfile2 = $file . <span class="charliteral">'.'</span> . 'map';
00155             <span class="keywordflow">if</span>(!isset($this-&gt;graph['directed'])) $this-&gt;graph['directed']=<span class="keyword">true</span>;
00156             $command  = $this-&gt;graph['directed'] ? $this-&gt;dotCommand : $this-&gt;neatoCommand;
00157             $command .= <span class="stringliteral">" -T$format -o$outputfile $file"</span>;
00158  
00159             @`$command`;
00160             $command = $this-&gt;dotCommand;
00161             $command.= <span class="stringliteral">" -Tcmap -o$outputfile2 $file"</span>;
00162             @`$command`;
00163             @unlink($file);
00164             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00165         }
00166     }
00167 
00168     
00169     function map() {
00170         <span class="keywordflow">if</span> ($file = $this-&gt;saveParsedGraph()) {
00171             
00172             $outputfile2 = $file . <span class="charliteral">'.'</span> . 'map';
00173             
00174             $command = $this-&gt;dotCommand;
00175             $command.= <span class="stringliteral">" -Tcmap -o$outputfile2 $file"</span>;
00176             @`$command`;
00177             $fr = fopen($outputfile2,<span class="stringliteral">"r"</span>);
00178             $map = fread($fr,filesize($outputfile2));
00179             fclose($fr);
00180             
00181             @unlink($outputfile2);
00182             @unlink($file);
00183             <span class="keywordflow">return</span> $map;
00184         }
00185     }
00186 
00194     function addCluster($id, $title) {
00195         $this-&gt;graph['clusters'][$id] = $title;
00196     }
00197 
00206     function addNode($name, $attributes = array(), $group = '<span class="keywordflow">default</span>') {
00207         $this-&gt;graph['nodes'][$group][$name] = $attributes;
00208     }
00209 
00216     function removeNode($name, $group = '<span class="keywordflow">default</span>') {
00217         <span class="keywordflow">if</span> (isset($this-&gt;graph['nodes'][$group][$name])) {
00218             unset($this-&gt;graph['nodes'][$group][$name]);
00219         }
00220     }
00221 
00229     function addEdge($edge, $attributes = array()) {
00230         <span class="keywordflow">if</span> (is_array($edge)) {
00231             $from = key($edge);
00232             $to   = $edge[$from];
00233             $id   = $from . <span class="charliteral">'_'</span> . $to;
00234 
00235             <span class="keywordflow">if</span> (!isset($this-&gt;graph['edges'][$id])) {
00236                 $this-&gt;graph['edges'][$id] = $edge;
00237             } <span class="keywordflow">else</span> {
00238                 $this-&gt;graph['edges'][$id] = array_merge(
00239                   $this-&gt;graph['edges'][$id],
00240                   $edge
00241                 );
00242             }
00243 
00244             <span class="keywordflow">if</span> (is_array($attributes)) {
00245                 <span class="keywordflow">if</span> (!isset($this-&gt;graph['edgeAttributes'][$id])) {
00246                     $this-&gt;graph['edgeAttributes'][$id] = $attributes;
00247                 } <span class="keywordflow">else</span> {
00248                     $this-&gt;graph['edgeAttributes'][$id] = array_merge(
00249                       $this-&gt;graph['edgeAttributes'][$id],
00250                       $attributes
00251                     );
00252                 }
00253             }
00254         }
00255     }
00256 
00263     function removeEdge($edge) {
00264         <span class="keywordflow">if</span> (is_array($edge)) {
00265               $from = key($edge);
00266               $to   = $edge[$from];
00267               $id   = $from . <span class="charliteral">'_'</span> . $to;
00268 
00269             <span class="keywordflow">if</span> (isset($this-&gt;graph['edges'][$id])) {
00270                 unset($this-&gt;graph['edges'][$id]);
00271             }
00272 
00273             <span class="keywordflow">if</span> (isset($this-&gt;graph['edgeAttributes'][$id])) {
00274                 unset($this-&gt;graph['edgeAttributes'][$id]);
00275             }
00276         }
00277     }
00278 
00285     function addAttributes($attributes) {
00286         <span class="keywordflow">if</span> (is_array($attributes)) {
00287             $this-&gt;graph['attributes'] = array_merge(
00288               $this-&gt;graph['attributes'],
00289               $attributes
00290             );
00291         }
00292     }
00293 
00300     function setAttributes($attributes) {
00301         <span class="keywordflow">if</span> (is_array($attributes)) {
00302             $this-&gt;graph['attributes'] = $attributes;
00303         }
00304     }
00305 
00312     function setDirected($directed) {
00313         <span class="keywordflow">if</span> (is_bool($directed)) {
00314             $this-&gt;graph['directed'] = $directed;
00315         }
00316     }
00317 
00324     function load($file) {
00325         <span class="keywordflow">if</span> ($serialized_graph = implode('', @file($file))) {
00326             $this-&gt;graph = unserialize($serialized_graph);
00327         }
00328     }
00329 
00337     function save($file = '') {
00338         $serialized_graph = serialize($this-&gt;graph);
00339 
00340         <span class="keywordflow">if</span> (empty($file)) {
00341             $file = tempnam('temp', 'graph_');
00342         }
00343 
00344         <span class="keywordflow">if</span> ($fp = @fopen($file, <span class="charliteral">'w'</span>)) {
00345             @fputs($fp, $serialized_graph);
00346             @fclose($fp);
00347 
00348             <span class="keywordflow">return</span> $file;
00349         }
00350 
00351         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00352     }
00353 
00360     function parse() {
00361         $parsedGraph = <span class="stringliteral">"digraph G {\n"</span>;
00362 
00363         <span class="keywordflow">if</span> (isset($this-&gt;graph['attributes'])) {
00364             foreach ($this-&gt;graph['attributes'] as $key =&gt; $value) {
00365                 $attributeList[] = $key . '=<span class="stringliteral">"' . $value . '"</span>';
00366             }
00367 
00368             <span class="keywordflow">if</span> (!empty($attributeList)) {
00369               $parsedGraph .= implode(<span class="charliteral">','</span>, $attributeList) . <span class="stringliteral">";\n"</span>;
00370             }
00371         }
00372 
00373         <span class="keywordflow">if</span> (isset($this-&gt;graph['nodes'])) {
00374             foreach($this-&gt;graph['nodes'] as $group =&gt; $nodes) {
00375                 <span class="keywordflow">if</span> ($group != '<span class="keywordflow">default</span>') {
00376                   $parsedGraph .= sprintf(
00377                     <span class="stringliteral">"subgraph \"cluster_%s\" {\nlabel=\"%s\";\n"</span>,
00378 
00379                     $group,
00380                     isset($this-&gt;graph['clusters'][$group]) ? $this-&gt;graph['clusters'][$group] : ''
00381                   );
00382                 }
00383 
00384                 foreach($nodes as $node =&gt; $attributes) {
00385                     unset($attributeList);
00386 
00387                     foreach($attributes as $key =&gt; $value) {
00388                         $attributeList[] = $key . '=<span class="stringliteral">"' . $value . '"</span>';
00389                     }
00390 
00391                     <span class="keywordflow">if</span> (!empty($attributeList)) {
00392                         $parsedGraph .= sprintf(
00393                           <span class="stringliteral">"\"%s\" [ %s ];\n"</span>,
00394                           addslashes(stripslashes($node)),
00395                           implode(<span class="charliteral">','</span>, $attributeList)
00396                         );
00397                     }
00398                 }
00399 
00400                 <span class="keywordflow">if</span> ($group != '<span class="keywordflow">default</span>') {
00401                   $parsedGraph .= <span class="stringliteral">"}\n"</span>;
00402                 }
00403             }
00404         }
00405 
00406         <span class="keywordflow">if</span> (isset($this-&gt;graph['edges'])) {
00407             foreach($this-&gt;graph['edges'] as $label =&gt; $node) {
00408                 unset($attributeList);
00409 
00410                 $from = key($node);
00411                 $to   = $node[$from];
00412 
00413                 foreach($this-&gt;graph['edgeAttributes'][$label] as $key =&gt; $value) {
00414                     $attributeList[] = $key . '=<span class="stringliteral">"' . $value . '"</span>';
00415                 }
00416 
00417                 $parsedGraph .= sprintf(
00418                   '<span class="stringliteral">"%s"</span> -&gt; <span class="stringliteral">"%s"</span>',
00419                   addslashes(stripslashes($from)),
00420                   addslashes(stripslashes($to))
00421                 );
00422                 
00423                 <span class="keywordflow">if</span> (!empty($attributeList)) {
00424                     $parsedGraph .= sprintf(
00425                       ' [ %s ]',
00426                       implode(<span class="charliteral">','</span>, $attributeList)
00427                     );
00428                 }
00429 
00430                 $parsedGraph .= <span class="stringliteral">";\n"</span>;
00431             }
00432         }
00433 
00434         <span class="keywordflow">return</span> $parsedGraph . <span class="stringliteral">"}\n"</span>;
00435     }
00436 
00445     function saveParsedGraph($file = '') {
00446         $parsedGraph = $this-&gt;parse();
00447         <span class="keywordflow">if</span> (!empty($parsedGraph)) {
00448 
00449                 $file = 'lib/Galaxia/Processes/'.$this-&gt;pid.'/graph/'.$this-&gt;pid;
00450             <span class="keywordflow">if</span> ($fp = @fopen($file, <span class="charliteral">'w'</span>)) {
00451                 @fputs($fp, $parsedGraph);
00452                 @fclose($fp);
00453 
00454                 <span class="keywordflow">return</span> $file;
00455             }
00456         }
00457 
00458         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00459     }
00460 }
00461 ?&gt;
</pre></div><hr><address style="align: right;"><small>Generated on Fri Apr 25 16:07:08 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
