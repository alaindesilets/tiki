<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RoleManager.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>RoleManager.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 
00005 
<a name="l00017"></a><a class="code" href="classRoleManager.html">00017</a> <span class="keyword">class </span><a class="code" href="classRoleManager.html">RoleManager</a> <span class="keyword">extends</span> BaseManager {
00018     
<a name="l00023"></a><a class="code" href="classRoleManager.html#a0">00023</a>   function <a class="code" href="classRoleManager.html#a0">RoleManager</a>($db) 
00024   {
00025     <span class="keywordflow">if</span>(!$db) {
00026       die(<span class="stringliteral">"Invalid db object passed to RoleManager constructor"</span>);  
00027     }
00028     $this-&gt;db = $db;  
00029   }
00030   
<a name="l00034"></a><a class="code" href="classRoleManager.html#a1">00034</a>   function <a class="code" href="classRoleManager.html#a1">get_role</a>($pId, $roleId)
00035   {
00036         $query = <span class="stringliteral">"select * from galaxia_roles where pId=$pId and roleId=$roleId"</span>;
00037         $result = $this-&gt;query($query);
00038         $res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC);
00039         <span class="keywordflow">return</span> $res;
00040   }
00041   
<a name="l00045"></a><a class="code" href="classRoleManager.html#a2">00045</a>   function <a class="code" href="classRoleManager.html#a2">role_name_exists</a>($name)
00046   {
00047         $name = addslashes($name);
00048     <span class="keywordflow">return</span> ($this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_roles where name='$name'"</span>));
00049   }
00050   
<a name="l00054"></a><a class="code" href="classRoleManager.html#a3">00054</a>   function <a class="code" href="classRoleManager.html#a3">map_user_to_role</a>($pId,$user,$roleId)
00055   {
00056     $query = <span class="stringliteral">"replace into galaxia_user_roles(pId,user,roleId) values($pId,'$user',$roleId)"</span>;
00057     $this-&gt;query($query);
00058   }
00059   
<a name="l00063"></a><a class="code" href="classRoleManager.html#a4">00063</a>   function <a class="code" href="classRoleManager.html#a4">remove_mapping</a>($user,$roleId)
00064   { 
00065     $query = <span class="stringliteral">"delete from galaxia_user_roles where user='$user' and roleId=$roleId"</span>;
00066     $this-&gt;query($query);
00067   }
00068   
<a name="l00072"></a><a class="code" href="classRoleManager.html#a5">00072</a>   function <a class="code" href="classRoleManager.html#a5">list_mappings</a>($pId,$offset,$maxRecords,$sort_mode,$find)  {
00073     $sort_mode = str_replace(<span class="stringliteral">"_"</span>,<span class="stringliteral">" "</span>,$sort_mode);
00074     <span class="keywordflow">if</span>($find) {
00075       $mid=<span class="stringliteral">" where gr.roleId=gur.roleId and gur.pId=$pId and ((name like '%"</span>.$find.<span class="stringliteral">"%') or (user like '%"</span>.$find.<span class="stringliteral">"%') or (description like '%"</span>.$find.<span class="stringliteral">"%'))"</span>;
00076     } <span class="keywordflow">else</span> {
00077       $mid=<span class="stringliteral">" where gr.roleId=gur.roleId and gur.pId=$pId "</span>;
00078     }
00079     $query = <span class="stringliteral">"select name,gr.roleId,user from galaxia_roles gr, galaxia_user_roles gur $mid order by $sort_mode limit $offset,$maxRecords"</span>;
00080     $query_cant = <span class="stringliteral">"select count(*) from galaxia_roles gr, galaxia_user_roles gur $mid"</span>;
00081     $result = $this-&gt;query($query);
00082     $cant = $this-&gt;getOne($query_cant);
00083     $ret = Array();
00084     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00085       $ret[] = $res;
00086     }
00087     $retval = Array();
00088     $retval[<span class="stringliteral">"data"</span>] = $ret;
00089     $retval[<span class="stringliteral">"cant"</span>] = $cant;
00090     <span class="keywordflow">return</span> $retval;
00091   }
00092   
<a name="l00096"></a><a class="code" href="classRoleManager.html#a6">00096</a>   function <a class="code" href="classRoleManager.html#a6">list_roles</a>($pId,$offset,$maxRecords,$sort_mode,$find,$where='')
00097   {
00098     $sort_mode = str_replace(<span class="stringliteral">"_"</span>,<span class="stringliteral">" "</span>,$sort_mode);
00099     <span class="keywordflow">if</span>($find) {
00100       $mid=<span class="stringliteral">" where pId=$pId and ((name like '%"</span>.$find.<span class="stringliteral">"%') or (description like '%"</span>.$find.<span class="stringliteral">"%'))"</span>;
00101     } <span class="keywordflow">else</span> {
00102       $mid=<span class="stringliteral">" where pId=$pId "</span>;
00103     }
00104     <span class="keywordflow">if</span>($where) {
00105       $mid.= <span class="stringliteral">" and ($where) "</span>;
00106     }
00107     $query = <span class="stringliteral">"select * from galaxia_roles $mid order by $sort_mode limit $offset,$maxRecords"</span>;
00108     $query_cant = <span class="stringliteral">"select count(*) from galaxia_roles $mid"</span>;
00109     $result = $this-&gt;query($query);
00110     $cant = $this-&gt;getOne($query_cant);
00111     $ret = Array();
00112     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00113       $ret[] = $res;
00114     }
00115     $retval = Array();
00116     $retval[<span class="stringliteral">"data"</span>] = $ret;
00117     $retval[<span class="stringliteral">"cant"</span>] = $cant;
00118     <span class="keywordflow">return</span> $retval;
00119   }
00120   
00121   
00122   
<a name="l00126"></a><a class="code" href="classRoleManager.html#a7">00126</a>   function <a class="code" href="classRoleManager.html#a7">remove_role</a>($pId, $roleId)
00127   {
00128     $query = <span class="stringliteral">"delete from galaxia_roles where pId=$pId and roleId=$roleId"</span>;
00129     $this-&gt;query($query);
00130     $query = <span class="stringliteral">"delete from galaxia_activity_roles where roleId=$roleId"</span>;
00131     $this-&gt;query($query);
00132     $query = <span class="stringliteral">"delete from galaxia_user_roles where roleId=$roleId"</span>;
00133     $this-&gt;query($query);
00134   }
00135   
<a name="l00142"></a><a class="code" href="classRoleManager.html#a8">00142</a>   function <a class="code" href="classRoleManager.html#a8">replace_role</a>($pId, $roleId, $vars)
00143   {
00144     $TABLE_NAME = 'galaxia_roles';
00145     $now = date(<span class="stringliteral">"U"</span>);
00146     $vars['lastModif']=$now;
00147     $vars['pId']=$pId;
00148     
00149     foreach($vars as $key=&gt;$value)
00150     {
00151       $vars[$key]=addslashes($value);
00152     }
00153   
00154     <span class="keywordflow">if</span>($roleId) {
00155       <span class="comment">// update mode</span>
00156       $first = <span class="keyword">true</span>;
00157       $query =<span class="stringliteral">"update $TABLE_NAME set"</span>;
00158       foreach($vars as $key=&gt;$value) {
00159         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>;
00160         <span class="keywordflow">if</span>(!is_numeric($value)) $value=<span class="stringliteral">"'"</span>.$value.<span class="stringliteral">"'"</span>;
00161         $query.= <span class="stringliteral">" $key=$value "</span>;
00162         $first = <span class="keyword">false</span>;
00163       }
00164       $query .= <span class="stringliteral">" where pId=$pId and roleId=$roleId "</span>;
00165       $this-&gt;query($query);
00166     } <span class="keywordflow">else</span> {
00167       $name = $vars['name'];
00168       <span class="keywordflow">if</span> ($this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_roles where pId=$pId and name='$name'"</span>)) {
00169         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00170       }
00171       unset($vars['roleId']);
00172       <span class="comment">// insert mode</span>
00173       $first = <span class="keyword">true</span>;
00174       $query = <span class="stringliteral">"insert into $TABLE_NAME("</span>;
00175       foreach(array_keys($vars) as $key) {
00176         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>; 
00177         $query.= <span class="stringliteral">"$key"</span>;
00178         $first = <span class="keyword">false</span>;
00179       } 
00180       $query .=<span class="stringliteral">") values("</span>;
00181       $first = <span class="keyword">true</span>;
00182       foreach(array_values($vars) as $value) {
00183         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>; 
00184         <span class="keywordflow">if</span>(!is_numeric($value)) $value=<span class="stringliteral">"'"</span>.$value.<span class="stringliteral">"'"</span>;
00185         $query.= <span class="stringliteral">"$value"</span>;
00186         $first = <span class="keyword">false</span>;
00187       } 
00188       $query .=<span class="stringliteral">")"</span>;
00189       $this-&gt;query($query);
00190       $roleId = $this-&gt;getOne(<span class="stringliteral">"select max(roleId) from $TABLE_NAME where pId=$pId and lastModif=$now"</span>); 
00191     }
00192     <span class="comment">// Get the id</span>
00193     <span class="keywordflow">return</span> $roleId;
00194   }
00195     
00196 }
00197 
00198 
00199 ?&gt;
</pre></div><hr><address style="align: right;"><small>Generated on Fri Apr 25 16:07:09 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
