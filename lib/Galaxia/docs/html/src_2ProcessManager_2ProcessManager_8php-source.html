<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ProcessManager.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>ProcessManager.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 
00005 
<a name="l00012"></a><a class="code" href="classProcessManager.html">00012</a> <span class="keyword">class </span><a class="code" href="classProcessManager.html">ProcessManager</a> <span class="keyword">extends</span> BaseManager {
00013   var $parser;
00014   var $tree;
00015   var $current;
00016   var $buffer;
00017   
<a name="l00022"></a><a class="code" href="classProcessManager.html#a0">00022</a>   function <a class="code" href="classProcessManager.html#a0">ProcessManager</a>($db) 
00023   {
00024     <span class="keywordflow">if</span>(!$db) {
00025       die(<span class="stringliteral">"Invalid db object passed to ProcessManager constructor"</span>);  
00026     }
00027     $this-&gt;db = $db;  
00028   }
00029   
00030  
<a name="l00034"></a><a class="code" href="classProcessManager.html#a1">00034</a>   function <a class="code" href="classProcessManager.html#a1">activate_process</a>($pId)
00035   {
00036         $query = <span class="stringliteral">"update galaxia_processes set isActive='y' where pId=$pId"</span>;
00037     $this-&gt;query($query);  
00038     $msg = sprintf(tra('Process %d has been activated'),$pId);
00039     $this-&gt;<a class="code" href="classObservable.html#b0">notify_all</a>(3,$msg);
00040   }
00041   
<a name="l00045"></a><a class="code" href="classProcessManager.html#a2">00045</a>   function <a class="code" href="classProcessManager.html#a2">deactivate_process</a>($pId)
00046   {
00047     $query = <span class="stringliteral">"update galaxia_processes set isActive='n' where pId=$pId"</span>;
00048     $this-&gt;query($query);  
00049     $msg = sprintf(tra('Process %d has been deactivated'),$pId);
00050     $this-&gt;<a class="code" href="classObservable.html#b0">notify_all</a>(3,$msg);
00051   }
00052   
<a name="l00056"></a><a class="code" href="classProcessManager.html#a3">00056</a>   function <a class="code" href="classProcessManager.html#a3">serialize_process</a>($pId)
00057   {
00058     <span class="comment">// &lt;process&gt;</span>
00059     $out = '&lt;process&gt;'.<span class="stringliteral">"\n"</span>;
00060     $proc_info = $this-&gt;<a class="code" href="classProcessManager.html#a8">get_process</a>($pId);
00061     $procname = $proc_info['normalized_name'];
00062     $out.= '  &lt;name&gt;'.htmlspecialchars($proc_info['name']).'&lt;/name&gt;'.<span class="stringliteral">"\n"</span>;
00063     $out.= '  &lt;isValid&gt;'.htmlspecialchars($proc_info['isValid']).'&lt;/isValid&gt;'.<span class="stringliteral">"\n"</span>;
00064     $out.= '  &lt;version&gt;'.htmlspecialchars($proc_info['version']).'&lt;/version&gt;'.<span class="stringliteral">"\n"</span>;
00065     $out.= '  &lt;isActive&gt;'.htmlspecialchars($proc_info['isActive']).'&lt;/isActive&gt;'.<span class="stringliteral">"\n"</span>;
00066         $out.='   &lt;description&gt;'.htmlspecialchars($proc_info['description']).'&lt;/description&gt;'.<span class="stringliteral">"\n"</span>;
00067     $out.= '  &lt;lastModif&gt;'.date(<span class="stringliteral">"d/m/Y [h:i:s]"</span>,$proc_info['lastModif']).'&lt;/lastModif&gt;'.<span class="stringliteral">"\n"</span>;
00068         $out.= '  &lt;sharedCode&gt;&lt;![CDATA[';
00069         $fp=fopen(<span class="stringliteral">"lib/Galaxia/processes/$procname/code/shared.php"</span>,<span class="stringliteral">"r"</span>);
00070         <span class="keywordflow">while</span>(!feof($fp)) {
00071           $line=fread($fp,8192);
00072           $out.=$line;
00073         }
00074         fclose($fp);
00075         $out.= '  ]]&gt;&lt;/sharedCode&gt;'.<span class="stringliteral">"\n"</span>;
00076         <span class="comment">// Now loop over activities</span>
00077         $query = <span class="stringliteral">"select * from galaxia_activities where pId=$pId"</span>;
00078         $result = $this-&gt;query($query);
00079         $out.='  &lt;activities&gt;'.<span class="stringliteral">"\n"</span>;
00080         $am = <span class="keyword">new</span> <a class="code" href="classActivityManager.html">ActivityManager</a>($this-&gt;db);
00081     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {       
00082         $name = $res['normalized_name'];
00083                 $out.='    &lt;activity&gt;'.<span class="stringliteral">"\n"</span>;
00084                 $out.='      &lt;name&gt;'.htmlspecialchars($res['name']).'&lt;/name&gt;'.<span class="stringliteral">"\n"</span>;
00085                 $out.='      &lt;type&gt;'.htmlspecialchars($res['type']).'&lt;/type&gt;'.<span class="stringliteral">"\n"</span>;
00086                 $out.='      &lt;description&gt;'.htmlspecialchars($res['description']).'&lt;/description&gt;'.<span class="stringliteral">"\n"</span>;
00087                 $out.='      &lt;lastModif&gt;'.date(<span class="stringliteral">"d/m/Y [h:i:s]"</span>,$res['lastModif']).'&lt;/lastModif&gt;'.<span class="stringliteral">"\n"</span>;
00088                 $out.='      &lt;isInteractive&gt;'.$res['isInteractive'].'&lt;/isInteractive&gt;'.<span class="stringliteral">"\n"</span>;
00089                 $out.='      &lt;isAutoRouted&gt;'.$res['isAutoRouted'].'&lt;/isAutoRouted&gt;'.<span class="stringliteral">"\n"</span>;
00090                 $out.='      &lt;roles&gt;'.<span class="stringliteral">"\n"</span>;
00091                 
00092                 $roles = $am-&gt;get_activity_roles($res['activityId']);
00093                 foreach($roles as $role) {
00094                   $out.='        &lt;role&gt;'.htmlspecialchars($role['name']).'&lt;/role&gt;'.<span class="stringliteral">"\n"</span>;
00095                 }       
00096                 $out.='      &lt;/roles&gt;'.<span class="stringliteral">"\n"</span>;
00097                 $out.='      &lt;code&gt;&lt;![CDATA[';
00098                 $fp=fopen(<span class="stringliteral">"lib/Galaxia/processes/$procname/code/activities/$name.php"</span>,<span class="stringliteral">"r"</span>);
00099                 <span class="keywordflow">while</span>(!feof($fp)) {
00100                         $line=fread($fp,8192);
00101                         $out.=$line;
00102                 }
00103                 fclose($fp);
00104                 $out.='      ]]&gt;&lt;/code&gt;';
00105                 <span class="keywordflow">if</span>($res['isInteractive']==<span class="charliteral">'y'</span>) {
00106                         $out.='      &lt;<span class="keyword">template</span>&gt;&lt;![CDATA[';
00107                         $fp=fopen(<span class="stringliteral">"lib/Galaxia/processes/$procname/code/templates/$name.tpl"</span>,<span class="stringliteral">"r"</span>);
00108                         <span class="keywordflow">while</span>(!feof($fp)) {
00109                                 $line=fread($fp,8192);
00110                                 $out.=$line;
00111                         }
00112                         fclose($fp);
00113                         $out.='      ]]&gt;&lt;/<span class="keyword">template</span>&gt;';
00114                 }
00115                 $out.='    &lt;/activity&gt;'.<span class="stringliteral">"\n"</span>;    
00116     }
00117         $out.='  &lt;/activities&gt;'.<span class="stringliteral">"\n"</span>;
00118         $out.='  &lt;transitions&gt;'.<span class="stringliteral">"\n"</span>;
00119         $transitions = $am-&gt;get_process_transitions($pId);
00120         foreach($transitions as $tran) {
00121           $out.='     &lt;transition&gt;'.<span class="stringliteral">"\n"</span>;
00122           $out.='       &lt;from&gt;'.htmlspecialchars($tran['actFromName']).'&lt;/from&gt;'.<span class="stringliteral">"\n"</span>;
00123           $out.='       &lt;to&gt;'.htmlspecialchars($tran['actToName']).'&lt;/to&gt;'.<span class="stringliteral">"\n"</span>;
00124           $out.='     &lt;/transition&gt;'.<span class="stringliteral">"\n"</span>;
00125         }       
00126         $out.='  &lt;/transitions&gt;'.<span class="stringliteral">"\n"</span>;
00127     $out.= '&lt;/process&gt;'.<span class="stringliteral">"\n"</span>;
00128     <span class="comment">//$fp = fopen("lib/Galaxia/processes/$procname/$procname.xml","w");</span>
00129     <span class="comment">//fwrite($fp,$out);</span>
00130     <span class="comment">//fclose($fp);</span>
00131     <span class="keywordflow">return</span> $out;
00132   }
00133   
<a name="l00138"></a><a class="code" href="classProcessManager.html#a4">00138</a>   function <a class="code" href="classProcessManager.html#a4">unserialize_process</a>($xml) 
00139   {
00140         <span class="comment">// Create SAX parser assign this object as base for handlers</span>
00141         <span class="comment">// handlers are private methods defined below.</span>
00142         <span class="comment">// keep contexts and parse</span>
00143         $this-&gt;parser = xml_parser_create(); 
00144         xml_parser_set_option($this-&gt;parser,XML_OPTION_CASE_FOLDING,0);
00145         xml_set_object($this-&gt;parser, &amp;$<span class="keyword">this</span>);
00146         xml_set_element_handler($this-&gt;parser, <span class="stringliteral">"_start_element_handler"</span>, <span class="stringliteral">"_end_element_handler"</span>);
00147     xml_set_character_data_handler($this-&gt;parser, <span class="stringliteral">"_data_handler"</span>); 
00148     $aux=Array(
00149         'name'=&gt;'root',
00150         'children'=&gt;Array(),
00151         'parent' =&gt; 0,
00152         'data'=&gt;''
00153     );
00154     $this-&gt;tree[0]=$aux;
00155     $this-&gt;current=0;
00156     <span class="keywordflow">if</span> (!xml_parse($this-&gt;parser, $xml, <span class="keyword">true</span>)) {
00157         $error = sprintf(<span class="stringliteral">"XML error: %s at line %d"</span>,
00158                     xml_error_string(xml_get_error_code($this-&gt;parser)),
00159                     xml_get_current_line_number($this-&gt;parser));
00160         trigger_error($error,E_USER_WARNING);
00161         }
00162     xml_parser_free($this-&gt;parser);   
00163         <span class="comment">// Now that we have the tree we can do interesting things</span>
00164         <span class="comment">//print_r($this-&gt;tree);</span>
00165         $process=Array();
00166         $activities=Array();
00167         $transitions=Array();
00168         <span class="keywordflow">for</span>($i=0;$i&lt;count($this-&gt;tree[1]['children']);$i++) {
00169           <span class="comment">// Process attributes</span>
00170           $z=$this-&gt;tree[1]['children'][$i];
00171           $name = trim($this-&gt;tree[$z]['name']);
00172           <span class="keywordflow">if</span>($name=='activities') {
00173             <span class="keywordflow">for</span>($j=0;$j&lt;count($this-&gt;tree[$z]['children']);$j++) {
00174               $z2 = $this-&gt;tree[$z]['children'][$j];
00175               <span class="comment">// this is an activity $name = $this-&gt;tree[$z2]['name'];</span>
00176               <span class="keywordflow">if</span>($this-&gt;tree[$z2]['name']=='activity') {
00177               <span class="keywordflow">for</span>($k=0;$k&lt;count($this-&gt;tree[$z2]['children']);$k++) {
00178                 $z3 = $this-&gt;tree[$z2]['children'][$k];
00179                 $name = trim($this-&gt;tree[$z3]['name']);
00180                 $value= trim($this-&gt;tree[$z3]['data']);
00181                 <span class="keywordflow">if</span>($name=='roles') {
00182                   $roles=Array();
00183                           <span class="keywordflow">for</span>($l=0;$l&lt;count($this-&gt;tree[$z3]['children']);$l++) {
00184                             $z4 = $this-&gt;tree[$z3]['children'][$l];
00185                             $name = trim($this-&gt;tree[$z4]['name']);
00186                             $data = trim($this-&gt;tree[$z4]['data']);
00187                             $roles[]=$data;
00188                           }                                
00189                 } <span class="keywordflow">else</span> {
00190                         
00191                   $aux[$name]=$value;
00192                   <span class="comment">//print("$name:$value&lt;br/&gt;");</span>
00193                 }
00194               }
00195           $aux['roles']=$roles;
00196           $activities[]=$aux;
00197           }
00198             }
00199           } elseif($name=='transitions') {
00200             <span class="keywordflow">for</span>($j=0;$j&lt;count($this-&gt;tree[$z]['children']);$j++) {
00201               $z2 = $this-&gt;tree[$z]['children'][$j];
00202               <span class="comment">// this is an activity $name = $this-&gt;tree[$z2]['name'];</span>
00203               <span class="keywordflow">if</span>($this-&gt;tree[$z2]['name']=='transition') {
00204               <span class="keywordflow">for</span>($k=0;$k&lt;count($this-&gt;tree[$z2]['children']);$k++) {
00205                 $z3 = $this-&gt;tree[$z2]['children'][$k];
00206                 $name = trim($this-&gt;tree[$z3]['name']);
00207                 $value= trim($this-&gt;tree[$z3]['data']);
00208                 <span class="keywordflow">if</span>($name == 'from' || $name == 'to') {
00209                   $aux[$name]=$value;
00210                 }
00211               }
00212               }
00213               $transitions[] = $aux;
00214             }
00215 
00216           
00217           } <span class="keywordflow">else</span> {
00218             $value = trim($this-&gt;tree[$z]['data']);
00219             <span class="comment">//print("$name is $value&lt;br/&gt;");</span>
00220             $process[$name]=$value;
00221             
00222           }
00223         }
00224         $process['activities']=$activities;
00225         $process['transitions']=$transitions;
00226         <span class="keywordflow">return</span> $process;
00227   }
00228   
<a name="l00234"></a><a class="code" href="classProcessManager.html#a5">00234</a>   function <a class="code" href="classProcessManager.html#a5">import_process</a>($data)
00235   {
00236         <span class="comment">//Now the show begins</span>
00237         $am = <span class="keyword">new</span> <a class="code" href="classActivityManager.html">ActivityManager</a>($this-&gt;db);
00238         $rm = <span class="keyword">new</span> <a class="code" href="classRoleManager.html">RoleManager</a>($this-&gt;db);
00239         <span class="comment">// First create the process</span>
00240         $vars = Array(
00241                 'name' =&gt; $data['name'],
00242                 'version' =&gt; $data['version'],
00243                 'description' =&gt; $data['description'],
00244                 'lastModif' =&gt; $data['lastModif'],
00245                 'isActive' =&gt; $data['isActive'],
00246                 'isValid' =&gt; $data['isValid']
00247         );
00248         $pid = $this-&gt;<a class="code" href="classProcessManager.html#a12">replace_process</a>(0,$vars);
00249         <span class="comment">//Put the shared code </span>
00250         $proc_info = $this-&gt;<a class="code" href="classProcessManager.html#a8">get_process</a>($pid);
00251         $procname = $proc_info['normalized_name'];
00252         $fp = fopen(<span class="stringliteral">"lib/Galaxia/processes/$procname/code/shared.php"</span>,<span class="stringliteral">"w"</span>);
00253         fwrite($fp,$data['sharedCode']);
00254         fclose($fp);
00255         $actids = Array();
00256         <span class="comment">// Foreach activity create activities</span>
00257         foreach($data['activities'] as $activity) {
00258           $vars = Array(
00259                 'name' =&gt; $activity['name'],
00260                 'description' =&gt; $activity['description'],
00261                 'type' =&gt; $activity['type'],
00262                 'lastModif' =&gt; $activity['lastModif'],
00263                 'isInteractive' =&gt; $activity['isInteractive'],
00264                 'isAutoRouted' =&gt; $activity['isAutoRouted']
00265           );      
00266           $actname=$am-&gt;_normalize_name($activity['name']);
00267       $fp = fopen(<span class="stringliteral">"lib/Galaxia/processes/$procname/code/activities/$actname"</span>.'.php',<span class="stringliteral">"w"</span>);
00268       fwrite($fp,$activity['code']);
00269       fclose($fp);
00270       <span class="keywordflow">if</span>($activity['isInteractive']==<span class="charliteral">'y'</span>) {
00271         $fp = fopen(<span class="stringliteral">"lib/Galaxia/processes/$procname/code/templates/$actname"</span>.'.tpl',<span class="stringliteral">"w"</span>);
00272         fwrite($fp,$activity['<span class="keyword">template</span>']);
00273         fclose($fp);
00274       }
00275       $actid = $am-&gt;replace_activity($pid,0,$vars);
00276       $actids[$activity['name']] = $am-&gt;_get_activity_id_by_name($pid,$activity['name']);
00277           $actname = $am-&gt;_normalize_name($activity['name']);
00278           $now = date(<span class="stringliteral">"U"</span>);
00279           foreach($activity['roles'] as $role) {
00280             $vars = Array(
00281                 'name' =&gt; $role,
00282                 'description' =&gt; $role,
00283                 'lastModif' =&gt; $now,
00284                 );        
00285                 <span class="keywordflow">if</span>(!$rm-&gt;role_name_exists($role['name'])) {
00286                   $rid=$rm-&gt;replace_role($pid,0,$vars);
00287                 }
00288                 $am-&gt;add_activity_role($actid,$rid);
00289                 
00290           }
00291         }
00292         foreach($data['transitions'] as $tran) {
00293                 $am-&gt;add_transition($pid,$actids[$tran['from']],$actids[$tran['to']]);  
00294         }
00295         unset($am);
00296         unset($rm);
00297         $msg = sprintf(tra('Process %s %s imported'),$vars['name'],$vars['version']);
00298         $this-&gt;<a class="code" href="classObservable.html#b0">notify_all</a>(2,$msg);
00299   }
00300   
00301   
00302    
00303     
00310 
<a name="l00311"></a><a class="code" href="classProcessManager.html#a6">00311</a>   function <a class="code" href="classProcessManager.html#a6">new_process_version</a>($pId, $minor=<span class="keyword">true</span>)
00312   {
00313     $oldpid = $pId;
00314     $proc_info = $this-&gt;<a class="code" href="classProcessManager.html#a8">get_process</a>($pId);
00315     $name = $proc_info['name'];
00316     <span class="keywordflow">if</span>(!$proc_info) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00317     <span class="comment">// Now update the version</span>
00318     $version = $this-&gt;_new_version($proc_info['version'],$minor);
00319     <span class="keywordflow">while</span>($this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_processes where name='$name' and version='$version'"</span>)) {
00320         $version = $this-&gt;_new_version($version,$minor);
00321     }
00322     <span class="comment">// Make new versions unactive</span>
00323     $proc_info['version'] = $version;
00324     $proc_info['isActive'] = <span class="charliteral">'n'</span>;
00325     $pid = $this-&gt;<a class="code" href="classProcessManager.html#a12">replace_process</a>(<span class="comment">/*new proc!*/</span> 0, $proc_info);
00326     <span class="comment">// And here copy all the activities &amp; so</span>
00327     $aM = <span class="keyword">new</span> <a class="code" href="classActivityManager.html">ActivityManager</a>($this-&gt;db);
00328     $query = <span class="stringliteral">"select * from galaxia_activities where pId=$oldpid"</span>;
00329         $result = $this-&gt;query($query);
00330     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {    
00331       $aM-&gt;replace_activity($pid,0,$res);
00332     }
00333     $query = <span class="stringliteral">"select * from galaxia_transitions where pId=$oldpid"</span>;
00334         $result = $this-&gt;query($query);
00335     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {    
00336       $aM-&gt;add_transition($pid,$res['actFromId'],$res['actToId']);
00337     }
00338     
00339     <span class="comment">//Now since we are copying a process we should copy</span>
00340     <span class="comment">//the old directory structure to the new directory</span>
00341     $oldname = $proc_info['normalized_name'];
00342     $newname = $this-&gt;_get_normalized_name($pid);
00343         $this-&gt;_rec_copy(<span class="stringliteral">"lib/Galaxia/processes/$oldname"</span>,<span class="stringliteral">"lib/Galaxia/processes/$newname"</span>);
00344     <span class="keywordflow">return</span> $pid;
00345   }
00346   
<a name="l00353"></a><a class="code" href="classProcessManager.html#a7">00353</a>   function <a class="code" href="classProcessManager.html#a7">process_name_exists</a>($name,$version)
00354   {
00355     $name = addslashes($this-&gt;_normalize_name($name,$version));
00356     <span class="keywordflow">return</span> $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_processes where normalized_name='$name'"</span>);
00357   }
00358   
00359   
<a name="l00363"></a><a class="code" href="classProcessManager.html#a8">00363</a>   function <a class="code" href="classProcessManager.html#a8">get_process</a>($pId)
00364   {
00365         $query = <span class="stringliteral">"select * from galaxia_processes where pId=$pId"</span>;
00366         $result = $this-&gt;query($query);
00367         <span class="keywordflow">if</span>(!$result-&gt;numRows()) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00368         $res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC);
00369         <span class="keywordflow">return</span> $res;
00370   }
00371   
<a name="l00375"></a><a class="code" href="classProcessManager.html#a9">00375</a>   function <a class="code" href="classProcessManager.html#a9">list_processes</a>($offset,$maxRecords,$sort_mode,$find,$where='')
00376   {
00377     $sort_mode = str_replace(<span class="stringliteral">"_"</span>,<span class="stringliteral">" "</span>,$sort_mode);
00378     <span class="keywordflow">if</span>($find) {
00379       $mid=<span class="stringliteral">" where ((name like '%"</span>.$find.<span class="stringliteral">"%') or (description like '%"</span>.$find.<span class="stringliteral">"%'))"</span>;
00380     } <span class="keywordflow">else</span> {
00381       $mid=<span class="stringliteral">""</span>;
00382     }
00383     <span class="keywordflow">if</span>($where) {
00384       <span class="keywordflow">if</span>($mid) {
00385         $mid.= <span class="stringliteral">" and ($where) "</span>;
00386       } <span class="keywordflow">else</span> {
00387         $mid.= <span class="stringliteral">" where ($where) "</span>;
00388       }
00389     }
00390     $query = <span class="stringliteral">"select * from galaxia_processes $mid order by $sort_mode limit $offset,$maxRecords"</span>;
00391     $query_cant = <span class="stringliteral">"select count(*) from galaxia_processes $mid"</span>;
00392     $result = $this-&gt;query($query);
00393     $cant = $this-&gt;getOne($query_cant);
00394     $ret = Array();
00395     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00396       $ret[] = $res;
00397     }
00398     $retval = Array();
00399     $retval[<span class="stringliteral">"data"</span>] = $ret;
00400     $retval[<span class="stringliteral">"cant"</span>] = $cant;
00401     <span class="keywordflow">return</span> $retval;
00402   }
00403   
<a name="l00407"></a><a class="code" href="classProcessManager.html#a10">00407</a>   function <a class="code" href="classProcessManager.html#a10">invalidate_process</a>($pid)
00408   {
00409     $query = <span class="stringliteral">"update galaxia_processes set isValid='n' where pId=$pid"</span>;
00410     $this-&gt;query($query);
00411   }
00412   
<a name="l00416"></a><a class="code" href="classProcessManager.html#a11">00416</a>   function <a class="code" href="classProcessManager.html#a11">remove_process</a>($pId)
00417   {
00418     $this-&gt;<a class="code" href="classProcessManager.html#a2">deactivate_process</a>($pId);
00419     $name = $this-&gt;_get_normalized_name($pId);
00420         $aM = <span class="keyword">new</span> <a class="code" href="classActivityManager.html">ActivityManager</a>($this-&gt;db);
00421     <span class="comment">// Remove process activities</span>
00422         $query = <span class="stringliteral">"select activityId from galaxia_activities where pId=$pId"</span>;
00423         $result = $this-&gt;query($query);
00424     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00425                 $aM-&gt;remove_activity($pId,$res['activityId']);
00426     }
00427 
00428     <span class="comment">// Remove process roles</span>
00429     $query = <span class="stringliteral">"delete from galaxia_roles where pId=$pId"</span>;
00430     $this-&gt;query($query);
00431     $query = <span class="stringliteral">"delete from galaxia_user_roles where pId=$pId"</span>;
00432     $this-&gt;query($query);
00433     
00434     <span class="comment">// Remove the directory structure</span>
00435     $this-&gt;_remove_directory(<span class="stringliteral">"lib/Galaxia/processes/$name"</span>,<span class="keyword">true</span>);
00436         $this-&gt;_remove_directory(<span class="stringliteral">"templates/$name"</span>,<span class="keyword">true</span>);
00437         <span class="comment">// And finally remove the proc</span>
00438     $query = <span class="stringliteral">"delete from galaxia_processes where pId=$pId"</span>;
00439     $this-&gt;query($query);
00440     $msg = sprintf(tra('Process %s removed'),$name);
00441         $this-&gt;<a class="code" href="classObservable.html#b0">notify_all</a>(5,$msg);
00442     
00443     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00444   }
00445   
<a name="l00451"></a><a class="code" href="classProcessManager.html#a12">00451</a>   function <a class="code" href="classProcessManager.html#a12">replace_process</a>($pId, $vars)
00452   {
00453     $TABLE_NAME = 'galaxia_processes';
00454     $now = date(<span class="stringliteral">"U"</span>);
00455     $vars['lastModif']=$now;
00456     $vars['normalized_name'] = $this-&gt;_normalize_name($vars['name'],$vars['version']);        
00457     foreach($vars as $key=&gt;$value)
00458     {
00459       $vars[$key]=addslashes($value);
00460     }
00461   
00462     <span class="keywordflow">if</span>($pId) {
00463       <span class="comment">// update mode</span>
00464       $old_proc = $this-&gt;<a class="code" href="classProcessManager.html#a8">get_process</a>($pId);
00465       $first = <span class="keyword">true</span>;
00466       $query =<span class="stringliteral">"update $TABLE_NAME set"</span>;
00467       foreach($vars as $key=&gt;$value) {
00468         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>;
00469         <span class="keywordflow">if</span>(!is_numeric($value)||strstr($value,<span class="charliteral">'.'</span>)) $value=<span class="stringliteral">"'"</span>.$value.<span class="stringliteral">"'"</span>;
00470         $query.= <span class="stringliteral">" $key=$value "</span>;
00471         $first = <span class="keyword">false</span>;
00472       }
00473       $query .= <span class="stringliteral">" where pId=$pId "</span>;
00474       $this-&gt;query($query);
00475       <span class="comment">// Note that if the name is being changed then</span>
00476       <span class="comment">// the directory has to be renamed!</span>
00477       $oldname = $old_proc['normalized_name'];
00478       $newname = $vars['normalized_name'];
00479       rename(<span class="stringliteral">"lib/Galaxia/processes/$oldname"</span>,<span class="stringliteral">"lib/Galaxia/processes/$newname"</span>);
00480       $msg = sprintf(tra('Process %s has been updated'),$vars['name']);     
00481       $this-&gt;<a class="code" href="classObservable.html#b0">notify_all</a>(3,$msg);
00482     } <span class="keywordflow">else</span> {
00483       unset($vars['pId']);
00484       <span class="comment">// insert mode</span>
00485       $name = $this-&gt;_normalize_name($vars['name'],$vars['version']);
00486       $this-&gt;_create_directory_structure($name);
00487       $first = <span class="keyword">true</span>;
00488       $query = <span class="stringliteral">"insert into $TABLE_NAME("</span>;
00489       foreach(array_keys($vars) as $key) {
00490         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>; 
00491         $query.= <span class="stringliteral">"$key"</span>;
00492         $first = <span class="keyword">false</span>;
00493       } 
00494       $query .=<span class="stringliteral">") values("</span>;
00495       $first = <span class="keyword">true</span>;
00496       foreach(array_values($vars) as $value) {
00497         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>; 
00498         <span class="keywordflow">if</span>(!is_numeric($value)||strstr($value,<span class="charliteral">'.'</span>)) $value=<span class="stringliteral">"'"</span>.$value.<span class="stringliteral">"'"</span>;
00499         $query.= <span class="stringliteral">"$value"</span>;
00500         $first = <span class="keyword">false</span>;
00501       } 
00502       $query .=<span class="stringliteral">")"</span>;
00503       $this-&gt;query($query);
00504       $pId = $this-&gt;getOne(<span class="stringliteral">"select max(pId) from $TABLE_NAME where lastModif=$now"</span>); 
00505       <span class="comment">// Now automatically add a start and end activity </span>
00506       $aM= <span class="keyword">new</span> <a class="code" href="classActivityManager.html">ActivityManager</a>($this-&gt;db);
00507       $vars1 = Array(
00508         'name' =&gt; 'start',
00509         'description' =&gt; '<span class="keywordflow">default</span> start activity',
00510         'type' =&gt; 'start',
00511         'isInteractive' =&gt; <span class="charliteral">'y'</span>,
00512         'isAutoRouted' =&gt; <span class="charliteral">'y'</span>
00513       );
00514       $vars2 = Array(
00515         'name' =&gt; 'end',
00516         'description' =&gt; '<span class="keywordflow">default</span> end activity',
00517         'type' =&gt; 'end',
00518         'isInteractive' =&gt; <span class="charliteral">'n'</span>,
00519         'isAutoRouted' =&gt; <span class="charliteral">'y'</span>
00520       );
00521 
00522       $aM-&gt;replace_activity($pId,0,$vars1);
00523       $aM-&gt;replace_activity($pId,0,$vars2);
00524           $msg = sprintf(tra('Process %s has been created'),$vars['name']);     
00525           $this-&gt;<a class="code" href="classObservable.html#b0">notify_all</a>(4,$msg);
00526     }
00527     <span class="comment">// Get the id</span>
00528     <span class="keywordflow">return</span> $pId;
00529    }
00530    
00535    function _get_normalized_name($pId)
00536    {
00537      $info = $this-&gt;<a class="code" href="classProcessManager.html#a8">get_process</a>($pId);
00538      <span class="keywordflow">return</span> $info['normalized_name'];
00539    }
00540    
00545    function _normalize_name($name, $version)
00546    {
00547      $name = $name.<span class="charliteral">'_'</span>.$version;
00548      $name = str_replace(<span class="stringliteral">" "</span>,<span class="stringliteral">"_"</span>,$name);
00549      $name = preg_replace(<span class="stringliteral">"/[^0-9A-Za-z\_]/"</span>,'',$name);
00550      <span class="keywordflow">return</span> $name;
00551    }
00552    
00557    function _new_version($version,$minor=<span class="keyword">true</span>)
00558    {
00559      $parts = explode(<span class="charliteral">'.'</span>,$version);
00560      <span class="keywordflow">if</span>($minor) {
00561        $parts[count($parts)-1]++;
00562      } <span class="keywordflow">else</span> {
00563        $parts[0]++;
00564      }
00565      <span class="keywordflow">return</span> implode(<span class="charliteral">'.'</span>,$parts);
00566    }
00567    
00572    function _create_directory_structure($name)
00573    {
00574     
00575      <span class="comment">// Create in processes a directory with this name</span>
00576      mkdir(<span class="stringliteral">"lib/Galaxia/processes/$name"</span>);
00577          mkdir(<span class="stringliteral">"lib/Galaxia/processes/$name/graph"</span>);
00578          mkdir(<span class="stringliteral">"lib/Galaxia/processes/$name/code"</span>);
00579          mkdir(<span class="stringliteral">"lib/Galaxia/processes/$name/compiled"</span>);
00580          mkdir(<span class="stringliteral">"lib/Galaxia/processes/$name/code/activities"</span>);
00581      mkdir(<span class="stringliteral">"lib/Galaxia/processes/$name/code/templates"</span>);
00582      mkdir(<span class="stringliteral">"templates/$name"</span>);
00583          <span class="comment">// Create shared file</span>
00584          $fp = fopen(<span class="stringliteral">"lib/Galaxia/processes/$name/code/shared.php"</span>,<span class="stringliteral">"w"</span>);
00585          fwrite($fp,<span class="charliteral">'&lt;'</span>.<span class="charliteral">'?'</span>.'php'.<span class="stringliteral">"\n"</span>.<span class="charliteral">'?'</span>.<span class="charliteral">'&gt;'</span>);
00586          fclose($fp);
00587    }
00588    
00593    function _remove_directory($dir,$rec=<span class="keyword">false</span>)
00594    {
00595 
00596      $h = opendir($dir);
00597      <span class="keywordflow">while</span>(($file = readdir($h)) !== <span class="keyword">false</span>) {
00598        <span class="keywordflow">if</span>(is_file($dir.<span class="charliteral">'/'</span>.$file)) {
00599          unlink($dir.<span class="charliteral">'/'</span>.$file);
00600        } <span class="keywordflow">else</span> {
00601          <span class="keywordflow">if</span>($rec &amp;&amp; $file != <span class="charliteral">'.'</span> &amp;&amp; $file != '..') {
00602            $this-&gt;_remove_directory($dir.<span class="charliteral">'/'</span>.$file, <span class="keyword">true</span>);
00603          }
00604        }
00605      }
00606      closedir($h);   
00607      @rmdir($dir);
00608      @unlink($dir);
00609    }
00610 
00611 
00612    function _rec_copy($dir1,$dir2)
00613    {
00614          @mkdir($dir2,0777);
00615      $h = opendir($dir1);
00616      <span class="keywordflow">while</span>(($file = readdir($h)) !== <span class="keyword">false</span>) {
00617        <span class="keywordflow">if</span>(is_file($dir1.<span class="charliteral">'/'</span>.$file)) {
00618          copy($dir1.<span class="charliteral">'/'</span>.$file,$dir2.<span class="charliteral">'/'</span>.$file);
00619        } <span class="keywordflow">else</span> {
00620          <span class="keywordflow">if</span>($file != <span class="charliteral">'.'</span> &amp;&amp; $file != '..') {
00621            $this-&gt;_rec_copy($dir1.<span class="charliteral">'/'</span>.$file, $dir2.<span class="charliteral">'/'</span>.$file);
00622          }
00623        }
00624      }
00625      closedir($h);   
00626    }
00627 
00628 
00629    function _start_element_handler($parser,$element,$attribs)
00630    {
00631      
00632      $aux=Array('name'=&gt;$element,
00633                 'data'=&gt;'',
00634                 'parent' =&gt; $this-&gt;current,
00635                 'children'=&gt;Array());
00636      $i = count($this-&gt;tree);           
00637      $this-&gt;tree[$i] = $aux;
00638 
00639      $this-&gt;tree[$this-&gt;current]['children'][]=$i;
00640      $this-&gt;current=$i;
00641    }
00642 
00643 
00644    function _end_element_handler($parser,$element)
00645    {
00646         <span class="comment">//when a tag ends put text</span>
00647         $this-&gt;tree[$this-&gt;current]['data']=$this-&gt;buffer;           
00648         $this-&gt;buffer='';
00649         $this-&gt;current=$this-&gt;tree[$this-&gt;current]['parent'];
00650    }
00651 
00652 
00653    function _data_handler($parser,$data)
00654    {
00655         $this-&gt;buffer.=$data;
00656    }
00657 
00658 
00659 
00660 }    
00661 
00662 
00663 
00664 ?&gt;
</pre></div><hr><address style="align: right;"><small>Generated on Mon Apr 21 11:15:31 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
