<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ProcessManager.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>ProcessManager.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 
00005 
00010 <span class="keyword">class </span><a class="code" href="classProcessManager.html">ProcessManager</a> <span class="keyword">extends</span> BaseManager {
00011   var $parser;
00012   var $tree;
00013   var $current;
00014   var $buffer;
00015   
<a name="l00020"></a><a class="code" href="classProcessManager.html#a10">00020</a>   function <a class="code" href="classProcessManager.html#a0">ProcessManager</a>($db) 
00021   {
00022     <span class="keywordflow">if</span>(!$db) {
00023       die(<span class="stringliteral">"Invalid db object passed to ProcessManager constructor"</span>);  
00024     }
00025     $this-&gt;db = $db;  
00026   }
00027   
00028  
<a name="l00032"></a><a class="code" href="classProcessManager.html#a11">00032</a>   function <a class="code" href="classProcessManager.html#a1">activate_process</a>($pId)
00033   {
00034     $query = <span class="stringliteral">"update galaxia_processes set isActive='y' where pId=$pId"</span>;
00035     $this-&gt;query($query);  
00036   }
00037   
<a name="l00041"></a><a class="code" href="classProcessManager.html#a12">00041</a>   function <a class="code" href="classProcessManager.html#a2">deactivate_process</a>($pId)
00042   {
00043     $query = <span class="stringliteral">"update galaxia_processes set isActive='n' where pId=$pId"</span>;
00044     $this-&gt;query($query);  
00045   }
00046   
<a name="l00050"></a><a class="code" href="classProcessManager.html#a13">00050</a>   function <a class="code" href="classProcessManager.html#a13">serialize_process</a>($pId)
00051   {
00052     <span class="comment">// &lt;process&gt;</span>
00053     $out = '&lt;process&gt;'.<span class="stringliteral">"\n"</span>;
00054     $proc_info = $this-&gt;<a class="code" href="classProcessManager.html#a5">get_process</a>($pId);
00055     $procname = $proc_info['normalized_name'];
00056     $out.= '  &lt;name&gt;'.htmlspecialchars($proc_info['name']).'&lt;/name&gt;'.<span class="stringliteral">"\n"</span>;
00057     $out.= '  &lt;isValid&gt;'.htmlspecialchars($proc_info['isValid']).'&lt;/isValid&gt;'.<span class="stringliteral">"\n"</span>;
00058     $out.= '  &lt;version&gt;'.htmlspecialchars($proc_info['version']).'&lt;/version&gt;'.<span class="stringliteral">"\n"</span>;
00059     $out.= '  &lt;isActive&gt;'.htmlspecialchars($proc_info['isActive']).'&lt;/isActive&gt;'.<span class="stringliteral">"\n"</span>;
00060         $out.='   &lt;description&gt;'.htmlspecialchars($proc_info['description']).'&lt;/description&gt;'.<span class="stringliteral">"\n"</span>;
00061     $out.= '  &lt;lastModif&gt;'.date(<span class="stringliteral">"d/m/Y [h:i:s]"</span>,$proc_info['lastModif']).'&lt;/lastModif&gt;'.<span class="stringliteral">"\n"</span>;
00062         $out.= '  &lt;sharedCode&gt;&lt;![CDATA[';
00063         $fp=fopen(<span class="stringliteral">"lib/Galaxia/processes/$procname/code/shared.php"</span>,<span class="stringliteral">"r"</span>);
00064         <span class="keywordflow">while</span>(!feof($fp)) {
00065           $line=fread($fp,8192);
00066           $out.=$line;
00067         }
00068         fclose($fp);
00069         $out.= '  ]]&gt;&lt;/sharedCode&gt;'.<span class="stringliteral">"\n"</span>;
00070         <span class="comment">// Now loop over activities</span>
00071         $query = <span class="stringliteral">"select * from galaxia_activities where pId=$pId"</span>;
00072         $result = $this-&gt;query($query);
00073         $out.='  &lt;activities&gt;'.<span class="stringliteral">"\n"</span>;
00074         $am = <span class="keyword">new</span> <a class="code" href="classActivityManager.html">ActivityManager</a>($this-&gt;db);
00075     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {       
00076         $name = $res['normalized_name'];
00077                 $out.='    &lt;activity&gt;'.<span class="stringliteral">"\n"</span>;
00078                 $out.='      &lt;name&gt;'.htmlspecialchars($res['name']).'&lt;/name&gt;'.<span class="stringliteral">"\n"</span>;
00079                 $out.='      &lt;type&gt;'.htmlspecialchars($res['type']).'&lt;/type&gt;'.<span class="stringliteral">"\n"</span>;
00080                 $out.='      &lt;description&gt;'.htmlspecialchars($res['description']).'&lt;/description&gt;'.<span class="stringliteral">"\n"</span>;
00081                 $out.='      &lt;lastModif&gt;'.date(<span class="stringliteral">"d/m/Y [h:i:s]"</span>,$res['lastModif']).'&lt;/lastModif&gt;'.<span class="stringliteral">"\n"</span>;
00082                 $out.='      &lt;isInteractive&gt;'.$res['isInteractive'].'&lt;/isInteractive&gt;'.<span class="stringliteral">"\n"</span>;
00083                 $out.='      &lt;isAutoRouted&gt;'.$res['isAutoRouted'].'&lt;/isAutoRouted&gt;'.<span class="stringliteral">"\n"</span>;
00084                 $out.='      &lt;roles&gt;'.<span class="stringliteral">"\n"</span>;
00085                 
00086                 $roles = $am-&gt;get_activity_roles($res['activityId']);
00087                 foreach($roles as $role) {
00088                   $out.='        &lt;role&gt;'.htmlspecialchars($role['name']).'&lt;/role&gt;'.<span class="stringliteral">"\n"</span>;
00089                 }       
00090                 $out.='      &lt;/roles&gt;'.<span class="stringliteral">"\n"</span>;
00091                 $out.='      &lt;code&gt;&lt;![CDATA[';
00092                 $fp=fopen(<span class="stringliteral">"lib/Galaxia/processes/$procname/code/activities/$name.php"</span>,<span class="stringliteral">"r"</span>);
00093                 <span class="keywordflow">while</span>(!feof($fp)) {
00094                         $line=fread($fp,8192);
00095                         $out.=$line;
00096                 }
00097                 fclose($fp);
00098                 $out.='      ]]&gt;&lt;/code&gt;';
00099                 $out.='    &lt;/activity&gt;'.<span class="stringliteral">"\n"</span>;    
00100     }
00101         $out.='  &lt;/activities&gt;'.<span class="stringliteral">"\n"</span>;
00102         $out.='  &lt;transitions&gt;'.<span class="stringliteral">"\n"</span>;
00103         $transitions = $am-&gt;get_process_transitions($pId);
00104         foreach($transitions as $tran) {
00105           $out.='     &lt;transition&gt;'.<span class="stringliteral">"\n"</span>;
00106           $out.='       &lt;from&gt;'.htmlspecialchars($tran['actFromName']).'&lt;/from&gt;'.<span class="stringliteral">"\n"</span>;
00107           $out.='       &lt;to&gt;'.htmlspecialchars($tran['actToName']).'&lt;/to&gt;'.<span class="stringliteral">"\n"</span>;
00108           $out.='     &lt;/transition&gt;'.<span class="stringliteral">"\n"</span>;
00109         }       
00110         $out.='  &lt;/transitions&gt;'.<span class="stringliteral">"\n"</span>;
00111     $out.= '&lt;/process&gt;'.<span class="stringliteral">"\n"</span>;
00112     <span class="comment">//$fp = fopen("lib/Galaxia/processes/$procname/$procname.xml","w");</span>
00113     <span class="comment">//fwrite($fp,$out);</span>
00114     <span class="comment">//fclose($fp);</span>
00115     <span class="keywordflow">return</span> $out;
00116   }
00117   
<a name="l00121"></a><a class="code" href="classProcessManager.html#a14">00121</a>   function <a class="code" href="classProcessManager.html#a14">unserialize_process</a>($xml) 
00122   {
00123         <span class="comment">// Create SAX parser assign this object as base for handlers</span>
00124         <span class="comment">// handlers are private methods defined below.</span>
00125         <span class="comment">// keep contexts and parse</span>
00126         $this-&gt;parser = xml_parser_create(); 
00127         xml_parser_set_option($this-&gt;parser,XML_OPTION_CASE_FOLDING,0);
00128         xml_set_object($this-&gt;parser, &amp;$<span class="keyword">this</span>);
00129         xml_set_element_handler($this-&gt;parser, <span class="stringliteral">"_start_element_handler"</span>, <span class="stringliteral">"_end_element_handler"</span>);
00130     xml_set_character_data_handler($this-&gt;parser, <span class="stringliteral">"_data_handler"</span>); 
00131     $aux=Array(
00132         'name'=&gt;'root',
00133         'children'=&gt;Array(),
00134         'parent' =&gt; 0,
00135         'data'=&gt;''
00136     );
00137     $this-&gt;tree[0]=$aux;
00138     $this-&gt;current=0;
00139     <span class="keywordflow">if</span> (!xml_parse($this-&gt;parser, $xml, <span class="keyword">true</span>)) {
00140         $error = sprintf(<span class="stringliteral">"XML error: %s at line %d"</span>,
00141                     xml_error_string(xml_get_error_code($this-&gt;parser)),
00142                     xml_get_current_line_number($this-&gt;parser));
00143         trigger_error($error,E_USER_WARNING);
00144         }
00145     xml_parser_free($this-&gt;parser);   
00146         <span class="comment">// Now that we have the tree we can do interesting things</span>
00147         <span class="comment">//print_r($this-&gt;tree);</span>
00148         $process=Array();
00149         $activities=Array();
00150         $transitions=Array();
00151         <span class="keywordflow">for</span>($i=0;$i&lt;count($this-&gt;tree[1]['children']);$i++) {
00152           <span class="comment">// Process attributes</span>
00153           $z=$this-&gt;tree[1]['children'][$i];
00154           $name = trim($this-&gt;tree[$z]['name']);
00155           <span class="keywordflow">if</span>($name=='activities') {
00156             <span class="keywordflow">for</span>($j=0;$j&lt;count($this-&gt;tree[$z]['children']);$j++) {
00157               $z2 = $this-&gt;tree[$z]['children'][$j];
00158               <span class="comment">// this is an activity $name = $this-&gt;tree[$z2]['name'];</span>
00159               <span class="keywordflow">if</span>($this-&gt;tree[$z2]['name']=='activity') {
00160               <span class="keywordflow">for</span>($k=0;$k&lt;count($this-&gt;tree[$z2]['children']);$k++) {
00161                 $z3 = $this-&gt;tree[$z2]['children'][$k];
00162                 $name = trim($this-&gt;tree[$z3]['name']);
00163                 $value= trim($this-&gt;tree[$z3]['data']);
00164                 <span class="keywordflow">if</span>($name=='roles') {
00165                   $roles=Array();
00166                           <span class="keywordflow">for</span>($l=0;$l&lt;count($this-&gt;tree[$z3]['children']);$l++) {
00167                             $z4 = $this-&gt;tree[$z3]['children'][$l];
00168                             $name = trim($this-&gt;tree[$z4]['name']);
00169                             $data = trim($this-&gt;tree[$z4]['data']);
00170                             $roles[]=$data;
00171                           }                                
00172                 } <span class="keywordflow">else</span> {
00173                         
00174                   $aux[$name]=$value;
00175                   <span class="comment">//print("$name:$value&lt;br/&gt;");</span>
00176                 }
00177               }
00178           $aux['roles']=$roles;
00179           $activities[]=$aux;
00180           }
00181             }
00182           } elseif($name=='transitions') {
00183             <span class="keywordflow">for</span>($j=0;$j&lt;count($this-&gt;tree[$z]['children']);$j++) {
00184               $z2 = $this-&gt;tree[$z]['children'][$j];
00185               <span class="comment">// this is an activity $name = $this-&gt;tree[$z2]['name'];</span>
00186               <span class="keywordflow">if</span>($this-&gt;tree[$z2]['name']=='transition') {
00187               <span class="keywordflow">for</span>($k=0;$k&lt;count($this-&gt;tree[$z2]['children']);$k++) {
00188                 $z3 = $this-&gt;tree[$z2]['children'][$k];
00189                 $name = trim($this-&gt;tree[$z3]['name']);
00190                 $value= trim($this-&gt;tree[$z3]['data']);
00191                 <span class="keywordflow">if</span>($name == 'from' || $name == 'to') {
00192                   $aux[$name]=$value;
00193                 }
00194               }
00195               }
00196               $transitions[] = $aux;
00197             }
00198 
00199           
00200           } <span class="keywordflow">else</span> {
00201             $value = trim($this-&gt;tree[$z]['data']);
00202             <span class="comment">//print("$name is $value&lt;br/&gt;");</span>
00203             $process[$name]=$value;
00204             
00205           }
00206         }
00207         $process['activities']=$activities;
00208         $process['transitions']=$transitions;
00209         <span class="keywordflow">return</span> $process;
00210   }
00211   
<a name="l00217"></a><a class="code" href="classProcessManager.html#a15">00217</a>   function <a class="code" href="classProcessManager.html#a15">import_process</a>($data)
00218   {
00219         <span class="comment">//Now the show begins</span>
00220         $am = <span class="keyword">new</span> <a class="code" href="classActivityManager.html">ActivityManager</a>($this-&gt;db);
00221         $rm = <span class="keyword">new</span> <a class="code" href="classRoleManager.html">RoleManager</a>($this-&gt;db);
00222         <span class="comment">// First create the process</span>
00223         $vars = Array(
00224                 'name' =&gt; $data['name'],
00225                 'version' =&gt; $data['version'],
00226                 'description' =&gt; $data['description'],
00227                 'lastModif' =&gt; $data['lastModif'],
00228                 'isActive' =&gt; $data['isActive'],
00229                 'isValid' =&gt; $data['isValid']
00230         );
00231         $pid = $this-&gt;<a class="code" href="classProcessManager.html#a8">replace_process</a>(0,$vars);
00232         <span class="comment">//Put the shared code </span>
00233         $proc_info = $this-&gt;<a class="code" href="classProcessManager.html#a5">get_process</a>($pid);
00234         $procname = $proc_info['normalized_name'];
00235         $fp = fopen(<span class="stringliteral">"lib/Galaxia/processes/$procname/code/shared.php"</span>,<span class="stringliteral">"w"</span>);
00236         fwrite($fp,$data['sharedCode']);
00237         fclose($fp);
00238         $actids = Array();
00239         <span class="comment">// Foreach activity create activities</span>
00240         foreach($data['activities'] as $activity) {
00241           $vars = Array(
00242                 'name' =&gt; $activity['name'],
00243                 'description' =&gt; $activity['description'],
00244                 'type' =&gt; $activity['type'],
00245                 'lastModif' =&gt; $activity['lastModif'],
00246                 'isInteractive' =&gt; $activity['isInteractive'],
00247                 'isAutoRouted' =&gt; $activity['isAutoRouted']
00248           );      
00249           $actname=$am-&gt;_normalize_name($activity['name']);
00250       $fp = fopen(<span class="stringliteral">"lib/Galaxia/processes/$procname/code/activities/$actname"</span>.'.php',<span class="stringliteral">"w"</span>);
00251       fwrite($fp,$activity['code']);
00252       fclose($fp);
00253       $actid = $am-&gt;replace_activity($pid,0,$vars);
00254       $actids[$activity['name']] = $am-&gt;_get_activity_id_by_name($pid,$activity['name']);
00255           $actname = $am-&gt;_normalize_name($activity['name']);
00256           $now = date(<span class="stringliteral">"U"</span>);
00257           foreach($activity['roles'] as $role) {
00258             $vars = Array(
00259                 'name' =&gt; $role,
00260                 'description' =&gt; $role,
00261                 'lastModif' =&gt; $now,
00262                 );        
00263                 <span class="keywordflow">if</span>(!$rm-&gt;role_name_exists($role['name'])) {
00264                   $rid=$rm-&gt;replace_role($pid,0,$vars);
00265                 }
00266                 $am-&gt;add_activity_role($actid,$rid);
00267                 
00268           }
00269         }
00270         foreach($data['transitions'] as $tran) {
00271                 $am-&gt;add_transition($pid,$actids[$tran['from']],$actids[$tran['to']]);  
00272         }
00273         
00274 
00275 
00276         
00277         unset($am);
00278         unset($rm);
00279   }
00280   
00281   
00282    
00283     
00290 
<a name="l00291"></a><a class="code" href="classProcessManager.html#a16">00291</a>   function <a class="code" href="classProcessManager.html#a3">new_process_version</a>($pId, $minor=<span class="keyword">true</span>)
00292   {
00293     $oldpid = $pId;
00294     $proc_info = $this-&gt;<a class="code" href="classProcessManager.html#a5">get_process</a>($pId);
00295     $name = $proc_info['name'];
00296     <span class="keywordflow">if</span>(!$proc_info) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00297     <span class="comment">// Now update the version</span>
00298     $version = $this-&gt;_new_version($proc_info['version'],$minor);
00299     <span class="keywordflow">while</span>($this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_processes where name='$name' and version='$version'"</span>)) {
00300         $version = $this-&gt;_new_version($version,$minor);
00301     }
00302     <span class="comment">// Make new versions unactive</span>
00303     $proc_info['version'] = $version;
00304     $proc_info['isActive'] = <span class="charliteral">'n'</span>;
00305     $pid = $this-&gt;<a class="code" href="classProcessManager.html#a8">replace_process</a>(<span class="comment">/*new proc!*/</span> 0, $proc_info);
00306     <span class="comment">// And here copy all the activities &amp; so</span>
00307     $aM = <span class="keyword">new</span> <a class="code" href="classActivityManager.html">ActivityManager</a>($this-&gt;db);
00308     $query = <span class="stringliteral">"select * from galaxia_activities where pId=$oldpid"</span>;
00309         $result = $this-&gt;query($query);
00310     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {    
00311       $aM-&gt;replace_activity($pid,0,$res);
00312     }
00313     $query = <span class="stringliteral">"select * from galaxia_transitions where pId=$oldpid"</span>;
00314         $result = $this-&gt;query($query);
00315     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {    
00316       $aM-&gt;add_transition($pid,$res['actFromId'],$res['actToId']);
00317     }
00318     
00319     <span class="comment">//Now since we are copying a process we should copy</span>
00320     <span class="comment">//the old directory structure to the new directory</span>
00321     $oldname = $proc_info['normalized_name'];
00322     $newname = $this-&gt;_get_normalized_name($pid);
00323         $this-&gt;_rec_copy(<span class="stringliteral">"lib/Galaxia/processes/$oldname"</span>,<span class="stringliteral">"lib/Galaxia/processes/$newname"</span>);
00324     <span class="keywordflow">return</span> $pid;
00325   }
00326   
<a name="l00333"></a><a class="code" href="classProcessManager.html#a17">00333</a>   function <a class="code" href="classProcessManager.html#a4">process_name_exists</a>($name,$version)
00334   {
00335     $name = addslashes($this-&gt;_normalize_name($name,$version));
00336     <span class="keywordflow">return</span> $this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_processes where normalized_name='$name'"</span>);
00337   }
00338   
00339   
<a name="l00343"></a><a class="code" href="classProcessManager.html#a18">00343</a>   function <a class="code" href="classProcessManager.html#a5">get_process</a>($pId)
00344   {
00345         $query = <span class="stringliteral">"select * from galaxia_processes where pId=$pId"</span>;
00346         $result = $this-&gt;query($query);
00347         <span class="keywordflow">if</span>(!$result-&gt;numRows()) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00348         $res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC);
00349         <span class="keywordflow">return</span> $res;
00350   }
00351   
<a name="l00355"></a><a class="code" href="classProcessManager.html#a19">00355</a>   function <a class="code" href="classProcessManager.html#a6">list_processes</a>($offset,$maxRecords,$sort_mode,$find,$where='')
00356   {
00357     $sort_mode = str_replace(<span class="stringliteral">"_"</span>,<span class="stringliteral">" "</span>,$sort_mode);
00358     <span class="keywordflow">if</span>($find) {
00359       $mid=<span class="stringliteral">" where ((name like '%"</span>.$find.<span class="stringliteral">"%') or (description like '%"</span>.$find.<span class="stringliteral">"%'))"</span>;
00360     } <span class="keywordflow">else</span> {
00361       $mid=<span class="stringliteral">""</span>;
00362     }
00363     <span class="keywordflow">if</span>($where) {
00364       <span class="keywordflow">if</span>($mid) {
00365         $mid.= <span class="stringliteral">" and ($where) "</span>;
00366       } <span class="keywordflow">else</span> {
00367         $mid.= <span class="stringliteral">" where ($where) "</span>;
00368       }
00369     }
00370     $query = <span class="stringliteral">"select * from galaxia_processes $mid order by $sort_mode limit $offset,$maxRecords"</span>;
00371     $query_cant = <span class="stringliteral">"select count(*) from galaxia_processes $mid"</span>;
00372     $result = $this-&gt;query($query);
00373     $cant = $this-&gt;getOne($query_cant);
00374     $ret = Array();
00375     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00376       $ret[] = $res;
00377     }
00378     $retval = Array();
00379     $retval[<span class="stringliteral">"data"</span>] = $ret;
00380     $retval[<span class="stringliteral">"cant"</span>] = $cant;
00381     <span class="keywordflow">return</span> $retval;
00382   }
00383   
<a name="l00387"></a><a class="code" href="classProcessManager.html#a20">00387</a>   function <a class="code" href="classProcessManager.html#a7">remove_process</a>($pId)
00388   {
00389     $name = $this-&gt;_get_normalized_name($pId);
00390         $aM = <span class="keyword">new</span> <a class="code" href="classActivityManager.html">ActivityManager</a>($this-&gt;db);
00391     <span class="comment">// Remove process activities</span>
00392         $query = <span class="stringliteral">"select activityId from galaxia_activities where pId=$pId"</span>;
00393         $result = $this-&gt;query($query);
00394     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00395                 $aM-&gt;remove_activity($pId,$res['activityId']);
00396     }
00397 
00398     <span class="comment">// Remove process roles</span>
00399     $query = <span class="stringliteral">"delete from galaxia_roles where pId=$pId"</span>;
00400     $this-&gt;query($query);
00401     $query = <span class="stringliteral">"delete from galaxia_user_roles where pId=$pId"</span>;
00402     $this-&gt;query($query);
00403     
00404     <span class="comment">// Remove the directory structure</span>
00405     $this-&gt;_remove_directory(<span class="stringliteral">"lib/Galaxia/processes/$name"</span>,<span class="keyword">true</span>);
00406 
00407         <span class="comment">// And finally remove the proc</span>
00408     $query = <span class="stringliteral">"delete from galaxia_processes where pId=$pId"</span>;
00409     $this-&gt;query($query);
00410 
00411     
00412     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00413   }
00414   
<a name="l00420"></a><a class="code" href="classProcessManager.html#a21">00420</a>   function <a class="code" href="classProcessManager.html#a8">replace_process</a>($pId, $vars)
00421   {
00422     $TABLE_NAME = 'galaxia_processes';
00423     $now = date(<span class="stringliteral">"U"</span>);
00424     $vars['lastModif']=$now;
00425     $vars['normalized_name'] = $this-&gt;_normalize_name($vars['name'],$vars['version']);        
00426     foreach($vars as $key=&gt;$value)
00427     {
00428       $vars[$key]=addslashes($value);
00429     }
00430   
00431     <span class="keywordflow">if</span>($pId) {
00432       <span class="comment">// update mode</span>
00433       $old_proc = $this-&gt;<a class="code" href="classProcessManager.html#a5">get_process</a>($pId);
00434       $first = <span class="keyword">true</span>;
00435       $query =<span class="stringliteral">"update $TABLE_NAME set"</span>;
00436       foreach($vars as $key=&gt;$value) {
00437         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>;
00438         <span class="keywordflow">if</span>(!is_numeric($value)||strstr($value,<span class="charliteral">'.'</span>)) $value=<span class="stringliteral">"'"</span>.$value.<span class="stringliteral">"'"</span>;
00439         $query.= <span class="stringliteral">" $key=$value "</span>;
00440         $first = <span class="keyword">false</span>;
00441       }
00442       $query .= <span class="stringliteral">" where pId=$pId "</span>;
00443       $this-&gt;query($query);
00444       <span class="comment">// Note that if the name is being changed then</span>
00445       <span class="comment">// the directory has to be renamed!</span>
00446       $oldname = $old_proc['normalized_name'];
00447       $newname = $vars['normalized_name'];
00448       rename(<span class="stringliteral">"lib/Galaxia/processes/$oldname"</span>,<span class="stringliteral">"lib/Galaxia/processes/$newname"</span>);
00449     } <span class="keywordflow">else</span> {
00450       unset($vars['pId']);
00451       <span class="comment">// insert mode</span>
00452       $name = $this-&gt;_normalize_name($vars['name'],$vars['version']);
00453       $this-&gt;_create_directory_structure($name);
00454       $first = <span class="keyword">true</span>;
00455       $query = <span class="stringliteral">"insert into $TABLE_NAME("</span>;
00456       foreach(array_keys($vars) as $key) {
00457         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>; 
00458         $query.= <span class="stringliteral">"$key"</span>;
00459         $first = <span class="keyword">false</span>;
00460       } 
00461       $query .=<span class="stringliteral">") values("</span>;
00462       $first = <span class="keyword">true</span>;
00463       foreach(array_values($vars) as $value) {
00464         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>; 
00465         <span class="keywordflow">if</span>(!is_numeric($value)||strstr($value,<span class="charliteral">'.'</span>)) $value=<span class="stringliteral">"'"</span>.$value.<span class="stringliteral">"'"</span>;
00466         $query.= <span class="stringliteral">"$value"</span>;
00467         $first = <span class="keyword">false</span>;
00468       } 
00469       $query .=<span class="stringliteral">")"</span>;
00470       $this-&gt;query($query);
00471       $pId = $this-&gt;getOne(<span class="stringliteral">"select max(pId) from $TABLE_NAME where lastModif=$now"</span>); 
00472       <span class="comment">// Now automatically add a start and end activity </span>
00473       $aM= <span class="keyword">new</span> <a class="code" href="classActivityManager.html">ActivityManager</a>($this-&gt;db);
00474       $vars1 = Array(
00475         'name' =&gt; 'start',
00476         'description' =&gt; '<span class="keywordflow">default</span> start activity',
00477         'type' =&gt; 'start',
00478         'isInteractive' =&gt; <span class="charliteral">'y'</span>,
00479         'isAutoRouted' =&gt; <span class="charliteral">'y'</span>
00480       );
00481       $vars2 = Array(
00482         'name' =&gt; 'end',
00483         'description' =&gt; '<span class="keywordflow">default</span> end activity',
00484         'type' =&gt; 'end',
00485         'isInteractive' =&gt; <span class="charliteral">'n'</span>,
00486         'isAutoRouted' =&gt; <span class="charliteral">'y'</span>
00487       );
00488 
00489       $aM-&gt;replace_activity($pId,0,$vars1);
00490       $aM-&gt;replace_activity($pId,0,$vars2);
00491      
00492     }
00493     <span class="comment">// Get the id</span>
00494     <span class="keywordflow">return</span> $pId;
00495    }
00496    
00501    function _get_normalized_name($pId)
00502    {
00503      $info = $this-&gt;<a class="code" href="classProcessManager.html#a5">get_process</a>($pId);
00504      <span class="keywordflow">return</span> $info['normalized_name'];
00505    }
00506    
00511    function _normalize_name($name, $version)
00512    {
00513      $name = $name.<span class="charliteral">'_'</span>.$version;
00514      $name = str_replace(<span class="stringliteral">" "</span>,<span class="stringliteral">"_"</span>,$name);
00515      $name = preg_replace(<span class="stringliteral">"/[^0-9A-Za-z\_]/"</span>,'',$name);
00516      <span class="keywordflow">return</span> $name;
00517    }
00518    
00523    function _new_version($version,$minor=<span class="keyword">true</span>)
00524    {
00525      $parts = explode(<span class="charliteral">'.'</span>,$version);
00526      <span class="keywordflow">if</span>($minor) {
00527        $parts[count($parts)-1]++;
00528      } <span class="keywordflow">else</span> {
00529        $parts[0]++;
00530      }
00531      <span class="keywordflow">return</span> implode(<span class="charliteral">'.'</span>,$parts);
00532    }
00533    
00538    function _create_directory_structure($name)
00539    {
00540     
00541      <span class="comment">// Create in processes a directory with this name</span>
00542      mkdir(<span class="stringliteral">"lib/Galaxia/processes/$name"</span>);
00543          mkdir(<span class="stringliteral">"lib/Galaxia/processes/$name/graph"</span>);
00544          mkdir(<span class="stringliteral">"lib/Galaxia/processes/$name/code"</span>);
00545          mkdir(<span class="stringliteral">"lib/Galaxia/processes/$name/compiled"</span>);
00546          mkdir(<span class="stringliteral">"lib/Galaxia/processes/$name/code/activities"</span>);
00547      mkdir(<span class="stringliteral">"lib/Galaxia/processes/$name/code/templates"</span>,0777);
00548          <span class="comment">// Create shared file</span>
00549          $fp = fopen(<span class="stringliteral">"lib/Galaxia/processes/$name/code/shared.php"</span>,<span class="stringliteral">"w"</span>);
00550          fwrite($fp,<span class="charliteral">'&lt;'</span>.<span class="charliteral">'?'</span>.'php'.<span class="stringliteral">"\n"</span>.<span class="charliteral">'?'</span>.<span class="charliteral">'&gt;'</span>);
00551          fclose($fp);
00552    }
00553    
00558    function _remove_directory($dir,$rec=<span class="keyword">false</span>)
00559    {
00560 
00561      $h = opendir($dir);
00562      <span class="keywordflow">while</span>(($file = readdir($h)) !== <span class="keyword">false</span>) {
00563        <span class="keywordflow">if</span>(is_file($dir.<span class="charliteral">'/'</span>.$file)) {
00564          unlink($dir.<span class="charliteral">'/'</span>.$file);
00565        } <span class="keywordflow">else</span> {
00566          <span class="keywordflow">if</span>($rec &amp;&amp; $file != <span class="charliteral">'.'</span> &amp;&amp; $file != '..') {
00567            $this-&gt;_remove_directory($dir.<span class="charliteral">'/'</span>.$file, <span class="keyword">true</span>);
00568          }
00569        }
00570      }
00571      closedir($h);   
00572      @rmdir($dir);
00573      @unlink($dir);
00574    }
00575 
00576 
00577    function _rec_copy($dir1,$dir2)
00578    {
00579          @mkdir($dir2,0777);
00580      $h = opendir($dir1);
00581      <span class="keywordflow">while</span>(($file = readdir($h)) !== <span class="keyword">false</span>) {
00582        <span class="keywordflow">if</span>(is_file($dir1.<span class="charliteral">'/'</span>.$file)) {
00583          copy($dir1.<span class="charliteral">'/'</span>.$file,$dir2.<span class="charliteral">'/'</span>.$file);
00584        } <span class="keywordflow">else</span> {
00585          <span class="keywordflow">if</span>($file != <span class="charliteral">'.'</span> &amp;&amp; $file != '..') {
00586            $this-&gt;_rec_copy($dir1.<span class="charliteral">'/'</span>.$file, $dir2.<span class="charliteral">'/'</span>.$file);
00587          }
00588        }
00589      }
00590      closedir($h);   
00591    }
00592 
00593    <span class="comment">//\todo code handler   </span>
00594    function _start_element_handler($parser,$element,$attribs)
00595    {
00596      
00597      $aux=Array('name'=&gt;$element,
00598                 'data'=&gt;'',
00599                 'parent' =&gt; $this-&gt;current,
00600                 'children'=&gt;Array());
00601      $i = count($this-&gt;tree);           
00602      $this-&gt;tree[$i] = $aux;
00603 
00604      $this-&gt;tree[$this-&gt;current]['children'][]=$i;
00605      $this-&gt;current=$i;
00606    }
00607 
00608    <span class="comment">//\todo code handler      </span>
00609    function _end_element_handler($parser,$element)
00610    {
00611         <span class="comment">//when a tag ends put text</span>
00612         $this-&gt;tree[$this-&gt;current]['data']=$this-&gt;buffer;           
00613         $this-&gt;buffer='';
00614         $this-&gt;current=$this-&gt;tree[$this-&gt;current]['parent'];
00615    }
00616 
00617    <span class="comment">//\todo code handler   </span>
00618    function _data_handler($parser,$data)
00619    {
00620         $this-&gt;buffer.=$data;
00621    }
00622 
00623 
00624 
00625 }    
00626 
00627 
00628 
00629 ?&gt;
</pre></div><hr><address style="align: right;"><small>Generated on Mon Apr 14 11:51:59 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
