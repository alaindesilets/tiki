<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>GraphViz.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>GraphViz.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 <span class="comment">//</span>
00003 <span class="comment">// +----------------------------------------------------------------------+</span>
00004 <span class="comment">// | PEAR :: Image :: GraphViz                                            |</span>
00005 <span class="comment">// +----------------------------------------------------------------------+</span>
00006 <span class="comment">// | Copyright (c) 2002 Sebastian Bergmann &lt;sb@sebastian-bergmann.de&gt; and |</span>
00007 <span class="comment">// |                    Dr. Volker GÃ¶bbels &lt;vmg@arachnion.de&gt;.            |</span>
00008 <span class="comment">// +----------------------------------------------------------------------+</span>
00009 <span class="comment">// | This source file is subject to version 3.00 of the PHP License,      |</span>
00010 <span class="comment">// | that is available at http://www.php.net/license/3_0.txt.             |</span>
00011 <span class="comment">// | If you did not receive a copy of the PHP license and are unable to   |</span>
00012 <span class="comment">// | obtain it through the world-wide-web, please send a note to          |</span>
00013 <span class="comment">// | license@php.net so we can mail you a copy immediately.               |</span>
00014 <span class="comment">// +----------------------------------------------------------------------+</span>
00015 <span class="comment">//</span>
00016 <span class="comment">// $Id: ProcessManager_2GraphViz_8php-source.html,v 1.1 2003-04-19 17:41:57 lrargerich Exp $</span>
00017 <span class="comment">//</span>
00018 
00057 <span class="keyword">class </span>Process_GraphViz {
00063     var $dotCommand = 'dot';
00064     
00065     var $pid;
00066 
00072     var $neatoCommand = 'neato';
00073 
00079     var $graph;
00080 
00088     function Image_GraphViz($directed = <span class="keyword">true</span>, $attributes = array()) {
00089         $this-&gt;setDirected($directed);
00090         $this-&gt;setAttributes($attributes);
00091     }
00092     
00093     function set_pid($pid) 
00094     {
00095       $this-&gt;pid = $pid;
00096     }
00097 
00105     function image($format = 'png') {
00106         <span class="keywordflow">if</span> ($file = $this-&gt;saveParsedGraph()) {
00107             $outputfile = $file . <span class="charliteral">'.'</span> . $format;
00108             $outputfile2 = $file . <span class="charliteral">'.'</span> . 'map';
00109             $command  = $this-&gt;graph['directed'] ? $this-&gt;dotCommand : $this-&gt;neatoCommand;
00110             $command .= <span class="stringliteral">" -T$format -o$outputfile $file"</span>;
00111  
00112             @`$command`;
00113             $command = $this-&gt;dotCommand;
00114             $command.= <span class="stringliteral">" -Tcmap -o$outputfile2 $file"</span>;
00115             @`$command`;
00116             $fr = fopen($outputfile2,<span class="stringliteral">"r"</span>);
00117             $map = fread($fr,filesize($outputfile2));
00118             fclose($fr);
00119             @unlink($file);
00120 
00121             <span class="keywordflow">switch</span> ($format) {
00122                 <span class="keywordflow">case</span> 'gif':
00123                 <span class="keywordflow">case</span> 'jpg':
00124                 <span class="keywordflow">case</span> 'png':
00125                 <span class="keywordflow">case</span> 'svg':
00126                 <span class="keywordflow">case</span> 'wbmp': {
00127                     header('Content-Type: image/' . $format);
00128                 }
00129                 <span class="keywordflow">break</span>;
00130 
00131                 <span class="keywordflow">case</span> 'pdf': {
00132                     header('Content-Type: application/pdf');
00133                 }
00134                 <span class="keywordflow">break</span>;
00135             }
00136 
00137             header('Content-Length: ' . filesize($outputfile));
00138 
00139             $fp = fopen($outputfile, 'rb');
00140 
00141             <span class="keywordflow">if</span> ($fp) {
00142                 echo fread($fp, filesize($outputfile));
00143                 fclose($fp);
00144                 @unlink($outputfile);
00145             }
00146             @unlink($outputfile2);
00147             <span class="keywordflow">return</span> $map;
00148         }
00149     }
00150     
00151     function image_and_map($format = 'png') {
00152         <span class="keywordflow">if</span> ($file = $this-&gt;saveParsedGraph()) {
00153             $outputfile = $file . <span class="charliteral">'.'</span> . $format;
00154             $outputfile2 = $file . <span class="charliteral">'.'</span> . 'map';
00155             $command  = $this-&gt;graph['directed'] ? $this-&gt;dotCommand : $this-&gt;neatoCommand;
00156             $command .= <span class="stringliteral">" -T$format -o$outputfile $file"</span>;
00157  
00158             @`$command`;
00159             $command = $this-&gt;dotCommand;
00160             $command.= <span class="stringliteral">" -Tcmap -o$outputfile2 $file"</span>;
00161             @`$command`;
00162             @unlink($file);
00163             <span class="keywordflow">return</span> <span class="keyword">true</span>;
00164         }
00165     }
00166 
00167     
00168     function map() {
00169         <span class="keywordflow">if</span> ($file = $this-&gt;saveParsedGraph()) {
00170             
00171             $outputfile2 = $file . <span class="charliteral">'.'</span> . 'map';
00172             
00173             $command = $this-&gt;dotCommand;
00174             $command.= <span class="stringliteral">" -Tcmap -o$outputfile2 $file"</span>;
00175             @`$command`;
00176             $fr = fopen($outputfile2,<span class="stringliteral">"r"</span>);
00177             $map = fread($fr,filesize($outputfile2));
00178             fclose($fr);
00179             
00180             @unlink($outputfile2);
00181             @unlink($file);
00182             <span class="keywordflow">return</span> $map;
00183         }
00184     }
00185 
00193     function addCluster($id, $title) {
00194         $this-&gt;graph['clusters'][$id] = $title;
00195     }
00196 
00205     function addNode($name, $attributes = array(), $group = '<span class="keywordflow">default</span>') {
00206         $this-&gt;graph['nodes'][$group][$name] = $attributes;
00207     }
00208 
00215     function removeNode($name, $group = '<span class="keywordflow">default</span>') {
00216         <span class="keywordflow">if</span> (isset($this-&gt;graph['nodes'][$group][$name])) {
00217             unset($this-&gt;graph['nodes'][$group][$name]);
00218         }
00219     }
00220 
00228     function addEdge($edge, $attributes = array()) {
00229         <span class="keywordflow">if</span> (is_array($edge)) {
00230             $from = key($edge);
00231             $to   = $edge[$from];
00232             $id   = $from . <span class="charliteral">'_'</span> . $to;
00233 
00234             <span class="keywordflow">if</span> (!isset($this-&gt;graph['edges'][$id])) {
00235                 $this-&gt;graph['edges'][$id] = $edge;
00236             } <span class="keywordflow">else</span> {
00237                 $this-&gt;graph['edges'][$id] = array_merge(
00238                   $this-&gt;graph['edges'][$id],
00239                   $edge
00240                 );
00241             }
00242 
00243             <span class="keywordflow">if</span> (is_array($attributes)) {
00244                 <span class="keywordflow">if</span> (!isset($this-&gt;graph['edgeAttributes'][$id])) {
00245                     $this-&gt;graph['edgeAttributes'][$id] = $attributes;
00246                 } <span class="keywordflow">else</span> {
00247                     $this-&gt;graph['edgeAttributes'][$id] = array_merge(
00248                       $this-&gt;graph['edgeAttributes'][$id],
00249                       $attributes
00250                     );
00251                 }
00252             }
00253         }
00254     }
00255 
00262     function removeEdge($edge) {
00263         <span class="keywordflow">if</span> (is_array($edge)) {
00264               $from = key($edge);
00265               $to   = $edge[$from];
00266               $id   = $from . <span class="charliteral">'_'</span> . $to;
00267 
00268             <span class="keywordflow">if</span> (isset($this-&gt;graph['edges'][$id])) {
00269                 unset($this-&gt;graph['edges'][$id]);
00270             }
00271 
00272             <span class="keywordflow">if</span> (isset($this-&gt;graph['edgeAttributes'][$id])) {
00273                 unset($this-&gt;graph['edgeAttributes'][$id]);
00274             }
00275         }
00276     }
00277 
00284     function addAttributes($attributes) {
00285         <span class="keywordflow">if</span> (is_array($attributes)) {
00286             $this-&gt;graph['attributes'] = array_merge(
00287               $this-&gt;graph['attributes'],
00288               $attributes
00289             );
00290         }
00291     }
00292 
00299     function setAttributes($attributes) {
00300         <span class="keywordflow">if</span> (is_array($attributes)) {
00301             $this-&gt;graph['attributes'] = $attributes;
00302         }
00303     }
00304 
00311     function setDirected($directed) {
00312         <span class="keywordflow">if</span> (is_bool($directed)) {
00313             $this-&gt;graph['directed'] = $directed;
00314         }
00315     }
00316 
00323     function load($file) {
00324         <span class="keywordflow">if</span> ($serialized_graph = implode('', @file($file))) {
00325             $this-&gt;graph = unserialize($serialized_graph);
00326         }
00327     }
00328 
00336     function save($file = '') {
00337         $serialized_graph = serialize($this-&gt;graph);
00338 
00339         <span class="keywordflow">if</span> (empty($file)) {
00340             $file = tempnam('temp', 'graph_');
00341         }
00342 
00343         <span class="keywordflow">if</span> ($fp = @fopen($file, <span class="charliteral">'w'</span>)) {
00344             @fputs($fp, $serialized_graph);
00345             @fclose($fp);
00346 
00347             <span class="keywordflow">return</span> $file;
00348         }
00349 
00350         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00351     }
00352 
00359     function parse() {
00360         $parsedGraph = <span class="stringliteral">"digraph G {\n"</span>;
00361 
00362         <span class="keywordflow">if</span> (isset($this-&gt;graph['attributes'])) {
00363             foreach ($this-&gt;graph['attributes'] as $key =&gt; $value) {
00364                 $attributeList[] = $key . '=<span class="stringliteral">"' . $value . '"</span>';
00365             }
00366 
00367             <span class="keywordflow">if</span> (!empty($attributeList)) {
00368               $parsedGraph .= implode(<span class="charliteral">','</span>, $attributeList) . <span class="stringliteral">";\n"</span>;
00369             }
00370         }
00371 
00372         <span class="keywordflow">if</span> (isset($this-&gt;graph['nodes'])) {
00373             foreach($this-&gt;graph['nodes'] as $group =&gt; $nodes) {
00374                 <span class="keywordflow">if</span> ($group != '<span class="keywordflow">default</span>') {
00375                   $parsedGraph .= sprintf(
00376                     <span class="stringliteral">"subgraph \"cluster_%s\" {\nlabel=\"%s\";\n"</span>,
00377 
00378                     $group,
00379                     isset($this-&gt;graph['clusters'][$group]) ? $this-&gt;graph['clusters'][$group] : ''
00380                   );
00381                 }
00382 
00383                 foreach($nodes as $node =&gt; $attributes) {
00384                     unset($attributeList);
00385 
00386                     foreach($attributes as $key =&gt; $value) {
00387                         $attributeList[] = $key . '=<span class="stringliteral">"' . $value . '"</span>';
00388                     }
00389 
00390                     <span class="keywordflow">if</span> (!empty($attributeList)) {
00391                         $parsedGraph .= sprintf(
00392                           <span class="stringliteral">"\"%s\" [ %s ];\n"</span>,
00393                           addslashes(stripslashes($node)),
00394                           implode(<span class="charliteral">','</span>, $attributeList)
00395                         );
00396                     }
00397                 }
00398 
00399                 <span class="keywordflow">if</span> ($group != '<span class="keywordflow">default</span>') {
00400                   $parsedGraph .= <span class="stringliteral">"}\n"</span>;
00401                 }
00402             }
00403         }
00404 
00405         <span class="keywordflow">if</span> (isset($this-&gt;graph['edges'])) {
00406             foreach($this-&gt;graph['edges'] as $label =&gt; $node) {
00407                 unset($attributeList);
00408 
00409                 $from = key($node);
00410                 $to   = $node[$from];
00411 
00412                 foreach($this-&gt;graph['edgeAttributes'][$label] as $key =&gt; $value) {
00413                     $attributeList[] = $key . '=<span class="stringliteral">"' . $value . '"</span>';
00414                 }
00415 
00416                 $parsedGraph .= sprintf(
00417                   '<span class="stringliteral">"%s"</span> -&gt; <span class="stringliteral">"%s"</span>',
00418                   addslashes(stripslashes($from)),
00419                   addslashes(stripslashes($to))
00420                 );
00421                 
00422                 <span class="keywordflow">if</span> (!empty($attributeList)) {
00423                     $parsedGraph .= sprintf(
00424                       ' [ %s ]',
00425                       implode(<span class="charliteral">','</span>, $attributeList)
00426                     );
00427                 }
00428 
00429                 $parsedGraph .= <span class="stringliteral">";\n"</span>;
00430             }
00431         }
00432 
00433         <span class="keywordflow">return</span> $parsedGraph . <span class="stringliteral">"}\n"</span>;
00434     }
00435 
00444     function saveParsedGraph($file = '') {
00445         $parsedGraph = $this-&gt;parse();
00446 
00447         <span class="keywordflow">if</span> (!empty($parsedGraph)) {
00448 
00449                 $file = 'lib/Galaxia/Processes/'.$this-&gt;pid.'/graph/';
00450 
00451             <span class="keywordflow">if</span> ($fp = @fopen($file, <span class="charliteral">'w'</span>)) {
00452                 @fputs($fp, $parsedGraph);
00453                 @fclose($fp);
00454 
00455                 <span class="keywordflow">return</span> $file;
00456             }
00457         }
00458 
00459         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00460     }
00461 }
00462 ?&gt;
</pre></div><hr><address style="align: right;"><small>Generated on Mon Apr 14 11:51:58 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
