<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>RoleManager.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>RoleManager.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 
00005 
<a name="l00017"></a><a class="code" href="classRoleManager.html">00017</a> <span class="keyword">class </span><a class="code" href="classRoleManager.html">RoleManager</a> <span class="keyword">extends</span> TikiLib {
00018     
<a name="l00023"></a><a class="code" href="classRoleManager.html#a0">00023</a>   function <a class="code" href="classRoleManager.html#a0">RoleManager</a>($db) 
00024   {
00025     <span class="keywordflow">if</span>(!$db) {
00026       die(<span class="stringliteral">"Invalid db object passed to RoleManager constructor"</span>);  
00027     }
00028     $this-&gt;db = $db;  
00029   }
00030   
<a name="l00034"></a><a class="code" href="classRoleManager.html#a1">00034</a>   function <a class="code" href="classRoleManager.html#a1">get_role</a>($pId, $roleId)
00035   {
00036         $query = <span class="stringliteral">"select * from galaxia_roles where pId=$pId and roleId=$roleId"</span>;
00037         $result = $this-&gt;query($query);
00038         $res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC);
00039         <span class="keywordflow">return</span> $res;
00040   }
00041   
<a name="l00045"></a><a class="code" href="classRoleManager.html#a2">00045</a>   function <a class="code" href="classRoleManager.html#a2">map_user_to_role</a>($pId,$user,$roleId)
00046   {
00047     $query = <span class="stringliteral">"replace into galaxia_user_roles(pId,user,roleId) values($pId,'$user',$roleId)"</span>;
00048     $this-&gt;query($query);
00049   }
00050   
<a name="l00054"></a><a class="code" href="classRoleManager.html#a3">00054</a>   function <a class="code" href="classRoleManager.html#a3">remove_mapping</a>($user,$roleId)
00055   { 
00056     $query = <span class="stringliteral">"delete from galaxia_user_roles where user='$user' and roleId=$roleId"</span>;
00057     $this-&gt;query($query);
00058   }
00059   
<a name="l00063"></a><a class="code" href="classRoleManager.html#a4">00063</a>   function <a class="code" href="classRoleManager.html#a4">list_mappings</a>($pId,$offset,$maxRecords,$sort_mode,$find)  {
00064     $sort_mode = str_replace(<span class="stringliteral">"_"</span>,<span class="stringliteral">" "</span>,$sort_mode);
00065     <span class="keywordflow">if</span>($find) {
00066       $mid=<span class="stringliteral">" where gr.roleId=gur.roleId and gur.pId=$pId and ((name like '%"</span>.$find.<span class="stringliteral">"%') or (user like '%"</span>.$find.<span class="stringliteral">"%') or (description like '%"</span>.$find.<span class="stringliteral">"%'))"</span>;
00067     } <span class="keywordflow">else</span> {
00068       $mid=<span class="stringliteral">" where gr.roleId=gur.roleId and gur.pId=$pId "</span>;
00069     }
00070     $query = <span class="stringliteral">"select name,gr.roleId,user from galaxia_roles gr, galaxia_user_roles gur $mid order by $sort_mode limit $offset,$maxRecords"</span>;
00071     $query_cant = <span class="stringliteral">"select count(*) from galaxia_roles gr, galaxia_user_roles gur $mid"</span>;
00072     $result = $this-&gt;query($query);
00073     $cant = $this-&gt;getOne($query_cant);
00074     $ret = Array();
00075     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00076       $ret[] = $res;
00077     }
00078     $retval = Array();
00079     $retval[<span class="stringliteral">"data"</span>] = $ret;
00080     $retval[<span class="stringliteral">"cant"</span>] = $cant;
00081     <span class="keywordflow">return</span> $retval;
00082   }
00083   
<a name="l00087"></a><a class="code" href="classRoleManager.html#a5">00087</a>   function <a class="code" href="classRoleManager.html#a5">list_roles</a>($pId,$offset,$maxRecords,$sort_mode,$find,$where='')
00088   {
00089     $sort_mode = str_replace(<span class="stringliteral">"_"</span>,<span class="stringliteral">" "</span>,$sort_mode);
00090     <span class="keywordflow">if</span>($find) {
00091       $mid=<span class="stringliteral">" where pId=$pId and ((name like '%"</span>.$find.<span class="stringliteral">"%') or (description like '%"</span>.$find.<span class="stringliteral">"%'))"</span>;
00092     } <span class="keywordflow">else</span> {
00093       $mid=<span class="stringliteral">" where pId=$pId "</span>;
00094     }
00095     <span class="keywordflow">if</span>($where) {
00096       $mid.= <span class="stringliteral">" and ($where) "</span>;
00097     }
00098     $query = <span class="stringliteral">"select * from galaxia_roles $mid order by $sort_mode limit $offset,$maxRecords"</span>;
00099     $query_cant = <span class="stringliteral">"select count(*) from galaxia_roles $mid"</span>;
00100     $result = $this-&gt;query($query);
00101     $cant = $this-&gt;getOne($query_cant);
00102     $ret = Array();
00103     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00104       $ret[] = $res;
00105     }
00106     $retval = Array();
00107     $retval[<span class="stringliteral">"data"</span>] = $ret;
00108     $retval[<span class="stringliteral">"cant"</span>] = $cant;
00109     <span class="keywordflow">return</span> $retval;
00110   }
00111   
00112   
00113   
<a name="l00117"></a><a class="code" href="classRoleManager.html#a6">00117</a>   function <a class="code" href="classRoleManager.html#a6">remove_role</a>($pId, $roleId)
00118   {
00119     $query = <span class="stringliteral">"delete from galaxia_roles where pId=$pId and roleId=$roleId"</span>;
00120     $this-&gt;query($query);
00121     $query = <span class="stringliteral">"delete from galaxia_activity_roles where roleId=$roleId"</span>;
00122     $this-&gt;query($query);
00123     $query = <span class="stringliteral">"delete from galaxia_user_roles where roleId=$roleId"</span>;
00124     $this-&gt;query($query);
00125   }
00126   
<a name="l00133"></a><a class="code" href="classRoleManager.html#a7">00133</a>   function <a class="code" href="classRoleManager.html#a7">replace_role</a>($pId, $roleId, $vars)
00134   {
00135     $TABLE_NAME = 'galaxia_roles';
00136     $now = date(<span class="stringliteral">"U"</span>);
00137     $vars['lastModif']=$now;
00138     $vars['pId']=$pId;
00139     
00140     foreach($vars as $key=&gt;$value)
00141     {
00142       $vars[$key]=addslashes($value);
00143     }
00144   
00145     <span class="keywordflow">if</span>($roleId) {
00146       <span class="comment">// update mode</span>
00147       $first = <span class="keyword">true</span>;
00148       $query =<span class="stringliteral">"update $TABLE_NAME set"</span>;
00149       foreach($vars as $key=&gt;$value) {
00150         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>;
00151         <span class="keywordflow">if</span>(!is_numeric($value)) $value=<span class="stringliteral">"'"</span>.$value.<span class="stringliteral">"'"</span>;
00152         $query.= <span class="stringliteral">" $key=$value "</span>;
00153         $first = <span class="keyword">false</span>;
00154       }
00155       $query .= <span class="stringliteral">" where pId=$pId and roleId=$roleId "</span>;
00156       $this-&gt;query($query);
00157     } <span class="keywordflow">else</span> {
00158       $name = $vars['name'];
00159       <span class="keywordflow">if</span> ($this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_roles where pId=$pId and name='$name'"</span>)) {
00160         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00161       }
00162       unset($vars['roleId']);
00163       <span class="comment">// insert mode</span>
00164       $first = <span class="keyword">true</span>;
00165       $query = <span class="stringliteral">"insert into $TABLE_NAME("</span>;
00166       foreach(array_keys($vars) as $key) {
00167         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>; 
00168         $query.= <span class="stringliteral">"$key"</span>;
00169         $first = <span class="keyword">false</span>;
00170       } 
00171       $query .=<span class="stringliteral">") values("</span>;
00172       $first = <span class="keyword">true</span>;
00173       foreach(array_values($vars) as $value) {
00174         <span class="keywordflow">if</span>(!$first) $query.= <span class="charliteral">','</span>; 
00175         <span class="keywordflow">if</span>(!is_numeric($value)) $value=<span class="stringliteral">"'"</span>.$value.<span class="stringliteral">"'"</span>;
00176         $query.= <span class="stringliteral">"$value"</span>;
00177         $first = <span class="keyword">false</span>;
00178       } 
00179       $query .=<span class="stringliteral">")"</span>;
00180       $this-&gt;query($query);
00181       $roleId = $this-&gt;getOne(<span class="stringliteral">"select max(roleId) from $TABLE_NAME where pId=$pId and lastModif=$now"</span>); 
00182     }
00183     <span class="comment">// Get the id</span>
00184     <span class="keywordflow">return</span> $roleId;
00185   }
00186     
00187 }
00188 
00190 $roleManager = <span class="keyword">new</span> <a class="code" href="classRoleManager.html">RoleManager</a>($dbTiki);
00191 
00192 ?&gt;
</pre></div><hr><address style="align: right;"><small>Generated on Mon Apr 14 11:51:59 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
