<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>tiki-g-admin_roles.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>tiki-g-admin_roles.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 require_once('tiki-setup.php');
00003 include_once('lib/Galaxia/<a class="code" href="classProcessManager.html">ProcessManager</a>.php');
00004 
00005 <span class="comment">// The galaxia roles manager PHP script.</span>
00006 
00007 <span class="comment">/*</span>
00008 <span class="comment">// Check if feature is enabled and permissions</span>
00009 <span class="comment">if($feature_galaxia != 'y') {</span>
00010 <span class="comment">  $smarty-&gt;assign('msg',tra("This feature is disabled"));</span>
00011 <span class="comment">  $smarty-&gt;display("styles/$style_base/error.tpl");</span>
00012 <span class="comment">  die;  </span>
00013 <span class="comment">}</span>
00014 <span class="comment">*/</span>
00015 
00016 <span class="keywordflow">if</span>(!isset($_REQUEST['pid'])) {
00017   $smarty-&gt;assign('msg',tra(<span class="stringliteral">"No process indicated"</span>));
00018   $smarty-&gt;display(<span class="stringliteral">"styles/$style_base/error.tpl"</span>);
00019   die;  
00020 }
00021 $smarty-&gt;assign('pid',$_REQUEST['pid']);
00022 
00023 $proc_info = $processManager-&gt;get_process($_REQUEST['pid']);
00024 $proc_info['graph']=<span class="stringliteral">"lib/Galaxia/processes/"</span>.$proc_info['normalized_name'].<span class="stringliteral">"/graph/"</span>.$proc_info['normalized_name'].<span class="stringliteral">".png"</span>;
00025 
00026 
00027 <span class="comment">// Retrieve activity info if we are editing, assign to </span>
00028 <span class="comment">// default values when creating a new activity</span>
00029 <span class="keywordflow">if</span>(!isset($_REQUEST['roleId'])) $_REQUEST['roleId'] = 0;
00030 <span class="keywordflow">if</span>($_REQUEST[<span class="stringliteral">"roleId"</span>]) {
00031   $info = $roleManager-&gt;get_role($_REQUEST['pid'],$_REQUEST[<span class="stringliteral">"roleId"</span>]);
00032 } <span class="keywordflow">else</span> {
00033   $info = Array(
00034     'name' =&gt; '',
00035     'description' =&gt; '',
00036     'roleId' =&gt; 0
00037   );
00038 }
00039 $smarty-&gt;assign('roleId',$_REQUEST['roleId']);
00040 $smarty-&gt;assign('info',$info);
00041 
00042 
00043 
00044 <span class="comment">// Delete roles</span>
00045 <span class="keywordflow">if</span>(isset($_REQUEST[<span class="stringliteral">"delete"</span>])) {
00046   foreach(array_keys($_REQUEST[<span class="stringliteral">"role"</span>]) as $item) {             
00047     $roleManager-&gt;remove_role($_REQUEST['pid'], $item);
00048   }
00049 }
00050 
00051 <span class="comment">// If we are adding an activity then add it!</span>
00052 <span class="keywordflow">if</span>(isset($_REQUEST['save'])) {
00053         $vars = Array(
00054     'name' =&gt; $_REQUEST['name'],
00055     'description' =&gt; $_REQUEST['description'],
00056         );  
00057         
00058         $roleManager-&gt;replace_role($_REQUEST['pid'],$_REQUEST['roleId'],$vars);
00059 
00060         $info = Array(
00061     'name' =&gt; '',
00062     'description' =&gt; '',
00063     'roleId' =&gt; 0
00064     );  
00065     $smarty-&gt;assign('info',$info);
00066 }
00067 
00068 
00069 <span class="comment">// MAPIING</span>
00070 
00071 <span class="keywordflow">if</span>(!isset($_REQUEST['find_users'])) $_REQUEST['find_users']='';
00072 $smarty-&gt;assign('find_users',$_REQUEST['find_users']);
00073 $users = $userlib-&gt;get_users(0,-1,'login_asc', $_REQUEST['find_users']);
00074 $smarty-&gt;assign_by_ref('users',$users['data']);
00075 
00076 $roles = $roleManager-&gt;list_roles($_REQUEST['pid'],0,-1,'name_asc<span class="charliteral">','</span>');
00077 $smarty-&gt;assign_by_ref('roles',$roles['data']);
00078 
00079 <span class="keywordflow">if</span>(isset($_REQUEST[<span class="stringliteral">"delete_map"</span>])) {
00080   foreach(array_keys($_REQUEST[<span class="stringliteral">"map"</span>]) as $item) {              
00081     $parts = explode(':::',$item);
00082     $roleManager-&gt;remove_mapping($parts[0],$parts[1]);
00083   }
00084 }
00085 
00086 
00087 <span class="keywordflow">if</span>(isset($_REQUEST['save_map'])) {
00088   <span class="keywordflow">if</span>(isset($_REQUEST['user'])  &amp;&amp; isset($_REQUEST['role'])) {
00089     foreach($_REQUEST['user'] as $user) {
00090       foreach($_REQUEST['role'] as $role) {
00091                 $roleManager-&gt;map_user_to_role($_REQUEST['pid'],$user,$role);    
00092       }
00093     }
00094   }
00095   
00096 }
00097 
00098 <span class="comment">// list mappings</span>
00099 <span class="keywordflow">if</span>(!isset($_REQUEST[<span class="stringliteral">"sort_mode"</span>])) {  $sort_mode = 'name_asc'; } <span class="keywordflow">else</span> {  $sort_mode = $_REQUEST[<span class="stringliteral">"sort_mode"</span>];} 
00100 <span class="keywordflow">if</span>(!isset($_REQUEST[<span class="stringliteral">"offset"</span>])) {  $offset = 0;} <span class="keywordflow">else</span> {  $offset = $_REQUEST[<span class="stringliteral">"offset"</span>]; }$smarty-&gt;assign_by_ref('offset',$offset);
00101 <span class="keywordflow">if</span>(isset($_REQUEST[<span class="stringliteral">"find"</span>])) { $find = $_REQUEST[<span class="stringliteral">"find"</span>];  } <span class="keywordflow">else</span> {  $find = ''; } $smarty-&gt;assign('find',$find);
00102 $smarty-&gt;assign_by_ref('sort_mode',$sort_mode);
00103 $mapitems = $roleManager-&gt;list_mappings($_REQUEST['pid'],$offset,$maxRecords,$sort_mode,$find);
00104 $smarty-&gt;assign('cant',$mapitems['cant']);
00105 $cant_pages = ceil($mapitems[<span class="stringliteral">"cant"</span>] / $maxRecords);$smarty-&gt;assign_by_ref('cant_pages',$cant_pages);$smarty-&gt;assign('actual_page',1+($offset/$maxRecords));
00106 <span class="keywordflow">if</span>($mapitems[<span class="stringliteral">"cant"</span>] &gt; ($offset+$maxRecords)) {  $smarty-&gt;assign('next_offset',$offset + $maxRecords);} <span class="keywordflow">else</span> {  $smarty-&gt;assign('next_offset',-1); }
00107 <span class="keywordflow">if</span>($offset&gt;0) {  $smarty-&gt;assign('prev_offset',$offset - $maxRecords);  } <span class="keywordflow">else</span> {  $smarty-&gt;assign('prev_offset',-1); }
00108 $smarty-&gt;assign_by_ref('mapitems',$mapitems[<span class="stringliteral">"data"</span>]);
00109 
00110 
00111 <span class="comment">//MAPPING</span>
00112 
00113 <span class="keywordflow">if</span>(!isset($_REQUEST['sort_mode2'])) $_REQUEST['sort_mode2']='name_asc';
00114 $smarty-&gt;assign('sort_mode2',$_REQUEST['sort_mode2']);
00115 <span class="comment">// Get all the process roles</span>
00116 $all_roles = $roleManager-&gt;list_roles($_REQUEST['pid'],0,-1,$_REQUEST['sort_mode2'],'');
00117 $smarty-&gt;assign_by_ref('items',$all_roles['data']);
00118 
00119 $valid = $activityManager-&gt;validate_process_activities($_REQUEST['pid']);
00120 $proc_info['isValid']=$valid?<span class="charliteral">'y'</span>:<span class="charliteral">'n'</span>;
00121 $errors = Array();
00122 <span class="keywordflow">if</span>(!$valid) {
00123   $errors = $activityManager-&gt;get_error();
00124 }
00125 $smarty-&gt;assign('errors',$errors);
00126 $smarty-&gt;assign('proc_info',$proc_info);
00127 
00128 $smarty-&gt;assign('mid<span class="charliteral">','</span>tiki-g-admin_roles.tpl');
00129 $smarty-&gt;display(<span class="stringliteral">"styles/$style_base/tiki.tpl"</span>);
00130 ?&gt;
</pre></div><hr><address style="align: right;"><small>Generated on Mon Apr 14 11:52:00 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
