<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>tiki-index_p.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>tiki-index_p.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 <span class="comment">// Initialization</span>
00003 require_once('tiki-setup.php');
00004 include_once('lib/structures/structlib.php');
00005 
00006 include_once('lib/wiki/wikilib.php');
00007 
00008 
00009 <span class="keywordflow">if</span>($feature_wiki != <span class="charliteral">'y'</span>) {
00010   $smarty-&gt;assign('msg',tra(<span class="stringliteral">"This feature is disabled"</span>));
00011   $smarty-&gt;display(<span class="stringliteral">"styles/$style_base/error.tpl"</span>);
00012   die;  
00013 }
00014 
00015 <span class="comment">//print($GLOBALS["HTTP_REFERER"]);</span>
00016 
00017 <span class="comment">// Create the HomePage if it doesn't exist</span>
00018 <span class="keywordflow">if</span>(!$tikilib-&gt;page_exists(<span class="stringliteral">"HomePage"</span>)) {
00019   $tikilib-&gt;create_page(<span class="stringliteral">"HomePage"</span>,0,'',date(<span class="stringliteral">"U"</span>),'Tiki initialization'); 
00020 }
00021 
00022 <span class="keywordflow">if</span>(!isset($_SESSION[<span class="stringliteral">"thedate"</span>])) {
00023   $thedate = date(<span class="stringliteral">"U"</span>);
00024 } <span class="keywordflow">else</span> {
00025   $thedate = $_SESSION[<span class="stringliteral">"thedate"</span>];
00026 }
00027 
00028 <span class="comment">// Get the page from the request var or default it to HomePage</span>
00029 <span class="keywordflow">if</span>(!isset($_REQUEST[<span class="stringliteral">"page"</span>])) {
00030   $_REQUEST[<span class="stringliteral">"page"</span>]=$wikiHomePage;
00031   $page = $wikiHomePage;
00032   $smarty-&gt;assign('page',$wikiHomePage); 
00033 } <span class="keywordflow">else</span> {
00034   $page = $_REQUEST[<span class="stringliteral">"page"</span>];
00035   $smarty-&gt;assign_by_ref('page',$_REQUEST[<span class="stringliteral">"page"</span>]); 
00036 }
00037 <span class="keywordflow">if</span>(!$tikilib-&gt;page_exists($wikiHomePage)) {
00038   $tikilib-&gt;create_page($wikiHomePage,0,'',date(<span class="stringliteral">"U"</span>),'Tiki initialization'); 
00039 }
00040 
00041 
00042 
00043 require_once('tiki-pagesetup.php');
00044 
00045 
00046 
00047 
00048 <span class="comment">// If the page doesn't exist then display an error</span>
00049 <span class="keywordflow">if</span>(!$tikilib-&gt;page_exists($page)) {
00050   $smarty-&gt;assign('msg',tra(<span class="stringliteral">"Page cannot be found"</span>));
00051   $smarty-&gt;display(<span class="stringliteral">"styles/$style_base/error.tpl"</span>);
00052   die;
00053 }
00054 
00055 
00056 <span class="comment">// Now check permissions to access this page</span>
00057 <span class="keywordflow">if</span>($tiki_p_view != <span class="charliteral">'y'</span>) {
00058   $smarty-&gt;assign('msg',tra(<span class="stringliteral">"Permission denied you cannot view this page"</span>));
00059   $smarty-&gt;display(<span class="stringliteral">"styles/$style_base/error.tpl"</span>);
00060   die;  
00061 }
00062 
00063 <span class="comment">// BreadCrumbNavigation here</span>
00064 <span class="comment">// Get the number of pages from the default or userPreferences</span>
00065 <span class="comment">// Remember to reverse the array when posting the array</span>
00066 $anonpref = $tikilib-&gt;get_preference('userbreadCrumb',4);
00067 <span class="keywordflow">if</span>($user) {
00068   $userbreadCrumb = $tikilib-&gt;get_user_preference($user,'userbreadCrumb',$anonpref);
00069 } <span class="keywordflow">else</span> {
00070   $userbreadCrumb = $anonpref;
00071 }
00072 <span class="keywordflow">if</span>(!isset($_SESSION[<span class="stringliteral">"breadCrumb"</span>])) {
00073   $_SESSION[<span class="stringliteral">"breadCrumb"</span>]=Array();
00074 }
00075 <span class="keywordflow">if</span>(!in_array($page,$_SESSION[<span class="stringliteral">"breadCrumb"</span>])) {
00076   <span class="keywordflow">if</span>(count($_SESSION[<span class="stringliteral">"breadCrumb"</span>])&gt;$userbreadCrumb) {
00077     array_shift($_SESSION[<span class="stringliteral">"breadCrumb"</span>]);
00078   } 
00079   array_push($_SESSION[<span class="stringliteral">"breadCrumb"</span>],$page);
00080 } <span class="keywordflow">else</span> {
00081   <span class="comment">// If the page is in the array move to the last position</span>
00082   $pos = array_search($page, $_SESSION[<span class="stringliteral">"breadCrumb"</span>]);
00083   unset($_SESSION[<span class="stringliteral">"breadCrumb"</span>][$pos]);
00084   array_push($_SESSION[<span class="stringliteral">"breadCrumb"</span>],$page);
00085 }
00086 <span class="comment">//print_r($_SESSION["breadCrumb"]);</span>
00087 
00088 
00089 <span class="comment">// Now increment page hits since we are visiting this page</span>
00090 $tikilib-&gt;add_hit($page);
00091 
00092 <span class="comment">// Get page data</span>
00093 $info = $tikilib-&gt;get_page_info($page);
00094 
00095 $smarty-&gt;assign('page_user',$info['user']);
00096 
00097 <span class="comment">// Check if we have to perform an action for this page</span>
00098 <span class="comment">// for example lock/unlock</span>
00099 <span class="keywordflow">if</span>( 
00100     ($tiki_p_admin_wiki == <span class="charliteral">'y'</span>) 
00101     || 
00102     ($user and ($tiki_p_lock == <span class="charliteral">'y'</span>) and ($feature_wiki_userlock == <span class="charliteral">'y'</span>))
00103    ) {
00104 <span class="keywordflow">if</span>(isset($_REQUEST[<span class="stringliteral">"action"</span>])) {
00105   <span class="keywordflow">if</span>($_REQUEST[<span class="stringliteral">"action"</span>]=='lock') {
00106     $tikilib-&gt;lock_page($page);
00107   }  
00108 }
00109 }
00110 
00111 <span class="keywordflow">if</span>( 
00112     ($tiki_p_admin_wiki == <span class="charliteral">'y'</span>) 
00113     || 
00114     ($user and ($user == $info['user']) and ($tiki_p_lock == <span class="charliteral">'y'</span>) and ($feature_wiki_userlock == <span class="charliteral">'y'</span>))
00115    ) {
00116 <span class="keywordflow">if</span>(isset($_REQUEST[<span class="stringliteral">"action"</span>])) {
00117   <span class="keywordflow">if</span> ($_REQUEST[<span class="stringliteral">"action"</span>]=='unlock') {
00118     $tikilib-&gt;unlock_page($page);
00119   }  
00120 }
00121 }
00122 
00123 
00124 <span class="comment">// Save to notepad if user wants to</span>
00125 <span class="keywordflow">if</span>($user 
00126     &amp;&amp; $feature_wiki_notepad == <span class="charliteral">'y'</span> 
00127         &amp;&amp; $tiki_p_notepad == <span class="charliteral">'y'</span> 
00128         &amp;&amp; $feature_notepad == <span class="charliteral">'y'</span> 
00129         &amp;&amp; isset($_REQUEST['savenotepad'])) {
00130   include_once('lib/notepad/notepadlib.php');   
00131   $notepadlib-&gt;replace_note($user,0,$_REQUEST['page'],$info['data']);
00132 }
00133 
00134 <span class="comment">// Verify lock status</span>
00135 <span class="keywordflow">if</span>($info[<span class="stringliteral">"flag"</span>] == <span class="charliteral">'L'</span>) {
00136   $smarty-&gt;assign('lock',<span class="keyword">true</span>);  
00137 } <span class="keywordflow">else</span> {
00138   $smarty-&gt;assign('lock',<span class="keyword">false</span>);
00139 }
00140 
00141 <span class="comment">// If not locked and last version is user version then can undo</span>
00142 $smarty-&gt;assign('canundo<span class="charliteral">','</span>n'); 
00143 <span class="keywordflow">if</span>($info[<span class="stringliteral">"flag"</span>]!=<span class="charliteral">'L'</span> &amp;&amp; ( ($tiki_p_edit == <span class="charliteral">'y'</span> &amp;&amp; $info[<span class="stringliteral">"user"</span>]==$user)||($tiki_p_remove==<span class="charliteral">'y'</span>) )) {
00144    $smarty-&gt;assign('canundo<span class="charliteral">','</span>y');      
00145 }
00146 <span class="keywordflow">if</span>($tiki_p_admin_wiki == <span class="charliteral">'y'</span>) {
00147   $smarty-&gt;assign('canundo<span class="charliteral">','</span>y');               
00148 }
00149 
00150 <span class="comment">// Process an undo here</span>
00151 <span class="keywordflow">if</span>(isset($_REQUEST[<span class="stringliteral">"undo"</span>])) {
00152 <span class="keywordflow">if</span>($tiki_p_admin_wiki == <span class="charliteral">'y'</span> || ($info[<span class="stringliteral">"flag"</span>]!=<span class="charliteral">'L'</span> &amp;&amp; ( ($tiki_p_edit == <span class="charliteral">'y'</span> &amp;&amp; $info[<span class="stringliteral">"user"</span>]==$user)||($tiki_p_remove==<span class="charliteral">'y'</span>)) )) {
00153   <span class="comment">// Remove the last version    </span>
00154   $tikilib-&gt;remove_last_version($page);
00155   <span class="comment">// If page was deleted then re-create</span>
00156   <span class="keywordflow">if</span>(!$tikilib-&gt;page_exists($page)) {
00157     $tikilib-&gt;create_page($page,0,'',date(<span class="stringliteral">"U"</span>),'Tiki initialization'); 
00158   }
00159   <span class="comment">// Restore page information</span>
00160   $info = $tikilib-&gt;get_page_info($page);       
00161 }
00162 }
00163 
00164 $slides = split(<span class="stringliteral">"-=[^=]+=-"</span>,$info[<span class="stringliteral">"data"</span>]);
00165 <span class="keywordflow">if</span>(count($slides)&gt;1) {
00166         $smarty-&gt;assign('show_slideshow<span class="charliteral">','</span>y');
00167 } <span class="keywordflow">else</span> {
00168         $smarty-&gt;assign('show_slideshow<span class="charliteral">','</span>n');
00169 }
00170 
00171 <span class="keywordflow">if</span>(isset($_REQUEST['refresh'])) {
00172   $tikilib-&gt;invalidate_cache($page);    
00173 }
00174 <span class="comment">// Here's where the data is parsed</span>
00175 <span class="comment">// if using cache</span>
00176 <span class="comment">//</span>
00177 <span class="comment">// get cache information</span>
00178 <span class="comment">// if cache is valid then pdata is cache</span>
00179 <span class="comment">// else</span>
00180 <span class="comment">// pdata is parse_data </span>
00181 <span class="comment">//   if using cache then update the cache</span>
00182 <span class="comment">// assign_by_ref</span>
00183 $smarty-&gt;assign('cached_page<span class="charliteral">','</span>n');
00184 <span class="keywordflow">if</span>($wiki_cache&gt;0) {
00185  $cache_info = $wikilib-&gt;get_cache_info($page);
00186  $now = date(<span class="charliteral">'U'</span>);
00187  <span class="keywordflow">if</span>($cache_info['cache_timestamp']+$wiki_cache &gt; $now) {
00188    $pdata = $cache_info['cache'];
00189    $smarty-&gt;assign('cached_page<span class="charliteral">','</span>y');
00190  } <span class="keywordflow">else</span> {
00191    $pdata = $tikilib-&gt;parse_data($info[<span class="stringliteral">"data"</span>]);
00192    $wikilib-&gt;update_cache($page,$pdata);
00193  }
00194 } <span class="keywordflow">else</span> {
00195  $pdata = $tikilib-&gt;parse_data($info[<span class="stringliteral">"data"</span>]);
00196 }
00197 
00198 $pdata = str_replace('tiki-index.php<span class="charliteral">','</span>tiki-index_p.php',$pdata);
00199 
00200 $smarty-&gt;assign_by_ref('parsed',$pdata);
00201 
00202 <span class="comment">//$smarty-&gt;assign_by_ref('lastModif',date("l d of F, Y  [H:i:s]",$info["lastModif"]));</span>
00203 $smarty-&gt;assign_by_ref('lastModif',$info[<span class="stringliteral">"lastModif"</span>]);
00204 <span class="keywordflow">if</span>(empty($info[<span class="stringliteral">"user"</span>])) {
00205   $info[<span class="stringliteral">"user"</span>]='anonymous';  
00206 }
00207 $smarty-&gt;assign_by_ref('lastUser',$info[<span class="stringliteral">"user"</span>]);
00208 $smarty-&gt;assign_by_ref('description',$info[<span class="stringliteral">"description"</span>]);
00209 
00210 $section='wiki';
00211 include_once('tiki-section_options.php');
00212 
00213 
00214 
00215 
00216 
00217 
00218 $smarty-&gt;assign('wiki_extras<span class="charliteral">','</span>y');
00219 $smarty-&gt;assign('structure<span class="charliteral">','</span>n');   
00220 <span class="keywordflow">if</span>($structlib-&gt;page_is_in_structure($page)) {   
00221         $smarty-&gt;assign('structure<span class="charliteral">','</span>y');   
00222         $prev=$structlib-&gt;get_prev_page($page);   
00223         $next=$structlib-&gt;get_next_page($page);   
00224         $<span class="keyword">struct</span>=$structlib-&gt;get_structure($page);   
00225         $smarty-&gt;assign('struct_next',$next);   
00226         $smarty-&gt;assign('struct_prev',$prev);   
00227         $smarty-&gt;assign('struct_struct',$<span class="keyword">struct</span>);   
00228 } 
00229 
00230 <span class="keywordflow">if</span>($feature_theme_control == <span class="charliteral">'y'</span>) {
00231         $cat_type='wiki page';
00232         $cat_objid = $_REQUEST[<span class="stringliteral">"page"</span>];
00233         include('tiki-tc.php');
00234 }
00235 
00236 
00237 <span class="comment">// Display the Index Template</span>
00238 $smarty-&gt;assign('dblclickedit<span class="charliteral">','</span>y');
00239 $smarty-&gt;display(<span class="stringliteral">"tiki-index_p.tpl"</span>);
00240 
00241 ?&gt;
</pre></div><hr><address style="align: right;"><small>Generated on Thu Apr 10 18:06:20 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
