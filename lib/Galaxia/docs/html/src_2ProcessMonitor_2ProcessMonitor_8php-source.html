<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>ProcessMonitor.php Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3-rc3 -->
<center>
<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="classes.html">Alphabetical List</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="pages.html">Related Pages</a> &nbsp; </center>
<hr><h1>ProcessMonitor.php</h1><div class="fragment"><pre>00001 &lt;?php
00002 <span class="keyword">class </span>ProcessMonitor <span class="keyword">extends</span> Base {
00003 
00004   function monitor_stats()
00005   {
00006     $res = Array();
00007     $res['active_processes']=$this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_processes where isActive='y'"</span>);
00008     $res['processes']=$this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_processes"</span>);
00009     $result=$this-&gt;query(<span class="stringliteral">"select distinct(pId) from galaxia_instances where status='active'"</span>);
00010     $res['running_processes']=$result-&gt;numRows();
00011     $res['active_instances']=$this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_instances where status='active'"</span>);
00012     $res['completed_instances']=$this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_instances where status='completed'"</span>);
00013     $res['exception_instances']=$this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_instances where status='exception'"</span>);
00014     $res['aborted_instances']=$this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_instances where status='aborted'"</span>);
00015     <span class="keywordflow">return</span> $res;
00016   }
00017   
00018   function update_instance_status($iid,$status)
00019   {
00020         $query = <span class="stringliteral">"update galaxia_instances set status='$status' where instanceId=$iid"</span>;
00021         $this-&gt;query($query);
00022   }
00023   
00024   function update_instance_activity_status($iid,$activityId,$status)
00025   {
00026         $query = <span class="stringliteral">"update galaxia_instance_activities set status='$status' where instanceId=$iid and activityId=$activityId"</span>;
00027         $this-&gt;query($query);
00028   
00029   }
00030   
00031   function remove_instance($iid)
00032   {
00033         $query = <span class="stringliteral">"delete from galaxia_workitems where instanceId=$iid"</span>;
00034         $this-&gt;query($query);
00035         $query = <span class="stringliteral">"delete from galaxia_instance_activities where instanceId=$iid"</span>;
00036         $this-&gt;query($query);
00037         $query = <span class="stringliteral">"delete from galaxia_instances where instanceId=$iid"</span>;
00038         $this-&gt;query($query);  
00039   }
00040   
00041   function remove_aborted()
00042   {
00043         
00044         $query=<span class="stringliteral">"select instanceId from galaxia_instances where status='aborted'"</span>;
00045         $result = $this-&gt;query($query);
00046     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {       
00047       $iid = $res['instanceId'];
00048       $query = <span class="stringliteral">"delete from galaxia_instance_activities where instanceId=$iid"</span>;
00049           $this-&gt;query($query);
00050           $query = <span class="stringliteral">"delete from galaxia_workitems where instanceId=$iid"</span>;
00051           $this-&gt;query($query);  
00052     }
00053         $query = <span class="stringliteral">"delete from galaxia_instances where status='aborted'"</span>;
00054         $this-&gt;query($query);
00055         
00056   }
00057 
00058   function remove_all($pId)
00059   {
00060         $query=<span class="stringliteral">"select instanceId from galaxia_instances where pId=$pId"</span>;
00061         $result = $this-&gt;query($query);
00062     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {       
00063       $iid = $res['instanceId'];
00064       $query = <span class="stringliteral">"delete from galaxia_instance_activities where instanceId=$iid"</span>;
00065           $this-&gt;query($query);
00066           $query = <span class="stringliteral">"delete from galaxia_workitems where instanceId=$iid"</span>;
00067           $this-&gt;query($query);  
00068     }
00069         $query = <span class="stringliteral">"delete from galaxia_instances where pId=$pId"</span>;
00070         $this-&gt;query($query);
00071         
00072   }
00073 
00074 
00075   
00076   function monitor_list_processes($offset,$maxRecords,$sort_mode,$find,$where='')
00077   {
00078     $sort_mode = str_replace(<span class="stringliteral">"_"</span>,<span class="stringliteral">" "</span>,$sort_mode);
00079     <span class="keywordflow">if</span>($find) {
00080       $mid=<span class="stringliteral">" where ((name like '%"</span>.$find.<span class="stringliteral">"%') or (description like '%"</span>.$find.<span class="stringliteral">"%'))"</span>;
00081     } <span class="keywordflow">else</span> {
00082       $mid=<span class="stringliteral">""</span>;
00083     }
00084     <span class="keywordflow">if</span>($where) {
00085       <span class="keywordflow">if</span>($mid) {
00086         $mid.= <span class="stringliteral">" and ($where) "</span>;
00087       } <span class="keywordflow">else</span> {
00088         $mid.= <span class="stringliteral">" where ($where) "</span>;
00089       }
00090     }
00091     $query = <span class="stringliteral">"select * from galaxia_processes $mid order by $sort_mode limit $offset,$maxRecords"</span>;
00092     $query_cant = <span class="stringliteral">"select count(*) from galaxia_processes $mid"</span>;
00093     $result = $this-&gt;query($query);
00094     $cant = $this-&gt;getOne($query_cant);
00095     $ret = Array();
00096     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00097       <span class="comment">// Number of active instances</span>
00098       $res['active_instances']=$this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_instances where status='active' and pId="</span>.$res['pId']);
00099       <span class="comment">// Number of exception instances</span>
00100       $res['exception_instances']=$this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_instances where status='exception' and pId="</span>.$res['pId']);
00101       <span class="comment">// Number of completed instances</span>
00102       $res['completed_instances']=$this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_instances where status='completed' and pId="</span>.$res['pId']);
00103       <span class="comment">// Number of aborted instances</span>
00104       $res['aborted_instances']=$this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_instances where status='aborted' and pId="</span>.$res['pId']);
00105       $res['all_instances']=$this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_instances where pId="</span>.$res['pId']);
00106       <span class="comment">// Number of activities</span>
00107       $res['activities']=$this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_activities where pId="</span>.$res['pId']);
00108       $ret[] = $res;
00109     }
00110     $retval = Array();
00111     $retval[<span class="stringliteral">"data"</span>] = $ret;
00112     $retval[<span class="stringliteral">"cant"</span>] = $cant;
00113     <span class="keywordflow">return</span> $retval;
00114   }
00115 
00116   function monitor_list_activities($offset,$maxRecords,$sort_mode,$find,$where='')
00117   {
00118     $sort_mode = str_replace(<span class="stringliteral">"_"</span>,<span class="stringliteral">" "</span>,$sort_mode);
00119     <span class="keywordflow">if</span>($find) {
00120       $mid=<span class="stringliteral">" where ((name like '%"</span>.$find.<span class="stringliteral">"%') or (description like '%"</span>.$find.<span class="stringliteral">"%'))"</span>;
00121     } <span class="keywordflow">else</span> {
00122       $mid=<span class="stringliteral">""</span>;
00123     }
00124     <span class="keywordflow">if</span>($where) {
00125       <span class="keywordflow">if</span>($mid) {
00126         $mid.= <span class="stringliteral">" and ($where) "</span>;
00127       } <span class="keywordflow">else</span> {
00128         $mid.= <span class="stringliteral">" where ($where) "</span>;
00129       }
00130     }
00131     $query = <span class="stringliteral">"select * from galaxia_activities $mid order by $sort_mode limit $offset,$maxRecords"</span>;
00132     $query_cant = <span class="stringliteral">"select count(*) from galaxia_activities $mid"</span>;
00133     $result = $this-&gt;query($query);
00134     $cant = $this-&gt;getOne($query_cant);
00135     $ret = Array();
00136     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00137       <span class="comment">// Number of active instances</span>
00138       $aid = $res['activityId'];
00139       $res['active_instances']=$this-&gt;getOne(<span class="stringliteral">"select count(gi.instanceId) from galaxia_instances gi,galaxia_instance_activities gia where gi.instanceId=gia.instanceId and gia.activitYId=$aid and gi.status='active' and pId="</span>.$res['pId']);
00140       $res['completed_instances']=$this-&gt;getOne(<span class="stringliteral">"select count(gi.instanceId) from galaxia_instances gi,galaxia_instance_activities gia where gi.instanceId=gia.instanceId and gia.activityId=$aid and gi.status='completed' and pId="</span>.$res['pId']);
00141       $res['aborted_instances']=$this-&gt;getOne(<span class="stringliteral">"select count(gi.instanceId) from galaxia_instances gi,galaxia_instance_activities gia where gi.instanceId=gia.instanceId and gia.activityId=$aid and gi.status='aborted' and pId="</span>.$res['pId']);
00142       $res['exception_instances']=$this-&gt;getOne(<span class="stringliteral">"select count(gi.instanceId) from galaxia_instances gi,galaxia_instance_activities gia where gi.instanceId=gia.instanceId and gia.activityId=$aid and gi.status='exception' and pId="</span>.$res['pId']);
00143           $res['act_running_instances']=$this-&gt;getOne(<span class="stringliteral">"select count(gi.instanceId) from galaxia_instances gi,galaxia_instance_activities gia where gi.instanceId=gia.instanceId and gia.activityId=$aid and gia.status='running' and pId="</span>.$res['pId']);      
00144       $res['act_completed_instances']=$this-&gt;getOne(<span class="stringliteral">"select count(gi.instanceId) from galaxia_instances gi,galaxia_instance_activities gia where gi.instanceId=gia.instanceId and gia.activityId=$aid and gia.status='completed' and pId="</span>.$res['pId']);
00145       $ret[] = $res;
00146     }
00147     $retval = Array();
00148     $retval[<span class="stringliteral">"data"</span>] = $ret;
00149     $retval[<span class="stringliteral">"cant"</span>] = $cant;
00150     <span class="keywordflow">return</span> $retval;
00151   }
00152 
00153   function monitor_list_instances($offset,$maxRecords,$sort_mode,$find,$where='')
00154   {
00155     $sort_mode = str_replace(<span class="stringliteral">"_"</span>,<span class="stringliteral">" "</span>,$sort_mode);
00156     <span class="keywordflow">if</span>($find) {
00157       $mid=<span class="stringliteral">" where ((properties like '%"</span>.$find.<span class="stringliteral">"%')"</span>;
00158     } <span class="keywordflow">else</span> {
00159       $mid=<span class="stringliteral">""</span>;
00160     }
00161     <span class="keywordflow">if</span>($where) {
00162       <span class="keywordflow">if</span>($mid) {
00163         $mid.= <span class="stringliteral">" and ($where) "</span>;
00164       } <span class="keywordflow">else</span> {
00165         $mid.= <span class="stringliteral">" where ($where) "</span>;
00166       }
00167     }
00168     
00169     $query = <span class="stringliteral">"</span>
00170 <span class="stringliteral">                select  gp.pId,</span>
00171 <span class="stringliteral">                     ga.isInteractive,</span>
00172 <span class="stringliteral">                     gi.owner,</span>
00173 <span class="stringliteral">                     gp.name as procname,</span>
00174 <span class="stringliteral">                     gp.version,</span>
00175 <span class="stringliteral">                     ga.type,</span>
00176 <span class="stringliteral">                     ga.activityId,</span>
00177 <span class="stringliteral">                     ga.name,</span>
00178 <span class="stringliteral">                     gi.instanceId,</span>
00179 <span class="stringliteral">                     gi.status,</span>
00180 <span class="stringliteral">                     gia.activityId,</span>
00181 <span class="stringliteral">                     gia.user,</span>
00182 <span class="stringliteral">                     gi.started,</span>
00183 <span class="stringliteral">                     gia.status as actstatus </span>
00184 <span class="stringliteral">                from </span>
00185 <span class="stringliteral">                   galaxia_instances gi LEFT JOIN galaxia_instance_activities gia ON gi.instanceId=gia.instanceId </span>
00186 <span class="stringliteral">                   LEFT JOIN galaxia_activities ga ON gia.activityId = ga.activityId </span>
00187 <span class="stringliteral">                   LEFT JOIN galaxia_processes gp ON gp.pId=gi.pId </span>
00188 <span class="stringliteral">                $mid order by $sort_mode limit $offset,$maxRecords"</span>;   
00189 
00190     $query_cant = <span class="stringliteral">"select count(*) from </span>
00191 <span class="stringliteral">                   galaxia_instances gi LEFT JOIN galaxia_instance_activities gia ON gi.instanceId=gia.instanceId </span>
00192 <span class="stringliteral">                   LEFT JOIN galaxia_activities ga ON gia.activityId = ga.activityId </span>
00193 <span class="stringliteral">                   LEFT JOIN galaxia_processes gp ON gp.pId=gi.pId             $mid"</span>;
00194     $result = $this-&gt;query($query);
00195     $cant = $this-&gt;getOne($query_cant);
00196     $ret = Array();
00197     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00198       $iid = $res['instanceId'];
00199       $res['workitems']=$this-&gt;getOne(<span class="stringliteral">"select count(*) from galaxia_workitems where instanceId=$iid"</span>);
00200       $ret[] = $res;
00201     }
00202     $retval = Array();
00203     $retval[<span class="stringliteral">"data"</span>] = $ret;
00204     $retval[<span class="stringliteral">"cant"</span>] = $cant;
00205     <span class="keywordflow">return</span> $retval;
00206   }
00207 
00208 
00209   function monitor_list_all_processes($sort_mode)
00210   {
00211       
00212     $query = <span class="stringliteral">"select distinct(name),pId from galaxia_processes order by $sort_mode"</span>;
00213     $result = $this-&gt;query($query);
00214     $ret = Array();
00215     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00216       $ret[] = $res;
00217     }
00218     <span class="keywordflow">return</span> $ret;
00219   }
00220   
00221   function monitor_list_statuses()
00222   {
00223     $query = <span class="stringliteral">"select distinct(status) from galaxia_instances"</span>;
00224     $result = $this-&gt;query($query);
00225     $ret = Array();
00226     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00227       $ret[] = $res['status'];
00228     }
00229     <span class="keywordflow">return</span> $ret;
00230   }
00231   
00232   function monitor_list_users()
00233   {
00234     $query = <span class="stringliteral">"select distinct(user) from galaxia_instance_activities"</span>;
00235     $result = $this-&gt;query($query);
00236     $ret = Array();
00237     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00238       $ret[] = $res['user'];
00239     }
00240     <span class="keywordflow">return</span> $ret;
00241   }
00242 
00243   function monitor_list_wi_users()
00244   {
00245     $query = <span class="stringliteral">"select distinct(user) from galaxia_workitems"</span>;
00246     $result = $this-&gt;query($query);
00247     $ret = Array();
00248     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00249       $ret[] = $res['user'];
00250     }
00251     <span class="keywordflow">return</span> $ret;
00252   }
00253 
00254   
00255   function monitor_list_owners()
00256   {
00257     $query = <span class="stringliteral">"select distinct(owner) from galaxia_instances"</span>;
00258     $result = $this-&gt;query($query);
00259     $ret = Array();
00260     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00261       $ret[] = $res['owner'];
00262     }
00263     <span class="keywordflow">return</span> $ret;
00264   }
00265   
00266   
00267   function monitor_list_activity_types()
00268   {
00269     $query = <span class="stringliteral">"select distinct(type) from galaxia_activities"</span>;
00270     $result = $this-&gt;query($query);
00271     $ret = Array();
00272     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00273       $ret[] = $res['type'];
00274     }
00275     <span class="keywordflow">return</span> $ret;  
00276   }
00277   
00278   function monitor_get_workitem($itemId)
00279   {
00280     $query = <span class="stringliteral">"select gw.orderId,ga.name,ga.type,ga.isInteractive,gp.name as procname,gp.version,gw.itemId,gw.properties,gw.user,started,ended-started as duration from galaxia_workitems gw,galaxia_activities ga,galaxia_processes gp where ga.activityId=gw.activityId and ga.pId=gp.pId and itemId=$itemId"</span>;
00281     $result = $this-&gt;query($query);    
00282     $res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC);
00283     $res['properties']=unserialize($res['properties']);
00284     <span class="keywordflow">return</span> $res;
00285   }
00286 
00287   <span class="comment">// List workitems per instance, remove workitem, update_workitem</span>
00288   function monitor_list_workitems($offset,$maxRecords,$sort_mode,$find,$where='')
00289   {
00290     $sort_mode = str_replace(<span class="stringliteral">"_"</span>,<span class="stringliteral">" "</span>,$sort_mode);
00291     <span class="keywordflow">if</span>($find) {
00292       $mid=<span class="stringliteral">" and ((properties like '%"</span>.$find.<span class="stringliteral">"%') or (name like '%"</span>.$find.<span class="stringliteral">"%'))"</span>;
00293     } <span class="keywordflow">else</span> {
00294       $mid=<span class="stringliteral">""</span>;
00295     }
00296     <span class="keywordflow">if</span>($where) {
00297       <span class="keywordflow">if</span>($mid) {
00298         $mid.= <span class="stringliteral">" and ($where) "</span>;
00299       } <span class="keywordflow">else</span> {
00300         $mid.= <span class="stringliteral">" and ($where) "</span>;
00301       }
00302     }
00303     $query = <span class="stringliteral">"select itemId,ended-started as duration,ga.isInteractive, ga.type,gp.name as procname,gp.version,ga.name as actname, ga.activityId,instanceId,orderId,properties,started,ended,user from galaxia_workitems gw,galaxia_activities ga,galaxia_processes gp where gw.activityId=ga.activityId and ga.pId=gp.pId $mid order by gp.pId,$sort_mode limit $offset,$maxRecords"</span>;
00304     $query_cant = <span class="stringliteral">"select count(*) from galaxia_workitems gw,galaxia_activities ga,galaxia_processes gp where gw.activityId=ga.activityId and ga.pId=gp.pId  $mid"</span>;
00305     $result = $this-&gt;query($query);
00306     $cant = $this-&gt;getOne($query_cant);
00307     $ret = Array();
00308     <span class="keywordflow">while</span>($res = $result-&gt;fetchRow(DB_FETCHMODE_ASSOC)) {
00309       $ret[] = $res;
00310     }
00311     $retval = Array();
00312     $retval[<span class="stringliteral">"data"</span>] = $ret;
00313     $retval[<span class="stringliteral">"cant"</span>] = $cant;
00314     <span class="keywordflow">return</span> $retval;
00315   }
00316   
00317 
00318 }
00319 ?&gt;
</pre></div><hr><address style="align: right;"><small>Generated on Fri Apr 25 16:07:09 2003 for Galaxia by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.3-rc3 </small></address>
</body>
</html>
